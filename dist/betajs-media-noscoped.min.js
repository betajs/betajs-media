/*!
betajs-media - v0.0.160 - 2020-06-26
Copyright (c) Ziggeo,Oliver Friedmann,Rashad Aliyev
Apache-2.0 Software License.
*/

(function(){var e=this.subScope();e.binding("module","global:BetaJS.Media"),e.binding("base","global:BetaJS"),e.binding("browser","global:BetaJS.Browser"),e.binding("flash","global:BetaJS.Flash"),e.define("module:",function(){return{guid:"8475efdb-dd7e-402e-9f50-36c76945a692",version:"0.0.160",datetime:1593203085266}}),e.assumeVersion("base:version","~1.0.136"),e.assumeVersion("browser:version","~1.0.61"),e.assumeVersion("flash:version","~0.0.18"),e.define("module:AudioPlayer.AudioPlayerWrapper",["base:Classes.OptimisticConditionalInstance","base:Events.EventsMixin","base:Types","base:Objs","base:Strings","browser:Events"],function(e,t,n,a,o,h,i){return e.extend({scoped:i},[t,function(r){return{constructor:function(e,t){r.constructor.call(this);var i=(e=a.extend(a.clone(e||{},1),t)).source||e.sources||[];n.is_string(i)?i=i.split(" "):n.is_array(i)||(i=[i]);var s=[];a.iter(i,function(e){if(n.is_string(e)?e={src:e.trim()}:"undefined"!=typeof Blob&&e instanceof Blob&&(e={src:e}),e.ext&&!e.type&&(e.type="audio/"+e.ext),!e.ext&&e.type&&(e.ext=o.last_after(e.type,"/")),!e.ext&&!e.type&&n.is_string(e.src)){var t=o.splitFirst(e.src,"?").head;0<=t.indexOf(".")&&(e.ext=o.last_after(t,"."),e.type="audio/"+e.ext)}e.ext&&(e.ext=e.ext.toLowerCase()),e.type&&(e.type=e.type.toLowerCase()),"undefined"!=typeof Blob&&e.src instanceof Blob&&(e.src=(window.URL||window.webkitURL).createObjectURL(e.src)),s.push(e)},this),this._sources=s,this._element=e.element,this._preload=e.preload||!1,this._reloadonplay=e.reloadonplay||!1,this._options=e,this._loop=e.loop||!1,this._loaded=!1,this._error=0,this._domEvents=new h},destroy:function(){this._domEvents.destroy(),r.destroy.call(this)},sources:function(){return this._sources},loaded:function(){return this._loaded},buffered:function(){},_eventLoaded:function(){this._loaded=!0,this.trigger("loaded")},_eventPlaying:function(){this._loaded||this._eventLoaded(),this.trigger("playing")},_eventPaused:function(){this.trigger("paused")},_eventEnded:function(){this._loop&&!this._options.forceflash&&this.play(),this.trigger("ended")},_eventError:function(e){this._error=e,this.trigger("error",e)},duration:function(){return this._element.duration},position:function(){return this._element.currentTime},error:function(){return this._error},play:function(){this._reloadonplay&&this._element.load(),this._reloadonplay=!1,this._element.play()},pause:function(){this._element.pause()},setPosition:function(e){this._element.currentTime=e},muted:function(){return this._element.muted},setMuted:function(e){this._element.muted=e},volume:function(){return this._element.volume},setVolume:function(e){this._element.volume=e}}}],{ERROR_NO_PLAYABLE_SOURCE:1,ERROR_FLASH_NOT_INSTALLED:2})}),e.define("module:AudioPlayer.Html5AudioPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","browser:Info","base:Promise","base:Objs","base:Timers.Timer","base:Strings","base:Async","browser:Dom","browser:Events"],function(e,_,m,f,p,g,s,v,b,t){return e.extend({scoped:t},function(e){return{_initialize:function(){if(this._options.nohtml5)return m.error(!0);if(this._sources.length<1)return m.error(!0);if(_.isInternetExplorer()&&_.internetExplorerVersion()<9)return m.error(!0);if(this._options.forceflash)return m.error(!0);var i=m.create();this._element.innerHTML="";var s=this.sources(),e=_.isInternetExplorer()&&9==_.internetExplorerVersion()||_.isWindowsPhone();if("audio"!==this._element.tagName.toLowerCase())this._element=v.changeTag(this._element,"audio"),this._transitionals.element=this._element;else if(e){var t=g.splitLast(this._element.outerHTML,"</audio>").head;f.iter(s,function(e){t+="<source"+(e.type?" type='"+e.type+"'":"")+" src='"+e.src+"' />"}),t+="</audio>";var r=v.elementByTemplate(t);v.elementInsertAfter(r,this._element),this._element.parentNode.removeChild(this._element),this._element=r,this._transitionals.element=this._element}_.isSafari()&&_.safariVersion()<6&&(this._element.src=s[0].src,this._preload=!0);this._domEvents.on(this._element,"loadevent",function(){this._element.networkState!==this._element.NETWORK_NO_SOURCE?i.asyncSuccess(!0):i.asyncError(!0)},this);var n=10,a=new p({context:this,fire:function(){this._element.networkState===this._element.NETWORK_NO_SOURCE?--n<=0&&i.asyncError(!0):this._element.networkState===this._element.NETWORK_IDLE?i.asyncSuccess(!0):this._element.networkState===this._element.NETWORK_LOADING&&(_.isEdge()||_.isInternetExplorer()?i.asyncSuccess(!0):_.isFirefox()&&0===s[0].src.indexOf("blob:")&&i.asyncSuccess(!0))},delay:50});this._element.preload=this._preload?"auto":"none";var o=0,h=new b;if(e)for(var d=this._element.getElementsByTagName("SOURCE"),c=function(){++o===s.length&&i.asyncError(!0)},l=0;l<d.length;++l)h.on(d[l],"error",c);else f.iter(s,function(e){var t=document.createElement("source");e.type&&(t.type=e.type),this._element.appendChild(t),h.on(t,"error",function(){++o===s.length&&i.asyncError(!0)}),t.src=e.src},this);i.callback(function(){h.weakDestroy(),a.destroy()},this),i.success(function(){this._setup()},this);try{_.isChrome()||this._element.load()}catch(u){}return i},destroy:function(){(!_.isInternetExplorer()||8<_.internetExplorerVersion())&&(this._element.innerHTML=""),e.destroy.call(this)},_setup:function(){this._loaded=!1,this._domEvents.on(this._element,"canplay",this._eventLoaded,this),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this);for(var e=this._element.getElementsByTagName("SOURCE"),t=function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},i=0;i<e.length;++i)this._domEvents.on(e[i],"error",t,this);_.isSafari()&&(5<_.safariVersion()||_.safariVersion()<9)&&this._element.networkState===this._element.NETWORK_LOADING&&s.eventually(function(){this.destroyed()||this._element.networkState!==this._element.NETWORK_LOADING||0!==this._element.buffered.length||this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this,1e4)},buffered:function(){return this._element.buffered.end(0)},play:function(){e.play.call(this)},pause:function(){this._element.pause()},setPosition:function(e){this._element.currentTime=e},muted:function(){return this._element.muted},setMuted:function(e){this._element.muted=e},volume:function(){return this._element.volume},setVolume:function(e){this._element.volume=e}}})}),e.define("module:AudioPlayer.FlashPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","module:AudioPlayer.FlashPlayer","browser:Info","base:Promise","browser:Dom"],function(e,t,i,s,r,n){return e.extend({scoped:n},function(e){return{_initialize:function(){if(this._options.noflash)return s.error(!0);if(this._sources.length<1)return s.error(!0);if(i.isMobile()||!i.flash().supported())return s.error(!0);if(!i.flash().installed()&&this._options.flashinstallrequired)return s.error(!0);if(!i.flash().installed())return this._eventError(this.cls.ERROR_NO_FLASH_INSTALLED),s.value(!0);s.create();"div"!==this._element.tagName.toLowerCase()&&(this._element=r.changeTag(this._element,"div"),this._transitionals.element=this._element);var e={sources:this.sources()};return this._loop&&(e.loop=!0),this._flashPlayer=new t(this._element,e),this._flashPlayer.ready.success(function(){this._setup()},this)},destroy:function(){this._flashPlayer&&this._flashPlayer.weakDestroy(),this._element.innerHTML="",e.destroy.call(this)},_setup:function(){this._loaded=!0,this._eventLoaded(),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this),this._domEvents.on(this._element,"audioerror",function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this)},position:function(){return this._element.get("currentTime")},buffered:function(){return this.position()},setPosition:function(e){this._element.set("currentTime",e)},setVolume:function(e){this._element.set("volume",e)}}})}),e.extend("module:AudioPlayer.AudioPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","module:AudioPlayer.Html5AudioPlayerWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:AudioPlayer.AudioPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","module:AudioPlayer.FlashPlayerWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:AudioPlayer.FlashPlayer",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Promise"],function(e,n,l,t,s,u,a,_,r,m,o,i){var h=e.extend({scoped:i},function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._source=this.__preferedSource(),this._embedding=this.auto_destroy(new s(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1})),this._flashObjs={},this._flashData={status:"idle"},this.ready=o.create(),this._embedding.ready(this.__initializeEmbedding,this)},__preferedSource:function(){var e=[".mp3",".ogg",".aac"],t=[];if(this.readAttr("src")||this.readAttr("source")||this.readAttr("sources")){var i=this.readAttr("src")||this.readAttr("source")||this.readAttr("sources");m.is_array(i)?t=i:t.push(i)}var s=this._element;if(l.isInternetExplorer()&&l.internetExplorerVersion()<9)for(var r=this._element;;){var n=r.nextSibling;if(!n||!n.tagName||"source"!=n.tagName.toLowerCase())break;t.push(n.src.toLowerCase()),r=n}else for(var a=0;a<this._element.childNodes.length;++a)s.childNodes[a].tagName&&"source"==s.childNodes[a].tagName.toLowerCase()&&s.childNodes[a].src&&t.push(s.childNodes[a].src.toLowerCase());for(var o=(t=_.map(t,function(e){return e.src||e}))[0],h=e.length-1,d=t.length-1;0<=d;--d)for(var c=0;c<=h;++c)if(u.ends_with(t[d],e[c])){o=t[d],h=c;break}return-1==o.indexOf("://")&&(o=document.location.href+"/../"+o),{sourceUrl:o}},__initializeEmbedding:function(){this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.soundTransform=this._embedding.newObject("flash.media.SoundTransform"),this._flashObjs.sound=this._embedding.newObject("flash.media.Sound"),this._flashObjs.urlRequest=this._embedding.newObject("flash.net.URLRequest",this._source.sourceUrl),this._flashObjs.sound.addEventListener("complete",this._embedding.newCallback(r.as_method(this.__requestComplete,this))),this._flashObjs.sound.loadVoid(this._flashObjs.urlRequest)},__requestComplete:function(){this._element.duration=this._flashObjs.sound.length,this.writeAttr("volume",1),this.hasAttr("muted")&&(this._flashObjs.soundTransform.set("volume",0),this.writeAttr("volume",0)),this.__lastPosition=0,this.__paused=!1,this.__playing=!1,this.hasAttr("autoplay")&&this._element.play(),this.ready.asyncSuccess(this)},_domMethods:["play","pause","load"],_domAttrs:{volume:{set:"_setVolume"},currentTime:{get:"_getCurrentTime",set:"_setCurrentTime"}},load:function(){},play:function(){this.__playing||(this.__playing=!0,this.__paused=!1,this._flashObjs.soundChannel=this._flashObjs.sound.play(this.__lastPosition,0,this._flashObjs.soundTransform),this._flashObjs.soundChannel.addEventListener("soundComplete",this._embedding.newCallback(r.as_method(this.__soundComplete,this))),this.domEvent("playing"))},pause:function(){this.__playing&&!this.__paused&&(this.__lastPosition=this._flashObjs.soundChannel.get("position"),this.__playing=!1,this.__paused=!0,this._flashObjs.soundChannel.stop(),this._flashObjs.soundChannel.destroy(),this.domEvent("pause"))},_setVolume:function(e){this._flashObjs.soundTransform.set("volume",e),this.domEvent("volumechange")},_getCurrentTime:function(){return this.__playing?this._flashObjs.soundTransform.get("position"):this.__lastPosition},_setCurrentTime:function(e){this.__playing?this._flashObjs.soundTransform.set("position",e):this.__lastPosition=e},__soundComplete:function(){this.__lastPosition=0,this.__playing=!1,this.__paused=!1,this._flashObjs.soundChannel.destroy(),this.domEvent("ended")}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new t,this.__flashRegistry.register("flash.media.Sound",["load","play","addEventListener"]),this.__flashRegistry.register("flash.media.SoundChannel",["stop","addEventListener"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"]),this.__flashRegistry.register("flash.media.SoundTransform",[])),this.__flashRegistry},polyfill:function(e,t,i,s){if(s){var r=o.create();return a.eventually(function(){r.asyncSuccess(h.polyfill(e,t,i))}),r}return"audio"==e.tagName.toLowerCase()&&"networkState"in e?e.networkState==e.NETWORK_NO_SOURCE||i?h.attach(n.changeTag(e,t||"audiopoly")):e:h.attach(e)},attach:function(e,t){new h(e,t);return e}});return h}),e.define("module:AudioRecorder.AudioRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(e,t,i,s,r){return e.extend({scoped:r},[t,function(t){return{constructor:function(e){t.constructor.call(this,e),this._element=this._options.element,this.ready=s.create()},destroy:function(){t.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},softwareDependencies:function(){return this._softwareDependencies()},_softwareDependencies:function(){},soundLevel:function(){},testSoundLevel:function(e){},getVolumeGain:function(){},setVolumeGain:function(e){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(e){},startRecord:function(e){},stopRecord:function(e){},isFlash:function(){return!1},isWebrtcStreaming:function(){return!1},supportsLocalPlayback:function(){return!1},localPlaybackSource:function(){return null},recordDelay:function(e){return 0}}}],{_initializeOptions:function(e){return i.extend({forceflash:!1,noflash:!1,recordVideo:!1,recordAudio:!0},e)}})}),e.define("module:AudioRecorder.WebRTCAudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","module:WebRTC.AudioAnalyser","browser:Dom","browser:Info","base:Time","base:Objs","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(e,i,s,r,n,t,a,o,h,d,c,l){return e.extend({scoped:l},function(t){return{constructor:function(e){t.constructor.call(this,e),"audio"!==this._element.tagName.toLowerCase()&&(this._element=n.changeTag(this._element,"audio")),this._recorder=i.create({video:this._element,recordVideo:!1,recordAudio:this._options.recordAudio,audioBitrate:this._options.audioBitrate,webrtcStreaming:this._options.webrtcStreaming,webrtcStreamingIfNecessary:this._options.webrtcStreamingIfNecessary,localPlaybackRequested:this._options.localPlaybackRequested}),this._recorder.on("bound",function(){this._analyser&&this.testSoundLevel(!0)},this),this._recorder.on("error",function(e,t){this.trigger("error",e,t)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._analyser&&this._analyser.weakDestroy(),this._recorder.destroy(),t.destroy.call(this)},recordDelay:function(e){return this._recorder.recordDelay(e)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},soundLevel:function(){return!this._analyser&&this._recorder&&this._recorder.stream()&&(this._analyser=new r(this._recorder.stream())),this._analyser?this._analyser.soundLevel():0},isWebrtcStreaming:function(){return this._recorder.isWebrtcStreaming()},testSoundLevel:function(e){this._analyser&&(this._analyser.weakDestroy(),delete this._analyser),e&&(this._analyser=new r(this._recorder.stream()))},currentDevices:function(){return{audio:this._currentAudio}},enumerateDevices:function(){return s.enumerateMediaSources().success(function(e){this._currentAudio||(this._currentAudio=o.ithKey(e.audio))},this)},setCurrentDevices:function(e){e&&e.audio&&this._recorder.selectMicrophone(e.audio)},startRecord:function(e){return this.__localPlaybackSource=null,this._recorder.startRecord(e)},stopRecord:function(r){var n=c.create();return this._recorder.once("data",function(e,t,i){this.__localPlaybackSource={src:t||e};var s=new d;this._options.simulate||i||e&&s.addUploader(h.create(o.extend({source:t||e},r.audio))),n.asyncSuccess(s)},this),this._recorder.stopRecord(),n},supportsLocalPlayback:function(){return!!this.__localPlaybackSource.src},localPlaybackSource:function(){return this.__localPlaybackSource},_softwareDependencies:function(){return c.value(!0)}}},{supported:function(e){return!e.forceflash&&!!i.anySupport(e)}})}),e.define("module:AudioRecorder.FlashAudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:Flash.FlashAudioRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(e,i,s,r,n,a,o,h,d,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),"div"!==this._element.tagName.toLowerCase()&&(this._element=s.changeTag(this._element,"div")),this._recorder=new i(this._element,{microphonecodec:this._options.rtmpMicrophoneCodec,audioRate:this._options.audioBitrate?Math.floor(this._options.audioBitrate/1e3):undefined}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this),this._recorder.on("endpoint_connectivity",function(e,t){this.trigger("endpoint_connectivity",e,t)},this)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},soundLevel:function(){var e=this._recorder.soundLevel();return e<=1?1:1+(e-1)/100},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},testSoundLevel:function(e){this._recorder.testSoundLevel(e)},enumerateDevices:function(){var e=this._recorder.enumerateDevices();return n.value({audioCount:a.count(e.audios),audio:a.map(e.audios,function(e,t){return{id:t,label:e}})})},currentDevices:function(){return{audio:this._recorder.currentMicrophone()}},setCurrentDevices:function(e){e&&e.audio&&this._recorder.selectMicrophone(e.audio)},startRecord:function(e){if(this._options.simulate)return n.value(!0);var t=this,i={},s=n.create();return this._recorder.on("recording",function(){s.asyncSuccess(),t._recorder.off(null,null,i)},i).on("error",function(e){s.asyncError(e),t._recorder.off(null,null,i)},i),this._recorder.startRecord(e.rtmp),s},stopRecord:function(e){if(this._options.simulate)return n.value(new d);var t=this,i={},s=new h,r=null;return r=new o({delay:100,context:this,fire:function(){if(this._recorder&&!this._recorder.destroyed()){var e=this._recorder.uploadStatus();s.progressCallback(e.total-e.remaining,e.total)}else r.destroy()}}),this._recorder.on("finished",function(){s.successCallback(!0),t._recorder.off(null,null,i),r.weakDestroy()},i).on("error",function(e){s.errorCallback(e),t._recorder.off(null,null,i),r.weakDestroy()},i),this._recorder.stopRecord(),n.create(s)},isFlash:function(){return!0},_softwareDependencies:function(){return r.flash().installed()?n.value(!0):n.error([{title:"Adobe Flash",execute:function(){window.open("https://get.adobe.com/flashplayer")}}])}}},{supported:function(e){return!r.isMobile()&&!e.noflash&&r.flash().supported()&&!e.screen}})}),e.extend("module:AudioRecorder.AudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:AudioRecorder.WebRTCAudioRecorderWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:AudioRecorder.AudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:AudioRecorder.FlashAudioRecorderWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:Flash.FlashAudioRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(e,t,i,s,r,n,a,o,h,d,c,l,u,_,m,f){var p=e.extend({scoped:f},[_,m,function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._embedding=this.auto_destroy(new r(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1,hasEmbedding:this.readAttr("hasembedding")||!1,namespace:this.readAttr("embednamespace")||null},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=u.create(),this.__status="idle",this.__audioRate=this.readAttr("audiorate")||44,this.__audioQuality=this.readAttr("audioquality")||10,this.__microphoneCodec=this.readAttr("microphonecodec")||"speex",this.__defaultGain=55,this._embedding.ready(this.__initializeEmbedding,this)},__initializeEmbedding:function(){this.__hasMicrophoneActivity=!1,this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.Microphone=this._embedding.getClass("flash.media.Microphone"),this._flashObjs.microphone=d.is_empty(0<this._flashObjs.Microphone.get("names").length)?null:this._flashObjs.Microphone.getMicrophone(0),this.setMicrophoneProfile(),this._currentMicrophone=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.ready.asyncSuccess(this),this.auto_destroy(new c({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){try{return!this._flashObjs.microphone||!this._flashObjs.microphone.get("muted")}catch(e){return!1}},isSecurityDialogOpen:function(){var e=this._embedding.newObject("flash.display.BitmapData",1,1),t=!1;try{e.draw(this._flashObjs.stage)}catch(i){t=!0}return e.dispose(),e.destroy(),t},openSecurityDialog:function(e){this.trigger("require_display"),this._flashObjs.Security.showSettings("privacy")},grantAccess:function(e,t){var i=u.create(),s=new c({fire:function(){this.destroyed()?s.destroy():this.isSecurityDialogOpen()||(this.isAccessGranted()?(s.destroy(),i.asyncSuccess(!0)):t?(s.destroy(),i.asyncError(!0)):this.openSecurityDialog(e))},context:this,delay:10,start:!0});return i},bindMedia:function(e,t){return this.grantAccess(e,t).mapSuccess(function(){this._mediaBound=!0},this)},unbindMedia:function(){this._mediaBound=!1},enumerateDevices:function(){return{audios:this._flashObjs.Microphone.get("names")}},selectMicrophone:function(e){this._flashObjs.microphone&&this._flashObjs.microphone.weakDestroy(),this.__hasMicrophoneActivity=!1,this.__microphoneActivityTime=null,this._flashObjs.microphone=this._flashObjs.Microphone.getMicrophone(e),this._currentMicrophone=e,this.setMicrophoneProfile(this._currentMicrophoneProfile)},currentMicrophone:function(){return this._currentMicrophone},microphoneInfo:function(){return this._flashObjs.microphone?{muted:this._flashObjs.microphone.get("muted"),name:this._flashObjs.microphone.get("name"),activityLevel:this._flashObjs.microphone.get("activityLevel"),gain:this._flashObjs.microphone.get("gain"),rate:this._flashObjs.microphone.get("rate"),encodeQuality:this._flashObjs.microphone.get("encodeQuality"),codec:this._flashObjs.microphone.get("codec"),hadActivity:this.__hadMicrophoneActivity,inactivityTime:this.__microphoneActivityTime?l.now()-this.__microphoneActivityTime:null}:{}},setMicrophoneProfile:function(e){this._flashObjs.microphone&&(e=e||{},this._flashObjs.microphone.setLoopBack(e.loopback||!1),this._flashObjs.microphone.set("gain",e.gain||this.__defaultGain),this._flashObjs.microphone.setSilenceLevel(e.silenceLevel||0),this._flashObjs.microphone.setUseEchoSuppression(e.echoSuppression||!1),this._flashObjs.microphone.set("rate",e.rate||this.__audioRate),this._flashObjs.microphone.set("encodeQuality",e.encodeQuality||this.__audioQuality),this._flashObjs.microphone.set("codec",e.codec||this.__microphoneCodec),this._currentMicrophoneProfile=e)},getVolumeGain:function(){return(this._mediaBound?this._flashObjs.micropone.get("gain"):55)/55},setVolumeGain:function(e){this.__defaultGain=Math.min(Math.max(0,Math.round(55*e)),100),this._mediaBound&&this._flashObjs.microphone&&this._flashObjs.microphone.set("gain",this.__defaultGain)},testSoundLevel:function(e){this.setMicrophoneProfile(e?{loopback:!0,gain:55,silenceLevel:100,echoSuppression:!0}:{})},soundLevel:function(){return this._flashObjs.microphone?this._flashObjs.microphone.get("activityLevel"):0},_fire:function(){this._mediaBound&&(this.__hadMicrophoneActivity=this.__hadMicrophoneActivity||this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel"),this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel")&&(this.__microphoneActivityTime=l.now()))},_error:function(e){this.__status="error",this.trigger("error",e)},_status:function(e){return e&&e!==this.__status&&(this.__status=e,this.trigger("status",e),this.trigger(e)),this.__status},__newCallback:function(i,e){var s=!0,r=null,n=function(){clearTimeout(r),s&&(s=!1,this.trigger("endpoint_connectivity",this.__endpoint,-1),0<e.length?(i=e.shift(),this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this.__newCallback(i,e)),this.__endpoint=i,this._flashObjs.connection.connectVoid(i.serverUrl)):this._error("Could not connect to server"))},t=this;return r=setTimeout(function(){n.call(t)},1e4),this._embedding.newCallback(h.as_method(function(e){if(s){var t=e.get("info").code;if("NetConnection.Connect.Closed"===t&&"recording"===this._status())return s=!1,void this._error("Connection to server interrupted.");"NetConnection.Connect.Success"===t&&"connecting"!==this._status()||"NetConnection.Connect.Closed"===t&&"connecting"===this._status()||"NetConnection.Connect.Failed"===t&&"connecting"===this._status()?n.call(this):"NetConnection.Connect.Closed"!==t||"uploading"!==this._status()?"NetConnection.Connect.Success"===t&&"connecting"===this._status()&&(this.trigger("endpoint_connectivity",this.__endpoint,1),clearTimeout(r),this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(h.as_method(function(e){var t=e.get("info").code;if("NetStream.Record.Start"!==t)return"NetStream.Play.StreamNotFound"===t?(this._flashObjs.stream.closeVoid(),void("none"!==this._status()&&this._error("Stream not found"))):void(("NetStream.Unpublish.Success"===t||"uploading"===this._status()&&"NetStream.Buffer.Empty"===t&&"flv"===this.__streamType&&0===this._flashObjs.stream.get("bufferLength"))&&(this._flashObjs.stream.closeVoid(),this._flashObjs.stream.destroy(),this._flashObjs.stream=null,this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=null,this._status("finished")));this._status("recording")},this))),this._flashObjs.stream.set("bufferTime",120),this._flashObjs.stream.attachAudioVoid(this._flashObjs.microphone),this._flashObjs.stream.publish(i.streamName,"record")):this._status("finished")}},this))},startRecord:function(e){1<arguments.length&&(e={serverUrl:e,streamName:arguments[1]}),d.is_array(e)||(e=[e]),this._status("connecting");var t=e.shift(),i=this.__newCallback(t,e);this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",i),this.__endpoint=t,this._flashObjs.connection.connectVoid(t.serverUrl)},stopRecord:function(){if("recording"===this._status()){this.__initialBufferLength=0,this._status("uploading"),this.__initialBufferLength=this._flashObjs.stream.get("bufferLength");try{this._flashObjs.stream.attachAudioVoid(null)}catch(e){}}},uploadStatus:function(){return{total:this.__initialBufferLength,remaining:this._flashObjs.stream.get("bufferLength")}}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new s,this.__flashRegistry.register("flash.media.Microphone",["setLoopBack","setSilenceLevel","setUseEchoSuppression"],["getMicrophone"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek","attachAudio","publish","close"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener","call","close"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"])),this.__flashRegistry},attach:function(e,t){new p(e,t);return e}});return p}),e.define("module:Encoding.WaveEncoder.Support",["base:Promise","base:Scheduling.Helper"],function(u,_){return{dumpInputBuffer:function(e,t,i,s){return{left:new Float32Array(e.getChannelData(0)),right:1<t?new Float32Array(e.getChannelData(1)):null,offset:s||0,endOffset:i}},waveChannelTransform:function(e,t,i,s){var r=u.create(),n=32767*(t||1),a=e.offset,o=e.endOffset,h=e.left,d=e.right,c=new Int16Array((o-a)*(d?2:1)),l=0;return _.schedulable(function(e){for(;0<e;){if(e--,o<=a)return r.asyncSuccess(c),!0;c[l]=h[a]*n,l++,d&&(c[l]=d[a]*n,l++),a++}return!1},100,i,s),r},generateHeader:function(e,t,i,s){s=s||new ArrayBuffer(44);var r=new DataView(s);return r.writeUTFBytes=function(e,t){for(var i=0;i<t.length;i++)this.setUint8(e+i,t.charCodeAt(i))},r.writeUTFBytes(0,"RIFF"),r.setUint32(4,44+e,!0),r.writeUTFBytes(8,"WAVE"),r.writeUTFBytes(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,i,!0),r.setUint32(28,4*i,!0),r.setUint16(32,2*t,!0),r.setUint16(34,16,!0),r.writeUTFBytes(36,"data"),r.setUint32(40,e,!0),s}}}),e.define("module:Encoding.WebmEncoder.Support",["base:Promise","base:Scheduling.Helper","base:Types"],function(e,t,i){return{parseWebP:function(e){for(var t=e.RIFF[0].WEBP[0],i=t.indexOf("\x9d\x01*"),s=0,r=[];s<4;s++)r[s]=t.charCodeAt(i+3+s);return{width:16383&(r[1]<<8|r[0]),height:16383&(r[3]<<8|r[2]),data:t,riff:e}},parseRIFF:function(e){for(var t=0,i={},s=function(e){var t=e.charCodeAt(0).toString(2);return new Array(8-t.length+1).join("0")+t};t<e.length;){var r=e.substr(t,4),n=parseInt(e.substr(t+4,4).split("").map(s).join(""),2),a=e.substr(t+4+4,n);t+=8+n,i[r]=i[r]||[],"RIFF"==r||"LIST"==r?i[r].push(this.parseRIFF(a)):i[r].push(a)}return i},isBlankFrame:function(e,t,i,s){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n,a,o,h=r.getContext("2d"),d=0,c=0,l=0,u=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),_=i&&0<=i&&i<=1?i:0,m=s&&0<=s&&s<=1?s:0,f=new Image;f.src=t.image,h.drawImage(f,0,0,e.width,e.height);var p=h.getImageData(0,0,e.width,e.height);n=0,a=p.data.length,o=p.data.length/4;for(var g=0;g<a;g+=4){var v=p.data[g],b=p.data[g+1],y=p.data[g+2];Math.sqrt(Math.pow(v-d,2)+Math.pow(b-c,2)+Math.pow(y-l,2))<=u*_&&n++}return o-n<=o*m},makeSimpleBlock:function(e){var t=0;if(e.keyframe&&(t|=128),e.invisible&&(t|=8),e.lacing&&(t|=e.lacing<<1),e.discardable&&(t|=1),127<e.trackNum)throw"TrackNumber > 127 not supported";return[128|e.trackNum,e.timecode>>8,255&e.timecode,t].map(function(e){return String.fromCharCode(e)}).join("")+e.frame},generateEBMLHeader:function(e,t,i){var s;return[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:(s=e,[].slice.call(new Uint8Array(new Float64Array([s]).buffer),0).map(function(e){return String.fromCharCode(e)}).reverse().join("")),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:t,id:176},{data:i,id:186}]}]}]}]}]},__numToBuffer:function(e){for(var t=[];0<e;)t.push(255&e),e>>=8;return new Uint8Array(t.reverse())},__strToBuffer:function(e){return new Uint8Array(e.split("").map(function(e){return e.charCodeAt(0)}))},__bitsToBuffer:function(e){var t=[];e=(e.length%8?new Array(9-e.length%8).join("0"):"")+e;for(var i=0;i<e.length;i+=8)t.push(parseInt(e.substr(i,8),2));return new Uint8Array(t)},serializeEBML:function(e){if(!i.is_array(e))return e;var h=[];return e.forEach(function(e){var t=e.data,i=typeof t;"object"===i?t=this.serializeEBML(t):"number"===i?t=this.__bitsToBuffer(t.toString(2)):"string"===i&&(t=this.__strToBuffer(t));var s=t.size||t.byteLength||t.length,r=Math.ceil(Math.ceil(Math.log(s)/Math.log(2))/8),n=s.toString(2),a=new Array(7*r+7+1-n.length).join("0")+n,o=new Array(r).join("0")+"1"+a;h.push(this.__numToBuffer(e.id)),h.push(this.__bitsToBuffer(o)),h.push(t)},this),new Blob(h,{type:"video/webm"})},makeTimecodeDataBlock:function(e,t){return{data:this.makeSimpleBlock({discardable:0,frame:e.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(t)}),id:163}},makeCluster:function(e,t){return e.unshift({data:t,id:231}),{id:524531317,data:e}}}}),e.define("module:Flash.FlashImageRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(e,t,i,s,r,n,a,o,c,h,d,l,u,_,m,f){var p=e.extend({scoped:f},[_,m,function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._embedding=this.auto_destroy(new r(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1,hasEmbedding:this.readAttr("hasembedding")||!1,namespace:this.readAttr("embednamespace")||null},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=u.create(),this.__videoRate=this.readAttr("videorate")||0,this.__videoQuality=this.readAttr("videoquality")||90,this.__cameraWidth=this.readAttr("camerawidth")||640,this.__cameraHeight=this.readAttr("cameraheight")||480,this._flip=h.parseBool(this.readAttr("flip")||!1),this._embedding.ready(this.__initializeEmbedding,this)},__initializeEmbedding:function(){this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.cameraVideo=this._embedding.newObject("flash.media.Video",this.__cameraWidth,this.__cameraHeight),this._flashObjs.main.addChildVoid(this._flashObjs.video),this._flashObjs.Camera=this._embedding.getClass("flash.media.Camera"),this._flashObjs.camera=this._flashObjs.Camera.getCamera(0),this._currentCamera=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.recomputeBB(),this.ready.asyncSuccess(this),this.auto_destroy(new d({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){try{return!this._flashObjs.camera||!this._flashObjs.camera.get("muted")}catch(e){return!1}},isSecurityDialogOpen:function(){var e=this._embedding.newObject("flash.display.BitmapData",1,1),t=!1;try{e.draw(this._flashObjs.stage)}catch(i){t=!0}return e.dispose(),e.destroy(),t},openSecurityDialog:function(e){this.trigger("require_display"),e?this._flashObjs.Security.showSettings("privacy"):(this._flashObjs.video.attachCamera(null),this._flashObjs.video.attachCamera(this._flashObjs.camera))},grantAccess:function(e,t){var i=u.create(),s=new d({fire:function(){this.destroyed()?s.destroy():this.isSecurityDialogOpen()||(this.isAccessGranted()?(s.destroy(),i.asyncSuccess(!0)):t?(s.destroy(),i.asyncError(!0)):this.openSecurityDialog(e))},context:this,delay:10,start:!0});return i},bindMedia:function(e,t){return this.grantAccess(e,t).mapSuccess(function(){this._mediaBound=!0,this._attachCamera()},this)},unbindMedia:function(){this._detachCamera(),this._mediaBound=!1},_attachCamera:function(){this._flashObjs.camera&&(this._flashObjs.camera.setMode(this.__cameraWidth,this.__cameraHeight,this.__fps),this._flashObjs.camera.setQuality(this.__videoRate,this.__videoQuality),this._flashObjs.camera.setKeyFrameInterval(5),this._flashObjs.video.attachCamera(this._flashObjs.camera),this._flashObjs.cameraVideo.attachCamera(this._flashObjs.camera)),this._flip&&(0<this._flashObjs.video.get("scaleX")&&this._flashObjs.video.set("scaleX",-this._flashObjs.video.get("scaleX")),this._flashObjs.video.set("x",this._flashObjs.video.get("width")))},_detachCamera:function(){this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)},enumerateDevices:function(){return{videos:this._flashObjs.Camera.get("names")}},selectCamera:function(e){this._flashObjs.camera&&this._flashObjs.camera.weakDestroy(),this.__cameraActivityTime=null,this._flashObjs.camera=this._flashObjs.Camera.getCamera(e),this._currentCamera=e,this._mediaBound&&this._attachCamera()},currentCamera:function(){return this._currentCamera},cameraInfo:function(){return this._flashObjs.camera?{muted:this._flashObjs.camera.get("muted"),name:this._flashObjs.camera.get("name"),activityLevel:this._flashObjs.camera.get("activityLevel"),fps:this._flashObjs.camera.get("fps"),width:this._flashObjs.camera.get("width"),height:this._flashObjs.camera.get("height"),inactivityTime:this.__cameraActivityTime?l.now()-this.__cameraActivityTime:null}:{}},_pixelSample:function(e,t,i){e=e||100;var s=this._flashObjs.cameraVideo.get("width"),r=this._flashObjs.cameraVideo.get("height"),n=Math.ceil(Math.sqrt(s/r*e)),a=Math.ceil(Math.sqrt(r/s*e)),o=this._embedding.newObject("flash.display.BitmapData",n,a),h=this._embedding.newObject("flash.geom.Matrix");h.scale(n/s,a/r),o.draw(this._flashObjs.cameraVideo,h);for(var d=0;d<e;++d){var c=d%n,l=Math.floor(d/n),u=o.getPixel(c,l);t.call(i||this,u%256,u/256%256,u/256/256%256)}h.destroy(),o.destroy()},_fire:function(){if(this._mediaBound&&this._flashObjs.camera){var e=this._flashObjs.camera.get("activityLevel");this.__lastCameraActivity&&this.__lastCameraActivity===e||(this.__cameraActivityTime=l.now()),this.__lastCameraActivity=e}},createSnapshot:function(){var e=this._embedding.newObject("flash.display.BitmapData",this._flashObjs.cameraVideo.get("videoWidth"),this._flashObjs.cameraVideo.get("videoHeight"));return e.draw(this._flashObjs.cameraVideo),e},postSnapshot:function(e,t,i,s){var r=u.create();s=s||90;var n=this._embedding.newObject("flash.net.URLRequestHeader","Content-type","application/octet-stream"),a=this._embedding.newObject("flash.net.URLRequest",t);if(a.set("requestHeaders",[n]),a.set("method","POST"),"jpg"===i){var o=this._embedding.newObject("com.adobe.images.JPGEncoder",s);a.set("data",o.encode(e)),o.destroy()}else{var h=this._embedding.getClass("com.adobe.images.PNGEncoder");a.set("data",h.encode(e))}var d=this._embedding.newObject("flash.net.URLLoader");return d.set("dataFormat","BINARY"),d.addEventListener("complete",this._embedding.newCallback(c.as_method(function(){r.asyncSuccess(!0)},this))),d.addEventListener("ioError",this._embedding.newCallback(c.as_method(function(){r.asyncError("IO Error")},this))),d.load(a),r.callback(function(){d.destroy(),a.destroy(),n.destroy()}),r},createSnapshotDisplay:function(e,t,i,s,r){var n=this._embedding.newObject("flash.display.Bitmap",e);return this.updateSnapshotDisplay(e,n,t,i,s,r),this._flashObjs.main.addChildVoid(n),n},updateSnapshotDisplay:function(e,t,i,s,r,n){t.set("x",i),t.set("y",s),t.set("scaleX",r/e.get("width")),t.set("scaleY",n/e.get("height"))},removeSnapshotDisplay:function(e){this._flashObjs.main.removeChildVoid(e),e.destroy()},idealBB:function(){return{width:this.__cameraWidth,height:this.__cameraHeight}},setActualBB:function(i){["object","embed"].forEach(function(e){var t=this._element.getElementsByTagName(e.toUpperCase())[0];t&&["width","height"].forEach(function(e){t.style[e]=i[e]+"px"})},this);var e=this._flashObjs.video;e&&(e.set("width",i.width),e.set("height",i.height),this._flip&&(0<e.get("scaleX")&&e.set("scaleX",-e.get("scaleX")),e.set("x",e.get("width"))))},_error:function(e){this.__status="error",this.trigger("error",e)}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new s,this.__flashRegistry.register("flash.media.Camera",["setMode","setQuality","setKeyFrameInterval","addEventListener"],["getCamera"]),this.__flashRegistry.register("flash.media.Video",["attachCamera","attachNetStream"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.net.URLRequestHeader",[]),this.__flashRegistry.register("flash.net.URLLoader",["addEventListener","load"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","removeChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"]),this.__flashRegistry.register("flash.display.BitmapData",["draw","getPixel","dispose"]),this.__flashRegistry.register("flash.display.Bitmap",[]),this.__flashRegistry.register("flash.geom.Matrix",["scale"]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"]),this.__flashRegistry.register("com.adobe.images.PNGEncoder",[],["encode"]),this.__flashRegistry.register("com.adobe.images.JPGEncoder",["encode"])),this.__flashRegistry},attach:function(e,t){new p(e,t);return e}});return p}),e.define("module:ImageRecorder.ImageRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(e,t,i,s,r){return e.extend({scoped:r},[t,function(t){return{constructor:function(e){t.constructor.call(this,e),this._element=this._options.element,this.ready=s.create()},destroy:function(){t.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},softwareDependencies:function(){return this._softwareDependencies()},_softwareDependencies:function(){},cameraWidth:function(){return this._options.recordingWidth},cameraHeight:function(){return this._options.recordingHeight},lightLevel:function(){},blankLevel:function(){},deltaCoefficient:function(){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(e){},createSnapshot:function(){},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){},updateSnapshotDisplay:function(e,t,i,s,r,n){},removeSnapshotDisplay:function(e){},createSnapshotUploader:function(e,t,i){},isFlash:function(){return!1},snapshotToLocalPoster:function(e){return null}}}],{_initializeOptions:function(e){return i.extend({forceflash:!1,noflash:!1,recordingWidth:640,recordingHeight:480},e)}})}),e.define("module:ImageRecorder.WebRTCImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","browser:Dom","browser:Info","base:Time","base:Objs","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(e,i,h,d,t,s,r,n,a,o,c){return e.extend({scoped:c},function(t){return{constructor:function(e){t.constructor.call(this,e),"video"!==this._element.tagName.toLowerCase()&&(this._element=d.changeTag(this._element,"video")),this._recorder=i.create({video:this._element,flip:!!this._options.flip,recordVideo:!0,recordAudio:!1,recordResolution:{width:this._options.recordingWidth,height:this._options.recordingHeight},videoBitrate:this._options.videoBitrate,screen:this._options.screen}),this._recorder.on("error",function(e,t){this.trigger("error",e,t)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},lightLevel:function(){return this._recorder.lightLevel()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},currentDevices:function(){return{video:this._currentVideo}},enumerateDevices:function(){return h.enumerateMediaSources().success(function(e){this._currentVideo||(this._currentVideo=r.ithKey(e.video))},this)},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video)},createSnapshot:function(e){return this._recorder.createSnapshot(e)},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){var a=h.globals().URL.createObjectURL(t),o=document.createElement("img");return o.style.position="absolute",this.updateSnapshotDisplay(t,o,i,s,r,n),o.src=a,d.elementPrependChild(e,o),o},updateSnapshotDisplay:function(e,t,i,s,r,n){t.style.left=i+"px",t.style.top=s+"px",t.style.width=r+"px",t.style.height=n+"px"},removeSnapshotDisplay:function(e){e.remove()},createSnapshotUploader:function(e,t,i){return n.create(r.extend({source:e},i))},snapshotToLocalPoster:function(e){return e},_softwareDependencies:function(){if(!this._options.screen||h.globals().supportedConstraints.mediaSource)return o.value(!0);var e=h.chromeExtensionExtract(this._options.screen),t=[{title:"Screen Recorder Extension",execute:function(){window.open(e.extensionInstallLink)}}],i=s.now();return h.chromeExtensionMessage(e.extensionId,{type:"ping",data:i}).mapError(function(){return t}).mapSuccess(function(e){return!(!e||"success"!==e.type||e.data!==i)||o.error(t)})}}},{supported:function(e){return!e.forceflash&&(!!i.anySupport(e)&&(!e.screen||(!!(h.globals().supportedConstraints.mediaSource&&t.isFirefox()&&55<t.firefoxVersion())||(!(!t.isChrome()||!e.screen.chromeExtensionId)||!(!t.isOpera()||!e.screen.operaExtensionId)))))}})}),e.define("module:ImageRecorder.FlashImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:Flash.FlashImageRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(e,i,s,r,n,a,t,o,h,d){return e.extend({scoped:d},function(t){return{constructor:function(e){t.constructor.call(this,e),"div"!==this._element.tagName.toLowerCase()&&(this._element=s.changeTag(this._element,"div")),this._recorder=new i(this._element,{flip:!!this._options.flip,camerawidth:this._options.recordingWidth,cameraheight:this._options.recordingHeight,fps:this._options.framerate,videoRate:this._options.videoBitrate?1e3*this._options.videoBitrate:undefined}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this),this._recorder.on("endpoint_connectivity",function(e,t){this.trigger("endpoint_connectivity",e,t)},this)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},lightLevel:function(){return this._recorder.lightLevel()},enumerateDevices:function(){var e=this._recorder.enumerateDevices();return n.value({videoCount:a.count(e.videos),video:a.map(e.videos,function(e,t){return{id:t,label:e}})})},currentDevices:function(){return{video:this._recorder.currentCamera()}},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video)},createSnapshot:function(e){return this._recorder.createSnapshot()},createSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.createSnapshotDisplay(t,i,s,r,n)},updateSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.updateSnapshotDisplay(e,t,i,s,r,n)},removeSnapshotDisplay:function(e){this._recorder.removeSnapshotDisplay(e)},createSnapshotUploader:function(e,t,i){var s=new o(a.extend({source:e,type:t,recorder:this._recorder},i));return s.on("upload",function(e){e.recorder.postSnapshot(e.source,e.url,e.type).success(s.successCallback,s).error(s.errorCallback,s)}),s},isFlash:function(){return!0},_softwareDependencies:function(){return r.flash().installed()?n.value(!0):n.error([{title:"Adobe Flash",execute:function(){window.open("https://get.adobe.com/flashplayer")}}])}}},{supported:function(e){return!r.isMobile()&&!e.noflash&&r.flash().supported()&&!e.screen}})}),e.extend("module:ImageRecorder.ImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:ImageRecorder.WebRTCImageRecorderWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:ImageRecorder.ImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:ImageRecorder.FlashImageRecorderWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:Player.Broadcasting",["base:Class","browser:Loader","browser:Events"],function(e,i,s,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.apply(this),this.player=e.player,this.googleCast={},this.airplay={},this.options=e.commonOptions,this.googleCast.initialOptions=e.castOptions,this.airplayOptions=e.airplayOptions,this.player.on("pause-google-cast",function(){this._googleCastRemotePause()},this),this.player.on("play-google-cast",function(){this._googleCastRemotePlay()},this),this.player.on("google-cast-seeking",function(e){this._seekToGoogleCast(e)},this),this.player.on("change-google-cast-volume",function(e){e=Math.min(1,e),this._changeGoogleCastVolume(e)},this)},attachAirplayEvent:function(e){this._airplayEvent=this.auto_destroy(new s),this._airplayEvent.on(e,"webkitplaybacktargetavailabilitychanged",function(e){switch(e.availability){case"available":return this.player._broadcastingState.airplayConnected=!0;default:return!1}},this)},attachGoggleCast:function(){var t=this;window.__onGCastApiAvailable=function(e){e&&t._initializeCastApi()},i.loadScript("https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1",function(){})},_initializeCastApi:function(){var e=this;e.player.trigger("cast-available",!0);var t=this.googleCast.initialOptions,i={},s=[chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,"41A5ADFD","8AA2B3F9","DE815B4F"],r=[chrome.cast.AutoJoinPolicy.PAGE_SCOPED,chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED,chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED];i.receiverApplicationId=s[2],i.autoJoinPolicy=r[1],cast.framework.CastContext.getInstance().setOptions(i);var n=new cast.framework.RemotePlayer;n.title=this.options.title,n.canControlVolume=t.canControlVolume,n.canPause=t.canPause,n.canSeek=t.canSeek,n.duration=t.duration,n.imageUrl=t.imageUrl,n.isConnected=t.isConnected,n.isMuted=t.isMuted,n.isPaused=t.isPaused,n.title=this.options.title,n.displayName=t.displayName;var a=new cast.framework.RemotePlayerController(n);a.addEventListener(cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,function(){cast&&cast.framework&&(n.isConnected?e._setupCastRemotePlayer(n,a):e._destroyCastRemotePlayer(n,a))})},_setupCastRemotePlayer:function(i,t){var s=this,r=this.player,e=(this.castOptions,r._options.sources[0]),n=r._element.currentSrc,a=e.type,o=cast.framework.CastContext.getInstance().getCurrentSession(),h=new chrome.cast.media.MediaInfo(n,a);h.metadata=new chrome.cast.media.GenericMediaMetadata,h.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC,h.metadata.title=this.options.title,h.metadata.images=[{url:this.options.poster}];var d=new chrome.cast.media.LoadRequest(h);this.googleCast.castRemotePlayer=i,this.googleCast.castRemotePlayerController=t,this.googleCast.castMediaInfo=h,(this.googleCast.castSession=o).loadMedia(d).then(function(){r._broadcastingState.googleCastConnected=!0,r.trigger("cast-loaded",i,t);var e=s.options.currentPosition;0<e&&s._seekToGoogleCast(e),t.addEventListener(cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED,function(){r.trigger("cast-playpause",i.isPaused)}),t.addEventListener(cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED,function(){var e=s._getGoogleCastCurrentMediaTime(i),t=s._getGoogleCastMediaDuration(i);r.trigger("cast-time-changed",e,t)})},function(e){console.warn("Remote media load error : "+s._googleCastPlayerErrorMessages(e))})},_destroyCastRemotePlayer:function(e,t){var i=this.player,s=this._getGoogleCastCurrentMediaTime(e);e.savedPlayerState&&!e.isConnected&&(s=e.savedPlayerState.currentTime),i._broadcastingState.googleCastConnected&&0<s&&i.trigger("proceed-when-ending-googlecast",s),this.player._broadcastingState.googleCastConnected=!1},_getGoogleCastRemotePlayer:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castRemotePlayer},_getGoogleCastRemotePlayerController:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castRemotePlayerController},_getGoogleCastMediaInfo:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castMediaInfo},_getGoogleCastCurrentSession:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castSession},_getGoogleCastCurrentMediaTime:function(e){if(this.player._broadcastingState.googleCastConnected)return e.currentTime},_getGoogleCastMediaDuration:function(e){if(this.player._broadcastingState.googleCastConnected)return e.duration},_googleCastRemotePlay:function(){if(this.player._broadcastingState.googleCastConnected){var e=this._getGoogleCastRemotePlayer(),t=this._getGoogleCastRemotePlayerController();return"PAUSED"===e.playerState&&t.playOrPause(),e}return!1},_googleCastRemotePause:function(){if(this.player._broadcastingState.googleCastConnected){var e=this._getGoogleCastRemotePlayer(),t=this._getGoogleCastRemotePlayerController();return"PLAYING"===e.playerState&&t.playOrPause(),e}return!1},_seekToGoogleCast:function(e){var t=this._getGoogleCastRemotePlayer(),i=this._getGoogleCastRemotePlayerController();t.currentTime=e,i.seek()},_changeGoogleCastVolume:function(e){var t=this._getGoogleCastRemotePlayerController();this._getGoogleCastRemotePlayer().volumeLevel=e,t.setVolumeLevel()},_googleCastPlayerErrorMessages:function(e){switch(e.code){case chrome.cast.ErrorCode.API_NOT_INITIALIZED:return"The API is not initialized."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.CANCEL:return"The operation was canceled by the user"+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.CHANNEL_ERROR:return"A channel to the receiver is not available."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.EXTENSION_MISSING:return"The Cast extension is not available."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.INVALID_PARAMETER:return"The parameters to the operation were not valid."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.RECEIVER_UNAVAILABLE:return"No receiver was compatible with the session request."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.SESSION_ERROR:return"A session could not be created, or a session was invalid."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.TIMEOUT:return"The operation timed out."+(e.description?" :"+e.description:"")}},lookForAirplayDevices:function(e){return e.webkitShowPlaybackTargetPicker()}}})}),e.define("module:Player.FlashPlayer",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Promise"],function(e,n,m,t,s,f,a,p,r,g,o,i){var h=e.extend({scoped:i},function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._source=this.__preferedSource(),this._embedding=this.auto_destroy(new s(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1})),this._flashObjs={},this._flashData={status:"idle"},this.ready=o.create(),this._embedding.ready(this.__initializeEmbedding,this)},__preferedSource:function(){var e=[".mp4",".flv"],t=[];if(this.readAttr("src")||this.readAttr("source")||this.readAttr("sources")){var i=this.readAttr("src")||this.readAttr("source")||this.readAttr("sources");g.is_array(i)?t=i:t.push(i)}var s=this._element;if(m.isInternetExplorer()&&m.internetExplorerVersion()<9)for(var r=this._element;;){var n=r.nextSibling;if(!n||!n.tagName||"source"!=n.tagName.toLowerCase())break;t.push(n.src.toLowerCase()),r=n}else for(var a=0;a<this._element.childNodes.length;++a)s.childNodes[a].tagName&&"source"==s.childNodes[a].tagName.toLowerCase()&&s.childNodes[a].src&&t.push(s.childNodes[a].src.toLowerCase());for(var o=(t=p.map(t,function(e){return e.src||e}))[0],h=e.length-1,d=t.length-1;0<=d;--d)for(var c=0;c<=h;++c)if(f.ends_with(t[d],e[c])){o=t[d],h=c;break}-1==o.indexOf("://")&&(o=document.location.href+"/../"+o);var l=null,u=o;if(f.starts_with(o,"rtmp")){var _=f.splitLast(o,"/");l=_.head,u=_.tail}return{sourceUrl:o,connectionUrl:l,playUrl:u}},__initializeEmbedding:function(){if(this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this.readAttr("poster")){this._flashObjs.imageLoader=this._embedding.newObject("flash.display.Loader");var e=this._flashObjs.imageLoader.get("contentLoaderInfo");e.addEventListener("complete",this._embedding.newCallback(r.as_method(function(){this.__imageLoaded={width:this._flashObjs.imageLoader.get("width"),height:this._flashObjs.imageLoader.get("height")},this.__metaLoaded||this.recomputeBB()},this))),e.addEventListener("ioError",this._embedding.newCallback(r.as_method(function(){this.domEvent("postererror")},this))),this._flashObjs.imageUrlRequest=this._embedding.newObject("flash.net.URLRequest",this.readAttr("poster")),this._flashObjs.imageLoader.load(this._flashObjs.imageUrlRequest),this._flashObjs.main.addChildVoid(this._flashObjs.imageLoader)}this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this._embedding.newCallback(r.as_method(this.__connectionStatusEvent,this))),this._flashObjs.connection.connectVoid(this._source.connectionUrl)},__connectionStatusEvent:function(){this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.set("client",this._embedding.newCallback("onMetaData",r.as_method(function(e){this._flashData.meta=e,this._element.duration=e.duration,this.__metaLoaded=!0,a.eventually(this.recomputeBB,this)},this))),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(r.as_method(this.__streamStatusEvent,this))),this._flashObjs.soundTransform=this._embedding.newObject("flash.media.SoundTransform"),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this._flashObjs.video.attachNetStreamVoid(this._flashObjs.stream),this.writeAttr("volume",1),this.hasAttr("muted")&&(this._flashObjs.soundTransform.set("volume",0),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.writeAttr("volume",0)),this._flashObjs.main.addChildVoid(this._flashObjs.video),this.hasAttr("autoplay")&&this._element.play(),this.ready.asyncSuccess(this)},__streamStatusEvent:function(e){var t=e.get("info").code;"NetStream.Play.StreamNotFound"==t&&(this._flashData.status="error",this.domEvent("videoerror")),"NetStream.Play.Start"==t&&(this._flashData.status="start"),"NetStream.Play.Stop"==t&&(this._flashData.status="stopping"),"NetStream.Buffer.Empty"==t&&"stopping"==this._flashData.status&&(this._flashData.status="stopped",this.domEvent("ended")),"stopped"==this._flashData.status&&this.hasAttr("loop")&&(this._flashData.status="idle",this._element.play())},idealBB:function(){return this.__imageLoaded||this.__metaLoaded?{width:this.__metaLoaded?this._flashData.meta.width:this.__imageLoaded.width,height:this.__metaLoaded?this._flashData.meta.height:this.__imageLoaded.height}:null},setActualBB:function(i){["object","embed"].forEach(function(e){var t=this._element.getElementsByTagName(e.toUpperCase())[0];t&&["width","height"].forEach(function(e){t.style[e]=i[e]+"px"})},this),this.__metaLoaded&&(this._flashObjs.video.set("width",i.width),this._flashObjs.video.set("height",i.height)),this.__imageLoaded&&(this._flashObjs.imageLoader.set("width",i.width),this._flashObjs.imageLoader.set("height",i.height))},videoWidth:function(){return this.__metaLoaded?this._flashData.meta.width:this.__imageLoaded?this.__imageLoaded.width:NaN},videoHeight:function(){return this.__metaLoaded?this._flashData.meta.height:this.__imageLoaded?this.__imageLoaded.height:NaN},_domMethods:["play","pause","load"],_domAttrs:{volume:{set:"_setVolume"},currentTime:{get:"_getCurrentTime",set:"_setCurrentTime"}},load:function(){},play:function(){this._flashObjs.main.imageLoader&&this._flashObjs.main.setChildIndex(this._flashObjs.video,1),"paused"===this._flashData.status?this._flashObjs.stream.resumeVoid():this._flashObjs.stream.playVoid(this._source.playUrl),this._flashData.status="playing",this.domEvent("playing")},pause:function(){"paused"!==this._flashData.status&&(this._flashData.status="paused",this._flashObjs.stream.pauseVoid(),this.domEvent("pause"))},_setVolume:function(e){this._flashObjs.soundTransform.set("volume",e),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.domEvent("volumechange")},_getCurrentTime:function(){return this._flashObjs.stream.get("time")},_setCurrentTime:function(e){this._flashObjs.stream.seek(e)}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new t,this.__flashRegistry.register("flash.media.Video",["attachNetStream"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"])),this.__flashRegistry},polyfill:function(e,t,i,s){if(s){var r=o.create();return a.eventually(function(){r.asyncSuccess(h.polyfill(e,t,i))}),r}return"video"==e.tagName.toLowerCase()&&"networkState"in e?e.networkState==e.NETWORK_NO_SOURCE||i?h.attach(n.changeTag(e,t||"videopoly")):e:h.attach(e)},attach:function(e,t){new h(e,t);return e}});return h}),e.define("module:Player.Support",["base:Promise","base:Objs"],function(d,c){return{resolutionToLabel:function(e,t){return t<300?"SD":t<400?"360p":t<500?"480p":"HD"},elementFileInfo:function(e,t,i,s){try{var r=document.createElement(e);c.iter(i,function(e,t){r[t]=e});var n=d.create(),a=!1,o=setTimeout(function(){a=!0,n.asyncError("Timeout")},1e3);return r[t]=function(){a||(clearTimeout(o),n.asyncSuccess(r))},r.src=(window.URL||window.webkitURL).createObjectURL(s),n}catch(h){return d.error(h)}},videoFileInfo:function(e){return this.elementFileInfo("video","onloadeddata",{volume:0,muted:!0,preload:!0},e).mapSuccess(function(e){return{width:e.videoWidth,height:e.videoHeight,duration:e.duration}})},audioFileInfo:function(e){return this.elementFileInfo("audio","onloadeddata",{volume:0,muted:!0,preload:!0},e).mapSuccess(function(e){return{duration:e.duration}})},imageFileInfo:function(e){return this.elementFileInfo("img","onload",{},e).mapSuccess(function(e){return{width:e.width,height:e.height}})}}}),e.define("module:Player.VideoPlayerWrapper",["base:Classes.OptimisticConditionalInstance","base:Events.EventsMixin","base:Types","base:Objs","base:Strings","browser:Events"],function(e,t,n,a,o,h,i){return e.extend({scoped:i},[t,function(r){return{constructor:function(i,e){r.constructor.call(this),i=a.extend(a.clone(i||{},1),e),this._poster=i.poster||null;var t=i.source||i.sources||[];n.is_string(t)?t=t.split(" "):n.is_array(t)||(t=[t]);var s=[];a.iter(t,function(e){if(n.is_string(e)?e={src:e.trim()}:"undefined"!=typeof Blob&&e instanceof Blob&&(e={src:e}),e.ext&&!e.type&&(e.type="video/"+e.ext),!e.ext&&e.type&&(e.ext=o.last_after(e.type,"/")),!e.ext&&!e.type&&n.is_string(e.src)){var t=o.splitFirst(e.src,"?").head;0<=t.indexOf(".")&&(e.ext=o.last_after(t,"."),e.type="video/"+e.ext)}e.ext&&(e.ext=e.ext.toLowerCase()),e.type&&(e.type=e.type.toLowerCase()),"undefined"!=typeof Blob&&e.src instanceof Blob&&(e.src="undefined"!=typeof i.onlyaudio&&i.onlyaudio?(window.URL||window.webkitURL).createObjectURL(e.audiosrc):(window.URL||window.webkitURL).createObjectURL(e.src)),"undefined"!=typeof Blob&&e.audiosrc instanceof Blob&&(e.audiosrc=(window.URL||window.webkitURL).createObjectURL(e.audiosrc)),s.push(e)},this),this._sources=s,this._element=i.element,this._preload=i.preload||!1,this._reloadonplay=i.reloadonplay||!1,this._options=i,this._loop=i.loop||!1,this._fullscreenedElement=i.fullscreenedElement,this._loaded=!1,this._postererror=!1,this._error=0,this._domEvents=new h,this._broadcastingState={googleCastConnected:!1,airplayConnected:!1}},destroy:function(){this._domEvents.destroy(),r.destroy.call(this)},poster:function(){return this._poster},sources:function(){return this._sources},loaded:function(){return this._loaded},postererror:function(){return this._postererror},buffered:function(){},_eventLoaded:function(){this._loaded=!0,this.trigger("loaded")},_eventPlaying:function(){this._loaded||this._eventLoaded(),this.trigger("playing")},_eventPaused:function(){this.duration()&&this.duration()===this.position()||this.trigger("paused")},_eventEnded:function(){this.trigger("ended")},_eventError:function(e){this._error=e,this.trigger("error",e)},_eventPosterError:function(){this._postererror=!0,this.trigger("postererror")},supportsFullscreen:function(){return!1},duration:function(){return this._element.duration},position:function(){return this._element.currentTime},enterFullscreen:function(){},exitFullscreen:function(){},isFullscreen:function(){return!1},supportsPIP:function(){return!1},enterPIPMode:function(){},exitPIPMode:function(){},isInPIPMode:function(){return!1},error:function(){return this._error},play:function(){this._reloadonplay&&this._element.load(),this._reloadonplay=!1;try{var e=this._element.play();e["catch"]&&e["catch"](function(){})}catch(t){}},pause:function(){this._element.pause()},setPosition:function(e){this._element.currentTime=e},muted:function(){return this._element.muted},setMuted:function(e){this._element.muted=e},volume:function(){return this._element.volume},setVolume:function(e){this._element.volume=e},videoWidth:function(){},videoHeight:function(){}}}],{ERROR_NO_PLAYABLE_SOURCE:1,ERROR_FLASH_NOT_INSTALLED:2})}),e.define("module:Player.Html5VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","browser:Info","base:Promise","base:Objs","base:Timers.Timer","base:Strings","base:Async","browser:Dom","browser:Events"],function(e,m,f,p,g,v,a,b,y,t){return e.extend({scoped:t},function(e){return{_initialize:function(){if(this._options.nohtml5)return f.error(!0);if(this._sources.length<1)return f.error(!0);if(m.isInternetExplorer()&&m.internetExplorerVersion()<9)return f.error(!0);if(this._options.forceflash)return f.error(!0);var s=f.create();this._element.innerHTML="";var r=this.sources(),e=0===r[0].src.indexOf("blob:")&&r[0].src,t=m.isInternetExplorer()&&9==m.internetExplorerVersion()||m.isWindowsPhone();if("video"!==this._element.tagName.toLowerCase())this._element=b.changeTag(this._element,"video"),this._transitionals.element=this._element;else if(t){var i=v.splitLast(this._element.outerHTML,"</video>").head;p.iter(r,function(e){i+="<source"+(e.type?" type='"+e.type+"'":"")+" src='"+e.src+"' />"}),i+="</video>";var n=b.elementByTemplate(i);b.elementInsertAfter(n,this._element),this._element.parentNode.removeChild(this._element),this._element=n,this._transitionals.element=this._element}m.isSafari()&&m.safariVersion()<6&&(this._element.src=r[0].src,this._preload=!0);this._domEvents.on(this._element,"loadevent",function(){this._element.networkState!==this._element.NETWORK_NO_SOURCE?s.asyncSuccess(!0):s.asyncError(!0)},this);var a=10,o=new g({context:this,fire:function(){this._element.networkState===this._element.NETWORK_NO_SOURCE?--a<=0&&s.asyncError(!0):this._element.networkState===this._element.NETWORK_IDLE?s.asyncSuccess(!0):this._element.networkState===this._element.NETWORK_LOADING&&(m.isEdge()||m.isInternetExplorer()?s.asyncSuccess(!0):m.isFirefox()&&e&&s.asyncSuccess(!0))},delay:50});this._element.preload=this._preload?"auto":"none";var h=0;this._audioElement=null;var d=new y;if(e)this._element.src=e;else if(t)for(var c=this._element.getElementsByTagName("SOURCE"),l=function(){++h===r.length&&s.asyncError(!0)},u=0;u<c.length;++u)d.on(c[u],"error",l);else p.iter(r,function(e){var t=document.createElement("source");if(e.type&&(t.type=e.type),this._element.appendChild(t),d.on(t,"error",function(){++h===r.length&&s.asyncError(!0)}),t.src=e.src,e.audiosrc){this._audioElement||(this._audioElement=document.createElement("audio"),b.elementInsertAfter(this._audioElement,this._element));var i=document.createElement("source");e.type&&(i.type=e.type),this._audioElement.appendChild(i),i.src=e.audiosrc}},this);this.poster()&&(this._element.poster=this.posterURL()),s.callback(function(){d.weakDestroy(),o.destroy()},this),s.success(function(){this._setup()},this);try{m.isChrome()||this._element.load()}catch(_){}return s},posterURL:function(){var e=this.poster();return e&&"undefined"!=typeof Blob&&e instanceof Blob?(window.URL||window.webkitURL).createObjectURL(e):e},destroy:function(){this._audioElement&&this._audioElement.remove(),this.supportsFullscreen()&&this.__fullscreenListener&&b.elementOffFullscreenChange(this._element,this.__fullscreenListener),this.supportsPIP()&&this.__pipListener&&b.videoRemovePIPChangeListeners(this._element,this.__pipListener),(!m.isInternetExplorer()||8<m.internetExplorerVersion())&&(this._element.innerHTML=""),e.destroy.call(this)},_eventEnded:function(){this._loop&&this.play(),e._eventEnded.call(this)},_setup:function(){this._loaded=!1,this._domEvents.on(this._element,"canplay",this._eventLoaded,this),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this);for(var e=this,t=this._element.getElementsByTagName("SOURCE"),i=function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},s=0;s<t.length;++s)this._domEvents.on(t[s],"error",i,this);if(this.poster()){var r=new Image;r.onerror=function(){delete e._element.poster,delete e._element.preload,e._eventPosterError()},r.src=this.posterURL(),r.onload=function(){e.__imageWidth=r.width,e.__imageHeight=r.height}}if(m.isSafari()&&(5<m.safariVersion()||m.safariVersion()<9)&&this._element.networkState===this._element.NETWORK_LOADING&&a.eventually(function(){this.destroyed()||this._element.networkState!==this._element.NETWORK_LOADING||0!==this._element.buffered.length||this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this,1e4),this.supportsFullscreen()){this.__videoClassBackup="";var n=this._fullscreenedElement||this._element;this.__fullscreenListener=b.elementOnFullscreenChange(n,function(e,t){this.trigger("fullscreen-change",t),t?(this.__videoClassBackup=this._element.className,this._element.className=""):(this._element.className=this.__videoClassBackup,this.__videoClassBackup="")},this)}this.supportsPIP()&&"pictureInPictureElement"in document&&(this.__pipListener=b.videoAddPIPChangeListeners(this._element,function(e,t){this.trigger("pip-mode-change",e,t)},this))},buffered:function(){return this._element.buffered.end(0)},_fullscreenElement:function(e){return m.isChromiumBased()&&!m.isMobile()?e||this._element.parentNode:m.isFirefox()?e||this._element.parentElement:e||this._element},supportsFullscreen:function(e){return b.elementSupportsFullscreen(this._fullscreenElement(e))},enterFullscreen:function(e){b.elementEnterFullscreen(this._fullscreenElement(e))},exitFullscreen:function(){b.documentExitFullscreen()},isFullscreen:function(e){return b.elementIsFullscreen(this._fullscreenElement(e))},supportsPIP:function(){return b.browserSupportsPIP(this._element)},enterPIPMode:function(e){b.videoElementEnterPIPMode(this._element)},exitPIPMode:function(){b.videoElementExitPIPMode(this._element)},isInPIPMode:function(){return b.videoIsInPIPMode(this._element)},videoWidth:function(){return this._element.width||this.__imageWidth||NaN},videoHeight:function(){return this._element.height||this.__imageHeight||NaN},play:function(){e.play.call(this),this._audioElement&&(this._reloadonplay&&this._audioElement.load(),this._audioElement.play())},pause:function(){this._element.pause(),this._audioElement&&this._audioElement.pause()},setPosition:function(e){this._element.currentTime=e,this._audioElement&&(this._audioElement.currentTime=e)},setSpeed:function(e){e<.5&&4<e?console.warn("Maximum allowed speed range is from 0.5 to 4.0"):(this._element.playbackRate=e,this._audioElement&&(this._audioElement.playbackRate=e))},muted:function(){return(this._audioElement?this._audioElement:this._element).muted},setMuted:function(e){(this._audioElement?this._audioElement:this._element).muted=e},volume:function(){return(this._audioElement?this._audioElement:this._element).volume},setVolume:function(e){(this._audioElement?this._audioElement:this._element).volume=e}}})}),e.define("module:Player.FlashPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayer","browser:Info","base:Promise","browser:Dom"],function(e,t,i,s,r,n){return e.extend({scoped:n},function(e){return{_initialize:function(){if(this._options.noflash)return s.error(!0);if(this._sources.length<1)return s.error(!0);if(i.isMobile()||!i.flash().supported())return s.error(!0);if(!i.flash().installed()&&this._options.flashinstallrequired)return s.error(!0);if(!i.flash().installed())return this._eventError(this.cls.ERROR_NO_FLASH_INSTALLED),s.value(!0);s.create();"div"!==this._element.tagName.toLowerCase()&&(this._element=r.changeTag(this._element,"div"),this._transitionals.element=this._element);var e={poster:this.poster(),sources:this.sources()};return this._loop&&(e.loop=!0),this._flashPlayer=new t(this._element,e),this._flashPlayer.ready.success(function(){this._setup()},this)},destroy:function(){this._flashPlayer&&this._flashPlayer.weakDestroy(),this._element.innerHTML="",e.destroy.call(this)},_setup:function(){this._loaded=!0,this._eventLoaded(),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this),this._domEvents.on(this._element,"videoerror",function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this),this._domEvents.on(this._element,"postererror",this._eventPosterError,this)},position:function(){return this._element.get("currentTime")},buffered:function(){return this.position()},setPosition:function(e){this._element.set("currentTime",e)},setVolume:function(e){this._element.set("volume",e)},videoWidth:function(){return this._flashPlayer?this._flashPlayer.videoWidth():null},videoHeight:function(){return this._flashPlayer?this._flashPlayer.videoHeight():null}}})}),e.extend("module:Player.VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.Html5VideoPlayerWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:Player.VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayerWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:Flash.FlashRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(e,t,i,s,r,n,a,o,c,h,d,l,u,_,m,f){var p=e.extend({scoped:f},[_,m,function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._embedding=this.auto_destroy(new r(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1,hasEmbedding:this.readAttr("hasembedding")||!1,namespace:this.readAttr("embednamespace")||null},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=u.create(),this.__status="idle",this.__disableVideo=this.readAttr("disablevideo")||!1,this.__disableAudio=this.readAttr("disableaudio")||!1,this.__cameraWidth=this.readAttr("camerawidth")||640,this.__cameraHeight=this.readAttr("cameraheight")||480,this.__audioRate=this.readAttr("audiorate")||44,this.__audioQuality=this.readAttr("audioquality")||10,this.__videoRate=this.readAttr("videorate")||0,this.__videoQuality=this.readAttr("videoquality")||90,this.__streamType=this.readAttr("streamtype")||"mp4",this.__microphoneCodec=this.readAttr("microphonecodec")||"speex",this.__fps=this.readAttr("fps")||20,this.__defaultGain=55,this._flip=h.parseBool(this.readAttr("flip")||!1),this._embedding.ready(this.__initializeEmbedding,this)},averageFrameRate:function(){return this.__fps},__initializeEmbedding:function(){this.__hasMicrophoneActivity=!1,this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.cameraVideo=this._embedding.newObject("flash.media.Video",this.__cameraWidth,this.__cameraHeight),this._flashObjs.main.addChildVoid(this._flashObjs.video),this._flashObjs.Microphone=this._embedding.getClass("flash.media.Microphone"),this._flashObjs.Camera=this._embedding.getClass("flash.media.Camera"),this._flashObjs.microphone=h.is_empty(0<this._flashObjs.Microphone.get("names").length)?null:this._flashObjs.Microphone.getMicrophone(0),this.setMicrophoneProfile(),this._flashObjs.camera=this._flashObjs.Camera.getCamera(0),this._currentCamera=0,this._currentMicrophone=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.recomputeBB(),this.ready.asyncSuccess(this),this.auto_destroy(new d({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){try{return!(this._flashObjs.camera&&this._flashObjs.camera.get("muted")||this._flashObjs.microphone&&this._flashObjs.microphone.get("muted"))}catch(e){return!1}},isSecurityDialogOpen:function(){var e=this._embedding.newObject("flash.display.BitmapData",1,1),t=!1;try{e.draw(this._flashObjs.stage)}catch(i){t=!0}return e.dispose(),e.destroy(),t},openSecurityDialog:function(e){this.trigger("require_display"),e?this._flashObjs.Security.showSettings("privacy"):(this._flashObjs.video.attachCamera(null),this._flashObjs.video.attachCamera(this._flashObjs.camera))},grantAccess:function(e,t){var i=u.create(),s=new d({fire:function(){this.destroyed()?s.destroy():this.isSecurityDialogOpen()||(this.isAccessGranted()?(s.destroy(),i.asyncSuccess(!0)):t?(s.destroy(),i.asyncError(!0)):this.openSecurityDialog(e))},context:this,delay:10,start:!0});return i},bindMedia:function(e,t){return this.grantAccess(e,t).mapSuccess(function(){this._mediaBound=!0,this._attachCamera()},this)},unbindMedia:function(){this._detachCamera(),this._mediaBound=!1},_attachCamera:function(){this._flashObjs.camera&&(this._flashObjs.camera.setMode(this.__cameraWidth,this.__cameraHeight,this.__fps),this._flashObjs.camera.setQuality(this.__videoRate,this.__videoQuality),this._flashObjs.camera.setKeyFrameInterval(5),this._flashObjs.video.attachCamera(this._flashObjs.camera),this._flashObjs.cameraVideo.attachCamera(this._flashObjs.camera)),this.__disableVideo&&(this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)),this._flip&&(0<this._flashObjs.video.get("scaleX")&&this._flashObjs.video.set("scaleX",-this._flashObjs.video.get("scaleX")),this._flashObjs.video.set("x",this._flashObjs.video.get("width")))},_detachCamera:function(){this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)},enumerateDevices:function(){return{audios:this._flashObjs.Microphone.get("names"),videos:this._flashObjs.Camera.get("names")}},selectMicrophone:function(e){this._flashObjs.microphone&&this._flashObjs.microphone.weakDestroy(),this.__hasMicrophoneActivity=!1,this.__microphoneActivityTime=null,this._flashObjs.microphone=this._flashObjs.Microphone.getMicrophone(e),this._currentMicrophone=e,this.setMicrophoneProfile(this._currentMicrophoneProfile)},selectCamera:function(e){this._flashObjs.camera&&this._flashObjs.camera.weakDestroy(),this.__cameraActivityTime=null,this._flashObjs.camera=this._flashObjs.Camera.getCamera(e),this._currentCamera=e,this._mediaBound&&this._attachCamera()},currentCamera:function(){return this._currentCamera},currentMicrophone:function(){return this._currentMicrophone},microphoneInfo:function(){return this._flashObjs.microphone?{muted:this._flashObjs.microphone.get("muted"),name:this._flashObjs.microphone.get("name"),activityLevel:this._flashObjs.microphone.get("activityLevel"),gain:this._flashObjs.microphone.get("gain"),rate:this._flashObjs.microphone.get("rate"),encodeQuality:this._flashObjs.microphone.get("encodeQuality"),codec:this._flashObjs.microphone.get("codec"),hadActivity:this.__hadMicrophoneActivity,inactivityTime:this.__microphoneActivityTime?l.now()-this.__microphoneActivityTime:null}:{}},cameraInfo:function(){return this._flashObjs.camera?{muted:this._flashObjs.camera.get("muted"),name:this._flashObjs.camera.get("name"),activityLevel:this._flashObjs.camera.get("activityLevel"),fps:this._flashObjs.camera.get("fps"),width:this._flashObjs.camera.get("width"),height:this._flashObjs.camera.get("height"),inactivityTime:this.__cameraActivityTime?l.now()-this.__cameraActivityTime:null}:{}},setMicrophoneProfile:function(e){this._flashObjs.microphone&&(e=e||{},this._flashObjs.microphone.setLoopBack(e.loopback||!1),this._flashObjs.microphone.set("gain",e.gain||this.__defaultGain),this._flashObjs.microphone.setSilenceLevel(e.silenceLevel||0),this._flashObjs.microphone.setUseEchoSuppression(e.echoSuppression||!1),this._flashObjs.microphone.set("rate",e.rate||this.__audioRate),this._flashObjs.microphone.set("encodeQuality",e.encodeQuality||this.__audioQuality),this._flashObjs.microphone.set("codec",e.codec||this.__microphoneCodec),this._currentMicrophoneProfile=e)},getVolumeGain:function(){return(this._mediaBound?this._flashObjs.micropone.get("gain"):55)/55},setVolumeGain:function(e){this.__defaultGain=Math.min(Math.max(0,Math.round(55*e)),100),this._mediaBound&&this._flashObjs.microphone&&this._flashObjs.microphone.set("gain",this.__defaultGain)},_pixelSample:function(e,t,i){e=e||100;var s=this._flashObjs.cameraVideo.get("width"),r=this._flashObjs.cameraVideo.get("height"),n=Math.ceil(Math.sqrt(s/r*e)),a=Math.ceil(Math.sqrt(r/s*e)),o=this._embedding.newObject("flash.display.BitmapData",n,a),h=this._embedding.newObject("flash.geom.Matrix");h.scale(n/s,a/r),o.draw(this._flashObjs.cameraVideo,h);for(var d=0;d<e;++d){var c=d%n,l=Math.floor(d/n),u=o.getPixel(c,l);t.call(i||this,u%256,u/256%256,u/256/256%256)}h.destroy(),o.destroy()},testSoundLevel:function(e){this.setMicrophoneProfile(e?{loopback:!0,gain:55,silenceLevel:100,echoSuppression:!0}:{})},soundLevel:function(){return this._flashObjs.microphone?this._flashObjs.microphone.get("activityLevel"):0},_fire:function(){if(this._mediaBound&&(this.__hadMicrophoneActivity=this.__hadMicrophoneActivity||this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel"),this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel")&&(this.__microphoneActivityTime=l.now()),this._flashObjs.camera)){var e=this._flashObjs.camera.get("activityLevel");this.__lastCameraActivity&&this.__lastCameraActivity===e||(this.__cameraActivityTime=l.now()),this.__lastCameraActivity=e}},createSnapshot:function(){var e=this._embedding.newObject("flash.display.BitmapData",this._flashObjs.cameraVideo.get("videoWidth"),this._flashObjs.cameraVideo.get("videoHeight"));return e.draw(this._flashObjs.cameraVideo),e},postSnapshot:function(e,t,i,s){var r=u.create();s=s||90;var n=this._embedding.newObject("flash.net.URLRequestHeader","Content-type","application/octet-stream"),a=this._embedding.newObject("flash.net.URLRequest",t);if(a.set("requestHeaders",[n]),a.set("method","POST"),"jpg"===i){var o=this._embedding.newObject("com.adobe.images.JPGEncoder",s);a.set("data",o.encode(e)),o.destroy()}else{var h=this._embedding.getClass("com.adobe.images.PNGEncoder");a.set("data",h.encode(e))}var d=this._embedding.newObject("flash.net.URLLoader");return d.set("dataFormat","BINARY"),d.addEventListener("complete",this._embedding.newCallback(c.as_method(function(){r.asyncSuccess(!0)},this))),d.addEventListener("ioError",this._embedding.newCallback(c.as_method(function(){r.asyncError("IO Error")},this))),d.load(a),r.callback(function(){d.destroy(),a.destroy(),n.destroy()}),r},createSnapshotDisplay:function(e,t,i,s,r){var n=this._embedding.newObject("flash.display.Bitmap",e);return this.updateSnapshotDisplay(e,n,t,i,s,r),this._flashObjs.main.addChildVoid(n),n},updateSnapshotDisplay:function(e,t,i,s,r,n){t.set("x",i),t.set("y",s),t.set("scaleX",r/e.get("width")),t.set("scaleY",n/e.get("height"))},removeSnapshotDisplay:function(e){try{this._flashObjs.main.removeChildVoid(e)}catch(t){}e.destroy()},idealBB:function(){return{width:this.__cameraWidth,height:this.__cameraHeight}},setActualBB:function(i){["object","embed"].forEach(function(e){var t=this._element.getElementsByTagName(e.toUpperCase())[0];t&&["width","height"].forEach(function(e){t.style[e]=i[e]+"px"})},this);var e=this._flashObjs.video;e&&(e.set("width",i.width),e.set("height",i.height),this._flip&&(0<e.get("scaleX")&&e.set("scaleX",-e.get("scaleX")),e.set("x",e.get("width"))))},_error:function(e){this.__status="error",this.trigger("error",e)},_status:function(e){return e&&e!==this.__status&&(this.__status=e,this.trigger("status",e),this.trigger(e)),this.__status},__newCallback:function(i,e){var s=!0,r=null,n=function(){clearTimeout(r),s&&(s=!1,this.trigger("endpoint_connectivity",this.__endpoint,-1),0<e.length?(i=e.shift(),this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this.__newCallback(i,e)),this.__endpoint=i,this._flashObjs.connection.connectVoid(i.serverUrl)):this._error("Could not connect to server"))},t=this;return r=setTimeout(function(){n.call(t)},1e4),this._embedding.newCallback(c.as_method(function(e){if(s){var t=e.get("info").code;if("NetConnection.Connect.Closed"===t&&"recording"===this._status())return s=!1,void this._error("Connection to server interrupted.");"NetConnection.Connect.Success"===t&&"connecting"!==this._status()||"NetConnection.Connect.Closed"===t&&"connecting"===this._status()||"NetConnection.Connect.Failed"===t&&"connecting"===this._status()?n.call(this):"NetConnection.Connect.Closed"!==t||"uploading"!==this._status()?"NetConnection.Connect.Success"===t&&"connecting"===this._status()&&(this.trigger("endpoint_connectivity",this.__endpoint,1),clearTimeout(r),"mp4"===this.__streamType&&this._flashObjs.connection.callVoid("setStreamType",null,"live"),this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(c.as_method(function(e){var t=e.get("info").code;if("NetStream.Record.Start"!==t){if("NetStream.Play.StreamNotFound"===t)return this._flashObjs.stream.closeVoid(),void("none"!==this._status()&&this._error("Stream not found"));"NetStream.Buffer.Empty"===t&&"uploading"===this._status()&&"mp4"===this.__streamType&&this._flashObjs.stream.publish(null),("NetStream.Unpublish.Success"===t||"uploading"===this._status()&&"NetStream.Buffer.Empty"===t&&"flv"===this.__streamType&&0===this._flashObjs.stream.get("bufferLength"))&&(this._flashObjs.stream.closeVoid(),this._flashObjs.stream.destroy(),this._flashObjs.stream=null,this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=null,this._status("finished"))}else this._status("recording")},this))),this._flashObjs.stream.set("bufferTime",120),"mp4"===this.__streamType&&(this._flashObjs.h264Settings=this._embedding.newObject("flash.media.H264VideoStreamSettings"),this._flashObjs.h264Settings.setProfileLevel("baseline","3.1"),this._flashObjs.stream.set("videoStreamSettings",this._flashObjs.h264Settings)),this.__disableVideo||this._flashObjs.stream.attachCameraVoid(this._flashObjs.camera),this.__disableAudio||this._flashObjs.stream.attachAudioVoid(this._flashObjs.microphone),this._flashObjs.stream.publish(i.streamName,"record")):this._status("finished")}},this))},startRecord:function(e){1<arguments.length&&(e={serverUrl:e,streamName:arguments[1]}),h.is_array(e)||(e=[e]),this._status("connecting");var t=e.shift(),i=this.__newCallback(t,e);this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",i),this.__endpoint=t,this._flashObjs.connection.connectVoid(t.serverUrl)},stopRecord:function(){if("recording"===this._status()){this.__initialBufferLength=0,this._status("uploading"),this.__initialBufferLength=this._flashObjs.stream.get("bufferLength");try{this._flashObjs.stream.attachAudioVoid(null)}catch(e){}this._flashObjs.stream.attachCameraVoid(null)}},uploadStatus:function(){return{total:this.__initialBufferLength,remaining:this._flashObjs.stream.get("bufferLength")}}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new s,this.__flashRegistry.register("flash.media.Microphone",["setLoopBack","setSilenceLevel","setUseEchoSuppression"],["getMicrophone"]),this.__flashRegistry.register("flash.media.Camera",["setMode","setQuality","setKeyFrameInterval","addEventListener"],["getCamera"]),this.__flashRegistry.register("flash.media.Video",["attachCamera","attachNetStream"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.media.H264VideoStreamSettings",["setProfileLevel"]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek","attachCamera","attachAudio","publish","close"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener","call","close"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.net.URLRequestHeader",[]),this.__flashRegistry.register("flash.net.URLLoader",["addEventListener","load"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","removeChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"]),this.__flashRegistry.register("flash.display.BitmapData",["draw","getPixel","dispose"]),this.__flashRegistry.register("flash.display.Bitmap",[]),this.__flashRegistry.register("flash.geom.Matrix",["scale"]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"]),this.__flashRegistry.register("com.adobe.images.PNGEncoder",[],["encode"]),this.__flashRegistry.register("com.adobe.images.JPGEncoder",["encode"])),this.__flashRegistry},attach:function(e,t){new p(e,t);return e}});return p}),e.define("module:Flash.Support",["base:Promise","base:Timers.Timer","base:Async","base:Objs","flash:FlashClassRegistry","flash:FlashEmbedding","browser:Info"],function(a,o,h,r,d,c,l){return{flashCanConnect:function(t,e){if(!l.flash().installed())return a.error(!1);var i=a.create(),s=new d;s.register("flash.net.NetConnection",["connect","addEventListener"]);var r=new c(null,{registry:s,wrap:!0});r.ready(function(){var e=r.newObject("flash.net.NetConnection");e.addEventListener("netStatus",r.newCallback(function(e){e.get("info")&&"NetConnection.Connect.Success"===e.get("info").code?i.asyncSuccess(!0):i.asyncError(!1)})),e.connectVoid(t)});var n=null;return e&&(n=new o({delay:e,once:!0,start:!0,fire:function(){i.asyncError()}})),i.callback(function(){n&&n.destroy(),h.eventually(function(){r.destroy()})}),i},enumerateMediaSources:function(){if(!l.flash().installed())return a.error(!1);var i=a.create(),e=new d;e.register("flash.media.Microphone"),e.register("flash.media.Camera");var s=new c(null,{registry:e,wrap:!0});return s.ready(function(){var e=s.getClass("flash.media.Camera").get("names"),t=s.getClass("flash.media.Microphone").get("names");i.asyncSuccess({videoCount:r.count(e),audioCount:r.count(t),video:r.map(e,function(e,t){return{id:t,label:e}}),audio:r.map(t,function(e,t){return{id:t,label:e}})})}),i.callback(function(){h.eventually(function(){s.destroy()})}),i}}}),e.define("module:Recorder.Support",["module:WebRTC.Support","browser:Upload.FileUploader","browser:Upload.CustomUploader","browser:Dom","browser:Info","base:Promise","base:Objs"],function(d,n,a,h,m,i,o){return{createSnapshot:function(e,t,i,s,r,n,a,o){var h=this._createSnapshot(e,t,i,s,r,n,a,o);return h?d.dataURItoBlob(h):h},_createSnapshot:function(e,t,i,s,r,n,a,o){n=n||0,a=a||0,o=o||1,i=i||!1;var h=document.createElement("canvas");h.width=r||t.videoWidth||t.clientWidth,h.height=s||t.videoHeight||t.clientHeight;var d=1<+h.width/h.height?"landscape":"portrait",c=m.isSafari()||m.isMobile()&&m.isiOS(),l="portrait"===d&&i&&(m.isFirefox()||c),u=h.getContext("2d");l&&1!==this.__detectVerticalSquash(t,h.width,h.height)?this.__rotateToPortrait(t,h,u):u.drawImage(t,n,a,h.width,h.height);var _=h.toDataURL(e,o);return this.__isCanvasBlank(h)?null:_},__rotateToPortrait:function(e,t,i){var s=Math.abs(t.height-t.width),r=t.width>t.height?t.width:t.height;t.height=t.width=r,i.drawImage(e,0,0,t.height,t.width),i.clearRect(0,0,t.width,t.height),i.save(),t.width-=s,i.translate(t.width/2,t.height/2),i.rotate(Math.PI/180*90),m.isFirefox()?i.drawImage(e,-t.height/2,-t.width/2,t.height,t.width):i.drawImage(e,-t.height/2,-t.width/2,t.height,t.width+s),i.restore()},__isCanvasBlank:function(e){return!e.getContext("2d").getImageData(0,0,e.width,e.height).data.some(function(e){return 0!==e})},__detectVerticalSquash:function(e,t,i){t||e.naturalWidth||e.width;var s=i||e.naturalHeight||e.height,r=document.createElement("canvas");r.width=1,r.height=s;var n=r.getContext("2d");n.drawImage(e,0,0);for(var a=n.getImageData(0,0,1,s).data,o=0,h=s,d=s;o<d;){0===a[4*(d-1)+3]?h=d:o=d,d=h+o>>1}var c=d/s;return 0===c?1:c},removeSnapshot:function(e){},removeSnapshotDisplay:function(e){e.remove()},createSnapshotDisplay:function(e,t,i,s,r,n){var a=d.globals().URL.createObjectURL(t),o=document.createElement("img");return o.style.position="absolute",this.updateSnapshotDisplay(t,o,i,s,r,n),o.src=a,"video"===e.tagName.toLowerCase()?h.elementInsertAfter(o,e):h.elementPrependChild(e,o),o},snapshotMetaData:function(e){var r=i.create(),t=d.globals().URL.createObjectURL(e),n=new Image;return n.src=t,n.onload=function(e){var t=n.naturalHeight||n.height,i=n.naturalWidth||n.width,s=+(i/t).toFixed(2);r.asyncSuccess({width:i,height:t,orientation:1<s?"landscape":"portrait",ratio:s})},r},updateSnapshotDisplay:function(e,t,i,s,r,n){t.style.left=i+"px",t.style.top=s+"px",t.style.width=r+"px",t.style.height=n+"px"},createSnapshotUploader:function(e,t,i,s){if(e){var r=new a(o.extend({source:t,type:i,recorder:this._recorder},s));return r.on("upload",function(e){e.recorder.postSnapshot(e.source,e.url,e.type).success(r.successCallback,r).error(r.errorCallback,r)}),r}return n.create(o.extend({source:t},s))}}}),e.define("module:Recorder.PixelSampleMixin",[],function(){return{lightLevel:function(e){e=e||100;var s=0;return this._pixelSample(e,function(e,t,i){s+=e+t+i}),s/(3*e)},blankLevel:function(e){e=e||100;var s=0;return this._pixelSample(e,function(e,t,i){s+=Math.pow(e,2)+Math.pow(t,2)+Math.pow(i,2)}),Math.sqrt(s/(3*e))},_materializePixelSample:function(e){var s=[];return this._pixelSample(e,function(e,t,i){s.push([e,t,i])}),s},deltaCoefficient:function(e){e=e||100;var t=this._materializePixelSample(e);if(!this.__deltaSample)return this.__deltaSample=t,null;for(var i=0,s=0;s<t.length;++s)for(var r=0;r<3;++r)i+=Math.pow(t[s][r]-this.__deltaSample[s][r],2);return this.__deltaSample=t,Math.sqrt(i/(3*e))}}}),e.define("module:Recorder.VideoRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(e,t,i,s,r){return e.extend({scoped:r},[t,function(t){return{constructor:function(e){t.constructor.call(this,e),this._element=this._options.element,this.ready=s.create()},destroy:function(){t.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},softwareDependencies:function(){return this._softwareDependencies()},_softwareDependencies:function(){},cameraWidth:function(){return this._options.recordingWidth},cameraHeight:function(){return this._options.recordingHeight},lightLevel:function(){},soundLevel:function(){},testSoundLevel:function(e){},blankLevel:function(){},deltaCoefficient:function(){},getVolumeGain:function(){},setVolumeGain:function(e){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(e){},setCameraFace:function(e){},addMultiStream:function(e,t){},updateMultiStreamPosition:function(e,t,i,s){},reverseCameraScreens:function(){},createSnapshot:function(){},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){},updateSnapshotDisplay:function(e,t,i,s,r,n){},removeSnapshotDisplay:function(e){},createSnapshotUploader:function(e,t,i){},startRecord:function(e){},pauseRecord:function(){},resumeRecord:function(){},stopRecord:function(e){},errorHandler:function(e){},isFlash:function(){return!1},isWebrtcStreaming:function(){return!1},canPause:function(){return!1},supportsLocalPlayback:function(){return!1},supportsCameraFace:function(){return!1},snapshotToLocalPoster:function(e){return null},localPlaybackSource:function(){return null},averageFrameRate:function(){return null},recordDelay:function(e){return 0}}}],{_initializeOptions:function(e){return i.extend({forceflash:!1,noflash:!1,recordingWidth:640,recordingHeight:480,recordVideo:!0,recordAudio:!0},e)}})}),e.define("module:Recorder.WebRTCVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","module:WebRTC.AudioAnalyser","browser:Dom","browser:Info","base:Time","base:Objs","base:Timers.Timer","base:Comparators","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(e,i,h,s,d,r,n,o,a,c,l,u,_,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),"video"!==this._element.tagName.toLowerCase()&&(this._element=d.changeTag(this._element,"video")),this._recorder=i.create({video:this._element,flip:!!this._options.flip,flipscreen:!!this._options.flipscreen,framerate:this._options.framerate,recordVideo:this._options.recordVideo,recordFakeVideo:!this._options.recordVideo,recordAudio:this._options.recordAudio,recordResolution:{width:this._options.recordingWidth,height:this._options.recordingHeight},resizeMode:this._options.resizeMode,videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,webrtcStreaming:this._options.webrtcStreaming,webrtcStreamingIfNecessary:this._options.webrtcStreamingIfNecessary,localPlaybackRequested:this._options.localPlaybackRequested,screen:this._options.screen,getDisplayMediaSupported:"undefined"!=typeof navigator.mediaDevices.getDisplayMedia,fittodimensions:this._options.fittodimensions}),this._recorder.on("bound",function(){this._analyser&&this.testSoundLevel(!0)},this),this._recorder.on("error",function(e,t){this.trigger("error",e,t)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._analyser&&this._analyser.weakDestroy(),this._recorder.destroy(),t.destroy.call(this)},recordDelay:function(e){return this._recorder.recordDelay(e)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},lightLevel:function(){return this._recorder.lightLevel()},blankLevel:function(){return this._recorder.blankLevel()},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},isWebrtcStreaming:function(){return this._recorder.isWebrtcStreaming()},canPause:function(){return this._recorder.canPause()},soundLevel:function(){return!this._analyser&&this._recorder&&this._recorder.stream()&&s.supported()&&(this._analyser=new s(this._recorder.stream())),this._analyser?this._analyser.soundLevel():1.1},testSoundLevel:function(e){this._analyser&&(this._analyser.weakDestroy(),delete this._analyser),e&&s.supported()&&(this._analyser=new s(this._recorder.stream()))},currentDevices:function(){return{video:this._currentVideo,audio:this._currentAudio}},enumerateDevices:function(){return h.enumerateMediaSources().success(function(e){this._detectCurrentDeviceId(e.video,e.videoCount,!0),this._detectCurrentDeviceId(e.audio,e.audioCount,!1);var t=this.auto_destroy(new a({start:!0,delay:100,context:this,destroy_on_stop:!0,fire:function(){this._currentVideo&&this._currentAudio&&(this.trigger("currentdevicesdetected",{video:this._currentVideo,audio:this._currentAudio}),t.stop())}}))},this)},addMultiStream:function(e,t){return this._recorder.addNewSingleStream(e,t)},updateMultiStreamPosition:function(e,t,i,s){return this._recorder.updateMultiStreamPosition(e,t,i,s)},reverseCameraScreens:function(){return this._recorder.reverseVideos()},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video),e&&e.audio&&this._recorder.selectMicrophone(e.audio)},setCameraFace:function(e){r.isMobile()&&this._recorder.selectCameraFace(e)},createSnapshot:function(e){return this._recorder.createSnapshot(e)},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){var a=h.globals().URL.createObjectURL(t),o=document.createElement("img");return o.style.position="absolute",this.updateSnapshotDisplay(t,o,i,s,r,n),o.src=a,"video"===e.tagName.toLowerCase()?d.elementInsertAfter(o,e):d.elementPrependChild(e,o),o},updateSnapshotDisplay:function(e,t,i,s,r,n){t.style.left=i+"px",t.style.top=s+"px",t.style.width=r+"px",t.style.height=n+"px"},removeSnapshotDisplay:function(e){e.remove()},createSnapshotUploader:function(e,t,i){return l.create(o.extend({source:e},i))},startRecord:function(e){return this.__localPlaybackSource=null,this._recorder.startRecord(e)},pauseRecord:function(){return this._recorder.pauseRecord()},resumeRecord:function(){return this._recorder.resumeRecord()},stopRecord:function(r){var n=_.create();return this._recorder.once("data",function(e,t,i){this.__localPlaybackSource={src:e,audiosrc:t};var s=new u;this._options.simulate||i||(e&&s.addUploader(l.create(o.extend({source:e},r.video))),t&&s.addUploader(l.create(o.extend({source:t},r.audio)))),n.asyncSuccess(s)},this),this._recorder.stopRecord(),n},supportsLocalPlayback:function(){return!!this.__localPlaybackSource.src},supportsCameraFace:function(){return r.isMobile()},snapshotToLocalPoster:function(e){return e},localPlaybackSource:function(){return this.__localPlaybackSource},averageFrameRate:function(){return this._recorder.averageFrameRate()},_softwareDependencies:function(){if(!this._options.screen||this._options.screen&&"undefined"!=typeof navigator.mediaDevices.getDisplayMedia||h.globals().supportedConstraints.mediaSource)return _.value(!0);var e=h.chromeExtensionExtract(this._options.screen),t=[{title:"Screen Recorder Extension",execute:function(){window.open(e.extensionInstallLink)}}],i=n.now();return h.chromeExtensionMessage(e.extensionId,{type:"ping",data:i}).mapError(function(){return t}).mapSuccess(function(e){return!(!e||"success"!==e.type||e.data!==i)||_.error(t)})},_detectCurrentDeviceId:function(i,s,r){var n,e,a;return(e=r?(n=this._recorder._videoTrack,this._recorder._videoTrackSettings):(n=this._recorder._audioTrack,this._recorder._audioTrackSettings))&&n?e.deviceId&&i[e.deviceId]?(r?this._currentVideo=i[e.deviceId].id:this._currentAudio=i[e.deviceId].id,i[e.deviceId].id):n.label?(a=1,void o.iter(i,function(e,t){return 0===c.byValue(e.label,n.label)?(r?this._currentVideo=t:this._currentAudio=t,t):s<=a?(r?this._currentVideo=o.ithKey(i):this._currentAudio=o.ithKey(i),o.ithKey(i)):void a++},this)):(r?this._currentVideo=o.ithKey(i):this._currentAudio=o.ithKey(i),o.ithKey(i)):(r?this._currentVideo=o.ithKey(i):this._currentAudio=o.ithKey(i),o.ithKey(i))},errorHandler:function(e){return h.errorHandler(e)}}},{supported:function(e){return!e.forceflash&&(!!i.anySupport(e)&&(!e.screen||(!(!(r.isChrome()||r.isFirefox()||r.isOpera())||"undefined"==typeof navigator.mediaDevices.getDisplayMedia)||(!!(h.globals().supportedConstraints.mediaSource&&r.isFirefox()&&55<r.firefoxVersion())||(!(!r.isChrome()||!e.screen.chromeExtensionId)||!(!r.isOpera()||!e.screen.operaExtensionId))))))}})}),e.define("module:Recorder.FlashVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Flash.FlashRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(e,i,s,r,n,a,o,h,d,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),"div"!==this._element.tagName.toLowerCase()&&(this._element=s.changeTag(this._element,"div")),this._recorder=new i(this._element,{flip:!!this._options.flip,disableaudio:!this._options.recordAudio,disablevideo:!this._options.recordVideo,streamtype:this._options.rtmpStreamType,camerawidth:this._options.recordingWidth,cameraheight:this._options.recordingHeight,microphonecodec:this._options.rtmpMicrophoneCodec,fps:this._options.framerate,audioRate:this._options.audioBitrate?Math.floor(this._options.audioBitrate/1e3):undefined,videoRate:this._options.videoBitrate?1e3*this._options.videoBitrate:undefined}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this),this._recorder.on("endpoint_connectivity",function(e,t){this.trigger("endpoint_connectivity",e,t)},this)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},lightLevel:function(){return this._recorder.lightLevel()},soundLevel:function(){var e=this._recorder.soundLevel();return e<=1?1:1+(e-1)/100},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},testSoundLevel:function(e){this._recorder.testSoundLevel(e)},enumerateDevices:function(){var e=this._recorder.enumerateDevices();return n.value({videoCount:a.count(e.videos),audioCount:a.count(e.audios),video:a.map(e.videos,function(e,t){return{id:t,label:e}}),audio:a.map(e.audios,function(e,t){return{id:t,label:e}})})},currentDevices:function(){return{video:this._recorder.currentCamera(),audio:this._recorder.currentMicrophone()}},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video),e&&e.audio&&this._recorder.selectMicrophone(e.audio)},createSnapshot:function(e){return this._recorder.createSnapshot()},createSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.createSnapshotDisplay(t,i,s,r,n)},updateSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.updateSnapshotDisplay(e,t,i,s,r,n)},removeSnapshotDisplay:function(e){this._recorder.removeSnapshotDisplay(e)},createSnapshotUploader:function(e,t,i){var s=new h(a.extend({source:e,type:t,recorder:this._recorder},i));return s.on("upload",function(e){e.recorder.postSnapshot(e.source,e.url,e.type).success(s.successCallback,s).error(s.errorCallback,s)}),s},startRecord:function(e){if(this._options.simulate)return n.value(!0);var t=this,i={},s=n.create();return this._recorder.on("recording",function(){s.asyncSuccess(),t._recorder.off(null,null,i)},i).on("error",function(e){s.asyncError(e),t._recorder.off(null,null,i)},i),this._recorder.startRecord(e.rtmp),s},stopRecord:function(e){if(this._options.simulate)return n.value(new d);var t=this,i={},s=new h,r=null;return r=new o({delay:100,context:this,fire:function(){if(this._recorder&&!this._recorder.destroyed()){var e=this._recorder.uploadStatus();s.progressCallback(e.total-e.remaining,e.total)}else r.destroy()}}),this._recorder.on("finished",function(){s.successCallback(!0),t._recorder.off(null,null,i),r.weakDestroy()},i).on("error",function(e){s.errorCallback(e),t._recorder.off(null,null,i),r.weakDestroy()},i),this._recorder.stopRecord(),n.create(s)},isFlash:function(){return!0},averageFrameRate:function(){return this._recorder.averageFrameRate()},_softwareDependencies:function(){return r.flash().installed()?n.value(!0):n.error([{title:"Adobe Flash",execute:function(){window.open("https://get.adobe.com/flashplayer")}}])}}},{supported:function(e){return!r.isMobile()&&!e.noflash&&r.flash().supported()&&!e.screen}})}),e.extend("module:Recorder.WebRTCVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Recorder.WebRTCVideoRecorderWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:Recorder.VideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Recorder.FlashVideoRecorderWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:WebRTC.AudioAnalyser",["base:Class","browser:Info","module:WebRTC.Support"],function(e,r,i,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._audioContext=i.globals().audioContext,this._analyserNode=this._audioContext.createAnalyser.call(this._audioContext),this._analyserNode.fftSize=32,0<e.getAudioTracks().length&&(this._audioInput=this._audioContext.createMediaStreamSource(e),this._audioInput.connect(this._analyserNode))},destroy:function(){this._analyserNode.disconnect(),delete this._analyserNode,t.destroy.call(this)},soundLevel:function(){if(!this._audioInput)return 0;var e=this._analyserNode.fftSize,t=new Uint8Array(e);this._analyserNode.getByteTimeDomainData(t);for(var i=0,s=0;s<e;s++)i=Math.max(i,Math.abs(t[s]/128));return r.isMobile()&&r.isFirefox()?i+.1:i}}},{supported:function(){return!(!i.globals().AudioContext||!i.globals().audioContext||r.isSafari()||r.isiOS())}})}),e.define("module:WebRTC.AudioRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Promise","base:Functions","module:WebRTC.Support","module:Encoding.WaveEncoder.Support"],function(e,t,s,r,n,a,o,i){return e.extend({scoped:i},[t,function(i){return{constructor:function(e,t){i.constructor.call(this),this._channels=[],this._recordingLength=0,this._options=s.extend({audioChannels:2,bufferSize:16384,sampleRate:44100},t),this._stream=e,this._started=!1,this._stopped=!1,this._volumeGainValue=1},_audioProcess:function(e){this._started&&(this._channels.push(o.dumpInputBuffer(e.inputBuffer,this._options.audioChannels,this._actualBufferSize)),this._recordingLength+=this._actualBufferSize)},destroy:function(){this.stop(),i.destroy.call(this)},getVolumeGain:function(){return this._volumeGainValue},setVolumeGain:function(e){this._volumeGainValue=e,this._volumeGain&&(this._volumeGain.value.gain=e)},__initializeContext:function(){var e=a.globals().AudioContext;this._audioContext=new e,this._actualSampleRate=this._audioContext.sampleRate||this._options.sampleRate,this._volumeGain=this._audioContext.createGain(),this._volumeGain.gain.value=this._volumeGainValue,this._audioInput=this._audioContext.createMediaStreamSource(this._stream),this._audioInput.connect(this._volumeGain),this._scriptProcessor=a.globals().audioContextScriptProcessor.call(this._audioContext,this._options.bufferSize,this._options.audioChannels,this._options.audioChannels),this._actualBufferSize=this._scriptProcessor.bufferSize,this._scriptProcessor.onaudioprocess=n.as_method(this._audioProcess,this),this._volumeGain.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)},__finalizeContext:function(){this._scriptProcessor.disconnect(),this._volumeGain.disconnect(),this._audioInput.disconnect(),this._scriptProcessor.onaudioprocess=null,this._audioContext.close(),delete this._scriptProcessor,delete this._volumeGain,delete this._audioInput,delete this._audioContext},start:function(){return this._started||(this.__initializeContext(),this._startContextTime=this._audioContext.currentTime,this._started=!0,this._stopped=!1,this._recordingLength=0,this._channels=[],this.trigger("started")),r.value(!0)},stop:function(){this._started&&!this._stopped&&(this._stopContextTime=this._audioContext.currentTime,this._stopped=!0,this.trigger("stopped"),this.__finalizeContext(),this._started=!1,this._generateData())},_generateData:function(){var t=44,e=this._recordingLength*this._options.audioChannels*2+44,i=new ArrayBuffer(e),s=new DataView(i);o.generateHeader(e,this._options.audioChannels,this._actualSampleRate,i),this._channels.forEach(function(e){o.waveChannelTransform(e,1).value().forEach(function(e){s.setInt16(t,e,!0),t+=2})}),this._data=new Blob([s],{type:"audio/wav"}),this._recordingLength=0,this.trigger("data",this._data)}}}],{supported:function(){return!!a.globals().AudioContext}})}),e.define("module:WebRTC.MediaRecorder",["base:Class","base:Events.EventsMixin","base:Functions","base:Promise","browser:Info","module:WebRTC.Support","base:Async"],function(e,t,a,i,o,h,s,r){return e.extend({scoped:r},[t,function(n){return{constructor:function(e,t){t=t||{},n.constructor.call(this),this._stream=e,this._started=!1;var i=h.globals().MediaRecorder,s={mimeType:""};try{t.audioonly?i.isTypeSupported("audio/mp3")?s={mimeType:"audio/mp3"}:i.isTypeSupported("audio/ogg;codecs=opus")&&(s={mimeType:"audio/ogg;codecs=opus"}):i.isTypeSupported?i.isTypeSupported("video/webm;codecs=vp9")?s={mimeType:"video/webm;codecs=vp9"}:i.isTypeSupported("video/webm;codecs=vp8")&&o.isFirefox()&&o.firefoxVersion()<71?s={mimeType:"video/webm;codecs=vp8"+(o.isFirefox()&&71<=o.firefoxVersion()?",opus":"")}:i.isTypeSupported("video/webm")&&(s={mimeType:"video/webm"}):s={mimeType:"video/webm;codecs=vp9"}}catch(r){s={}}t.videoBitrate&&(s.videoBitsPerSecond=1e3*t.videoBitrate),t.audioBitrate&&(s.audioBitsPerSecond=1e3*t.audioBitrate),this.__audioonly=t.audioonly,this.__mediaRecorderOptions=s,this._mediaRecorder=new i(e,s),this._mediaRecorder.ondataavailable=a.as_method(this._dataAvailable,this),this._mediaRecorder.onstop=a.as_method(this._dataStop,this),this._mediaRecorder.onpause=a.as_method(this._hasPaused,this),this._mediaRecorder.onresume=a.as_method(this._hasResumed,this),this._mediaRecorder.onstart=a.as_method(this._recorderStarted,this),this._mediaRecorder.onerror=a.as_method(this.onErrorMethod,this)},_recorderStarted:function(e){this._started=!0,this.trigger("started"),this._startRecPromise.asyncSuccess()},onErrorMethod:function(e){this._startRecPromise.asyncError(e),this.trigger("error",e)},destroy:function(){this.stop(),n.destroy.call(this)},start:function(){return this._started?i.value(!0):(this._startRecPromise=i.create(),this._chunks=[],this._mediaRecorder.start(10),o.isSafari()&&(this._started=!0,this.trigger("started"),s.eventually(function(){"recording"===this._mediaRecorder.state?this._startRecPromise.asyncSuccess():this._startRecPromise.asyncError("Could not start recording")},this,1e3)),this._startRecPromise)},pause:function(){!this._paused&&this._started&&(this._paused=!0,this._mediaRecorder.pause(),this.trigger("pause"))},_hasPaused:function(){this.trigger("paused")},resume:function(){this._paused&&this._started&&(this._paused=!1,this._mediaRecorder.resume(),this.trigger("resume"))},_hasResumed:function(){this.trigger("resumed")},stop:function(){this._started&&(this._started=!1,this._mediaRecorder.stop(),this.trigger("stopped"))},_dataAvailable:function(e){e.data&&0<e.data.size&&this._chunks.push(e.data)},_dataStop:function(e){if(this._data=new Blob(this._chunks,{type:this.__mediaRecorderOptions.mimeType.split(";")[0]||(this.__audioonly?"audio/ogg":"video/webm")}),this._chunks=[],o.isFirefox()){var t=this,i=new FileReader;i.onload=function(){t._data=new Blob([this.result],{type:t._data.type}),t.trigger("data",t._data)},i.readAsArrayBuffer(this._data)}else this.trigger("data",this._data)}}}],{supported:function(){return!!h.globals().MediaRecorder&&((0===document.location.href.indexOf("https://")||"localhost"===document.location.hostname||!o.isOpera()&&!o.isChrome())&&(!(o.isOpera()&&o.operaVersion()<44)&&!(o.isChrome()&&o.chromeVersion()<57)))}})}),e.define("module:WebRTC.PeerRecorder",["base:Class","base:Events.EventsMixin","base:Functions","base:Objs","base:Promise","base:Async","browser:Info","module:WebRTC.Support"],function(e,t,r,o,n,a,h,d,i){return e.extend({scoped:i},[t,function(i){return{constructor:function(e,t){i.constructor.call(this),this._stream=e,!t.videoBitrate&&t.recorderWidth&&t.recorderHeight&&(t.videoBitrate=Math.round(t.recorderWidth*t.recorderHeight/250)),this._videoBitrate=t.videoBitrate||1024,this._audioBitrate=t.audioBitrate||256,this._videoFrameRate=t.framerate,this._audioonly=t.audioonly,this._started=!1},destroy:function(){this.stop(),i.destroy.call(this)},start:function(e){if(this._started)return n.value(!0);this._wssUrl=e.wssUrl,this._streamInfo=e.streamInfo,this._userData=e.userData||{},this._delay=e.delay||0,this._started=!0,this._wsConnection=new(d.globals().WebSocket)(this._wssUrl),this._wsConnection.binaryType="arraybuffer",this._wsConnection.onopen=r.as_method(this._wsOnOpen,this),this._wsConnection.onmessage=r.as_method(this._wsOnMessage,this),this._wsConnection.onclose=r.as_method(this._wsOnClose,this),this._wsConnection.onerror=this._errorCallback("WS_CONNECTION");var t=n.create(),i={},s=this;return this.on("started",function(){s.off(null,null,i),t.asyncSuccess(!0)},i).on("error",function(e){s.off(null,null,i),t.asyncError(e)},i),t},stop:function(){this._started&&(this._started=!1,this._peerConnection&&this._peerConnection.close(),this._peerConnection=null,this._wsConnection&&this._wsConnection.close(),this._wsConnection=null,this.trigger("stopped"))},_wsOnOpen:function(){this._peerConnection=new(d.globals().RTCPeerConnection)({iceServers:[]}),this._stream.getTracks&&this._peerConnection.addTrack?o.iter(this._stream.getTracks(),function(e){this._peerConnection.addTrack(e,this._stream)},this):this._peerConnection.addStream(this._stream);var e=this._peerConnection.createOffer();e.then(r.as_method(this._offerGotDescription,this)),e["catch"](this._errorCallback("PEER_CREATE_OFFER"))},_wsOnMessage:function(e){var t=JSON.parse(e.data),i=parseInt(t.status,10);t.command;if(200!==i)this._error("MESSAGE_ERROR",{status:i,description:t.statusDescription});else{if(t.sdp!==undefined){var s=this._peerConnection.setRemoteDescription(new(d.globals().RTCSessionDescription)(t.sdp));s.then(function(){}),s["catch"](this._errorCallback("PEER_REMOTE_DESCRIPTION"))}t.iceCandidates&&o.iter(t.iceCandidates,function(e){this._peerConnection.addIceCandidate(new(d.globals().RTCIceCandidate)(e))},this),a.eventually(function(){this.trigger("started")},this,this._delay)}this._wsConnection&&this._wsConnection.close(),this._wsConnection=null},_offerGotDescription:function(e){var t={};return this._audioBitrate&&(t.audioBitrate=Number(this._audioBitrate)),this._videoBitrate&&!this._audioonly&&(t.videoBitrate=Number(this._videoBitrate)),this._videoFrameRate&&!this._audioonly&&(t.videoFrameRate=Number(this._videoFrameRate)),e.sdp=this._enhanceSDP(e.sdp,t),this._peerConnection.setLocalDescription(e).then(r.as_method(function(){this._wsConnection.send(JSON.stringify({direction:"publish",command:"sendOffer",streamInfo:this._streamInfo,sdp:e,userData:this._userData}))},this))["catch"](this._errorCallback("Peer Local Description"))},_enhanceSDP:function(e,s){var t=e.split(/\r\n/),r="header",n=!1,a="";return o.iter(t,function(e){if(!(e.length<=0||(a+=e+"\r\n",0===e.indexOf("m=audio")?n=!(r="audio"):0===e.indexOf("m=video")?n=!(r="video"):0===e.indexOf("a=rtpmap")&&(n=!(r="bandwidth")),0===e.indexOf("i=")||0===e.indexOf("c=")||n))){if(0==="audio".localeCompare(r))s.audioBitrate!==undefined&&(a+="b=AS:"+s.audioBitrate+"\r\n",a+="b=TIAS:"+1024*s.audioBitrate+"\r\n");else if(0==="video".localeCompare(r))s.videoBitrate!==undefined&&(a+="b=AS:"+s.videoBitrate+"\r\n",a+="b=CT:"+s.videoBitrate+"\r\n",s.videoFrameRate!==undefined&&(a+="a=framerate:"+s.videoFrameRate+"\r\n"));else if(0==="bandwidth".localeCompare(r)&&h.isChrome()){var t;if(null!==(t=this._getRTPMapID(e))){var i=t[2].toLowerCase();0!=="vp9".localeCompare(i)&&0!=="vp8".localeCompare(i)&&0!=="h264".localeCompare(i)&&0!=="red".localeCompare(i)&&0!=="ulpfec".localeCompare(i)&&0!=="rtx".localeCompare(i)||s.videoBitrate!==undefined&&(a+="a=fmtp:"+t[1]+" x-google-min-bitrate="+s.videoBitrate+";x-google-max-bitrate="+s.videoBitrate+"\r\n"),0!=="opus".localeCompare(i)&&0!=="isac".localeCompare(i)&&0!=="g722".localeCompare(i)&&0!=="pcmu".localeCompare(i)&&0!=="pcma".localeCompare(i)&&0!=="cn".localeCompare(i)||s.audioBitrate!==undefined&&(a+="a=fmtp:"+t[1]+" x-google-min-bitrate="+s.audioBitrate+";x-google-max-bitrate="+s.audioBitrate+"\r\n")}}n=!0}},this),a},_getRTPMapID:function(e){var t=new RegExp("a=rtpmap:(\\d+) (\\w+)/(\\d+)"),i=e.match(t);return i&&3<=i.length?i:null},_wsOnClose:function(){},_error:function(e,t){this.trigger("error",e+" "+t.toString(),t),this.stop()},_errorCallback:function(t){return r.as_method(function(e){this._error(t,e)},this)}}}],{supported:function(){if(h.isEdge())return!1;if(h.isSafari()&&h.safariVersion()<11)return!1;if(0!==document.location.href.indexOf("https://")&&"localhost"!==document.location.hostname){if(h.isChrome()&&47<=h.chromeVersion())return!1;if(h.isOpera()&&34<=h.operaVersion())return!1}return d.globals().RTCPeerConnection&&d.globals().RTCIceCandidate&&d.globals().RTCSessionDescription&&d.globals().WebSocket}})}),e.define("module:WebRTC.RecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Async","base:Promise","base:Time","module:WebRTC.Support","module:Recorder.Support","module:Recorder.PixelSampleMixin"],function(e,t,l,c,i,s,u,r,n,a){return e.extend({scoped:a},[t,n,function(t){return{constructor:function(e){t.constructor.call(this,e),this._video=e.video,this._localPlaybackRequested=e.localPlaybackRequested,this._recording=!1,this._bound=!1,this._hasAudio=!1,this._hasVideo=!1,this._screen=e.screen,this._resizeMode=e.resizeMode,this._flip=!!e.flip,this._screen&&!e.flipscreen&&(this._flip=!1),this._videoTrackSettings={slippedFromOrigin:{height:1,width:1}},this._options.fittodimensions&&(null===this._screen?(this._initCanvasStreamSettings(),this._prepareRecorderStreamCanvas(!0)):this._options.fittodimensions=!1)},_getConstraints:function(){return{audio:!!this._options.recordAudio&&{sourceId:this._options.audioId},video:!!this._options.recordVideo&&{frameRate:this._options.framerate,sourceId:this._options.videoId,width:this._options.recordResolution.width,height:this._options.recordResolution.height,cameraFaceFront:this._options.cameraFaceFront,resizeMode:this._resizeMode},screen:this._screen}},addNewSingleStream:function(e,t){var i,s,r,n,a,o,h;this._initCanvasStreamSettings();var d=!0;return o=this._options.video.aspectRatio,s=t.positionX||0,r=t.positionY||0,a=t.width||.2*this._options.recordResolution.width||120,(n=t.height)||(n=o?Math.floor(a*o):Math.floor(a/1.33),d=!1),h={video:i={frameRate:this._options.framerate,sourceId:e.id,cameraFaceFront:this._options.cameraFaceFront}},this._prepareRecorderStreamCanvas(),this._multiStreamConstraints=h,this.__addedStreamOptions=l.tree_merge(i,{positionX:s,positionY:r,width:a,height:n,isTrueHeight:d}),this.addNewMediaStream()},updateMultiStreamPosition:function(e,t,i,s){this.__addedStreamOptions.positionX=e||this.__addedStreamOptions.positionX,this.__addedStreamOptions.positionY=t||this.__addedStreamOptions.positionY,this.__addedStreamOptions.width=i||this.__addedStreamOptions.width,this.__addedStreamOptions.height=s||this.__addedStreamOptions.height},addNewMediaStream:function(){var t=i.create();return this._canvasStreams.length<1&&this._canvasStreams.push(this._stream),u.userMedia2(this._multiStreamConstraints,this).success(function(e){this._canvasStreams.push(e),this._buildVideoElementsArray(t),this.on("stream-canvas-drawn",function(){return t.asyncSuccess()},this)},this)},recordDelay:function(e){return 0},stream:function(){return this._stream},isWebrtcStreaming:function(){return!1},canPause:function(){return!1},bindMedia:function(){if(!this._bound)return u.userMedia2(this._getConstraints()).success(function(e){this._hasAudio=this._options.recordAudio&&0<e.getAudioTracks().length,this._hasVideo=this._options.recordVideo&&0<e.getVideoTracks().length;var t=null,i=null,s=null,r=e.getVideoTracks()[0]||{};if(this._hasVideo&&"function"==typeof r.getSettings&&(t=r.getSettings()),this._hasVideo&&"function"==typeof r.getCapabilities&&t&&(s=r.getCapabilities(),i=this._getConstraints().video,s.width.max&&s.height.max&&this.__checkAndApplyCorrectConstraints(r,s,i,e)),t&&i&&this._options.fittodimensions){var n=i.width/i.height,a=t.width/t.height;Math.abs(n-a)<=.1&&(this._options.fittodimensions=!1)}this._options.fittodimensions&&t?(this._canvasStreams.push(e),this.__initialVideoTrackSettings||this.__calculateVideoTrackSettings(t,this._video,!0),this._videoTrackSettings.capabilities=s,this._videoTrackSettings.constrainsts=this._getConstraints().video,this._buildVideoElementsArray()):(this._bound=!0,this._stream=e,this._setLocalTrackSettings(e),u.bindStreamToVideo(e,this._video,this._flip),this.trigger("bound",e),this._boundMedia())},this)},selectCamera:function(e){this._options.videoId=e,this._bound&&(this.unbindMedia(),this.bindMedia())},selectMicrophone:function(e){this._options.audioId=e,this._bound&&(this.unbindMedia(),this.bindMedia())},selectCameraFace:function(e){this._options.cameraFaceFront=e,this._bound&&(this.unbindMedia(),this.bindMedia())},startRecord:function(e){if(this._recording)return i.value(!0);this._recording=!0;var t=this._startRecord(e);return t.success(function(){this._pausedDuration=0,this._startTime=s.now()},this),t},pauseRecord:function(){this.canPause()&&!this._paused&&(this._paused=!0,this._recorder.once("paused",function(){this.trigger("paused"),this.__pauseStartTime=s.now()},this),this._recorder.pause())},resumeRecord:function(){this.canPause()&&this._paused&&(this._paused=!1,this._recorder.once("resumed",function(){this.trigger("resumed"),this._pausedDuration+=s.now()-this.__pauseStartTime,delete this.__pauseStartTime},this),this._recorder.resume())},stopRecord:function(){this._recording&&(this._recording=!1,this._stopRecord(),this._stopTime=s.now())},duration:function(){return(this._recording||!this._stopTime?s.now():this._stopTime)-this._startTime-this._pausedDuration-(this.__pauseStartTime!==undefined?s.now()-this.__pauseStartTime:0)},unbindMedia:function(){this._bound&&!this._recording&&(u.stopUserMediaStream(this._stream,this._sourceTracks),this._bound=!1,this.trigger("unbound"),this._unboundMedia())},createSnapshot:function(e){return r.createSnapshot(e,this._video)},_pixelSample:function(e,t,i){e=e||100;var s=this._video.videoWidth||this._video.clientWidth,r=this._video.videoHeight||this._video.clientHeight,n=Math.ceil(Math.sqrt(s/r*e)),a=Math.ceil(Math.sqrt(r/s*e)),o=document.createElement("canvas");o.width=n,o.height=a;var h=o.getContext("2d");h.drawImage(this._video,0,0,n,a);for(var d=0;d<e;++d){var c=d%n,l=Math.floor(d/n),u=h.getImageData(c,l,1,1).data;t.call(i||this,u[0],u[1],u[2])}},_initCanvasStreamSettings:function(){this._canvasStreams=[],this._videoElements=[],this._audioInputs=[],this._sourceTracks=[],this._multiStreamConstraints={},this._drawingStream=!1},_prepareRecorderStreamCanvas:function(e){if(!this.__recorderStreamCanvas||!this.__recorderStreamCtx){var t=this._videoTrackSettings.height||this._video.clientHeight||this._video.videoHeight,i=this._videoTrackSettings.width||this._video.clientWidth||this._video.videoWidth;"undefined"==typeof this.__recorderStreamCanvas&&(this.__recorderStreamCanvas=document.createElement("canvas")),this.__recorderStreamCanvas.setAttribute("width",i),this.__recorderStreamCanvas.setAttribute("height",t),this.__recorderStreamCanvas.setAttribute("style","position:fixed; left: 200%; pointer-events: none"),this.__recorderStreamCtx=this.__recorderStreamCanvas.getContext("2d"),this._drawerSetting={fittodimensions:e||!1,streamsReversed:!1,isMultiStream:!1}}},_setLocalTrackSettings:function(e){if(void 0!==e.getVideoTracks()&&e.getVideoTracks()[0]){var t=this;if(this._videoTrack=e.getVideoTracks()[0],this._options.getDisplayMediaSupported){if("undefined"!=typeof this._videoTrack.getSettings){var i=this._videoTrack.getSettings();"undefined"==typeof this._videoTrackSettings.videoInnerFrame&&(this._videoTrackSettings=l.extend(i,this._videoTrackSettings)),this._video.onloadedmetadata=function(e){t.__calculateVideoTrackSettings(i,e.target,!0)}}}else"undefined"==typeof this._resizeMode&&(this._resizeMode="none"),this._videoTrack.applyConstraints({resizeMode:this._resizeMode}).then(function(){"undefined"!=typeof t._videoTrack.getSettings&&(t._videoTrackSettings=l.extend(i,t._videoTrackSettings))})}"undefined"!=typeof e.getAudioTracks&&e.getAudioTracks()[0]&&(this._audioTrack=e.getAudioTracks()[0],void 0!==this._audioTrack.getSettings()&&(this._audioTrackSettings=this._audioTrack.getSettings()))},__checkAndApplyCorrectConstraints:function(e,t,i){var s=t.width.max,r=t.height.max;if(i.width>s||i.height>r){var n,a,o,h,d=s/r,c=i.width/i.height;if(t.aspectRatio.min&&t.aspectRatio.max)c=i.width/i.height,o=t.aspectRatio.min,h=t.aspectRatio.max,1<c&&h<c?c=h:c<1&&c<o&&(c=o);else c=d;return i.width>s&&i.height>r?(n=1<c?s:r*c,r<(a=1<c?s/c:r)&&1<c&&(n=(a=r)/c),s<n&&c<1&&(a=(n=s)/c)):i.width>s?(a=1<c?s/c:Math.min(r,i.height),n=1<c?s:a*c):i.height>r&&(n=1<c?Math.min(s,i.width):r*c,a=1<c?n/c:r),{width:n,height:a}}},__calculateVideoTrackSettings:function(e,t,i){var s,r,n,a,o;t=t||this._video;var h=e.aspectRatio||e.width/e.height;if(!isNaN(h)){var d=t.offsetWidth,c=t.offsetHeight;return s=d<=c*h?d:Math.round(c*h),r=c*h<d?c:Math.round(d/h),n=e.width>s?e.width/s:s/e.width,a=e.height>r?e.height/r:r/e.height,o=l.extend(e,{videoElement:{width:d,height:c},videoInnerFrame:{width:s,height:r},slippedFromOrigin:{width:n,height:a}}),i&&(this.__initialVideoTrackSettings=o),this._videoTrackSettings=o}},_buildVideoElementsArray:function(r){this.__multiStreamVideoSettings={isMainStream:!0,mainStream:{},smallStream:{}},l.iter(this._canvasStreams,function(t,e){var i=t.getTracks(),s=!1;l.iter(i,function(e){this._sourceTracks.push(e),"video"===e.kind&&(this._videoTrack&&(s=e.id!==this._videoTrack.id,this._drawerSetting.isMultiStream=!0),this._videoElements.push(this._arraySingleVideoElement(this.__addedStreamOptions,t,s,e))),"audio"===e.kind&&this._audioInputs.push(e)},this),this._videoElements.length+this._audioInputs.length===i.length&&this._startDrawRecorderToCanvas(t),c.eventually(function(){if(!this._drawingStream)return!!r&&r.asyncError({message:"Could not be able to get required tracks"})},this,1e3)},this)},_startDrawRecorderToCanvas:function(e){try{var t=e.getVideoTracks()[0].getSettings();if(t.aspectRatio&&.1<Math.abs(t.aspectRatio-this._videoTrackSettings.aspectRatio)&&(this._videoTrackSettings.aspectRatio=t.aspectRatio,this.__calculateVideoTrackSettings(t,null,!0),this.__recorderStreamCanvas.setAttribute("width",t.width),this.__recorderStreamCanvas.setAttribute("height",t.height)),this._drawingStream=!0,this._drawerSetting.fittodimensions&&"undefined"!=typeof this._videoTrackSettings.videoInnerFrame){var i={},s=this._videoTrackSettings.width,r=this._videoTrackSettings.height,n=(this.__recorderStreamCanvas.width=s)/(this.__recorderStreamCanvas.height=r),a=this._videoTrackSettings.videoInnerFrame,o=this._videoTrackSettings.videoElement,h=this._videoTrackSettings.constrainsts,d=h.width/h.height,c=a.width===o.width;.1<=Math.abs(n-d)&&(!0,c?(i.ch=Math.round(s/d),i.ch>r&&(c=!1)):(i.cw=1<n?Math.round(r*d):Math.round(r/d),i.cw>s&&(c=!0)),c?(i.cw=s,i.ch=Math.round(s/d),i.cx=0,i.cy=(r-i.ch)/2,i.w=i.cw,i.h=i.ch,i.x=0,i.y=(r-i.h)/2):(i.ch=r,i.cw=1<n?Math.round(r*d):Math.round(r/d),i.cy=0,i.cx=(s-i.cw)/2,i.w=i.cw,i.h=i.ch,i.y=0,i.x=(s-i.w)/2)),this.__cropSettings=i}this._drawTracksToCanvas(),this._startCanvasStreaming()}catch(l){console.warn(l)}},_drawTracksToCanvas:function(){if(this._drawingStream){var e=this._videoElements.length,t=!1;"undefined"!=typeof this._drawerSetting&&this._drawerSetting.streamsReversed&&(t=!0);for(var i=0;i<this._videoElements.length;i++){var s,r,n,a,o,h;if(s=this._videoElements[i],this._drawerSetting.fittodimensions){var d=this.__cropSettings;n=d.w,a=d.h,o=d.x,h=d.y,this.__recorderStreamCtx.drawImage(s,d.cx,d.cy,d.cw,d.ch,o,h,n,a)}else o=(r=0!==i?this.__addedStreamOptions:{}).positionX||0,h=r.positionY||0,s.__multistreamElement?(n=t?this._drawerSetting.smallStreamWidth:r.width||360,a=t?this._drawerSetting.smallStreamHeight:r.height||240):t?(o=this._drawerSetting.positionX,h=this._drawerSetting.positionY,n=this._drawerSetting.width,a=this._drawerSetting.height,this.__multiStreamVideoSettings.mainStream&&0<l.keys(this.__multiStreamVideoSettings.mainStream).length&&(this.__recorderStreamCtx.fillStyle="#000000",this.__recorderStreamCtx.fillRect(0,0,this.__recorderStreamCanvas.width,this.__recorderStreamCanvas.height),this.__recorderStreamCtx.restore())):(n=this.__recorderStreamCanvas.width||r.width||360,a=this.__recorderStreamCanvas.height||r.height||240),this.__recorderStreamCtx.drawImage(s,o,h,n,a);0===--e&&c.eventually(this._drawTracksToCanvas,this,20)}}},reverseVideos:function(){var e=this.__multiStreamVideoSettings.isMainStream;this.__multiStreamVideoSettings.isMainStream=!e;var t,i,s,r,n=this.__multiStreamVideoSettings.mainStream.settings,a=this.__multiStreamVideoSettings.smallStream.settings,o=0,h=0;if(e){var d=a.aspectRatio,c=this._videoTrackSettings.aspectRatio||this._videoTrackSettings.width/this._videoTrackSettings.height;this._videoTrackSettings.videoElement.width===this._videoTrackSettings.videoInnerFrame.width?(t=(i=n.streamHeight)*d,r=(s=a.videoWidth)/c):(i=(t=n.streamWidth)/d,s=(r=a.videoHeight)*c),o=(n.streamWidth-t)/2,h=(n.streamHeight-i)/2,this._drawerSetting={streamsReversed:!0,width:t,height:i,positionX:o,positionY:h,smallStreamHeight:r,smallStreamWidth:s}}else this._drawerSetting.streamsReversed=!1,s=a.videoWidth,r=a.videoHeight;if(this._drawingStream)for(var l=document.createElement("video"),u=0;u<this._videoElements.length;u++)if(l.srcObject){if(l.srcObject){this._videoElements[u].srcObject=l.srcObject,this._videoElements[u].load(),this._videoElements[u].oncanplay=function(){this.play()};var _={width:s,height:r};e?this.__calculateVideoTrackSettings(_):this._videoTrackSettings=this.__initialVideoTrackSettings,this.trigger("multistream-camera-switched",_,e),l.remove()}}else l.srcObject=this._videoElements[u].srcObject,this._videoElements[u].srcObject=this._videoElements[u+1].srcObject,this._videoElements[u].load(),this._videoElements[u].oncanplay=function(){this.play()}},_startCanvasStreaming:function(){var e=this.__recorderStreamCanvas.captureStream(25);this._audioInputs[0]&&e.addTrack(this._audioInputs[0]),this._stream=e,u.bindStreamToVideo(e,this._video,this._flip),this.trigger("bound",e),this.trigger("stream-canvas-drawn"),this._setLocalTrackSettings(e),this._boundMedia(e)},_arraySingleVideoElement:function(e,t,n,a){var o=this,i=u.bindStreamToVideo(t);if(n=n||!1)i.__multistreamElement=!0,i.width=this.__addedStreamOptions.width||e.width||360,i.height=this.__addedStreamOptions.height||e.height||240;else{var h=o._videoTrackSettings.videoInnerFrame;o._videoTrackSettings.aspectRatio}var d=o._videoTrackSettings.slippedFromOrigin;return i.muted=!0,i.volume=0,i.oncanplay=function(){var e=a.getSettings(),t=this.width,i=this.height,s=n?e.aspectRatio||e.width/e.height:s;"undefined"!=typeof o.__addedStreamOptions&&!o.__addedStreamOptions._isTrueHeight&&n&&s&&(i=1<s?(t/s).toFixed(2):(t*s).toFixed(2),o.__addedStreamOptions.height=i,o.updateMultiStreamPosition());var r={track:a,isMainScreen:n,settings:{videoWidth:n?t:o._videoTrackSettings.videoElement.width,videoHeight:n?i:o._videoTrackSettings.videoElement.height,streamWidth:n?e.width:o._videoTrackSettings.width,streamHeight:n?e.height:o._videoTrackSettings.height,visibleWidth:n?t/d.width:h.width,visibleHeight:n?i/d.height:h.height,deviceId:e.deviceId,aspectRatio:s}};n?o.__multiStreamVideoSettings.smallStream=r:o.__multiStreamVideoSettings.mainStream=r,this.play()},i},_boundMedia:function(){},_unboundMedia:function(){},_startRecord:function(e){},_stopRecord:function(){},_error:function(e,t){this.trigger("error",e,t)},getVolumeGain:function(){},setVolumeGain:function(e){},_dataAvailable:function(e,t,i){this.destroyed()||this.trigger("data",e,t,i)},destroy:function(){this.stopRecord(),this.unbindMedia(),t.destroy.call(this)},averageFrameRate:function(){return null}}}],{_initializeOptions:function(e){return l.extend({recordAudio:!0,recordVideo:!0,recordResolution:{width:320,height:200}},e)},supported:function(e){return!!u.globals().getUserMedia&&!!u.globals().URL}})}),e.define("module:WebRTC.PeerRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.PeerRecorder","module:WebRTC.MediaRecorder","browser:Info","base:Async"],function(e,i,t,s,r,n){return e.extend({scoped:n},{_boundMedia:function(){this._recorder=new i(this._stream,{recorderWidth:this._options.recordResolution.width,recorderHeight:this._options.recordResolution.height,videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,framerate:this._options.framerate,audioonly:!this._options.recordVideo}),this._localPlaybackRequested&&t.supported()&&(this.__localMediaRecorder=new t(this._stream)),this._recorder.on("error",this._error,this)},_unboundMedia:function(){this._recorder.destroy(),this.__localMediaRecorder&&this.__localMediaRecorder.weakDestroy()},_startRecord:function(e){return this.__localMediaRecorder&&this.__localMediaRecorder.start(),this._recorder.start(e.webrtcStreaming)},isWebrtcStreaming:function(){return!0},_stopRecord:function(){this._recorder.stop();var t=null;this.__localMediaRecorder&&(this.__localMediaRecorder.once("data",function(e){t=e}),this.__localMediaRecorder.stop()),r.eventually(function(){this._dataAvailable(t,null,!0)},this,this.__stopDelay||this._options.webrtcStreaming.stopDelay||0)},recordDelay:function(e){return this.__stopDelay=e.webrtcStreaming.stopDelay,e.webrtcStreaming.delay||0},getVolumeGain:function(){},setVolumeGain:function(e){},averageFrameRate:function(){return null}},function(t){return{supported:function(e){return!!t.supported.call(this,e)&&((!e.screen||!s.isFirefox())&&(e.webrtcStreaming&&i.supported()&&!e.webrtcStreamingIfNecessary))}}})}),e.define("module:WebRTC.PeerRecorderWrapperIfNecessary",["module:WebRTC.PeerRecorderWrapper","base:Objs"],function(e,i,t){return e.extend({scoped:t},{},function(t){return{supported:function(e){return e.webrtcStreamingIfNecessary&&((e=i.clone(e,1)).webrtcStreamingIfNecessary=!1,e.webrtcStreaming=!0),t.supported.call(this,e)}}})}),e.define("module:WebRTC.MediaRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.MediaRecorder"],function(e,i,t){return e.extend({scoped:t},{_boundMedia:function(e){e=e||this._stream,this._recorder=new i(e,{videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,audioonly:!this._options.recordVideo}),this._recorder.on("data",function(e){this._dataAvailable(e)},this)},_unboundMedia:function(){this._recorder.destroy(),this._drawingStream&&this._initCanvasStreamSettings()},_startRecord:function(){return this._recorder.start()},_stopRecord:function(){this._recorder.stop()},canPause:function(){return!0},getVolumeGain:function(){},setVolumeGain:function(e){},averageFrameRate:function(){return null}},function(t){return{supported:function(e){return!!t.supported.call(this,e)&&(!e.recordFakeVideo&&i.supported())}}})}),e.define("module:WebRTC.WhammyAudioRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.AudioRecorder","module:WebRTC.WhammyRecorder","browser:Info","base:Promise"],function(e,i,s,r,t,n){return e.extend({scoped:n},{_createSnapshot:function(e){return this._whammyRecorder.createSnapshot(e)},_boundMedia:function(){this._videoBlob=null,this._audioBlob=null,this._hasVideo?this._whammyRecorder=new s(this._stream,{video:this._video,framerate:this._options.framerate}):this._whammyRecorder=new s(null,{framerate:this._options.framerate}),this._hasAudio&&(this._audioRecorder=new i(this._stream),this._audioRecorder.on("data",function(e){this._audioBlob=e,!this._videoBlob&&this._hasVideo||this._dataAvailable(this._videoBlob,this._audioBlob)},this)),this._whammyRecorder.on("data",function(e){this._videoBlob=e,!this._audioBlob&&this._hasAudio||this._dataAvailable(this._videoBlob,this._audioBlob)},this)},_unboundMedia:function(){this._hasAudio&&this._audioRecorder.destroy(),this._whammyRecorder.destroy()},_startRecord:function(){var e=[];return e.push(this._whammyRecorder.start()),this._hasAudio&&e.push(this._audioRecorder.start()),t.and(e)},_stopRecord:function(){this._whammyRecorder.stop(),this._hasAudio&&this._audioRecorder.stop()},getVolumeGain:function(){return this._audioRecorder?this._audioRecorder.getVolumeGain():1},setVolumeGain:function(e){this._audioRecorder&&this._audioRecorder.setVolumeGain(e)},averageFrameRate:function(){return this._whammyRecorder.averageFrameRate()}},function(t){return{supported:function(e){if(!t.supported.call(this,e))return!1;if(0!==document.location.href.indexOf("https://")&&"localhost"!==document.location.hostname){if(r.isChrome()&&47<=r.chromeVersion())return!1;if(r.isOpera()&&34<=r.operaVersion())return!1}return i.supported()&&s.supported(!e.recordVideo)}}})}),e.extend("module:WebRTC.RecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.PeerRecorderWrapper","module:WebRTC.MediaRecorderWrapper","module:WebRTC.WhammyAudioRecorderWrapper","module:WebRTC.PeerRecorderWrapperIfNecessary"],function(e,t,i,s,r){return e.register(t,4),e.register(i,3),e.register(s,2),e.register(r,1),{}}),e.define("module:WebRTC.Support",["base:Promise","base:Objs","browser:Info","browser:Dom","base:Time"],function(u,_,m,h,f){return{canvasSupportsImageFormat:function(e){try{var t=document.createElement("canvas").toDataURL(e);t.indexOf(";");return-1!=t.substring(0,t.indexOf(";")).indexOf(e)}catch(i){return!1}},getGlobals:function(){var e=null,t=null;t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(e=navigator.mediaDevices.getUserMedia,navigator.mediaDevices):(e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator);var i=window.URL||window.webkitURL,s=window.MediaRecorder,r=window.AudioContext||window.webkitAudioContext;r&&h.userInteraction(function(){this.__globals&&(this.__globals.audioContext=new r)},this);var n=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,a=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,o=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;return{getUserMedia:e,getUserMediaCtx:t,URL:i,MediaRecorder:s,AudioContext:r,audioContextScriptProcessor:function(){return(this.createScriptProcessor||this.createJavaScriptNode).apply(this,arguments)},webpSupport:this.canvasSupportsImageFormat("image/webp"),RTCPeerConnection:n,RTCIceCandidate:a,RTCSessionDescription:o,WebSocket:window.WebSocket,supportedConstraints:navigator.mediaDevices&&navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{}}},globals:function(){return this.__globals||(this.__globals=this.getGlobals()),this.__globals},userMediaSupported:function(){return!!this.globals().getUserMedia},enumerateMediaSources:function(){var t=u.create(),e=function(e){var i={audio:{},audioCount:0,video:{},videoCount:0};_.iter(e,function(e){var t;0===e.kind.indexOf("video")&&(i.videoCount++,"undefined"!=typeof e.getCapabilities&&(t=e.getCapabilities()),i.video[e.id||e.deviceId]={id:e.id||e.deviceId,label:e.label,capabilities:t}),0===e.kind.indexOf("audio")&&(i.audioCount++,"undefined"!=typeof e.getCapabilities&&(t=e.getCapabilities()),i.audio[e.id||e.deviceId]={id:e.id||e.deviceId,label:e.label,capabilities:t})}),t.asyncSuccess(i)};try{navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(e):MediaStreamTrack&&MediaStreamTrack.getSources?MediaStreamTrack.getSources(e):t.asyncError("Unsupported")}catch(i){t.asyncError(i)}return t},streamQueryResolution:function(e){var t=u.create(),i=this.bindStreamToVideo(e);return i.addEventListener("playing",function(){setTimeout(function(){t.asyncSuccess({stream:e,width:i.videoWidth,height:i.videoHeight}),i.remove()},500)}),t},chromeExtensionMessage:function(e,t){var i=u.create();return chrome.runtime.sendMessage(e,t,i.asyncSuccessFunc()),i},chromeExtensionExtract:function(e){var t={};return m.isChrome()?(t.extensionId=e.chromeExtensionId,t.extensionInstallLink=e.chromeExtensionInstallLink):m.isOpera()&&(t.extensionId=e.operaExtensionId,t.extensionInstallLink=e.operaExtensionInstallLink),t},userMedia:function(e){var t=u.create(),i=this.globals().getUserMedia.call(this.globals().getUserMediaCtx,e,function(e){t.asyncSuccess(e)},function(e){t.asyncError(e)});try{i.then&&i.then(function(e){t.asyncSuccess(e)}),i["catch"]&&i["catch"](function(e){t.asyncError(e)})}catch(s){}return t},userMedia2:function(t){var i,s={};if(t.audio&&(s.audio=t.audio),t.screen&&!t.video&&(t.video={}),!t.video)return this.userMedia(s);if(t.screen&&(t.video.width=t.video.width||window.innerWidth||document.body.clientWidth,t.video.height=t.video.height||window.innerHeight||document.body.clientHeight),m.isiOS())return s.video={},t.video.width&&(s.video.width=t.video.width),t.video.height&&(s.video.height=t.video.height),t.video.frameRate&&(s.video.frameRate=t.video.frameRate),t.video.cameraFaceFront!==undefined&&(s.video.facingMode={exact:t.video.cameraFaceFront?"user":"environment"}),this.userMedia(s);if(t.screen&&"undefined"!=typeof navigator.mediaDevices.getDisplayMedia){i=u.create();var e=this,r="boolean"!=typeof t.audio||t.audio;"undefined"==typeof t.video.resizeMode&&(t.video.resizeMode="none");var n={cursor:"motion",resizeMode:t.video.resizeMode,displaySurface:"application"};0<parseInt(t.video.width,10)&&(n.width=parseInt(t.video.width,10)),0<parseInt(t.video.height,10)&&(n.height=parseInt(t.video.height,10));var a=navigator.mediaDevices.getDisplayMedia({video:n,audio:r});return a.then(function(t){t.getAudioTracks().length<1&&r?e.userMedia({video:!1,audio:!0}).mapError(function(e){i.asyncSuccess(t)}).mapSuccess(function(e){i.asyncSuccess(new MediaStream([t.getTracks()[0],e.getAudioTracks()[0]]))}):i.asyncSuccess(t)}),a["catch"](function(e){i.asyncError(e)}),i}if(m.isFirefox())return s.video={},!t.screen||(s.video.mediaSource="screen",navigator.mediaDevices&&navigator.mediaDevices.getSupportedConstraints&&navigator.mediaDevices.getSupportedConstraints().mediaSource)?(!t.video.aspectRatio||t.video.width&&t.video.height||(t.video.width?t.video.height=Math.round(t.video.width/t.video.aspectRatio):t.video.height&&(t.video.width=Math.round(t.video.height*t.video.aspectRatio))),t.video.width&&(s.video.width={ideal:t.video.width}),t.video.height&&(s.video.height={ideal:t.video.height}),t.video.frameRate&&(s.video.frameRate={ideal:t.video.frameRate}),t.video.sourceId&&(s.video.sourceId=t.video.sourceId),t.video.cameraFaceFront!==undefined&&m.isMobile()&&(s.video.facingMode={exact:t.video.cameraFaceFront?"user":"environment"}),this.userMedia(s)):u.error("This browser does not support screen recording.");if(m.isEdge()&&t.screen){if(navigator.getDisplayMedia){i=u.create();var o=navigator.getDisplayMedia({video:!0});return o.then(i.asyncSuccessFunc()),o["catch"](i.asyncErrorFunc()),i}return u.error("This browser does not support screen recording.")}s.video={mandatory:{}},t.video.width&&(s.video.mandatory.minWidth=t.video.width,s.video.mandatory.maxWidth=t.video.width),!t.video.width&&t.video.height&&(s.video.mandatory.minHeight=t.video.height,s.video.mandatory.maxHeight=t.video.height);var h=t.video.aspectRatio?t.video.aspectRatio:t.video.width&&t.video.height?t.video.width/t.video.height:null;h&&(s.video.mandatory.minAspectRatio=h,s.video.mandatory.maxAspectRatio=h),t.video.sourceId&&(s.video.mandatory.sourceId=t.video.sourceId),t.video.cameraFaceFront!==undefined&&m.isMobile()&&(s.video.mandatory.facingMode={exact:t.video.cameraFaceFront?"user":"environment"}),t.video.frameRate&&(s.video.mandatory.minFrameRate=t.video.frameRate,s.video.mandatory.maxFrameRate=t.video.frameRate);var d=function(o){var h=s.video.mandatory;return this.userMedia(s).mapError(function(e){if(o--,"ConstraintNotSatisfiedError"!==e.name&&"OverconstrainedError"!==e.name)return e;var a=(e.constraintName||e.constraint).toLowerCase();return _.iter(h,function(e,t){var i=t.toLowerCase();if(0<=i.indexOf(a)){var s=0<i.indexOf("aspect"),r=0===i.indexOf("min")?-1:1,n=Math.max(0,h[t]*(1+r/10));h[t]=s?n:Math.round(n),o<0&&(delete h[t],o=100)}},this),d.call(this,o)},this)};if(t.screen){var c=this.chromeExtensionExtract(t.screen).extensionId;if(!c)return u.error("This browser does not support screen recording.");var l=f.now();return this.chromeExtensionMessage(c,{type:"ping",data:l}).mapSuccess(function(e){return i=u.create(),e&&"success"===e.type&&e.data===l?(i.asyncSuccess(!0),i.mapSuccess(function(){return this.chromeExtensionMessage(c,{type:"acquire",sources:["window","screen","tab"],url:window.self!==window.top?window.location.href:null}).mapSuccess(function(e){return e&&"success"===e.type?(s.video.mandatory.chromeMediaSource="desktop",s.video.mandatory.chromeMediaSourceId=e.streamId,delete s.audio,d.call(this,100).mapSuccess(function(i){return t.audio?this.userMedia({audio:!0}).mapError(function(){return u.value(i)}).mapSuccess(function(e){try{return new MediaStream([i.getVideoTracks()[0],e.getAudioTracks()[0]])}catch(t){return i}}):i},this)):u.error("Could not acquire permission to access screen.")},this)},this)):u.error("This browser does not support screen recording.")},this)}return d.call(this,100)},stopUserMediaStream:function(e,t){var i=!1;try{e.getTracks&&e.getTracks().forEach(function(e){e.stop(),i=!0}),0<t.length&&_.iter(t,function(e){e.stop(),i=!0},this)}catch(s){}try{!i&&e.stop&&e.stop()}catch(s){}},bindStreamToVideo:function(e,t,i){return t||(t=document.createElement("video")),t.volume=0,t.muted=!0,"mozSrcObject"in t?t.mozSrcObject=e:"srcObject"in t?t.srcObject=e:t.src=this.globals().URL.createObjectURL(e),i?(t.style["-moz-transform"]="scale(-1, 1)",t.style["-webkit-transform"]="scale(-1, 1)",t.style["-o-transform"]="scale(-1, 1)",t.style.transform="scale(-1, 1)",t.style.filter="FlipH"):(delete t.style["-moz-transform"],delete t.style["-webkit-transform"],delete t.style["-o-transform"],delete t.style.transform,delete t.style.filter),t.autoplay=!0,t.play(),t},dataURItoBlob:function(e){if(""!==e){for(var t=atob(e.split(",")[1]),i=e.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(t.length),r=new Uint8Array(s),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);var a=new DataView(s);return new Blob([a],{type:i})}},errorHandler:function(e){switch(e){case"NotReadableError":case"TrackStartError":return{key:"device-already-in-use",message:"Web camera or microphone are already in use",userLevel:!0};case"NotFoundError":case"DevicesNotFoundError":return{key:"missing-track",message:"Required audio or video track is missing",userLevel:!0};case"OverconstrainedError":case"ConstraintNotSatisfiedError":return{key:"constrains-error",message:"Constraints can not be satisfied by available devices",userLevel:!1};case"NotAllowedError":case"PermissionDeniedError":return{key:"browser-permission-denied",message:"Permission denied by browser, please grant access to proceed",userLevel:!0};case"TypeError":return{key:"empty-constraints",message:"Empty constraints object",userLevel:!1};default:return{key:"unknown-error",message:"Unknown Error",userLevel:!1}}}}}),e.define("module:WebRTC.WhammyRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Time","base:Functions","base:Promise","base:Async","module:WebRTC.Support","module:Encoding.WebmEncoder.Support"],function(e,t,s,r,i,n,a,o,d,h){return e.extend({scoped:h},[t,function(i){return{constructor:function(e,t){i.constructor.call(this),this._stream=e,this._options=s.extend({recordWidth:320,recordHeight:240,quality:undefined,video:null,framerate:null},t),this._started=!1},destroy:function(){this._started=!1,this.trigger("stopped"),i.destroy.call(this)},start:function(){return this._started||(this._started=!0,this._options.video&&(this._options.recordWidth=this._options.video.videoWidth||this._options.video.clientWidth,this._options.recordHeight=this._options.video.videoHeight||this._options.video.clientHeight),this._video=document.createElement("video"),this._video.width=this._options.recordWidth||80,this._video.height=this._options.recordHeight||60,this._stream&&o.bindStreamToVideo(this._stream,this._video),this._canvas=document.createElement("canvas"),this._canvas.width=this._options.recordWidth||80,this._canvas.height=this._options.recordHeight||60,this._context=this._canvas.getContext("2d"),this._frames=[],this._lastTime=r.now(),this._startTime=this._lastTime,this.trigger("started"),a.eventually(this._process,[],this)),n.value(!0)},stop:function(){this._started&&(this._started=!1,this.trigger("stopped"),this._generateData())},_process:function(){if(this._started){var e=r.now(),t=e-this._lastTime;this._lastTime=e,this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._frames.push({duration:t,image:this._stream?this._canvas.toDataURL("image/webp",this._options.quality):"data:image/webp;base64,UklGRjwAAABXRUJQVlA4IDAAAADQAwCdASpQADwAPpFIoUylpCMiIagAsBIJaQAADHThw4cOHDhwrAAA/vhNAAAAAAA="});var i=this._options.framerate?1e3/this._options.framerate:10;a.eventually(this._process,[],this,Math.max(1,i-(r.now()-e)))}},averageFrameRate:function(){return 0<this._frames.length?this._frames.length/(r.now()-this._startTime)*1e3:null},_generateData:function(){this._frames.length&&(this._data=this.__compile(this._stream?this.__dropBlackFrames(this._canvas,this._frames):this._frames),this.trigger("data",this._data))},__compile:function(e){var i=0,s=null,r=null,n=[],a=0,o=null,h=null;e.forEach(function(e){o||(o=[],h=0);var t=d.parseWebP(d.parseRIFF(atob(e.image.slice(23))));o.push(d.serializeEBML(d.makeTimecodeDataBlock(t.data,h))),h+=e.duration,i+=e.duration,s=s||t.width,r=r||t.height,3e4<=h&&(n.push(d.serializeEBML(d.makeCluster(o,a))),a=i,o=null,h=0)},this),o&&n.push(d.serializeEBML(d.makeCluster(o,a)));var t=d.generateEBMLHeader(i,s,r);return t[1].data=t[1].data.concat(n),d.serializeEBML(t)},__dropBlackFrames:function(e,t,i,s){for(var r=0;r<t.length&&d.isBlankFrame(e,t[r],i,s);)r++;return t.slice(r)},createSnapshot:function(e){return this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._canvas.toDataURL(e)}}}],{supported:function(e){return e||o.globals().webpSupport}})})}).call(Scoped);