/*!
betajs-media - v0.0.134 - 2019-09-03
Copyright (c) Ziggeo,Oliver Friedmann,Rashad Aliyev
Apache-2.0 Software License.
*/

(function(){var e=this.subScope();e.binding("module","global:BetaJS.Media"),e.binding("base","global:BetaJS"),e.binding("browser","global:BetaJS.Browser"),e.binding("flash","global:BetaJS.Flash"),e.define("module:",function(){return{guid:"8475efdb-dd7e-402e-9f50-36c76945a692",version:"0.0.134",datetime:1567555289274}}),e.assumeVersion("base:version","~1.0.136"),e.assumeVersion("browser:version","~1.0.61"),e.assumeVersion("flash:version","~0.0.18"),e.define("module:AudioPlayer.AudioPlayerWrapper",["base:Classes.OptimisticConditionalInstance","base:Events.EventsMixin","base:Types","base:Objs","base:Strings","browser:Events"],function(e,t,n,o,a,h,i){return e.extend({scoped:i},[t,function(r){return{constructor:function(e,t){r.constructor.call(this);var i=(e=o.extend(o.clone(e||{},1),t)).source||e.sources||[];n.is_string(i)?i=i.split(" "):n.is_array(i)||(i=[i]);var s=[];o.iter(i,function(e){if(n.is_string(e)?e={src:e.trim()}:"undefined"!=typeof Blob&&e instanceof Blob&&(e={src:e}),e.ext&&!e.type&&(e.type="audio/"+e.ext),!e.ext&&e.type&&(e.ext=a.last_after(e.type,"/")),!e.ext&&!e.type&&n.is_string(e.src)){var t=a.splitFirst(e.src,"?").head;0<=t.indexOf(".")&&(e.ext=a.last_after(t,"."),e.type="audio/"+e.ext)}e.ext&&(e.ext=e.ext.toLowerCase()),e.type&&(e.type=e.type.toLowerCase()),"undefined"!=typeof Blob&&e.src instanceof Blob&&(e.src=(window.URL||window.webkitURL).createObjectURL(e.src)),s.push(e)},this),this._sources=s,this._element=e.element,this._preload=e.preload||!1,this._reloadonplay=e.reloadonplay||!1,this._options=e,this._loop=e.loop||!1,this._loaded=!1,this._error=0,this._domEvents=new h},destroy:function(){this._domEvents.destroy(),r.destroy.call(this)},sources:function(){return this._sources},loaded:function(){return this._loaded},buffered:function(){},_eventLoaded:function(){this._loaded=!0,this.trigger("loaded")},_eventPlaying:function(){this._loaded||this._eventLoaded(),this.trigger("playing")},_eventPaused:function(){this.trigger("paused")},_eventEnded:function(){this._loop&&!this._options.forceflash&&this.play(),this.trigger("ended")},_eventError:function(e){this._error=e,this.trigger("error",e)},duration:function(){return this._element.duration},position:function(){return this._element.currentTime},error:function(){return this._error},play:function(){this._reloadonplay&&this._element.load(),this._reloadonplay=!1,this._element.play()},pause:function(){this._element.pause()},setPosition:function(e){this._element.currentTime=e},muted:function(){return this._element.muted},setMuted:function(e){this._element.muted=e},volume:function(){return this._element.volume},setVolume:function(e){this._element.volume=e}}}],{ERROR_NO_PLAYABLE_SOURCE:1,ERROR_FLASH_NOT_INSTALLED:2})}),e.define("module:AudioPlayer.Html5AudioPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","browser:Info","base:Promise","base:Objs","base:Timers.Timer","base:Strings","base:Async","browser:Dom","browser:Events"],function(e,_,f,m,p,g,s,b,v,t){return e.extend({scoped:t},function(e){return{_initialize:function(){if(this._options.nohtml5)return f.error(!0);if(this._sources.length<1)return f.error(!0);if(_.isInternetExplorer()&&_.internetExplorerVersion()<9)return f.error(!0);if(this._options.forceflash)return f.error(!0);var i=f.create();this._element.innerHTML="";var s=this.sources(),e=_.isInternetExplorer()&&9==_.internetExplorerVersion()||_.isWindowsPhone();if("audio"!==this._element.tagName.toLowerCase())this._element=b.changeTag(this._element,"audio"),this._transitionals.element=this._element;else if(e){var t=g.splitLast(this._element.outerHTML,"</audio>").head;m.iter(s,function(e){t+="<source"+(e.type?" type='"+e.type+"'":"")+" src='"+e.src+"' />"}),t+="</audio>";var r=b.elementByTemplate(t);b.elementInsertAfter(r,this._element),this._element.parentNode.removeChild(this._element),this._element=r,this._transitionals.element=this._element}_.isSafari()&&_.safariVersion()<6&&(this._element.src=s[0].src,this._preload=!0);this._domEvents.on(this._element,"loadevent",function(){this._element.networkState!==this._element.NETWORK_NO_SOURCE?i.asyncSuccess(!0):i.asyncError(!0)},this);var n=10,o=new p({context:this,fire:function(){this._element.networkState===this._element.NETWORK_NO_SOURCE?--n<=0&&i.asyncError(!0):this._element.networkState===this._element.NETWORK_IDLE?i.asyncSuccess(!0):this._element.networkState===this._element.NETWORK_LOADING&&(_.isEdge()||_.isInternetExplorer()?i.asyncSuccess(!0):_.isFirefox()&&0===s[0].src.indexOf("blob:")&&i.asyncSuccess(!0))},delay:50});this._element.preload=this._preload?"auto":"none";var a=0,h=new v;if(e)for(var d=this._element.getElementsByTagName("SOURCE"),c=function(){++a===s.length&&i.asyncError(!0)},l=0;l<d.length;++l)h.on(d[l],"error",c);else m.iter(s,function(e){var t=document.createElement("source");e.type&&(t.type=e.type),this._element.appendChild(t),h.on(t,"error",function(){++a===s.length&&i.asyncError(!0)}),t.src=e.src},this);i.callback(function(){h.weakDestroy(),o.destroy()},this),i.success(function(){this._setup()},this);try{_.isChrome()||this._element.load()}catch(u){}return i},destroy:function(){(!_.isInternetExplorer()||8<_.internetExplorerVersion())&&(this._element.innerHTML=""),e.destroy.call(this)},_setup:function(){this._loaded=!1,this._domEvents.on(this._element,"canplay",this._eventLoaded,this),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this);for(var e=this._element.getElementsByTagName("SOURCE"),t=function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},i=0;i<e.length;++i)this._domEvents.on(e[i],"error",t,this);_.isSafari()&&(5<_.safariVersion()||_.safariVersion()<9)&&this._element.networkState===this._element.NETWORK_LOADING&&s.eventually(function(){this.destroyed()||this._element.networkState!==this._element.NETWORK_LOADING||0!==this._element.buffered.length||this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this,1e4)},buffered:function(){return this._element.buffered.end(0)},play:function(){e.play.call(this)},pause:function(){this._element.pause()},setPosition:function(e){this._element.currentTime=e},muted:function(){return this._element.muted},setMuted:function(e){this._element.muted=e},volume:function(){return this._element.volume},setVolume:function(e){this._element.volume=e}}})}),e.define("module:AudioPlayer.FlashPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","module:AudioPlayer.FlashPlayer","browser:Info","base:Promise","browser:Dom"],function(e,t,i,s,r,n){return e.extend({scoped:n},function(e){return{_initialize:function(){if(this._options.noflash)return s.error(!0);if(this._sources.length<1)return s.error(!0);if(i.isMobile()||!i.flash().supported())return s.error(!0);if(!i.flash().installed()&&this._options.flashinstallrequired)return s.error(!0);if(!i.flash().installed())return this._eventError(this.cls.ERROR_NO_FLASH_INSTALLED),s.value(!0);s.create();"div"!==this._element.tagName.toLowerCase()&&(this._element=r.changeTag(this._element,"div"),this._transitionals.element=this._element);var e={sources:this.sources()};return this._loop&&(e.loop=!0),this._flashPlayer=new t(this._element,e),this._flashPlayer.ready.success(function(){this._setup()},this)},destroy:function(){this._flashPlayer&&this._flashPlayer.weakDestroy(),this._element.innerHTML="",e.destroy.call(this)},_setup:function(){this._loaded=!0,this._eventLoaded(),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this),this._domEvents.on(this._element,"audioerror",function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this)},position:function(){return this._element.get("currentTime")},buffered:function(){return this.position()},setPosition:function(e){this._element.set("currentTime",e)},setVolume:function(e){this._element.set("volume",e)}}})}),e.extend("module:AudioPlayer.AudioPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","module:AudioPlayer.Html5AudioPlayerWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:AudioPlayer.AudioPlayerWrapper",["module:AudioPlayer.AudioPlayerWrapper","module:AudioPlayer.FlashPlayerWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:AudioPlayer.FlashPlayer",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Promise"],function(e,n,l,t,s,u,o,_,r,f,a,i){var h=e.extend({scoped:i},function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._source=this.__preferedSource(),this._embedding=this.auto_destroy(new s(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1})),this._flashObjs={},this._flashData={status:"idle"},this.ready=a.create(),this._embedding.ready(this.__initializeEmbedding,this)},__preferedSource:function(){var e=[".mp3",".ogg",".aac"],t=[];if(this.readAttr("src")||this.readAttr("source")||this.readAttr("sources")){var i=this.readAttr("src")||this.readAttr("source")||this.readAttr("sources");f.is_array(i)?t=i:t.push(i)}var s=this._element;if(l.isInternetExplorer()&&l.internetExplorerVersion()<9)for(var r=this._element;;){var n=r.nextSibling;if(!n||!n.tagName||"source"!=n.tagName.toLowerCase())break;t.push(n.src.toLowerCase()),r=n}else for(var o=0;o<this._element.childNodes.length;++o)s.childNodes[o].tagName&&"source"==s.childNodes[o].tagName.toLowerCase()&&s.childNodes[o].src&&t.push(s.childNodes[o].src.toLowerCase());for(var a=(t=_.map(t,function(e){return e.src||e}))[0],h=e.length-1,d=t.length-1;0<=d;--d)for(var c=0;c<=h;++c)if(u.ends_with(t[d],e[c])){a=t[d],h=c;break}return-1==a.indexOf("://")&&(a=document.location.href+"/../"+a),{sourceUrl:a}},__initializeEmbedding:function(){this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.soundTransform=this._embedding.newObject("flash.media.SoundTransform"),this._flashObjs.sound=this._embedding.newObject("flash.media.Sound"),this._flashObjs.urlRequest=this._embedding.newObject("flash.net.URLRequest",this._source.sourceUrl),this._flashObjs.sound.addEventListener("complete",this._embedding.newCallback(r.as_method(this.__requestComplete,this))),this._flashObjs.sound.loadVoid(this._flashObjs.urlRequest)},__requestComplete:function(){this._element.duration=this._flashObjs.sound.length,this.writeAttr("volume",1),this.hasAttr("muted")&&(this._flashObjs.soundTransform.set("volume",0),this.writeAttr("volume",0)),this.__lastPosition=0,this.__paused=!1,this.__playing=!1,this.hasAttr("autoplay")&&this._element.play(),this.ready.asyncSuccess(this)},_domMethods:["play","pause","load"],_domAttrs:{volume:{set:"_setVolume"},currentTime:{get:"_getCurrentTime",set:"_setCurrentTime"}},load:function(){},play:function(){this.__playing||(this.__playing=!0,this.__paused=!1,this._flashObjs.soundChannel=this._flashObjs.sound.play(this.__lastPosition,0,this._flashObjs.soundTransform),this._flashObjs.soundChannel.addEventListener("soundComplete",this._embedding.newCallback(r.as_method(this.__soundComplete,this))),this.domEvent("playing"))},pause:function(){this.__playing&&!this.__paused&&(this.__lastPosition=this._flashObjs.soundChannel.get("position"),this.__playing=!1,this.__paused=!0,this._flashObjs.soundChannel.stop(),this._flashObjs.soundChannel.destroy(),this.domEvent("pause"))},_setVolume:function(e){this._flashObjs.soundTransform.set("volume",e),this.domEvent("volumechange")},_getCurrentTime:function(){return this.__playing?this._flashObjs.soundTransform.get("position"):this.__lastPosition},_setCurrentTime:function(e){this.__playing?this._flashObjs.soundTransform.set("position",e):this.__lastPosition=e},__soundComplete:function(){this.__lastPosition=0,this.__playing=!1,this.__paused=!1,this._flashObjs.soundChannel.destroy(),this.domEvent("ended")}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new t,this.__flashRegistry.register("flash.media.Sound",["load","play","addEventListener"]),this.__flashRegistry.register("flash.media.SoundChannel",["stop","addEventListener"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"]),this.__flashRegistry.register("flash.media.SoundTransform",[])),this.__flashRegistry},polyfill:function(e,t,i,s){if(s){var r=a.create();return o.eventually(function(){r.asyncSuccess(h.polyfill(e,t,i))}),r}return"audio"==e.tagName.toLowerCase()&&"networkState"in e?e.networkState==e.NETWORK_NO_SOURCE||i?h.attach(n.changeTag(e,t||"audiopoly")):e:h.attach(e)},attach:function(e,t){new h(e,t);return e}});return h}),e.define("module:AudioRecorder.AudioRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(e,t,i,s,r){return e.extend({scoped:r},[t,function(t){return{constructor:function(e){t.constructor.call(this,e),this._element=this._options.element,this.ready=s.create()},destroy:function(){t.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},softwareDependencies:function(){return this._softwareDependencies()},_softwareDependencies:function(){},soundLevel:function(){},testSoundLevel:function(e){},getVolumeGain:function(){},setVolumeGain:function(e){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(e){},startRecord:function(e){},stopRecord:function(e){},isFlash:function(){return!1},isWebrtcStreaming:function(){return!1},supportsLocalPlayback:function(){return!1},localPlaybackSource:function(){return null},recordDelay:function(e){return 0}}}],{_initializeOptions:function(e){return i.extend({forceflash:!1,noflash:!1,recordVideo:!1,recordAudio:!0},e)}})}),e.define("module:AudioRecorder.WebRTCAudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","module:WebRTC.AudioAnalyser","browser:Dom","browser:Info","base:Time","base:Objs","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(e,i,s,r,n,t,o,a,h,d,c,l){return e.extend({scoped:l},function(t){return{constructor:function(e){t.constructor.call(this,e),"audio"!==this._element.tagName.toLowerCase()&&(this._element=n.changeTag(this._element,"audio")),this._recorder=i.create({video:this._element,recordVideo:!1,recordAudio:this._options.recordAudio,audioBitrate:this._options.audioBitrate,webrtcStreaming:this._options.webrtcStreaming,webrtcStreamingIfNecessary:this._options.webrtcStreamingIfNecessary,localPlaybackRequested:this._options.localPlaybackRequested}),this._recorder.on("bound",function(){this._analyser&&this.testSoundLevel(!0)},this),this._recorder.on("error",function(e,t){this.trigger("error",e,t)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._analyser&&this._analyser.weakDestroy(),this._recorder.destroy(),t.destroy.call(this)},recordDelay:function(e){return this._recorder.recordDelay(e)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},soundLevel:function(){return!this._analyser&&this._recorder&&this._recorder.stream()&&(this._analyser=new r(this._recorder.stream())),this._analyser?this._analyser.soundLevel():0},isWebrtcStreaming:function(){return this._recorder.isWebrtcStreaming()},testSoundLevel:function(e){this._analyser&&(this._analyser.weakDestroy(),delete this._analyser),e&&(this._analyser=new r(this._recorder.stream()))},currentDevices:function(){return{audio:this._currentAudio}},enumerateDevices:function(){return s.enumerateMediaSources().success(function(e){this._currentAudio||(this._currentAudio=a.ithKey(e.audio))},this)},setCurrentDevices:function(e){e&&e.audio&&this._recorder.selectMicrophone(e.audio)},startRecord:function(e){return this.__localPlaybackSource=null,this._recorder.startRecord(e)},stopRecord:function(r){var n=c.create();return this._recorder.once("data",function(e,t,i){this.__localPlaybackSource={src:t||e};var s=new d;this._options.simulate||i||e&&s.addUploader(h.create(a.extend({source:t||e},r.audio))),n.asyncSuccess(s)},this),this._recorder.stopRecord(),n},supportsLocalPlayback:function(){return!!this.__localPlaybackSource.src},localPlaybackSource:function(){return this.__localPlaybackSource},_softwareDependencies:function(){return c.value(!0)}}},{supported:function(e){return!e.forceflash&&!!i.anySupport(e)}})}),e.define("module:AudioRecorder.FlashAudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:Flash.FlashAudioRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(e,i,s,r,n,o,a,h,d,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),"div"!==this._element.tagName.toLowerCase()&&(this._element=s.changeTag(this._element,"div")),this._recorder=new i(this._element,{microphonecodec:this._options.rtmpMicrophoneCodec,audioRate:this._options.audioBitrate?Math.floor(this._options.audioBitrate/1e3):undefined}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this),this._recorder.on("endpoint_connectivity",function(e,t){this.trigger("endpoint_connectivity",e,t)},this)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},soundLevel:function(){var e=this._recorder.soundLevel();return e<=1?1:1+(e-1)/100},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},testSoundLevel:function(e){this._recorder.testSoundLevel(e)},enumerateDevices:function(){var e=this._recorder.enumerateDevices();return n.value({audioCount:o.count(e.audios),audio:o.map(e.audios,function(e,t){return{id:t,label:e}})})},currentDevices:function(){return{audio:this._recorder.currentMicrophone()}},setCurrentDevices:function(e){e&&e.audio&&this._recorder.selectMicrophone(e.audio)},startRecord:function(e){if(this._options.simulate)return n.value(!0);var t=this,i={},s=n.create();return this._recorder.on("recording",function(){s.asyncSuccess(),t._recorder.off(null,null,i)},i).on("error",function(e){s.asyncError(e),t._recorder.off(null,null,i)},i),this._recorder.startRecord(e.rtmp),s},stopRecord:function(e){if(this._options.simulate)return n.value(new d);var t=this,i={},s=new h,r=null;return r=new a({delay:100,context:this,fire:function(){if(this._recorder&&!this._recorder.destroyed()){var e=this._recorder.uploadStatus();s.progressCallback(e.total-e.remaining,e.total)}else r.destroy()}}),this._recorder.on("finished",function(){s.successCallback(!0),t._recorder.off(null,null,i),r.weakDestroy()},i).on("error",function(e){s.errorCallback(e),t._recorder.off(null,null,i),r.weakDestroy()},i),this._recorder.stopRecord(),n.create(s)},isFlash:function(){return!0},_softwareDependencies:function(){return r.flash().installed()?n.value(!0):n.error([{title:"Adobe Flash",execute:function(){window.open("https://get.adobe.com/flashplayer")}}])}}},{supported:function(e){return!r.isMobile()&&!e.noflash&&r.flash().supported()&&!e.screen}})}),e.extend("module:AudioRecorder.AudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:AudioRecorder.WebRTCAudioRecorderWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:AudioRecorder.AudioRecorderWrapper",["module:AudioRecorder.AudioRecorderWrapper","module:AudioRecorder.FlashAudioRecorderWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:Flash.FlashAudioRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(e,t,i,s,r,n,o,a,h,d,c,l,u,_,f,m){var p=e.extend({scoped:m},[_,f,function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._embedding=this.auto_destroy(new r(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1,hasEmbedding:this.readAttr("hasembedding")||!1,namespace:this.readAttr("embednamespace")||null},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=u.create(),this.__status="idle",this.__audioRate=this.readAttr("audiorate")||44,this.__audioQuality=this.readAttr("audioquality")||10,this.__microphoneCodec=this.readAttr("microphonecodec")||"speex",this.__defaultGain=55,this._embedding.ready(this.__initializeEmbedding,this)},__initializeEmbedding:function(){this.__hasMicrophoneActivity=!1,this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.Microphone=this._embedding.getClass("flash.media.Microphone"),this._flashObjs.microphone=d.is_empty(0<this._flashObjs.Microphone.get("names").length)?null:this._flashObjs.Microphone.getMicrophone(0),this.setMicrophoneProfile(),this._currentMicrophone=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.ready.asyncSuccess(this),this.auto_destroy(new c({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){try{return!this._flashObjs.microphone||!this._flashObjs.microphone.get("muted")}catch(e){return!1}},isSecurityDialogOpen:function(){var e=this._embedding.newObject("flash.display.BitmapData",1,1),t=!1;try{e.draw(this._flashObjs.stage)}catch(i){t=!0}return e.dispose(),e.destroy(),t},openSecurityDialog:function(e){this.trigger("require_display"),this._flashObjs.Security.showSettings("privacy")},grantAccess:function(e,t){var i=u.create(),s=new c({fire:function(){this.destroyed()?s.destroy():this.isSecurityDialogOpen()||(this.isAccessGranted()?(s.destroy(),i.asyncSuccess(!0)):t?(s.destroy(),i.asyncError(!0)):this.openSecurityDialog(e))},context:this,delay:10,start:!0});return i},bindMedia:function(e,t){return this.grantAccess(e,t).mapSuccess(function(){this._mediaBound=!0},this)},unbindMedia:function(){this._mediaBound=!1},enumerateDevices:function(){return{audios:this._flashObjs.Microphone.get("names")}},selectMicrophone:function(e){this._flashObjs.microphone&&this._flashObjs.microphone.weakDestroy(),this.__hasMicrophoneActivity=!1,this.__microphoneActivityTime=null,this._flashObjs.microphone=this._flashObjs.Microphone.getMicrophone(e),this._currentMicrophone=e,this.setMicrophoneProfile(this._currentMicrophoneProfile)},currentMicrophone:function(){return this._currentMicrophone},microphoneInfo:function(){return this._flashObjs.microphone?{muted:this._flashObjs.microphone.get("muted"),name:this._flashObjs.microphone.get("name"),activityLevel:this._flashObjs.microphone.get("activityLevel"),gain:this._flashObjs.microphone.get("gain"),rate:this._flashObjs.microphone.get("rate"),encodeQuality:this._flashObjs.microphone.get("encodeQuality"),codec:this._flashObjs.microphone.get("codec"),hadActivity:this.__hadMicrophoneActivity,inactivityTime:this.__microphoneActivityTime?l.now()-this.__microphoneActivityTime:null}:{}},setMicrophoneProfile:function(e){this._flashObjs.microphone&&(e=e||{},this._flashObjs.microphone.setLoopBack(e.loopback||!1),this._flashObjs.microphone.set("gain",e.gain||this.__defaultGain),this._flashObjs.microphone.setSilenceLevel(e.silenceLevel||0),this._flashObjs.microphone.setUseEchoSuppression(e.echoSuppression||!1),this._flashObjs.microphone.set("rate",e.rate||this.__audioRate),this._flashObjs.microphone.set("encodeQuality",e.encodeQuality||this.__audioQuality),this._flashObjs.microphone.set("codec",e.codec||this.__microphoneCodec),this._currentMicrophoneProfile=e)},getVolumeGain:function(){return(this._mediaBound?this._flashObjs.micropone.get("gain"):55)/55},setVolumeGain:function(e){this.__defaultGain=Math.min(Math.max(0,Math.round(55*e)),100),this._mediaBound&&this._flashObjs.microphone&&this._flashObjs.microphone.set("gain",this.__defaultGain)},testSoundLevel:function(e){this.setMicrophoneProfile(e?{loopback:!0,gain:55,silenceLevel:100,echoSuppression:!0}:{})},soundLevel:function(){return this._flashObjs.microphone?this._flashObjs.microphone.get("activityLevel"):0},_fire:function(){this._mediaBound&&(this.__hadMicrophoneActivity=this.__hadMicrophoneActivity||this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel"),this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel")&&(this.__microphoneActivityTime=l.now()))},_error:function(e){this.__status="error",this.trigger("error",e)},_status:function(e){return e&&e!==this.__status&&(this.__status=e,this.trigger("status",e),this.trigger(e)),this.__status},__newCallback:function(i,e){var s=!0,r=null,n=function(){clearTimeout(r),s&&(s=!1,this.trigger("endpoint_connectivity",this.__endpoint,-1),0<e.length?(i=e.shift(),this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this.__newCallback(i,e)),this.__endpoint=i,this._flashObjs.connection.connectVoid(i.serverUrl)):this._error("Could not connect to server"))},t=this;return r=setTimeout(function(){n.call(t)},1e4),this._embedding.newCallback(h.as_method(function(e){if(s){var t=e.get("info").code;if("NetConnection.Connect.Closed"===t&&"recording"===this._status())return s=!1,void this._error("Connection to server interrupted.");"NetConnection.Connect.Success"===t&&"connecting"!==this._status()||"NetConnection.Connect.Closed"===t&&"connecting"===this._status()||"NetConnection.Connect.Failed"===t&&"connecting"===this._status()?n.call(this):"NetConnection.Connect.Closed"!==t||"uploading"!==this._status()?"NetConnection.Connect.Success"===t&&"connecting"===this._status()&&(this.trigger("endpoint_connectivity",this.__endpoint,1),clearTimeout(r),this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(h.as_method(function(e){var t=e.get("info").code;if("NetStream.Record.Start"!==t)return"NetStream.Play.StreamNotFound"===t?(this._flashObjs.stream.closeVoid(),void("none"!==this._status()&&this._error("Stream not found"))):void(("NetStream.Unpublish.Success"===t||"uploading"===this._status()&&"NetStream.Buffer.Empty"===t&&"flv"===this.__streamType&&0===this._flashObjs.stream.get("bufferLength"))&&(this._flashObjs.stream.closeVoid(),this._flashObjs.stream.destroy(),this._flashObjs.stream=null,this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=null,this._status("finished")));this._status("recording")},this))),this._flashObjs.stream.set("bufferTime",120),this._flashObjs.stream.attachAudioVoid(this._flashObjs.microphone),this._flashObjs.stream.publish(i.streamName,"record")):this._status("finished")}},this))},startRecord:function(e){1<arguments.length&&(e={serverUrl:e,streamName:arguments[1]}),d.is_array(e)||(e=[e]),this._status("connecting");var t=e.shift(),i=this.__newCallback(t,e);this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",i),this.__endpoint=t,this._flashObjs.connection.connectVoid(t.serverUrl)},stopRecord:function(){if("recording"===this._status()){this.__initialBufferLength=0,this._status("uploading"),this.__initialBufferLength=this._flashObjs.stream.get("bufferLength");try{this._flashObjs.stream.attachAudioVoid(null)}catch(e){}}},uploadStatus:function(){return{total:this.__initialBufferLength,remaining:this._flashObjs.stream.get("bufferLength")}}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new s,this.__flashRegistry.register("flash.media.Microphone",["setLoopBack","setSilenceLevel","setUseEchoSuppression"],["getMicrophone"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek","attachAudio","publish","close"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener","call","close"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"])),this.__flashRegistry},attach:function(e,t){new p(e,t);return e}});return p}),e.define("module:Encoding.WaveEncoder.Support",["base:Promise","base:Scheduling.Helper"],function(u,_){return{dumpInputBuffer:function(e,t,i,s){return{left:new Float32Array(e.getChannelData(0)),right:1<t?new Float32Array(e.getChannelData(1)):null,offset:s||0,endOffset:i}},waveChannelTransform:function(e,t,i,s){var r=u.create(),n=32767*(t||1),o=e.offset,a=e.endOffset,h=e.left,d=e.right,c=new Int16Array((a-o)*(d?2:1)),l=0;return _.schedulable(function(e){for(;0<e;){if(e--,a<=o)return r.asyncSuccess(c),!0;c[l]=h[o]*n,l++,d&&(c[l]=d[o]*n,l++),o++}return!1},100,i,s),r},generateHeader:function(e,t,i,s){s=s||new ArrayBuffer(44);var r=new DataView(s);return r.writeUTFBytes=function(e,t){for(var i=0;i<t.length;i++)this.setUint8(e+i,t.charCodeAt(i))},r.writeUTFBytes(0,"RIFF"),r.setUint32(4,44+e,!0),r.writeUTFBytes(8,"WAVE"),r.writeUTFBytes(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,i,!0),r.setUint32(28,4*i,!0),r.setUint16(32,2*t,!0),r.setUint16(34,16,!0),r.writeUTFBytes(36,"data"),r.setUint32(40,e,!0),s}}}),e.define("module:Encoding.WebmEncoder.Support",["base:Promise","base:Scheduling.Helper","base:Types"],function(e,t,i){return{parseWebP:function(e){for(var t=e.RIFF[0].WEBP[0],i=t.indexOf("\x9d\x01*"),s=0,r=[];s<4;s++)r[s]=t.charCodeAt(i+3+s);return{width:16383&(r[1]<<8|r[0]),height:16383&(r[3]<<8|r[2]),data:t,riff:e}},parseRIFF:function(e){for(var t=0,i={},s=function(e){var t=e.charCodeAt(0).toString(2);return new Array(8-t.length+1).join("0")+t};t<e.length;){var r=e.substr(t,4),n=parseInt(e.substr(t+4,4).split("").map(s).join(""),2),o=e.substr(t+4+4,n);t+=8+n,i[r]=i[r]||[],"RIFF"==r||"LIST"==r?i[r].push(this.parseRIFF(o)):i[r].push(o)}return i},isBlankFrame:function(e,t,i,s){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n,o,a,h=r.getContext("2d"),d=0,c=0,l=0,u=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),_=i&&0<=i&&i<=1?i:0,f=s&&0<=s&&s<=1?s:0,m=new Image;m.src=t.image,h.drawImage(m,0,0,e.width,e.height);var p=h.getImageData(0,0,e.width,e.height);n=0,o=p.data.length,a=p.data.length/4;for(var g=0;g<o;g+=4){var b=p.data[g],v=p.data[g+1],y=p.data[g+2];Math.sqrt(Math.pow(b-d,2)+Math.pow(v-c,2)+Math.pow(y-l,2))<=u*_&&n++}return a-n<=a*f},makeSimpleBlock:function(e){var t=0;if(e.keyframe&&(t|=128),e.invisible&&(t|=8),e.lacing&&(t|=e.lacing<<1),e.discardable&&(t|=1),127<e.trackNum)throw"TrackNumber > 127 not supported";return[128|e.trackNum,e.timecode>>8,255&e.timecode,t].map(function(e){return String.fromCharCode(e)}).join("")+e.frame},generateEBMLHeader:function(e,t,i){var s;return[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:(s=e,[].slice.call(new Uint8Array(new Float64Array([s]).buffer),0).map(function(e){return String.fromCharCode(e)}).reverse().join("")),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:t,id:176},{data:i,id:186}]}]}]}]}]},__numToBuffer:function(e){for(var t=[];0<e;)t.push(255&e),e>>=8;return new Uint8Array(t.reverse())},__strToBuffer:function(e){return new Uint8Array(e.split("").map(function(e){return e.charCodeAt(0)}))},__bitsToBuffer:function(e){var t=[];e=(e.length%8?new Array(9-e.length%8).join("0"):"")+e;for(var i=0;i<e.length;i+=8)t.push(parseInt(e.substr(i,8),2));return new Uint8Array(t)},serializeEBML:function(e){if(!i.is_array(e))return e;var h=[];return e.forEach(function(e){var t=e.data,i=typeof t;"object"===i?t=this.serializeEBML(t):"number"===i?t=this.__bitsToBuffer(t.toString(2)):"string"===i&&(t=this.__strToBuffer(t));var s=t.size||t.byteLength||t.length,r=Math.ceil(Math.ceil(Math.log(s)/Math.log(2))/8),n=s.toString(2),o=new Array(7*r+7+1-n.length).join("0")+n,a=new Array(r).join("0")+"1"+o;h.push(this.__numToBuffer(e.id)),h.push(this.__bitsToBuffer(a)),h.push(t)},this),new Blob(h,{type:"video/webm"})},makeTimecodeDataBlock:function(e,t){return{data:this.makeSimpleBlock({discardable:0,frame:e.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(t)}),id:163}},makeCluster:function(e,t){return e.unshift({data:t,id:231}),{id:524531317,data:e}}}}),e.define("module:Flash.FlashImageRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(e,t,i,s,r,n,o,a,c,h,d,l,u,_,f,m){var p=e.extend({scoped:m},[_,f,function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._embedding=this.auto_destroy(new r(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1,hasEmbedding:this.readAttr("hasembedding")||!1,namespace:this.readAttr("embednamespace")||null},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=u.create(),this.__videoRate=this.readAttr("videorate")||0,this.__videoQuality=this.readAttr("videoquality")||90,this.__cameraWidth=this.readAttr("camerawidth")||640,this.__cameraHeight=this.readAttr("cameraheight")||480,this._flip=h.parseBool(this.readAttr("flip")||!1),this._embedding.ready(this.__initializeEmbedding,this)},__initializeEmbedding:function(){this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.cameraVideo=this._embedding.newObject("flash.media.Video",this.__cameraWidth,this.__cameraHeight),this._flashObjs.main.addChildVoid(this._flashObjs.video),this._flashObjs.Camera=this._embedding.getClass("flash.media.Camera"),this._flashObjs.camera=this._flashObjs.Camera.getCamera(0),this._currentCamera=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.recomputeBB(),this.ready.asyncSuccess(this),this.auto_destroy(new d({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){try{return!this._flashObjs.camera||!this._flashObjs.camera.get("muted")}catch(e){return!1}},isSecurityDialogOpen:function(){var e=this._embedding.newObject("flash.display.BitmapData",1,1),t=!1;try{e.draw(this._flashObjs.stage)}catch(i){t=!0}return e.dispose(),e.destroy(),t},openSecurityDialog:function(e){this.trigger("require_display"),e?this._flashObjs.Security.showSettings("privacy"):(this._flashObjs.video.attachCamera(null),this._flashObjs.video.attachCamera(this._flashObjs.camera))},grantAccess:function(e,t){var i=u.create(),s=new d({fire:function(){this.destroyed()?s.destroy():this.isSecurityDialogOpen()||(this.isAccessGranted()?(s.destroy(),i.asyncSuccess(!0)):t?(s.destroy(),i.asyncError(!0)):this.openSecurityDialog(e))},context:this,delay:10,start:!0});return i},bindMedia:function(e,t){return this.grantAccess(e,t).mapSuccess(function(){this._mediaBound=!0,this._attachCamera()},this)},unbindMedia:function(){this._detachCamera(),this._mediaBound=!1},_attachCamera:function(){this._flashObjs.camera&&(this._flashObjs.camera.setMode(this.__cameraWidth,this.__cameraHeight,this.__fps),this._flashObjs.camera.setQuality(this.__videoRate,this.__videoQuality),this._flashObjs.camera.setKeyFrameInterval(5),this._flashObjs.video.attachCamera(this._flashObjs.camera),this._flashObjs.cameraVideo.attachCamera(this._flashObjs.camera)),this._flip&&(0<this._flashObjs.video.get("scaleX")&&this._flashObjs.video.set("scaleX",-this._flashObjs.video.get("scaleX")),this._flashObjs.video.set("x",this._flashObjs.video.get("width")))},_detachCamera:function(){this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)},enumerateDevices:function(){return{videos:this._flashObjs.Camera.get("names")}},selectCamera:function(e){this._flashObjs.camera&&this._flashObjs.camera.weakDestroy(),this.__cameraActivityTime=null,this._flashObjs.camera=this._flashObjs.Camera.getCamera(e),this._currentCamera=e,this._mediaBound&&this._attachCamera()},currentCamera:function(){return this._currentCamera},cameraInfo:function(){return this._flashObjs.camera?{muted:this._flashObjs.camera.get("muted"),name:this._flashObjs.camera.get("name"),activityLevel:this._flashObjs.camera.get("activityLevel"),fps:this._flashObjs.camera.get("fps"),width:this._flashObjs.camera.get("width"),height:this._flashObjs.camera.get("height"),inactivityTime:this.__cameraActivityTime?l.now()-this.__cameraActivityTime:null}:{}},_pixelSample:function(e,t,i){e=e||100;var s=this._flashObjs.cameraVideo.get("width"),r=this._flashObjs.cameraVideo.get("height"),n=Math.ceil(Math.sqrt(s/r*e)),o=Math.ceil(Math.sqrt(r/s*e)),a=this._embedding.newObject("flash.display.BitmapData",n,o),h=this._embedding.newObject("flash.geom.Matrix");h.scale(n/s,o/r),a.draw(this._flashObjs.cameraVideo,h);for(var d=0;d<e;++d){var c=d%n,l=Math.floor(d/n),u=a.getPixel(c,l);t.call(i||this,u%256,u/256%256,u/256/256%256)}h.destroy(),a.destroy()},_fire:function(){if(this._mediaBound&&this._flashObjs.camera){var e=this._flashObjs.camera.get("activityLevel");this.__lastCameraActivity&&this.__lastCameraActivity===e||(this.__cameraActivityTime=l.now()),this.__lastCameraActivity=e}},createSnapshot:function(){var e=this._embedding.newObject("flash.display.BitmapData",this._flashObjs.cameraVideo.get("videoWidth"),this._flashObjs.cameraVideo.get("videoHeight"));return e.draw(this._flashObjs.cameraVideo),e},postSnapshot:function(e,t,i,s){var r=u.create();s=s||90;var n=this._embedding.newObject("flash.net.URLRequestHeader","Content-type","application/octet-stream"),o=this._embedding.newObject("flash.net.URLRequest",t);if(o.set("requestHeaders",[n]),o.set("method","POST"),"jpg"===i){var a=this._embedding.newObject("com.adobe.images.JPGEncoder",s);o.set("data",a.encode(e)),a.destroy()}else{var h=this._embedding.getClass("com.adobe.images.PNGEncoder");o.set("data",h.encode(e))}var d=this._embedding.newObject("flash.net.URLLoader");return d.set("dataFormat","BINARY"),d.addEventListener("complete",this._embedding.newCallback(c.as_method(function(){r.asyncSuccess(!0)},this))),d.addEventListener("ioError",this._embedding.newCallback(c.as_method(function(){r.asyncError("IO Error")},this))),d.load(o),r.callback(function(){d.destroy(),o.destroy(),n.destroy()}),r},createSnapshotDisplay:function(e,t,i,s,r){var n=this._embedding.newObject("flash.display.Bitmap",e);return this.updateSnapshotDisplay(e,n,t,i,s,r),this._flashObjs.main.addChildVoid(n),n},updateSnapshotDisplay:function(e,t,i,s,r,n){t.set("x",i),t.set("y",s),t.set("scaleX",r/e.get("width")),t.set("scaleY",n/e.get("height"))},removeSnapshotDisplay:function(e){this._flashObjs.main.removeChildVoid(e),e.destroy()},idealBB:function(){return{width:this.__cameraWidth,height:this.__cameraHeight}},setActualBB:function(i){["object","embed"].forEach(function(e){var t=this._element.getElementsByTagName(e.toUpperCase())[0];t&&["width","height"].forEach(function(e){t.style[e]=i[e]+"px"})},this);var e=this._flashObjs.video;e&&(e.set("width",i.width),e.set("height",i.height),this._flip&&(0<e.get("scaleX")&&e.set("scaleX",-e.get("scaleX")),e.set("x",e.get("width"))))},_error:function(e){this.__status="error",this.trigger("error",e)}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new s,this.__flashRegistry.register("flash.media.Camera",["setMode","setQuality","setKeyFrameInterval","addEventListener"],["getCamera"]),this.__flashRegistry.register("flash.media.Video",["attachCamera","attachNetStream"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.net.URLRequestHeader",[]),this.__flashRegistry.register("flash.net.URLLoader",["addEventListener","load"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","removeChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"]),this.__flashRegistry.register("flash.display.BitmapData",["draw","getPixel","dispose"]),this.__flashRegistry.register("flash.display.Bitmap",[]),this.__flashRegistry.register("flash.geom.Matrix",["scale"]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"]),this.__flashRegistry.register("com.adobe.images.PNGEncoder",[],["encode"]),this.__flashRegistry.register("com.adobe.images.JPGEncoder",["encode"])),this.__flashRegistry},attach:function(e,t){new p(e,t);return e}});return p}),e.define("module:ImageRecorder.ImageRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(e,t,i,s,r){return e.extend({scoped:r},[t,function(t){return{constructor:function(e){t.constructor.call(this,e),this._element=this._options.element,this.ready=s.create()},destroy:function(){t.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},softwareDependencies:function(){return this._softwareDependencies()},_softwareDependencies:function(){},cameraWidth:function(){return this._options.recordingWidth},cameraHeight:function(){return this._options.recordingHeight},lightLevel:function(){},blankLevel:function(){},deltaCoefficient:function(){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(e){},createSnapshot:function(){},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){},updateSnapshotDisplay:function(e,t,i,s,r,n){},removeSnapshotDisplay:function(e){},createSnapshotUploader:function(e,t,i){},isFlash:function(){return!1},snapshotToLocalPoster:function(e){return null}}}],{_initializeOptions:function(e){return i.extend({forceflash:!1,noflash:!1,recordingWidth:640,recordingHeight:480},e)}})}),e.define("module:ImageRecorder.WebRTCImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","browser:Dom","browser:Info","base:Time","base:Objs","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(e,i,h,d,t,s,r,n,o,a,c){return e.extend({scoped:c},function(t){return{constructor:function(e){t.constructor.call(this,e),"video"!==this._element.tagName.toLowerCase()&&(this._element=d.changeTag(this._element,"video")),this._recorder=i.create({video:this._element,flip:!!this._options.flip,recordVideo:!0,recordAudio:!1,recordResolution:{width:this._options.recordingWidth,height:this._options.recordingHeight},videoBitrate:this._options.videoBitrate,screen:this._options.screen}),this._recorder.on("error",function(e,t){this.trigger("error",e,t)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},lightLevel:function(){return this._recorder.lightLevel()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},currentDevices:function(){return{video:this._currentVideo}},enumerateDevices:function(){return h.enumerateMediaSources().success(function(e){this._currentVideo||(this._currentVideo=r.ithKey(e.video))},this)},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video)},createSnapshot:function(e){return this._recorder.createSnapshot(e)},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){var o=h.globals().URL.createObjectURL(t),a=document.createElement("img");return a.style.position="absolute",this.updateSnapshotDisplay(t,a,i,s,r,n),a.src=o,d.elementPrependChild(e,a),a},updateSnapshotDisplay:function(e,t,i,s,r,n){t.style.left=i+"px",t.style.top=s+"px",t.style.width=r+"px",t.style.height=n+"px"},removeSnapshotDisplay:function(e){e.remove()},createSnapshotUploader:function(e,t,i){return n.create(r.extend({source:e},i))},snapshotToLocalPoster:function(e){return e},_softwareDependencies:function(){if(!this._options.screen||h.globals().supportedConstraints.mediaSource)return a.value(!0);var e=h.chromeExtensionExtract(this._options.screen),t=[{title:"Screen Recorder Extension",execute:function(){window.open(e.extensionInstallLink)}}],i=s.now();return h.chromeExtensionMessage(e.extensionId,{type:"ping",data:i}).mapError(function(){return t}).mapSuccess(function(e){return!(!e||"success"!==e.type||e.data!==i)||a.error(t)})}}},{supported:function(e){return!e.forceflash&&(!!i.anySupport(e)&&(!e.screen||(!!(h.globals().supportedConstraints.mediaSource&&t.isFirefox()&&55<t.firefoxVersion())||(!(!t.isChrome()||!e.screen.chromeExtensionId)||!(!t.isOpera()||!e.screen.operaExtensionId)))))}})}),e.define("module:ImageRecorder.FlashImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:Flash.FlashImageRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(e,i,s,r,n,o,t,a,h,d){return e.extend({scoped:d},function(t){return{constructor:function(e){t.constructor.call(this,e),"div"!==this._element.tagName.toLowerCase()&&(this._element=s.changeTag(this._element,"div")),this._recorder=new i(this._element,{flip:!!this._options.flip,camerawidth:this._options.recordingWidth,cameraheight:this._options.recordingHeight,fps:this._options.framerate,videoRate:this._options.videoBitrate?1e3*this._options.videoBitrate:undefined}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this),this._recorder.on("endpoint_connectivity",function(e,t){this.trigger("endpoint_connectivity",e,t)},this)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},lightLevel:function(){return this._recorder.lightLevel()},enumerateDevices:function(){var e=this._recorder.enumerateDevices();return n.value({videoCount:o.count(e.videos),video:o.map(e.videos,function(e,t){return{id:t,label:e}})})},currentDevices:function(){return{video:this._recorder.currentCamera()}},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video)},createSnapshot:function(e){return this._recorder.createSnapshot()},createSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.createSnapshotDisplay(t,i,s,r,n)},updateSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.updateSnapshotDisplay(e,t,i,s,r,n)},removeSnapshotDisplay:function(e){this._recorder.removeSnapshotDisplay(e)},createSnapshotUploader:function(e,t,i){var s=new a(o.extend({source:e,type:t,recorder:this._recorder},i));return s.on("upload",function(e){e.recorder.postSnapshot(e.source,e.url,e.type).success(s.successCallback,s).error(s.errorCallback,s)}),s},isFlash:function(){return!0},_softwareDependencies:function(){return r.flash().installed()?n.value(!0):n.error([{title:"Adobe Flash",execute:function(){window.open("https://get.adobe.com/flashplayer")}}])}}},{supported:function(e){return!r.isMobile()&&!e.noflash&&r.flash().supported()&&!e.screen}})}),e.extend("module:ImageRecorder.ImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:ImageRecorder.WebRTCImageRecorderWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:ImageRecorder.ImageRecorderWrapper",["module:ImageRecorder.ImageRecorderWrapper","module:ImageRecorder.FlashImageRecorderWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:Player.Broadcasting",["base:Class","browser:Loader","browser:Events"],function(e,i,s,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.apply(this),this.player=e.player,this.googleCast={},this.airplay={},this.options=e.commonOptions,this.googleCast.initialOptions=e.castOptions,this.airplayOptions=e.airplayOptions,this.player.on("pause-google-cast",function(){this._googleCastRemotePause()},this),this.player.on("play-google-cast",function(){this._googleCastRemotePlay()},this),this.player.on("google-cast-seeking",function(e){this._seekToGoogleCast(e)},this),this.player.on("change-google-cast-volume",function(e){e=Math.min(1,e),this._changeGoogleCastVolume(e)},this)},attachAirplayEvent:function(e){this._airplayEvent=this.auto_destroy(new s),this._airplayEvent.on(e,"webkitplaybacktargetavailabilitychanged",function(e){switch(e.availability){case"available":return this.player._broadcastingState.airplayConnected=!0;default:return!1}},this)},attachGoggleCast:function(){var t=this;window.__onGCastApiAvailable=function(e){e&&t._initializeCastApi()},i.loadScript("https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1",function(){})},_initializeCastApi:function(){var e=this;e.player.trigger("cast-available",!0);var t=this.googleCast.initialOptions,i={},s=[chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,"41A5ADFD","8AA2B3F9","DE815B4F"],r=[chrome.cast.AutoJoinPolicy.PAGE_SCOPED,chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED,chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED];i.receiverApplicationId=s[2],i.autoJoinPolicy=r[1],cast.framework.CastContext.getInstance().setOptions(i);var n=new cast.framework.RemotePlayer;n.title=this.options.title,n.canControlVolume=t.canControlVolume,n.canPause=t.canPause,n.canSeek=t.canSeek,n.duration=t.duration,n.imageUrl=t.imageUrl,n.isConnected=t.isConnected,n.isMuted=t.isMuted,n.isPaused=t.isPaused,n.title=this.options.title,n.displayName=t.displayName;var o=new cast.framework.RemotePlayerController(n);o.addEventListener(cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,function(){cast&&cast.framework&&(n.isConnected?e._setupCastRemotePlayer(n,o):e._destroyCastRemotePlayer(n,o))})},_setupCastRemotePlayer:function(i,t){var s=this,r=this.player,e=(this.castOptions,r._options.sources[0]),n=r._element.currentSrc,o=e.type,a=cast.framework.CastContext.getInstance().getCurrentSession(),h=new chrome.cast.media.MediaInfo(n,o);h.metadata=new chrome.cast.media.GenericMediaMetadata,h.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC,h.metadata.title=this.options.title,h.metadata.images=[{url:this.options.poster}];var d=new chrome.cast.media.LoadRequest(h);this.googleCast.castRemotePlayer=i,this.googleCast.castRemotePlayerController=t,this.googleCast.castMediaInfo=h,(this.googleCast.castSession=a).loadMedia(d).then(function(){r._broadcastingState.googleCastConnected=!0,r.trigger("cast-loaded",i,t);var e=s.options.currentPosition;0<e&&s._seekToGoogleCast(e),t.addEventListener(cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED,function(){r.trigger("cast-playpause",i.isPaused)}),t.addEventListener(cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED,function(){var e=s._getGoogleCastCurrentMediaTime(i),t=s._getGoogleCastMediaDuration(i);r.trigger("cast-time-changed",e,t)})},function(e){console.warn("Remote media load error : "+s._googleCastPlayerErrorMessages(e))})},_destroyCastRemotePlayer:function(e,t){var i=this.player,s=this._getGoogleCastCurrentMediaTime(e);e.savedPlayerState&&!e.isConnected&&(s=e.savedPlayerState.currentTime),i._broadcastingState.googleCastConnected&&0<s&&i.trigger("proceed-when-ending-googlecast",s),this.player._broadcastingState.googleCastConnected=!1},_getGoogleCastRemotePlayer:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castRemotePlayer},_getGoogleCastRemotePlayerController:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castRemotePlayerController},_getGoogleCastMediaInfo:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castMediaInfo},_getGoogleCastCurrentSession:function(){if(this.player._broadcastingState.googleCastConnected)return this.googleCast.castSession},_getGoogleCastCurrentMediaTime:function(e){if(this.player._broadcastingState.googleCastConnected)return e.currentTime},_getGoogleCastMediaDuration:function(e){if(this.player._broadcastingState.googleCastConnected)return e.duration},_googleCastRemotePlay:function(){if(this.player._broadcastingState.googleCastConnected){var e=this._getGoogleCastRemotePlayer(),t=this._getGoogleCastRemotePlayerController();return"PAUSED"===e.playerState&&t.playOrPause(),e}return!1},_googleCastRemotePause:function(){if(this.player._broadcastingState.googleCastConnected){var e=this._getGoogleCastRemotePlayer(),t=this._getGoogleCastRemotePlayerController();return"PLAYING"===e.playerState&&t.playOrPause(),e}return!1},_seekToGoogleCast:function(e){var t=this._getGoogleCastRemotePlayer(),i=this._getGoogleCastRemotePlayerController();t.currentTime=e,i.seek()},_changeGoogleCastVolume:function(e){var t=this._getGoogleCastRemotePlayerController();this._getGoogleCastRemotePlayer().volumeLevel=e,t.setVolumeLevel()},_googleCastPlayerErrorMessages:function(e){switch(e.code){case chrome.cast.ErrorCode.API_NOT_INITIALIZED:return"The API is not initialized."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.CANCEL:return"The operation was canceled by the user"+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.CHANNEL_ERROR:return"A channel to the receiver is not available."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.EXTENSION_MISSING:return"The Cast extension is not available."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.INVALID_PARAMETER:return"The parameters to the operation were not valid."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.RECEIVER_UNAVAILABLE:return"No receiver was compatible with the session request."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.SESSION_ERROR:return"A session could not be created, or a session was invalid."+(e.description?" :"+e.description:"");case chrome.cast.ErrorCode.TIMEOUT:return"The operation timed out."+(e.description?" :"+e.description:"")}},lookForAirplayDevices:function(e){return e.webkitShowPlaybackTargetPicker()}}})}),e.define("module:Player.FlashPlayer",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Promise"],function(e,n,f,t,s,m,o,p,r,g,a,i){var h=e.extend({scoped:i},function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._source=this.__preferedSource(),this._embedding=this.auto_destroy(new s(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1})),this._flashObjs={},this._flashData={status:"idle"},this.ready=a.create(),this._embedding.ready(this.__initializeEmbedding,this)},__preferedSource:function(){var e=[".mp4",".flv"],t=[];if(this.readAttr("src")||this.readAttr("source")||this.readAttr("sources")){var i=this.readAttr("src")||this.readAttr("source")||this.readAttr("sources");g.is_array(i)?t=i:t.push(i)}var s=this._element;if(f.isInternetExplorer()&&f.internetExplorerVersion()<9)for(var r=this._element;;){var n=r.nextSibling;if(!n||!n.tagName||"source"!=n.tagName.toLowerCase())break;t.push(n.src.toLowerCase()),r=n}else for(var o=0;o<this._element.childNodes.length;++o)s.childNodes[o].tagName&&"source"==s.childNodes[o].tagName.toLowerCase()&&s.childNodes[o].src&&t.push(s.childNodes[o].src.toLowerCase());for(var a=(t=p.map(t,function(e){return e.src||e}))[0],h=e.length-1,d=t.length-1;0<=d;--d)for(var c=0;c<=h;++c)if(m.ends_with(t[d],e[c])){a=t[d],h=c;break}-1==a.indexOf("://")&&(a=document.location.href+"/../"+a);var l=null,u=a;if(m.starts_with(a,"rtmp")){var _=m.splitLast(a,"/");l=_.head,u=_.tail}return{sourceUrl:a,connectionUrl:l,playUrl:u}},__initializeEmbedding:function(){if(this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this.readAttr("poster")){this._flashObjs.imageLoader=this._embedding.newObject("flash.display.Loader");var e=this._flashObjs.imageLoader.get("contentLoaderInfo");e.addEventListener("complete",this._embedding.newCallback(r.as_method(function(){this.__imageLoaded={width:this._flashObjs.imageLoader.get("width"),height:this._flashObjs.imageLoader.get("height")},this.__metaLoaded||this.recomputeBB()},this))),e.addEventListener("ioError",this._embedding.newCallback(r.as_method(function(){this.domEvent("postererror")},this))),this._flashObjs.imageUrlRequest=this._embedding.newObject("flash.net.URLRequest",this.readAttr("poster")),this._flashObjs.imageLoader.load(this._flashObjs.imageUrlRequest),this._flashObjs.main.addChildVoid(this._flashObjs.imageLoader)}this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this._embedding.newCallback(r.as_method(this.__connectionStatusEvent,this))),this._flashObjs.connection.connectVoid(this._source.connectionUrl)},__connectionStatusEvent:function(){this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.set("client",this._embedding.newCallback("onMetaData",r.as_method(function(e){this._flashData.meta=e,this._element.duration=e.duration,this.__metaLoaded=!0,o.eventually(this.recomputeBB,this)},this))),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(r.as_method(this.__streamStatusEvent,this))),this._flashObjs.soundTransform=this._embedding.newObject("flash.media.SoundTransform"),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this._flashObjs.video.attachNetStreamVoid(this._flashObjs.stream),this.writeAttr("volume",1),this.hasAttr("muted")&&(this._flashObjs.soundTransform.set("volume",0),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.writeAttr("volume",0)),this._flashObjs.main.addChildVoid(this._flashObjs.video),this.hasAttr("autoplay")&&this._element.play(),this.ready.asyncSuccess(this)},__streamStatusEvent:function(e){var t=e.get("info").code;"NetStream.Play.StreamNotFound"==t&&(this._flashData.status="error",this.domEvent("videoerror")),"NetStream.Play.Start"==t&&(this._flashData.status="start"),"NetStream.Play.Stop"==t&&(this._flashData.status="stopping"),"NetStream.Buffer.Empty"==t&&"stopping"==this._flashData.status&&(this._flashData.status="stopped",this.domEvent("ended")),"stopped"==this._flashData.status&&this.hasAttr("loop")&&(this._flashData.status="idle",this._element.play())},idealBB:function(){return this.__imageLoaded||this.__metaLoaded?{width:this.__metaLoaded?this._flashData.meta.width:this.__imageLoaded.width,height:this.__metaLoaded?this._flashData.meta.height:this.__imageLoaded.height}:null},setActualBB:function(i){["object","embed"].forEach(function(e){var t=this._element.getElementsByTagName(e.toUpperCase())[0];t&&["width","height"].forEach(function(e){t.style[e]=i[e]+"px"})},this),this.__metaLoaded&&(this._flashObjs.video.set("width",i.width),this._flashObjs.video.set("height",i.height)),this.__imageLoaded&&(this._flashObjs.imageLoader.set("width",i.width),this._flashObjs.imageLoader.set("height",i.height))},videoWidth:function(){return this.__metaLoaded?this._flashData.meta.width:this.__imageLoaded?this.__imageLoaded.width:NaN},videoHeight:function(){return this.__metaLoaded?this._flashData.meta.height:this.__imageLoaded?this.__imageLoaded.height:NaN},_domMethods:["play","pause","load"],_domAttrs:{volume:{set:"_setVolume"},currentTime:{get:"_getCurrentTime",set:"_setCurrentTime"}},load:function(){},play:function(){this._flashObjs.main.imageLoader&&this._flashObjs.main.setChildIndex(this._flashObjs.video,1),"paused"===this._flashData.status?this._flashObjs.stream.resumeVoid():this._flashObjs.stream.playVoid(this._source.playUrl),this._flashData.status="playing",this.domEvent("playing")},pause:function(){"paused"!==this._flashData.status&&(this._flashData.status="paused",this._flashObjs.stream.pauseVoid(),this.domEvent("pause"))},_setVolume:function(e){this._flashObjs.soundTransform.set("volume",e),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.domEvent("volumechange")},_getCurrentTime:function(){return this._flashObjs.stream.get("time")},_setCurrentTime:function(e){this._flashObjs.stream.seek(e)}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new t,this.__flashRegistry.register("flash.media.Video",["attachNetStream"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"])),this.__flashRegistry},polyfill:function(e,t,i,s){if(s){var r=a.create();return o.eventually(function(){r.asyncSuccess(h.polyfill(e,t,i))}),r}return"video"==e.tagName.toLowerCase()&&"networkState"in e?e.networkState==e.NETWORK_NO_SOURCE||i?h.attach(n.changeTag(e,t||"videopoly")):e:h.attach(e)},attach:function(e,t){new h(e,t);return e}});return h}),e.define("module:Player.Support",["base:Promise","base:Objs"],function(d,c){return{resolutionToLabel:function(e,t){return t<300?"SD":t<400?"360p":t<500?"480p":"HD"},elementFileInfo:function(e,t,i,s){try{var r=document.createElement(e);c.iter(i,function(e,t){r[t]=e});var n=d.create(),o=!1,a=setTimeout(function(){o=!0,n.asyncError("Timeout")},1e3);return r[t]=function(){o||(clearTimeout(a),n.asyncSuccess(r))},r.src=(window.URL||window.webkitURL).createObjectURL(s),n}catch(h){return d.error(h)}},videoFileInfo:function(e){return this.elementFileInfo("video","onloadeddata",{volume:0,muted:!0,preload:!0},e).mapSuccess(function(e){return{width:e.videoWidth,height:e.videoHeight,duration:e.duration}})},audioFileInfo:function(e){return this.elementFileInfo("audio","onloadeddata",{volume:0,muted:!0,preload:!0},e).mapSuccess(function(e){return{duration:e.duration}})},imageFileInfo:function(e){return this.elementFileInfo("img","onload",{},e).mapSuccess(function(e){return{width:e.width,height:e.height}})}}}),e.define("module:Player.VideoPlayerWrapper",["base:Classes.OptimisticConditionalInstance","base:Events.EventsMixin","base:Types","base:Objs","base:Strings","browser:Events"],function(e,t,n,o,a,h,i){return e.extend({scoped:i},[t,function(r){return{constructor:function(i,e){r.constructor.call(this),i=o.extend(o.clone(i||{},1),e),this._poster=i.poster||null;var t=i.source||i.sources||[];n.is_string(t)?t=t.split(" "):n.is_array(t)||(t=[t]);var s=[];o.iter(t,function(e){if(n.is_string(e)?e={src:e.trim()}:"undefined"!=typeof Blob&&e instanceof Blob&&(e={src:e}),e.ext&&!e.type&&(e.type="video/"+e.ext),!e.ext&&e.type&&(e.ext=a.last_after(e.type,"/")),!e.ext&&!e.type&&n.is_string(e.src)){var t=a.splitFirst(e.src,"?").head;0<=t.indexOf(".")&&(e.ext=a.last_after(t,"."),e.type="video/"+e.ext)}e.ext&&(e.ext=e.ext.toLowerCase()),e.type&&(e.type=e.type.toLowerCase()),"undefined"!=typeof Blob&&e.src instanceof Blob&&(e.src="undefined"!=typeof i.onlyaudio&&i.onlyaudio?(window.URL||window.webkitURL).createObjectURL(e.audiosrc):(window.URL||window.webkitURL).createObjectURL(e.src)),"undefined"!=typeof Blob&&e.audiosrc instanceof Blob&&(e.audiosrc=(window.URL||window.webkitURL).createObjectURL(e.audiosrc)),s.push(e)},this),this._sources=s,this._element=i.element,this._preload=i.preload||!1,this._reloadonplay=i.reloadonplay||!1,this._options=i,this._loop=i.loop||!1,this._fullscreenedElement=i.fullscreenedElement,this._loaded=!1,this._postererror=!1,this._error=0,this._domEvents=new h,this._broadcastingState={googleCastConnected:!1,airplayConnected:!1}},destroy:function(){this._domEvents.destroy(),r.destroy.call(this)},poster:function(){return this._poster},sources:function(){return this._sources},loaded:function(){return this._loaded},postererror:function(){return this._postererror},buffered:function(){},_eventLoaded:function(){this._loaded=!0,this.trigger("loaded")},_eventPlaying:function(){this._loaded||this._eventLoaded(),this.trigger("playing")},_eventPaused:function(){this.duration()&&this.duration()===this.position()||this.trigger("paused")},_eventEnded:function(){this.trigger("ended")},_eventError:function(e){this._error=e,this.trigger("error",e)},_eventPosterError:function(){this._postererror=!0,this.trigger("postererror")},supportsFullscreen:function(){return!1},duration:function(){return this._element.duration},position:function(){return this._element.currentTime},enterFullscreen:function(){},exitFullscreen:function(){},isFullscreen:function(){return!1},error:function(){return this._error},play:function(){this._reloadonplay&&this._element.load(),this._reloadonplay=!1;try{var e=this._element.play();e["catch"]&&e["catch"](function(){})}catch(t){}},pause:function(){this._element.pause()},setPosition:function(e){this._element.currentTime=e},muted:function(){return this._element.muted},setMuted:function(e){this._element.muted=e},volume:function(){return this._element.volume},setVolume:function(e){this._element.volume=e},videoWidth:function(){},videoHeight:function(){}}}],{ERROR_NO_PLAYABLE_SOURCE:1,ERROR_FLASH_NOT_INSTALLED:2})}),e.define("module:Player.Html5VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","browser:Info","base:Promise","base:Objs","base:Timers.Timer","base:Strings","base:Async","browser:Dom","browser:Events"],function(e,f,m,p,g,b,o,v,y,t){return e.extend({scoped:t},function(e){return{_initialize:function(){if(this._options.nohtml5)return m.error(!0);if(this._sources.length<1)return m.error(!0);if(f.isInternetExplorer()&&f.internetExplorerVersion()<9)return m.error(!0);if(this._options.forceflash)return m.error(!0);var s=m.create();this._element.innerHTML="";var r=this.sources(),e=0===r[0].src.indexOf("blob:")&&r[0].src,t=f.isInternetExplorer()&&9==f.internetExplorerVersion()||f.isWindowsPhone();if("video"!==this._element.tagName.toLowerCase())this._element=v.changeTag(this._element,"video"),this._transitionals.element=this._element;else if(t){var i=b.splitLast(this._element.outerHTML,"</video>").head;p.iter(r,function(e){i+="<source"+(e.type?" type='"+e.type+"'":"")+" src='"+e.src+"' />"}),i+="</video>";var n=v.elementByTemplate(i);v.elementInsertAfter(n,this._element),this._element.parentNode.removeChild(this._element),this._element=n,this._transitionals.element=this._element}f.isSafari()&&f.safariVersion()<6&&(this._element.src=r[0].src,this._preload=!0);this._domEvents.on(this._element,"loadevent",function(){this._element.networkState!==this._element.NETWORK_NO_SOURCE?s.asyncSuccess(!0):s.asyncError(!0)},this);var o=10,a=new g({context:this,fire:function(){this._element.networkState===this._element.NETWORK_NO_SOURCE?--o<=0&&s.asyncError(!0):this._element.networkState===this._element.NETWORK_IDLE?s.asyncSuccess(!0):this._element.networkState===this._element.NETWORK_LOADING&&(f.isEdge()||f.isInternetExplorer()?s.asyncSuccess(!0):f.isFirefox()&&e&&s.asyncSuccess(!0))},delay:50});this._element.preload=this._preload?"auto":"none";var h=0;this._audioElement=null;var d=new y;if(e)this._element.src=e;else if(t)for(var c=this._element.getElementsByTagName("SOURCE"),l=function(){++h===r.length&&s.asyncError(!0)},u=0;u<c.length;++u)d.on(c[u],"error",l);else p.iter(r,function(e){var t=document.createElement("source");if(e.type&&(t.type=e.type),this._element.appendChild(t),d.on(t,"error",function(){++h===r.length&&s.asyncError(!0)}),t.src=e.src,e.audiosrc){this._audioElement||(this._audioElement=document.createElement("audio"),v.elementInsertAfter(this._audioElement,this._element));var i=document.createElement("source");e.type&&(i.type=e.type),this._audioElement.appendChild(i),i.src=e.audiosrc}},this);this.poster()&&(this._element.poster=this.posterURL()),s.callback(function(){d.weakDestroy(),a.destroy()},this),s.success(function(){this._setup()},this);try{f.isChrome()||this._element.load()}catch(_){}return s},posterURL:function(){var e=this.poster();return e&&"undefined"!=typeof Blob&&e instanceof Blob?(window.URL||window.webkitURL).createObjectURL(e):e},destroy:function(){this._audioElement&&this._audioElement.remove(),this.supportsFullscreen()&&this.__fullscreenListener&&v.elementOffFullscreenChange(this._element,this.__fullscreenListener),(!f.isInternetExplorer()||8<f.internetExplorerVersion())&&(this._element.innerHTML=""),e.destroy.call(this)},_eventEnded:function(){this._loop&&this.play(),e._eventEnded.call(this)},_setup:function(){this._loaded=!1,this._domEvents.on(this._element,"canplay",this._eventLoaded,this),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this);for(var e=this,t=this._element.getElementsByTagName("SOURCE"),i=function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},s=0;s<t.length;++s)this._domEvents.on(t[s],"error",i,this);if(this.poster()){var r=new Image;r.onerror=function(){delete e._element.poster,delete e._element.preload,e._eventPosterError()},r.src=this.posterURL(),r.onload=function(){e.__imageWidth=r.width,e.__imageHeight=r.height}}if(f.isSafari()&&(5<f.safariVersion()||f.safariVersion()<9)&&this._element.networkState===this._element.NETWORK_LOADING&&o.eventually(function(){this.destroyed()||this._element.networkState!==this._element.NETWORK_LOADING||0!==this._element.buffered.length||this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this,1e4),this.supportsFullscreen()){this.__videoClassBackup="";var n=this._fullscreenedElement||this._element;this.__fullscreenListener=v.elementOnFullscreenChange(n,function(e,t){this.trigger("fullscreen-change",t),t?(this.__videoClassBackup=this._element.className,this._element.className=""):(this._element.className=this.__videoClassBackup,this.__videoClassBackup="")},this)}},buffered:function(){return this._element.buffered.end(0)},_fullscreenElement:function(e){return f.isChromiumBased()&&!f.isMobile()?e||this._element.parentNode:f.isFirefox()?e||this._element.parentElement:e||this._element},supportsFullscreen:function(e){return v.elementSupportsFullscreen(this._fullscreenElement(e))},enterFullscreen:function(e){v.elementEnterFullscreen(this._fullscreenElement(e))},exitFullscreen:function(){v.documentExitFullscreen()},isFullscreen:function(e){return v.elementIsFullscreen(this._fullscreenElement(e))},videoWidth:function(){return this._element.width||this.__imageWidth||NaN},videoHeight:function(){return this._element.height||this.__imageHeight||NaN},play:function(){e.play.call(this),this._audioElement&&(this._reloadonplay&&this._audioElement.load(),this._audioElement.play())},pause:function(){this._element.pause(),this._audioElement&&this._audioElement.pause()},setPosition:function(e){this._element.currentTime=e,this._audioElement&&(this._audioElement.currentTime=e)},setSpeed:function(e){e<.5&&4<e?console.warn("Maximum allowed speed range is from 0.5 to 4.0"):(this._element.playbackRate=e,this._audioElement&&(this._audioElement.playbackRate=e))},muted:function(){return(this._audioElement?this._audioElement:this._element).muted},setMuted:function(e){(this._audioElement?this._audioElement:this._element).muted=e},volume:function(){return(this._audioElement?this._audioElement:this._element).volume},setVolume:function(e){(this._audioElement?this._audioElement:this._element).volume=e}}})}),e.define("module:Player.FlashPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayer","browser:Info","base:Promise","browser:Dom"],function(e,t,i,s,r,n){return e.extend({scoped:n},function(e){return{_initialize:function(){if(this._options.noflash)return s.error(!0);if(this._sources.length<1)return s.error(!0);if(i.isMobile()||!i.flash().supported())return s.error(!0);if(!i.flash().installed()&&this._options.flashinstallrequired)return s.error(!0);if(!i.flash().installed())return this._eventError(this.cls.ERROR_NO_FLASH_INSTALLED),s.value(!0);s.create();"div"!==this._element.tagName.toLowerCase()&&(this._element=r.changeTag(this._element,"div"),this._transitionals.element=this._element);var e={poster:this.poster(),sources:this.sources()};return this._loop&&(e.loop=!0),this._flashPlayer=new t(this._element,e),this._flashPlayer.ready.success(function(){this._setup()},this)},destroy:function(){this._flashPlayer&&this._flashPlayer.weakDestroy(),this._element.innerHTML="",e.destroy.call(this)},_setup:function(){this._loaded=!0,this._eventLoaded(),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this),this._domEvents.on(this._element,"videoerror",function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this),this._domEvents.on(this._element,"postererror",this._eventPosterError,this)},position:function(){return this._element.get("currentTime")},buffered:function(){return this.position()},setPosition:function(e){this._element.set("currentTime",e)},setVolume:function(e){this._element.set("volume",e)},videoWidth:function(){return this._flashPlayer?this._flashPlayer.videoWidth():null},videoHeight:function(){return this._flashPlayer?this._flashPlayer.videoHeight():null}}})}),e.extend("module:Player.VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.Html5VideoPlayerWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:Player.VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayerWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:Flash.FlashRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(e,t,i,s,r,n,o,a,c,h,d,l,u,_,f,m){var p=e.extend({scoped:m},[_,f,function(i){return{constructor:function(e,t){i.constructor.call(this,e,t),this._embedding=this.auto_destroy(new r(e,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1,hasEmbedding:this.readAttr("hasembedding")||!1,namespace:this.readAttr("embednamespace")||null},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=u.create(),this.__status="idle",this.__disableVideo=this.readAttr("disablevideo")||!1,this.__disableAudio=this.readAttr("disableaudio")||!1,this.__cameraWidth=this.readAttr("camerawidth")||640,this.__cameraHeight=this.readAttr("cameraheight")||480,this.__audioRate=this.readAttr("audiorate")||44,this.__audioQuality=this.readAttr("audioquality")||10,this.__videoRate=this.readAttr("videorate")||0,this.__videoQuality=this.readAttr("videoquality")||90,this.__streamType=this.readAttr("streamtype")||"mp4",this.__microphoneCodec=this.readAttr("microphonecodec")||"speex",this.__fps=this.readAttr("fps")||20,this.__defaultGain=55,this._flip=h.parseBool(this.readAttr("flip")||!1),this._embedding.ready(this.__initializeEmbedding,this)},averageFrameRate:function(){return this.__fps},__initializeEmbedding:function(){this.__hasMicrophoneActivity=!1,this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.cameraVideo=this._embedding.newObject("flash.media.Video",this.__cameraWidth,this.__cameraHeight),this._flashObjs.main.addChildVoid(this._flashObjs.video),this._flashObjs.Microphone=this._embedding.getClass("flash.media.Microphone"),this._flashObjs.Camera=this._embedding.getClass("flash.media.Camera"),this._flashObjs.microphone=h.is_empty(0<this._flashObjs.Microphone.get("names").length)?null:this._flashObjs.Microphone.getMicrophone(0),this.setMicrophoneProfile(),this._flashObjs.camera=this._flashObjs.Camera.getCamera(0),this._currentCamera=0,this._currentMicrophone=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.recomputeBB(),this.ready.asyncSuccess(this),this.auto_destroy(new d({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){try{return!(this._flashObjs.camera&&this._flashObjs.camera.get("muted")||this._flashObjs.microphone&&this._flashObjs.microphone.get("muted"))}catch(e){return!1}},isSecurityDialogOpen:function(){var e=this._embedding.newObject("flash.display.BitmapData",1,1),t=!1;try{e.draw(this._flashObjs.stage)}catch(i){t=!0}return e.dispose(),e.destroy(),t},openSecurityDialog:function(e){this.trigger("require_display"),e?this._flashObjs.Security.showSettings("privacy"):(this._flashObjs.video.attachCamera(null),this._flashObjs.video.attachCamera(this._flashObjs.camera))},grantAccess:function(e,t){var i=u.create(),s=new d({fire:function(){this.destroyed()?s.destroy():this.isSecurityDialogOpen()||(this.isAccessGranted()?(s.destroy(),i.asyncSuccess(!0)):t?(s.destroy(),i.asyncError(!0)):this.openSecurityDialog(e))},context:this,delay:10,start:!0});return i},bindMedia:function(e,t){return this.grantAccess(e,t).mapSuccess(function(){this._mediaBound=!0,this._attachCamera()},this)},unbindMedia:function(){this._detachCamera(),this._mediaBound=!1},_attachCamera:function(){this._flashObjs.camera&&(this._flashObjs.camera.setMode(this.__cameraWidth,this.__cameraHeight,this.__fps),this._flashObjs.camera.setQuality(this.__videoRate,this.__videoQuality),this._flashObjs.camera.setKeyFrameInterval(5),this._flashObjs.video.attachCamera(this._flashObjs.camera),this._flashObjs.cameraVideo.attachCamera(this._flashObjs.camera)),this.__disableVideo&&(this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)),this._flip&&(0<this._flashObjs.video.get("scaleX")&&this._flashObjs.video.set("scaleX",-this._flashObjs.video.get("scaleX")),this._flashObjs.video.set("x",this._flashObjs.video.get("width")))},_detachCamera:function(){this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)},enumerateDevices:function(){return{audios:this._flashObjs.Microphone.get("names"),videos:this._flashObjs.Camera.get("names")}},selectMicrophone:function(e){this._flashObjs.microphone&&this._flashObjs.microphone.weakDestroy(),this.__hasMicrophoneActivity=!1,this.__microphoneActivityTime=null,this._flashObjs.microphone=this._flashObjs.Microphone.getMicrophone(e),this._currentMicrophone=e,this.setMicrophoneProfile(this._currentMicrophoneProfile)},selectCamera:function(e){this._flashObjs.camera&&this._flashObjs.camera.weakDestroy(),this.__cameraActivityTime=null,this._flashObjs.camera=this._flashObjs.Camera.getCamera(e),this._currentCamera=e,this._mediaBound&&this._attachCamera()},currentCamera:function(){return this._currentCamera},currentMicrophone:function(){return this._currentMicrophone},microphoneInfo:function(){return this._flashObjs.microphone?{muted:this._flashObjs.microphone.get("muted"),name:this._flashObjs.microphone.get("name"),activityLevel:this._flashObjs.microphone.get("activityLevel"),gain:this._flashObjs.microphone.get("gain"),rate:this._flashObjs.microphone.get("rate"),encodeQuality:this._flashObjs.microphone.get("encodeQuality"),codec:this._flashObjs.microphone.get("codec"),hadActivity:this.__hadMicrophoneActivity,inactivityTime:this.__microphoneActivityTime?l.now()-this.__microphoneActivityTime:null}:{}},cameraInfo:function(){return this._flashObjs.camera?{muted:this._flashObjs.camera.get("muted"),name:this._flashObjs.camera.get("name"),activityLevel:this._flashObjs.camera.get("activityLevel"),fps:this._flashObjs.camera.get("fps"),width:this._flashObjs.camera.get("width"),height:this._flashObjs.camera.get("height"),inactivityTime:this.__cameraActivityTime?l.now()-this.__cameraActivityTime:null}:{}},setMicrophoneProfile:function(e){this._flashObjs.microphone&&(e=e||{},this._flashObjs.microphone.setLoopBack(e.loopback||!1),this._flashObjs.microphone.set("gain",e.gain||this.__defaultGain),this._flashObjs.microphone.setSilenceLevel(e.silenceLevel||0),this._flashObjs.microphone.setUseEchoSuppression(e.echoSuppression||!1),this._flashObjs.microphone.set("rate",e.rate||this.__audioRate),this._flashObjs.microphone.set("encodeQuality",e.encodeQuality||this.__audioQuality),this._flashObjs.microphone.set("codec",e.codec||this.__microphoneCodec),this._currentMicrophoneProfile=e)},getVolumeGain:function(){return(this._mediaBound?this._flashObjs.micropone.get("gain"):55)/55},setVolumeGain:function(e){this.__defaultGain=Math.min(Math.max(0,Math.round(55*e)),100),this._mediaBound&&this._flashObjs.microphone&&this._flashObjs.microphone.set("gain",this.__defaultGain)},_pixelSample:function(e,t,i){e=e||100;var s=this._flashObjs.cameraVideo.get("width"),r=this._flashObjs.cameraVideo.get("height"),n=Math.ceil(Math.sqrt(s/r*e)),o=Math.ceil(Math.sqrt(r/s*e)),a=this._embedding.newObject("flash.display.BitmapData",n,o),h=this._embedding.newObject("flash.geom.Matrix");h.scale(n/s,o/r),a.draw(this._flashObjs.cameraVideo,h);for(var d=0;d<e;++d){var c=d%n,l=Math.floor(d/n),u=a.getPixel(c,l);t.call(i||this,u%256,u/256%256,u/256/256%256)}h.destroy(),a.destroy()},testSoundLevel:function(e){this.setMicrophoneProfile(e?{loopback:!0,gain:55,silenceLevel:100,echoSuppression:!0}:{})},soundLevel:function(){return this._flashObjs.microphone?this._flashObjs.microphone.get("activityLevel"):0},_fire:function(){if(this._mediaBound&&(this.__hadMicrophoneActivity=this.__hadMicrophoneActivity||this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel"),this._flashObjs.microphone&&0<this._flashObjs.microphone.get("activityLevel")&&(this.__microphoneActivityTime=l.now()),this._flashObjs.camera)){var e=this._flashObjs.camera.get("activityLevel");this.__lastCameraActivity&&this.__lastCameraActivity===e||(this.__cameraActivityTime=l.now()),this.__lastCameraActivity=e}},createSnapshot:function(){var e=this._embedding.newObject("flash.display.BitmapData",this._flashObjs.cameraVideo.get("videoWidth"),this._flashObjs.cameraVideo.get("videoHeight"));return e.draw(this._flashObjs.cameraVideo),e},postSnapshot:function(e,t,i,s){var r=u.create();s=s||90;var n=this._embedding.newObject("flash.net.URLRequestHeader","Content-type","application/octet-stream"),o=this._embedding.newObject("flash.net.URLRequest",t);if(o.set("requestHeaders",[n]),o.set("method","POST"),"jpg"===i){var a=this._embedding.newObject("com.adobe.images.JPGEncoder",s);o.set("data",a.encode(e)),a.destroy()}else{var h=this._embedding.getClass("com.adobe.images.PNGEncoder");o.set("data",h.encode(e))}var d=this._embedding.newObject("flash.net.URLLoader");return d.set("dataFormat","BINARY"),d.addEventListener("complete",this._embedding.newCallback(c.as_method(function(){r.asyncSuccess(!0)},this))),d.addEventListener("ioError",this._embedding.newCallback(c.as_method(function(){r.asyncError("IO Error")},this))),d.load(o),r.callback(function(){d.destroy(),o.destroy(),n.destroy()}),r},createSnapshotDisplay:function(e,t,i,s,r){var n=this._embedding.newObject("flash.display.Bitmap",e);return this.updateSnapshotDisplay(e,n,t,i,s,r),this._flashObjs.main.addChildVoid(n),n},updateSnapshotDisplay:function(e,t,i,s,r,n){t.set("x",i),t.set("y",s),t.set("scaleX",r/e.get("width")),t.set("scaleY",n/e.get("height"))},removeSnapshotDisplay:function(e){try{this._flashObjs.main.removeChildVoid(e)}catch(t){}e.destroy()},idealBB:function(){return{width:this.__cameraWidth,height:this.__cameraHeight}},setActualBB:function(i){["object","embed"].forEach(function(e){var t=this._element.getElementsByTagName(e.toUpperCase())[0];t&&["width","height"].forEach(function(e){t.style[e]=i[e]+"px"})},this);var e=this._flashObjs.video;e&&(e.set("width",i.width),e.set("height",i.height),this._flip&&(0<e.get("scaleX")&&e.set("scaleX",-e.get("scaleX")),e.set("x",e.get("width"))))},_error:function(e){this.__status="error",this.trigger("error",e)},_status:function(e){return e&&e!==this.__status&&(this.__status=e,this.trigger("status",e),this.trigger(e)),this.__status},__newCallback:function(i,e){var s=!0,r=null,n=function(){clearTimeout(r),s&&(s=!1,this.trigger("endpoint_connectivity",this.__endpoint,-1),0<e.length?(i=e.shift(),this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this.__newCallback(i,e)),this.__endpoint=i,this._flashObjs.connection.connectVoid(i.serverUrl)):this._error("Could not connect to server"))},t=this;return r=setTimeout(function(){n.call(t)},1e4),this._embedding.newCallback(c.as_method(function(e){if(s){var t=e.get("info").code;if("NetConnection.Connect.Closed"===t&&"recording"===this._status())return s=!1,void this._error("Connection to server interrupted.");"NetConnection.Connect.Success"===t&&"connecting"!==this._status()||"NetConnection.Connect.Closed"===t&&"connecting"===this._status()||"NetConnection.Connect.Failed"===t&&"connecting"===this._status()?n.call(this):"NetConnection.Connect.Closed"!==t||"uploading"!==this._status()?"NetConnection.Connect.Success"===t&&"connecting"===this._status()&&(this.trigger("endpoint_connectivity",this.__endpoint,1),clearTimeout(r),"mp4"===this.__streamType&&this._flashObjs.connection.callVoid("setStreamType",null,"live"),this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(c.as_method(function(e){var t=e.get("info").code;if("NetStream.Record.Start"!==t){if("NetStream.Play.StreamNotFound"===t)return this._flashObjs.stream.closeVoid(),void("none"!==this._status()&&this._error("Stream not found"));"NetStream.Buffer.Empty"===t&&"uploading"===this._status()&&"mp4"===this.__streamType&&this._flashObjs.stream.publish(null),("NetStream.Unpublish.Success"===t||"uploading"===this._status()&&"NetStream.Buffer.Empty"===t&&"flv"===this.__streamType&&0===this._flashObjs.stream.get("bufferLength"))&&(this._flashObjs.stream.closeVoid(),this._flashObjs.stream.destroy(),this._flashObjs.stream=null,this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=null,this._status("finished"))}else this._status("recording")},this))),this._flashObjs.stream.set("bufferTime",120),"mp4"===this.__streamType&&(this._flashObjs.h264Settings=this._embedding.newObject("flash.media.H264VideoStreamSettings"),this._flashObjs.h264Settings.setProfileLevel("baseline","3.1"),this._flashObjs.stream.set("videoStreamSettings",this._flashObjs.h264Settings)),this.__disableVideo||this._flashObjs.stream.attachCameraVoid(this._flashObjs.camera),this.__disableAudio||this._flashObjs.stream.attachAudioVoid(this._flashObjs.microphone),this._flashObjs.stream.publish(i.streamName,"record")):this._status("finished")}},this))},startRecord:function(e){1<arguments.length&&(e={serverUrl:e,streamName:arguments[1]}),h.is_array(e)||(e=[e]),this._status("connecting");var t=e.shift(),i=this.__newCallback(t,e);this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",i),this.__endpoint=t,this._flashObjs.connection.connectVoid(t.serverUrl)},stopRecord:function(){if("recording"===this._status()){this.__initialBufferLength=0,this._status("uploading"),this.__initialBufferLength=this._flashObjs.stream.get("bufferLength");try{this._flashObjs.stream.attachAudioVoid(null)}catch(e){}this._flashObjs.stream.attachCameraVoid(null)}},uploadStatus:function(){return{total:this.__initialBufferLength,remaining:this._flashObjs.stream.get("bufferLength")}}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new s,this.__flashRegistry.register("flash.media.Microphone",["setLoopBack","setSilenceLevel","setUseEchoSuppression"],["getMicrophone"]),this.__flashRegistry.register("flash.media.Camera",["setMode","setQuality","setKeyFrameInterval","addEventListener"],["getCamera"]),this.__flashRegistry.register("flash.media.Video",["attachCamera","attachNetStream"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.media.H264VideoStreamSettings",["setProfileLevel"]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek","attachCamera","attachAudio","publish","close"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener","call","close"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.net.URLRequestHeader",[]),this.__flashRegistry.register("flash.net.URLLoader",["addEventListener","load"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","removeChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"]),this.__flashRegistry.register("flash.display.BitmapData",["draw","getPixel","dispose"]),this.__flashRegistry.register("flash.display.Bitmap",[]),this.__flashRegistry.register("flash.geom.Matrix",["scale"]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"]),this.__flashRegistry.register("com.adobe.images.PNGEncoder",[],["encode"]),this.__flashRegistry.register("com.adobe.images.JPGEncoder",["encode"])),this.__flashRegistry},attach:function(e,t){new p(e,t);return e}});return p}),e.define("module:Flash.Support",["base:Promise","base:Timers.Timer","base:Async","base:Objs","flash:FlashClassRegistry","flash:FlashEmbedding","browser:Info"],function(o,a,h,r,d,c,l){return{flashCanConnect:function(t,e){if(!l.flash().installed())return o.error(!1);var i=o.create(),s=new d;s.register("flash.net.NetConnection",["connect","addEventListener"]);var r=new c(null,{registry:s,wrap:!0});r.ready(function(){var e=r.newObject("flash.net.NetConnection");e.addEventListener("netStatus",r.newCallback(function(e){e.get("info")&&"NetConnection.Connect.Success"===e.get("info").code?i.asyncSuccess(!0):i.asyncError(!1)})),e.connectVoid(t)});var n=null;return e&&(n=new a({delay:e,once:!0,start:!0,fire:function(){i.asyncError()}})),i.callback(function(){n&&n.destroy(),h.eventually(function(){r.destroy()})}),i},enumerateMediaSources:function(){if(!l.flash().installed())return o.error(!1);var i=o.create(),e=new d;e.register("flash.media.Microphone"),e.register("flash.media.Camera");var s=new c(null,{registry:e,wrap:!0});return s.ready(function(){var e=s.getClass("flash.media.Camera").get("names"),t=s.getClass("flash.media.Microphone").get("names");i.asyncSuccess({videoCount:r.count(e),audioCount:r.count(t),video:r.map(e,function(e,t){return{id:t,label:e}}),audio:r.map(t,function(e,t){return{id:t,label:e}})})}),i.callback(function(){h.eventually(function(){s.destroy()})}),i}}}),e.define("module:Recorder.Support",["module:WebRTC.Support","browser:Upload.FileUploader","browser:Upload.CustomUploader","browser:Dom","browser:Info","base:Promise","base:Objs"],function(d,n,o,h,f,i,a){return{createSnapshot:function(e,t,i,s,r,n,o,a){var h=this._createSnapshot(e,t,i,s,r,n,o,a);return h?d.dataURItoBlob(h):h},_createSnapshot:function(e,t,i,s,r,n,o,a){n=n||0,o=o||0,a=a||1,i=i||!1;var h=document.createElement("canvas");h.width=r||t.videoWidth||t.clientWidth,h.height=s||t.videoHeight||t.clientHeight;var d=1<+h.width/h.height?"landscape":"portrait",c=f.isSafari()||f.isMobile()&&f.isiOS(),l="portrait"===d&&i&&(f.isFirefox()||c),u=h.getContext("2d");l&&1!==this.__detectVerticalSquash(t,h.width,h.height)?this.__rotateToPortrait(t,h,u):c&&"portrait"===d?u.drawImage(t,0,-h.width,h.height,h.width):u.drawImage(t,n,o,h.width,h.height);var _=h.toDataURL(e,a);return this.__isCanvasBlank(h)?null:_},__rotateToPortrait:function(e,t,i){var s=Math.abs(t.height-t.width),r=t.width>t.height?t.width:t.height;t.height=t.width=r,i.drawImage(e,0,0,t.height,t.width),i.clearRect(0,0,t.width,t.height),i.save(),t.width-=s,i.translate(t.width/2,t.height/2),i.rotate(Math.PI/180*90),f.isFirefox()?i.drawImage(e,-t.height/2,-t.width/2,t.height,t.width):i.drawImage(e,-t.height/2,-t.width/2,t.height,t.width+s),i.restore()},__isCanvasBlank:function(e){return!e.getContext("2d").getImageData(0,0,e.width,e.height).data.some(function(e){return 0!==e})},__detectVerticalSquash:function(e,t,i){t||e.naturalWidth||e.width;var s=i||e.naturalHeight||e.height,r=document.createElement("canvas");r.width=1,r.height=s;var n=r.getContext("2d");n.drawImage(e,0,0);for(var o=n.getImageData(0,0,1,s).data,a=0,h=s,d=s;a<d;){0===o[4*(d-1)+3]?h=d:a=d,d=h+a>>1}var c=d/s;return 0===c?1:c},removeSnapshot:function(e){},removeSnapshotDisplay:function(e){e.remove()},createSnapshotDisplay:function(e,t,i,s,r,n){var o=d.globals().URL.createObjectURL(t),a=document.createElement("img");return a.style.position="absolute",this.updateSnapshotDisplay(t,a,i,s,r,n),a.src=o,"video"===e.tagName.toLowerCase()?h.elementInsertAfter(a,e):h.elementPrependChild(e,a),a},snapshotMetaData:function(e){var r=i.create(),t=d.globals().URL.createObjectURL(e),n=new Image;return n.src=t,n.onload=function(e){var t=n.naturalHeight||n.height,i=n.naturalWidth||n.width,s=+(i/t).toFixed(2);r.asyncSuccess({width:i,height:t,orientation:1<s?"landscape":"portrait",ratio:s})},r},updateSnapshotDisplay:function(e,t,i,s,r,n){t.style.left=i+"px",t.style.top=s+"px",t.style.width=r+"px",t.style.height=n+"px"},createSnapshotUploader:function(e,t,i,s){if(e){var r=new o(a.extend({source:t,type:i,recorder:this._recorder},s));return r.on("upload",function(e){e.recorder.postSnapshot(e.source,e.url,e.type).success(r.successCallback,r).error(r.errorCallback,r)}),r}return n.create(a.extend({source:t},s))}}}),e.define("module:Recorder.PixelSampleMixin",[],function(){return{lightLevel:function(e){e=e||100;var s=0;return this._pixelSample(e,function(e,t,i){s+=e+t+i}),s/(3*e)},blankLevel:function(e){e=e||100;var s=0;return this._pixelSample(e,function(e,t,i){s+=Math.pow(e,2)+Math.pow(t,2)+Math.pow(i,2)}),Math.sqrt(s/(3*e))},_materializePixelSample:function(e){var s=[];return this._pixelSample(e,function(e,t,i){s.push([e,t,i])}),s},deltaCoefficient:function(e){e=e||100;var t=this._materializePixelSample(e);if(!this.__deltaSample)return this.__deltaSample=t,null;for(var i=0,s=0;s<t.length;++s)for(var r=0;r<3;++r)i+=Math.pow(t[s][r]-this.__deltaSample[s][r],2);return this.__deltaSample=t,Math.sqrt(i/(3*e))}}}),e.define("module:Recorder.VideoRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(e,t,i,s,r){return e.extend({scoped:r},[t,function(t){return{constructor:function(e){t.constructor.call(this,e),this._element=this._options.element,this.ready=s.create()},destroy:function(){t.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},softwareDependencies:function(){return this._softwareDependencies()},_softwareDependencies:function(){},cameraWidth:function(){return this._options.recordingWidth},cameraHeight:function(){return this._options.recordingHeight},lightLevel:function(){},soundLevel:function(){},testSoundLevel:function(e){},blankLevel:function(){},deltaCoefficient:function(){},getVolumeGain:function(){},setVolumeGain:function(e){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(e){},setCameraFace:function(e){},addMultiStream:function(e,t){},reverseCameraScreens:function(){},createSnapshot:function(){},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){},updateSnapshotDisplay:function(e,t,i,s,r,n){},removeSnapshotDisplay:function(e){},createSnapshotUploader:function(e,t,i){},startRecord:function(e){},pauseRecord:function(){},resumeRecord:function(){},stopRecord:function(e){},isFlash:function(){return!1},isWebrtcStreaming:function(){return!1},canPause:function(){return!1},supportsLocalPlayback:function(){return!1},supportsCameraFace:function(){return!1},snapshotToLocalPoster:function(e){return null},localPlaybackSource:function(){return null},averageFrameRate:function(){return null},recordDelay:function(e){return 0}}}],{_initializeOptions:function(e){return i.extend({forceflash:!1,noflash:!1,recordingWidth:640,recordingHeight:480,recordVideo:!0,recordAudio:!0},e)}})}),e.define("module:Recorder.WebRTCVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","module:WebRTC.AudioAnalyser","browser:Dom","browser:Info","base:Time","base:Objs","base:Timers.Timer","base:Comparators","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(e,i,h,s,d,r,n,a,o,c,l,u,_,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),"video"!==this._element.tagName.toLowerCase()&&(this._element=d.changeTag(this._element,"video")),this._recorder=i.create({video:this._element,flip:!!this._options.flip,framerate:this._options.framerate,recordVideo:this._options.recordVideo,recordFakeVideo:!this._options.recordVideo,recordAudio:this._options.recordAudio,recordResolution:{width:this._options.recordingWidth,height:this._options.recordingHeight},videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,webrtcStreaming:this._options.webrtcStreaming,webrtcStreamingIfNecessary:this._options.webrtcStreamingIfNecessary,localPlaybackRequested:this._options.localPlaybackRequested,screen:this._options.screen}),this._recorder.on("bound",function(){this._analyser&&this.testSoundLevel(!0)},this),this._recorder.on("error",function(e,t){this.trigger("error",e,t)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._analyser&&this._analyser.weakDestroy(),this._recorder.destroy(),t.destroy.call(this)},recordDelay:function(e){return this._recorder.recordDelay(e)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},lightLevel:function(){return this._recorder.lightLevel()},blankLevel:function(){return this._recorder.blankLevel()},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},isWebrtcStreaming:function(){return this._recorder.isWebrtcStreaming()},canPause:function(){return this._recorder.canPause()},soundLevel:function(){return!this._analyser&&this._recorder&&this._recorder.stream()&&s.supported()&&(this._analyser=new s(this._recorder.stream())),this._analyser?this._analyser.soundLevel():0},testSoundLevel:function(e){this._analyser&&(this._analyser.weakDestroy(),delete this._analyser),e&&s.supported()&&(this._analyser=new s(this._recorder.stream()))},currentDevices:function(){return{video:this._currentVideo,audio:this._currentAudio}},enumerateDevices:function(){return h.enumerateMediaSources().success(function(e){this._detectCurrentDeviceId(e.video,e.videoCount,!0),this._detectCurrentDeviceId(e.audio,e.audioCount,!1);var t=this.auto_destroy(new o({start:!0,delay:100,context:this,destroy_on_stop:!0,fire:function(){this._currentVideo&&this._currentAudio&&(this.trigger("currentdevicesdetected",{video:this._currentVideo,audio:this._currentAudio}),t.stop())}}))},this)},addMultiStream:function(e,t){return this._recorder.addNewSingleStream(e,t)},reverseCameraScreens:function(){return this._recorder.reverseVideos()},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video),e&&e.audio&&this._recorder.selectMicrophone(e.audio)},setCameraFace:function(e){r.isMobile()&&this._recorder.selectCameraFace(e)},createSnapshot:function(e){return this._recorder.createSnapshot(e)},removeSnapshot:function(e){},createSnapshotDisplay:function(e,t,i,s,r,n){var o=h.globals().URL.createObjectURL(t),a=document.createElement("img");return a.style.position="absolute",this.updateSnapshotDisplay(t,a,i,s,r,n),a.src=o,"video"===e.tagName.toLowerCase()?d.elementInsertAfter(a,e):d.elementPrependChild(e,a),a},updateSnapshotDisplay:function(e,t,i,s,r,n){t.style.left=i+"px",t.style.top=s+"px",t.style.width=r+"px",t.style.height=n+"px"},removeSnapshotDisplay:function(e){e.remove()},createSnapshotUploader:function(e,t,i){return l.create(a.extend({source:e},i))},startRecord:function(e){return this.__localPlaybackSource=null,this._recorder.startRecord(e)},pauseRecord:function(){return this._recorder.pauseRecord()},resumeRecord:function(){return this._recorder.resumeRecord()},stopRecord:function(r){var n=_.create();return this._recorder.once("data",function(e,t,i){this.__localPlaybackSource={src:e,audiosrc:t};var s=new u;this._options.simulate||i||(e&&s.addUploader(l.create(a.extend({source:e},r.video))),t&&s.addUploader(l.create(a.extend({source:t},r.audio)))),n.asyncSuccess(s)},this),this._recorder.stopRecord(),n},supportsLocalPlayback:function(){return!!this.__localPlaybackSource.src},supportsCameraFace:function(){return r.isMobile()},snapshotToLocalPoster:function(e){return e},localPlaybackSource:function(){return this.__localPlaybackSource},averageFrameRate:function(){return this._recorder.averageFrameRate()},_softwareDependencies:function(){if(!this._options.screen||h.globals().supportedConstraints.mediaSource)return _.value(!0);var e=h.chromeExtensionExtract(this._options.screen),t=[{title:"Screen Recorder Extension",execute:function(){window.open(e.extensionInstallLink)}}],i=n.now();return h.chromeExtensionMessage(e.extensionId,{type:"ping",data:i}).mapError(function(){return t}).mapSuccess(function(e){return!(!e||"success"!==e.type||e.data!==i)||_.error(t)})},_detectCurrentDeviceId:function(i,s,r){var n,e,o;return(e=r?(n=this._recorder._videoTrack,this._recorder._videoTrackSettings):(n=this._recorder._audioTrack,this._recorder._audioTrackSettings))&&n?e.deviceId&&i[e.deviceId]?(r?this._currentVideo=i[e.deviceId].id:this._currentAudio=i[e.deviceId].id,i[e.deviceId].id):n.label?(o=1,void a.iter(i,function(e,t){return 0===c.byValue(e.label,n.label)?(r?this._currentVideo=t:this._currentAudio=t,t):s<=o?(r?this._currentVideo=a.ithKey(i):this._currentAudio=a.ithKey(i),a.ithKey(i)):void o++},this)):(r?this._currentVideo=a.ithKey(i):this._currentAudio=a.ithKey(i),a.ithKey(i)):(r?this._currentVideo=a.ithKey(i):this._currentAudio=a.ithKey(i),a.ithKey(i))}}},{supported:function(e){return!e.forceflash&&(!!i.anySupport(e)&&(!e.screen||(!!(h.globals().supportedConstraints.mediaSource&&r.isFirefox()&&55<r.firefoxVersion())||(!(!r.isChrome()||!e.screen.chromeExtensionId)||!(!r.isOpera()||!e.screen.operaExtensionId)))))}})}),e.define("module:Recorder.FlashVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Flash.FlashRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(e,i,s,r,n,o,a,h,d,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this,e),"div"!==this._element.tagName.toLowerCase()&&(this._element=s.changeTag(this._element,"div")),this._recorder=new i(this._element,{flip:!!this._options.flip,disableaudio:!this._options.recordAudio,disablevideo:!this._options.recordVideo,streamtype:this._options.rtmpStreamType,camerawidth:this._options.recordingWidth,cameraheight:this._options.recordingHeight,microphonecodec:this._options.rtmpMicrophoneCodec,fps:this._options.framerate,audioRate:this._options.audioBitrate?Math.floor(this._options.audioBitrate/1e3):undefined,videoRate:this._options.videoBitrate?1e3*this._options.videoBitrate:undefined}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this),this._recorder.on("endpoint_connectivity",function(e,t){this.trigger("endpoint_connectivity",e,t)},this)},destroy:function(){this._recorder.destroy(),t.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},lightLevel:function(){return this._recorder.lightLevel()},soundLevel:function(){var e=this._recorder.soundLevel();return e<=1?1:1+(e-1)/100},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(e){this._recorder.setVolumeGain(e)},testSoundLevel:function(e){this._recorder.testSoundLevel(e)},enumerateDevices:function(){var e=this._recorder.enumerateDevices();return n.value({videoCount:o.count(e.videos),audioCount:o.count(e.audios),video:o.map(e.videos,function(e,t){return{id:t,label:e}}),audio:o.map(e.audios,function(e,t){return{id:t,label:e}})})},currentDevices:function(){return{video:this._recorder.currentCamera(),audio:this._recorder.currentMicrophone()}},setCurrentDevices:function(e){e&&e.video&&this._recorder.selectCamera(e.video),e&&e.audio&&this._recorder.selectMicrophone(e.audio)},createSnapshot:function(e){return this._recorder.createSnapshot()},createSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.createSnapshotDisplay(t,i,s,r,n)},updateSnapshotDisplay:function(e,t,i,s,r,n){return this._recorder.updateSnapshotDisplay(e,t,i,s,r,n)},removeSnapshotDisplay:function(e){this._recorder.removeSnapshotDisplay(e)},createSnapshotUploader:function(e,t,i){var s=new h(o.extend({source:e,type:t,recorder:this._recorder},i));return s.on("upload",function(e){e.recorder.postSnapshot(e.source,e.url,e.type).success(s.successCallback,s).error(s.errorCallback,s)}),s},startRecord:function(e){if(this._options.simulate)return n.value(!0);var t=this,i={},s=n.create();return this._recorder.on("recording",function(){s.asyncSuccess(),t._recorder.off(null,null,i)},i).on("error",function(e){s.asyncError(e),t._recorder.off(null,null,i)},i),this._recorder.startRecord(e.rtmp),s},stopRecord:function(e){if(this._options.simulate)return n.value(new d);var t=this,i={},s=new h,r=null;return r=new a({delay:100,context:this,fire:function(){if(this._recorder&&!this._recorder.destroyed()){var e=this._recorder.uploadStatus();s.progressCallback(e.total-e.remaining,e.total)}else r.destroy()}}),this._recorder.on("finished",function(){s.successCallback(!0),t._recorder.off(null,null,i),r.weakDestroy()},i).on("error",function(e){s.errorCallback(e),t._recorder.off(null,null,i),r.weakDestroy()},i),this._recorder.stopRecord(),n.create(s)},isFlash:function(){return!0},averageFrameRate:function(){return this._recorder.averageFrameRate()},_softwareDependencies:function(){return r.flash().installed()?n.value(!0):n.error([{title:"Adobe Flash",execute:function(){window.open("https://get.adobe.com/flashplayer")}}])}}},{supported:function(e){return!r.isMobile()&&!e.noflash&&r.flash().supported()&&!e.screen}})}),e.extend("module:Recorder.WebRTCVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Recorder.WebRTCVideoRecorderWrapper"],function(e,t){return e.register(t,2),{}}),e.extend("module:Recorder.VideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Recorder.FlashVideoRecorderWrapper"],function(e,t){return e.register(t,1),{}}),e.define("module:WebRTC.AudioAnalyser",["base:Class","module:WebRTC.Support"],function(e,i,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),this._audioContext=i.globals().audioContext,this._analyserNode=this._audioContext.createAnalyser.call(this._audioContext),this._analyserNode.fftSize=32,0<e.getAudioTracks().length&&(this._audioInput=this._audioContext.createMediaStreamSource(e),this._audioInput.connect(this._analyserNode))},destroy:function(){this._analyserNode.disconnect(),delete this._analyserNode,t.destroy.call(this)},soundLevel:function(){if(!this._audioInput)return 0;var e=this._analyserNode.fftSize,t=new Uint8Array(e);this._analyserNode.getByteTimeDomainData(t);for(var i=0,s=0;s<e;s++)i=Math.max(i,Math.abs(t[s]/128));return i}}},{supported:function(){return!!i.globals().AudioContext&&!!i.globals().createAnalyser&&!!i.globals().audioContext}})}),e.define("module:WebRTC.AudioRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Promise","base:Functions","module:WebRTC.Support","module:Encoding.WaveEncoder.Support"],function(e,t,s,r,n,o,a,i){return e.extend({scoped:i},[t,function(i){return{constructor:function(e,t){i.constructor.call(this),this._channels=[],this._recordingLength=0,this._options=s.extend({audioChannels:2,bufferSize:16384,sampleRate:44100},t),this._stream=e,this._started=!1,this._stopped=!1,this._volumeGainValue=1},_audioProcess:function(e){this._started&&(this._channels.push(a.dumpInputBuffer(e.inputBuffer,this._options.audioChannels,this._actualBufferSize)),this._recordingLength+=this._actualBufferSize)},destroy:function(){this.stop(),i.destroy.call(this)},getVolumeGain:function(){return this._volumeGainValue},setVolumeGain:function(e){this._volumeGainValue=e,this._volumeGain&&(this._volumeGain.value.gain=e)},__initializeContext:function(){var e=o.globals().AudioContext;this._audioContext=new e,this._actualSampleRate=this._audioContext.sampleRate||this._options.sampleRate,this._volumeGain=this._audioContext.createGain(),this._volumeGain.gain.value=this._volumeGainValue,this._audioInput=this._audioContext.createMediaStreamSource(this._stream),this._audioInput.connect(this._volumeGain),this._scriptProcessor=o.globals().audioContextScriptProcessor.call(this._audioContext,this._options.bufferSize,this._options.audioChannels,this._options.audioChannels),this._actualBufferSize=this._scriptProcessor.bufferSize,this._scriptProcessor.onaudioprocess=n.as_method(this._audioProcess,this),this._volumeGain.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)},__finalizeContext:function(){this._scriptProcessor.disconnect(),this._volumeGain.disconnect(),this._audioInput.disconnect(),this._scriptProcessor.onaudioprocess=null,this._audioContext.close(),delete this._scriptProcessor,delete this._volumeGain,delete this._audioInput,delete this._audioContext},start:function(){return this._started||(this.__initializeContext(),this._startContextTime=this._audioContext.currentTime,this._started=!0,this._stopped=!1,this._recordingLength=0,this._channels=[],this.trigger("started")),r.value(!0)},stop:function(){this._started&&!this._stopped&&(this._stopContextTime=this._audioContext.currentTime,this._stopped=!0,this.trigger("stopped"),this.__finalizeContext(),this._started=!1,this._generateData())},_generateData:function(){var t=44,e=this._recordingLength*this._options.audioChannels*2+44,i=new ArrayBuffer(e),s=new DataView(i);a.generateHeader(e,this._options.audioChannels,this._actualSampleRate,i),this._channels.forEach(function(e){a.waveChannelTransform(e,1).value().forEach(function(e){s.setInt16(t,e,!0),t+=2})}),this._data=new Blob([s],{type:"audio/wav"}),this._leftChannel=[],this._rightChannel=[],this._recordingLength=0,this.trigger("data",this._data)}}}],{supported:function(){return!!o.globals().AudioContext&&!!o.globals().audioContextScriptProcessor}})}),e.define("module:WebRTC.MediaRecorder",["base:Class","base:Events.EventsMixin","base:Functions","base:Promise","browser:Info","module:WebRTC.Support"],function(e,t,o,i,s,a,r){return e.extend({scoped:r},[t,function(n){return{constructor:function(e,t){t=t||{},n.constructor.call(this),this._stream=e,this._started=!1;var i=a.globals().MediaRecorder,s={mimeType:""};try{t.audioonly?i.isTypeSupported("audio/mp3")?s={mimeType:"audio/mp3"}:i.isTypeSupported("audio/ogg;codecs=opus")&&(s={mimeType:"audio/ogg;codecs=opus"}):i.isTypeSupported("video/webm;codecs=vp9")?s={mimeType:"video/webm;codecs=vp9"}:i.isTypeSupported("video/webm;codecs=vp8")?s={mimeType:"video/webm;codecs=vp8"}:i.isTypeSupported("video/webm")&&(s={mimeType:"video/webm"})}catch(r){s={}}t.videoBitrate&&(s.videoBitsPerSecond=1e3*t.videoBitrate),t.audioBitrate&&(s.audioBitsPerSecond=1e3*t.audioBitrate),this.__audioonly=t.audioonly,this.__mediaRecorderOptions=s,this._mediaRecorder=new i(e,s),this._mediaRecorder.ondataavailable=o.as_method(this._dataAvailable,this),this._mediaRecorder.onstop=o.as_method(this._dataStop,this),this._mediaRecorder.onpause=o.as_method(this._hasPaused,this),this._mediaRecorder.onresume=o.as_method(this._hasResumed,this)},destroy:function(){this.stop(),n.destroy.call(this)},start:function(){return this._started||(this._started=!0,this._chunks=[],this._mediaRecorder.start(10),this.trigger("started")),i.value(!0)},pause:function(){!this._paused&&this._started&&(this._paused=!0,this._mediaRecorder.pause(),this.trigger("pause"))},_hasPaused:function(){this.trigger("paused")},resume:function(){this._paused&&this._started&&(this._paused=!1,this._mediaRecorder.resume(),this.trigger("resume"))},_hasResumed:function(){this.trigger("resumed")},stop:function(){this._started&&(this._started=!1,this._mediaRecorder.stop(),this.trigger("stopped"))},_dataAvailable:function(e){e.data&&0<e.data.size&&this._chunks.push(e.data)},_dataStop:function(e){if(this._data=new Blob(this._chunks,{type:this.__mediaRecorderOptions.mimeType.split(";")[0]||(this.__audioonly?"audio/ogg":"video/webm")}),this._chunks=[],s.isFirefox()){var t=this,i=new FileReader;i.onload=function(){t._data=new Blob([this.result],{type:t._data.type}),t.trigger("data",t._data)},i.readAsArrayBuffer(this._data)}else this.trigger("data",this._data)}}}],{supported:function(){return!!a.globals().MediaRecorder&&((0===document.location.href.indexOf("https://")||"localhost"===document.location.hostname||!s.isOpera()&&!s.isChrome())&&(!(s.isOpera()&&s.operaVersion()<44)&&!(s.isChrome()&&s.chromeVersion()<57)))}})}),e.define("module:WebRTC.PeerRecorder",["base:Class","base:Events.EventsMixin","base:Functions","base:Objs","base:Promise","base:Async","browser:Info","module:WebRTC.Support"],function(e,t,r,o,n,a,i,h,s){return e.extend({scoped:s},[t,function(i){return{constructor:function(e,t){i.constructor.call(this),this._stream=e,!t.videoBitrate&&t.recorderWidth&&t.recorderHeight&&(t.videoBitrate=Math.round(t.recorderWidth*t.recorderHeight/250)),this._videoBitrate=t.videoBitrate||1024,this._audioBitrate=t.audioBitrate||256,this._audioonly=t.audioonly,this._started=!1},destroy:function(){this.stop(),i.destroy.call(this)},start:function(e){if(this._started)return n.value(!0);this._wssUrl=e.wssUrl,this._streamInfo=e.streamInfo,this._userData=e.userData||{},this._delay=e.delay||0,this._started=!0,this._wsConnection=new(h.globals().WebSocket)(this._wssUrl),this._wsConnection.binaryType="arraybuffer",this._wsConnection.onopen=r.as_method(this._wsOnOpen,this),this._wsConnection.onmessage=r.as_method(this._wsOnMessage,this),this._wsConnection.onclose=r.as_method(this._wsOnClose,this),this._wsConnection.onerror=this._errorCallback("WS_CONNECTION");var t=n.create(),i={},s=this;return this.on("started",function(){s.off(null,null,i),t.asyncSuccess(!0)},i).on("error",function(e){s.off(null,null,i),t.asyncError(e)},i),t},stop:function(){this._started&&(this._started=!1,this._peerConnection&&this._peerConnection.close(),this._peerConnection=null,this._wsConnection&&this._wsConnection.close(),this._wsConnection=null,this.trigger("stopped"))},_wsOnOpen:function(){this._peerConnection=new(h.globals().RTCPeerConnection)({iceServers:[]}),this._stream.getTracks&&this._peerConnection.addTrack?o.iter(this._stream.getTracks(),function(e){this._peerConnection.addTrack(e,this._stream)},this):this._peerConnection.addStream(this._stream);var e=this._peerConnection.createOffer();e.then(r.as_method(this._offerGotDescription,this)),e["catch"](this._errorCallback("PEER_CREATE_OFFER"))},_wsOnMessage:function(e){var t=JSON.parse(e.data),i=parseInt(t.status,10);t.command;if(200!==i)this._error("MESSAGE_ERROR",{status:i,description:t.statusDescription});else{if(t.sdp!==undefined){var s=this._peerConnection.setRemoteDescription(new(h.globals().RTCSessionDescription)(t.sdp));s.then(function(){}),s["catch"](this._errorCallback("PEER_REMOTE_DESCRIPTION"))}t.iceCandidates&&o.iter(t.iceCandidates,function(e){this._peerConnection.addIceCandidate(new(h.globals().RTCIceCandidate)(e))},this),a.eventually(function(){this.trigger("started")},this,this._delay)}this._wsConnection&&this._wsConnection.close(),this._wsConnection=null},_offerGotDescription:function(e){var t={};return this._audioBitrate&&(t.audioBitrate=this._audioBitrate),this._videoBitrate&&!this._audioonly&&(t.videoBitrate=this._videoBitrate),e.sdp=this._enhanceSDP(e.sdp,t),this._peerConnection.setLocalDescription(e).then(r.as_method(function(){this._wsConnection.send(JSON.stringify({direction:"publish",command:"sendOffer",streamInfo:this._streamInfo,sdp:e,userData:this._userData}))},this))["catch"](this._errorCallback("Peer Local Description"))},_enhanceSDP:function(e,t){var i=e.split(/\r\n/),s="header",r=!1,n="";return o.iter(i,function(e){e.length<=0||(n+=e+"\r\n",0===e.indexOf("m=audio")?r=!(s="audio"):0===e.indexOf("m=video")&&(r=!(s="video")),0===e.indexOf("a=mid:")&&(r||(0==="audio".localeCompare(s)?t.audioBitrate!==undefined&&(n+="b=AS:"+t.audioBitrate+"\r\n",n+="b=TIAS:"+1024*t.audioBitrate+"\r\n"):0==="video".localeCompare(s)&&t.videoBitrate!==undefined&&(n+="b=AS:"+t.videoBitrate+"\r\n",n+="b=TIAS:"+1024*t.videoBitrate+"\r\n"),r=!0)))},this),n},_wsOnClose:function(){},_error:function(e,t){this.trigger("error",e+" "+t.toString(),t),this.stop()},_errorCallback:function(t){return r.as_method(function(e){this._error(t,e)},this)}}}],{supported:function(){if(i.isEdge())return!1;if(i.isSafari()&&i.safariVersion()<11)return!1;if(0!==document.location.href.indexOf("https://")&&"localhost"!==document.location.hostname){if(i.isChrome()&&47<=i.chromeVersion())return!1;if(i.isOpera()&&34<=i.operaVersion())return!1}return h.globals().RTCPeerConnection&&h.globals().RTCIceCandidate&&h.globals().RTCSessionDescription&&h.globals().WebSocket}})}),e.define("module:WebRTC.RecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Async","base:Promise","base:Time","module:WebRTC.Support","module:Recorder.Support","module:Recorder.PixelSampleMixin"],function(e,t,d,h,i,s,r,n,o,a){return e.extend({scoped:a},[t,o,function(t){return{constructor:function(e){t.constructor.call(this,e),this._video=e.video,this._localPlaybackRequested=e.localPlaybackRequested,this._recording=!1,this._bound=!1,this._hasAudio=!1,this._hasVideo=!1,this._screen=e.screen,this._flip=!!e.flip},_getConstraints:function(){return{audio:!!this._options.recordAudio&&{sourceId:this._options.audioId},video:!!this._options.recordVideo&&{frameRate:this._options.framerate,sourceId:this._options.videoId,width:this._options.recordResolution.width,height:this._options.recordResolution.height,cameraFaceFront:this._options.cameraFaceFront},screen:this._screen}},addNewSingleStream:function(e,t){var i,s,r,n,o,a,h;return this._initMultiStreamSettings(),a=this._options.video.aspectRatio,s=t.positionX||0,r=t.positionY||0,o=t.width||.2*this._options.recordResolution.width||120,(n=t.height)||(n=a?Math.floor(o*a):Math.floor(o/1.33)),h={video:i={frameRate:this._options.framerate,sourceId:e.id,cameraFaceFront:this._options.cameraFaceFront}},this._prepareMultiStreamCanvas(),this._multiStreamConstraints=h,this.__addedStreamOptions=d.tree_merge(i,{positionX:s,positionY:r,width:o,height:n}),this.addNewMediaStream()},addNewMediaStream:function(){var t=i.create();return this._multiStreams.length<1&&this._multiStreams.push(this._stream),r.userMedia2(this._multiStreamConstraints,this).success(function(e){this._multiStreams.push(e),this._addNewVideoElement(t),this.on("multistream-canvas-drawn",function(){return t.asyncSuccess()},this)},this)},recordDelay:function(e){return 0},stream:function(){return this._stream},isWebrtcStreaming:function(){return!1},canPause:function(){return!1},bindMedia:function(){if(!this._bound)return r.userMedia2(this._getConstraints()).success(function(e){this._hasAudio=this._options.recordAudio&&0<e.getAudioTracks().length,this._hasVideo=this._options.recordVideo&&0<e.getVideoTracks().length,this._bound=!0,this._stream=e,r.bindStreamToVideo(e,this._video,this._flip),this.trigger("bound",e),this._setLocalTrackSettings(e),this._boundMedia()},this)},selectCamera:function(e){this._options.videoId=e,this._bound&&(this.unbindMedia(),this.bindMedia())},selectMicrophone:function(e){this._options.audioId=e,this._bound&&(this.unbindMedia(),this.bindMedia())},selectCameraFace:function(e){this._options.cameraFaceFront=e,this._bound&&(this.unbindMedia(),this.bindMedia())},startRecord:function(e){if(this._recording)return i.value(!0);this._recording=!0;var t=this._startRecord(e);return t.success(function(){this._pausedDuration=0,this._startTime=s.now()},this),t},pauseRecord:function(){this.canPause()&&!this._paused&&(this._paused=!0,this._recorder.once("paused",function(){this.trigger("paused"),this.__pauseStartTime=s.now()},this),this._recorder.pause())},resumeRecord:function(){this.canPause()&&this._paused&&(this._paused=!1,this._recorder.once("resumed",function(){this.trigger("resumed"),this._pausedDuration+=s.now()-this.__pauseStartTime,delete this.__pauseStartTime},this),this._recorder.resume())},stopRecord:function(){this._recording&&(this._recording=!1,this._stopRecord(),this._stopTime=s.now())},duration:function(){return(this._recording||!this._stopTime?s.now():this._stopTime)-this._startTime-this._pausedDuration-(this.__pauseStartTime!==undefined?s.now()-this.__pauseStartTime:0)},unbindMedia:function(){this._bound&&!this._recording&&(r.stopUserMediaStream(this._stream,this._sourceTracks),this._bound=!1,this.trigger("unbound"),this._unboundMedia())},createSnapshot:function(e){return n.createSnapshot(e,this._video)},_pixelSample:function(e,t,i){e=e||100;var s=this._video.videoWidth||this._video.clientWidth,r=this._video.videoHeight||this._video.clientHeight,n=Math.ceil(Math.sqrt(s/r*e)),o=Math.ceil(Math.sqrt(r/s*e)),a=document.createElement("canvas");a.width=n,a.height=o;var h=a.getContext("2d");h.drawImage(this._video,0,0,n,o);for(var d=0;d<e;++d){var c=d%n,l=Math.floor(d/n),u=h.getImageData(c,l,1,1).data;t.call(i||this,u[0],u[1],u[2])}},_initMultiStreamSettings:function(){this._multiStreams=[],this._videoElements=[],this._audioInputs=[],this._sourceTracks=[],this._multiStreamConstraints={},this._drawingStream=!1},_prepareMultiStreamCanvas:function(){var e=this._video.clientHeight||this._video.videoHeight,t=this._video.clientWidth||this._video.videoWidth;"undefined"==typeof this.__multiStreamCanvas&&(this.__multiStreamCanvas=document.createElement("canvas")),this.__multiStreamCanvas.setAttribute("width",t+"px"),this.__multiStreamCanvas.setAttribute("height",e+"px"),this.__multiStreamCanvas.setAttribute("style","position:fixed; left: 200%; pointer-events: none"),this.__multiStreamCtx=this.__multiStreamCanvas.getContext("2d")},_setLocalTrackSettings:function(e){if(void 0!==e.getVideoTracks()&&e.getVideoTracks()[0])if(this._videoTrack=e.getVideoTracks()[0],this._options.screen){var t=this;this._videoTrack.applyConstraints({resizeMode:"none"}).then(function(){void 0!==t._videoTrack.getSettings()&&(t._videoTrackSettings=t._videoTrack.getSettings())})}else void 0!==this._videoTrack.getSettings()&&(this._videoTrackSettings=this._videoTrack.getSettings());void 0!==e.getAudioTracks()&&e.getAudioTracks()[0]&&(this._audioTrack=e.getAudioTracks()[0],void 0!==this._audioTrack.getSettings()&&(this._audioTrackSettings=this._audioTrack.getSettings()))},_addNewVideoElement:function(r){d.iter(this._multiStreams,function(t,e){var i=t.getTracks();if(d.iter(i,function(e){this._sourceTracks.push(e),"video"===e.kind&&(e.id!==this._videoTrack.id?this._videoElements.push(this._singleVideoElement(this.__addedStreamOptions,t,!0)):this._videoElements.push(this._singleVideoElement(this._getConstraints().video,t))),"audio"===e.kind&&this._audioInputs.push(e)},this),this._videoElements.length+this._audioInputs.length===i.length)try{this._drawingStream=!0,this._drawTracksToCanvas(),this._startMultiStreaming()}catch(s){console.warn(s)}h.eventually(function(){if(!this._drawingStream)return r.asyncError({message:"Could not be able to get required tracks"})},this,1e3)},this)},_drawTracksToCanvas:function(){if(this._drawingStream)for(var e=this._videoElements.length,t=0;t<this._videoElements.length;t++){var i,s,r,n,o,a;i=this._videoElements[t],o=(s=0!==t?this.__addedStreamOptions:{}).positionX||0,a=s.positionY||0,n=i.__multistreamElement?(r=s.width||360,s.height||240):(r=this.__multiStreamCanvas.width||s.width||360,this.__multiStreamCanvas.height||s.height||240),this.__multiStreamCtx.drawImage(i,o,a,r,n),0===--e&&h.eventually(this._drawTracksToCanvas,[],this,1e3/30)}},reverseVideos:function(){if(this._drawingStream)for(var e=document.createElement("video"),t=0;t<this._videoElements.length;t++)e.srcObject?e.srcObject&&(this._videoElements[t].srcObject=e.srcObject,this._videoElements[t].load(),this._videoElements[t].oncanplay=function(){this.play()},e.remove()):(e.srcObject=this._videoElements[t].srcObject,this._videoElements[t].srcObject=this._videoElements[t+1].srcObject,this._videoElements[t].load(),this._videoElements[t].oncanplay=function(){this.play()})},_startMultiStreaming:function(){var e=this.__multiStreamCanvas.captureStream(25);e.addTrack(this._audioInputs[0]),this._stream=e,r.bindStreamToVideo(e,this._video,this._flip),this.trigger("bound",e),this.trigger("multistream-canvas-drawn"),this._setLocalTrackSettings(e),this._boundMedia(e)},_singleVideoElement:function(e,t,i){var s=r.bindStreamToVideo(t);return(i=i||!1)&&(s.__multistreamElement=!0),s.muted=!0,s.volume=0,s.width=this.__addedStreamOptions.width||e.width||360,s.height=this.__addedStreamOptions.height||e.height||240,s.oncanplay=function(){this.play()},s},_boundMedia:function(){},_unboundMedia:function(){},_startRecord:function(e){},_stopRecord:function(){},_error:function(e,t){this.trigger("error",e,t)},getVolumeGain:function(){},setVolumeGain:function(e){},_dataAvailable:function(e,t,i){this.destroyed()||this.trigger("data",e,t,i)},destroy:function(){this.stopRecord(),this.unbindMedia(),t.destroy.call(this)},averageFrameRate:function(){return null}}}],{_initializeOptions:function(e){return d.extend({recordAudio:!0,recordVideo:!0,recordResolution:{width:320,height:200}},e)},supported:function(e){return!!r.globals().getUserMedia&&!!r.globals().URL}})}),e.define("module:WebRTC.PeerRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.PeerRecorder","module:WebRTC.MediaRecorder","browser:Info","base:Async"],function(e,i,t,s,r,n){return e.extend({scoped:n},{_boundMedia:function(){this._recorder=new i(this._stream,{recorderWidth:this._options.recordResolution.width,recorderHeight:this._options.recordResolution.height,videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,audioonly:!this._options.recordVideo}),this._localPlaybackRequested&&t.supported()&&(this.__localMediaRecorder=new t(this._stream)),this._recorder.on("error",this._error,this)},_unboundMedia:function(){this._recorder.destroy(),this.__localMediaRecorder&&this.__localMediaRecorder.weakDestroy()},_startRecord:function(e){return this.__localMediaRecorder&&this.__localMediaRecorder.start(),this._recorder.start(e.webrtcStreaming)},isWebrtcStreaming:function(){return!0},_stopRecord:function(){this._recorder.stop();var t=null;this.__localMediaRecorder&&(this.__localMediaRecorder.once("data",function(e){t=e}),this.__localMediaRecorder.stop()),r.eventually(function(){this._dataAvailable(t,null,!0)},this,this.__stopDelay||this._options.webrtcStreaming.stopDelay||0)},recordDelay:function(e){return this.__stopDelay=e.webrtcStreaming.stopDelay,e.webrtcStreaming.delay||0},getVolumeGain:function(){},setVolumeGain:function(e){},averageFrameRate:function(){return null}},function(t){return{supported:function(e){return!!t.supported.call(this,e)&&((!e.screen||!s.isFirefox())&&(e.webrtcStreaming&&i.supported()&&!e.webrtcStreamingIfNecessary))}}})}),e.define("module:WebRTC.PeerRecorderWrapperIfNecessary",["module:WebRTC.PeerRecorderWrapper","base:Objs"],function(e,i,t){return e.extend({scoped:t},{},function(t){return{supported:function(e){return e.webrtcStreamingIfNecessary&&((e=i.clone(e,1)).webrtcStreamingIfNecessary=!1,e.webrtcStreaming=!0),t.supported.call(this,e)}}})}),e.define("module:WebRTC.MediaRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.MediaRecorder"],function(e,i,t){return e.extend({scoped:t},{_boundMedia:function(e){e=e||this._stream,this._recorder=new i(e,{videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,audioonly:!this._options.recordVideo}),this._recorder.on("data",function(e){this._dataAvailable(e)},this)},_unboundMedia:function(){this._recorder.destroy(),this._drawingStream&&this._initMultiStreamSettings()},_startRecord:function(){return this._recorder.start()},_stopRecord:function(){this._recorder.stop()},canPause:function(){return!0},getVolumeGain:function(){},setVolumeGain:function(e){},averageFrameRate:function(){return null}},function(t){return{supported:function(e){return!!t.supported.call(this,e)&&(!e.recordFakeVideo&&i.supported())}}})}),e.define("module:WebRTC.WhammyAudioRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.AudioRecorder","module:WebRTC.WhammyRecorder","browser:Info","base:Promise"],function(e,i,s,r,t,n){return e.extend({scoped:n},{_createSnapshot:function(e){return this._whammyRecorder.createSnapshot(e)},_boundMedia:function(){this._videoBlob=null,this._audioBlob=null,this._hasVideo?this._whammyRecorder=new s(this._stream,{video:this._video,framerate:this._options.framerate}):this._whammyRecorder=new s(null,{framerate:this._options.framerate}),this._hasAudio&&(this._audioRecorder=new i(this._stream),this._audioRecorder.on("data",function(e){this._audioBlob=e,!this._videoBlob&&this._hasVideo||this._dataAvailable(this._videoBlob,this._audioBlob)},this)),this._whammyRecorder.on("data",function(e){this._videoBlob=e,!this._audioBlob&&this._hasAudio||this._dataAvailable(this._videoBlob,this._audioBlob)},this)},_unboundMedia:function(){this._hasAudio&&this._audioRecorder.destroy(),this._whammyRecorder.destroy()},_startRecord:function(){var e=[];return e.push(this._whammyRecorder.start()),this._hasAudio&&e.push(this._audioRecorder.start()),t.and(e)},_stopRecord:function(){this._whammyRecorder.stop(),this._hasAudio&&this._audioRecorder.stop()},getVolumeGain:function(){return this._audioRecorder?this._audioRecorder.getVolumeGain():1},setVolumeGain:function(e){this._audioRecorder&&this._audioRecorder.setVolumeGain(e)},averageFrameRate:function(){return this._whammyRecorder.averageFrameRate()}},function(t){return{supported:function(e){if(!t.supported.call(this,e))return!1;if(0!==document.location.href.indexOf("https://")&&"localhost"!==document.location.hostname){if(r.isChrome()&&47<=r.chromeVersion())return!1;if(r.isOpera()&&34<=r.operaVersion())return!1}return i.supported()&&s.supported(!e.recordVideo)}}})}),e.extend("module:WebRTC.RecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.PeerRecorderWrapper","module:WebRTC.MediaRecorderWrapper","module:WebRTC.WhammyAudioRecorderWrapper","module:WebRTC.PeerRecorderWrapperIfNecessary"],function(e,t,i,s,r){return e.register(t,4),e.register(i,3),e.register(s,2),e.register(r,1),{}}),e.define("module:WebRTC.Support",["base:Promise","base:Objs","browser:Info","browser:Dom","base:Time"],function(h,d,c,l,u){return{canvasSupportsImageFormat:function(e){try{var t=document.createElement("canvas").toDataURL(e);t.indexOf(";");return-1!=t.substring(0,t.indexOf(";")).indexOf(e)}catch(i){return!1}},getGlobals:function(){var e=null,t=null;t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(e=navigator.mediaDevices.getUserMedia,navigator.mediaDevices):(e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator);var i=window.URL||window.webkitURL,s=window.MediaRecorder,r=window.AudioContext||window.webkitAudioContext;r&&l.userInteraction(function(){if(this.__globals){var e=new r;this.__globals.audioContext=e,this.__globals.audioContextScriptProcessor=e.createJavaScriptNode||e.createScriptProcessor,this.__globals.createAnalyser=e.createAnalyser}},this);var n=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,o=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,a=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,h=window.WebSocket;return{getUserMedia:e,getUserMediaCtx:t,URL:i,MediaRecorder:s,AudioContext:r,webpSupport:this.canvasSupportsImageFormat("image/webp"),RTCPeerConnection:n,RTCIceCandidate:o,RTCSessionDescription:a,WebSocket:h,supportedConstraints:navigator.mediaDevices&&navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{}}},globals:function(){return this.__globals||(this.__globals=this.getGlobals()),this.__globals},userMediaSupported:function(){return!!this.globals().getUserMedia},enumerateMediaSources:function(){var t=h.create(),e=function(e){var i={audio:{},audioCount:0,video:{},videoCount:0};d.iter(e,function(e){var t;0===e.kind.indexOf("video")&&(i.videoCount++,"undefined"!=typeof e.getCapabilities&&(t=e.getCapabilities()),i.video[e.id||e.deviceId]={id:e.id||e.deviceId,label:e.label,capabilities:t}),0===e.kind.indexOf("audio")&&(i.audioCount++,"undefined"!=typeof e.getCapabilities&&(t=e.getCapabilities()),i.audio[e.id||e.deviceId]={id:e.id||e.deviceId,label:e.label,capabilities:t})}),t.asyncSuccess(i)};try{navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(e):MediaStreamTrack&&MediaStreamTrack.getSources?MediaStreamTrack.getSources(e):t.asyncError("Unsupported")}catch(i){t.asyncError(i)}return t},streamQueryResolution:function(e){var t=h.create(),i=this.bindStreamToVideo(e);return i.addEventListener("playing",function(){setTimeout(function(){t.asyncSuccess({stream:e,width:i.videoWidth,height:i.videoHeight}),i.remove()},500)}),t},chromeExtensionMessage:function(e,t){var i=h.create();return chrome.runtime.sendMessage(e,t,i.asyncSuccessFunc()),i},chromeExtensionExtract:function(e){var t={};return c.isChrome()?(t.extensionId=e.chromeExtensionId,t.extensionInstallLink=e.chromeExtensionInstallLink):c.isOpera()&&(t.extensionId=e.operaExtensionId,t.extensionInstallLink=e.operaExtensionInstallLink),t},userMedia:function(e){var t=h.create(),i=this.globals().getUserMedia.call(this.globals().getUserMediaCtx,e,function(e){t.asyncSuccess(e)},function(e){t.asyncError(e)});try{i.then&&i.then(function(e){t.asyncSuccess(e)}),i["catch"]&&i["catch"](function(e){t.asyncError(e)})}catch(s){}return t},userMedia2:function(s){var i={};if(s.audio&&(i.audio=s.audio),s.screen&&!s.video&&(s.video={}),!s.video)return this.userMedia(i);if(s.screen&&(s.video.width=s.video.width||window.innerWidth||document.body.clientWidth,s.video.height=s.video.height||window.innerHeight||document.body.clientHeight),c.isiOS())return i.video={},s.video.width&&(i.video.width=s.video.width),s.video.height&&(i.video.height=s.video.height),s.video.frameRate&&(i.video.frameRate=s.video.frameRate),s.video.cameraFaceFront!==undefined&&(i.video.facingMode={exact:s.video.cameraFaceFront?"user":"environment"}),this.userMedia(i);if(c.isFirefox())return i.video={},!s.screen||(i.video.mediaSource="screen",navigator.mediaDevices&&navigator.mediaDevices.getSupportedConstraints&&navigator.mediaDevices.getSupportedConstraints().mediaSource)?(!s.video.aspectRatio||s.video.width&&s.video.height||(s.video.width?s.video.height=Math.round(s.video.width/s.video.aspectRatio):s.video.height&&(s.video.width=Math.round(s.video.height*s.video.aspectRatio))),s.video.width&&(i.video.width={ideal:s.video.width}),s.video.height&&(i.video.height={ideal:s.video.height}),s.video.frameRate&&(i.video.frameRate={ideal:s.video.frameRate}),s.video.sourceId&&(i.video.sourceId=s.video.sourceId),s.video.cameraFaceFront!==undefined&&c.isMobile()&&(i.video.facingMode={exact:s.video.cameraFaceFront?"user":"environment"}),this.userMedia(i)):h.error("This browser does not support screen recording.");if(c.isEdge()&&s.screen){if(navigator.getDisplayMedia){var e=h.create(),t=navigator.getDisplayMedia({video:!0});return t.then(e.asyncSuccessFunc()),t["catch"](e.asyncErrorFunc()),e}return h.error("This browser does not support screen recording.")}i.video={mandatory:{}},s.video.width&&(i.video.mandatory.minWidth=s.video.width,i.video.mandatory.maxWidth=s.video.width),!s.video.width&&s.video.height&&(i.video.mandatory.minHeight=s.video.height,i.video.mandatory.maxHeight=s.video.height);var r=s.video.aspectRatio?s.video.aspectRatio:s.video.width&&s.video.height?s.video.width/s.video.height:null;r&&(i.video.mandatory.minAspectRatio=r,i.video.mandatory.maxAspectRatio=r),s.video.sourceId&&(i.video.mandatory.sourceId=s.video.sourceId),s.video.cameraFaceFront!==undefined&&c.isMobile()&&(i.video.mandatory.facingMode={exact:s.video.cameraFaceFront?"user":"environment"}),s.video.frameRate&&(i.video.mandatory.minFrameRate=s.video.frameRate,i.video.mandatory.maxFrameRate=s.video.frameRate);var n=function(a){var h=i.video.mandatory;return this.userMedia(i).mapError(function(e){if(a--,"ConstraintNotSatisfiedError"!==e.name&&"OverconstrainedError"!==e.name)return e;var o=(e.constraintName||e.constraint).toLowerCase();return d.iter(h,function(e,t){var i=t.toLowerCase();if(0<=i.indexOf(o)){var s=0<i.indexOf("aspect"),r=0===i.indexOf("min")?-1:1,n=Math.max(0,h[t]*(1+r/10));h[t]=s?n:Math.round(n),a<0&&(delete h[t],a=100)}},this),n.call(this,a)},this)};if(s.screen){var o=this.chromeExtensionExtract(s.screen).extensionId;if(!o)return h.error("This browser does not support screen recording.");var a=u.now();return this.chromeExtensionMessage(o,{type:"ping",data:a}).mapSuccess(function(e){var t=h.create();return e&&"success"===e.type&&e.data===a?(t.asyncSuccess(!0),t.mapSuccess(function(){return this.chromeExtensionMessage(o,{type:"acquire",sources:["window","screen","tab"],url:window.self!==window.top?window.location.href:null}).mapSuccess(function(e){return e&&"success"===e.type?(i.video.mandatory.chromeMediaSource="desktop",i.video.mandatory.chromeMediaSourceId=e.streamId,delete i.audio,n.call(this,100).mapSuccess(function(i){return s.audio?this.userMedia({audio:!0}).mapError(function(){return h.value(i)}).mapSuccess(function(e){try{return new MediaStream([i.getVideoTracks()[0],e.getAudioTracks()[0]])}catch(t){return i}}):i},this)):h.error("Could not acquire permission to access screen.")},this)},this)):h.error("This browser does not support screen recording.")},this)}return n.call(this,100)},stopUserMediaStream:function(e,t){var i=!1;try{e.getTracks&&e.getTracks().forEach(function(e){e.stop(),i=!0}),0<t.length&&d.iter(t,function(e){e.stop(),i=!0},this)}catch(s){}try{!i&&e.stop&&e.stop()}catch(s){}},bindStreamToVideo:function(e,t,i){return t||(t=document.createElement("video")),t.volume=0,t.muted=!0,"mozSrcObject"in t?t.mozSrcObject=e:"srcObject"in t?t.srcObject=e:t.src=this.globals().URL.createObjectURL(e),i?(t.style["-moz-transform"]="scale(-1, 1)",t.style["-webkit-transform"]="scale(-1, 1)",t.style["-o-transform"]="scale(-1, 1)",t.style.transform="scale(-1, 1)",t.style.filter="FlipH"):(delete t.style["-moz-transform"],delete t.style["-webkit-transform"],delete t.style["-o-transform"],delete t.style.transform,delete t.style.filter),t.autoplay=!0,t.play(),t},dataURItoBlob:function(e){if(""!==e){for(var t=atob(e.split(",")[1]),i=e.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(t.length),r=new Uint8Array(s),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);var o=new DataView(s);return new Blob([o],{type:i})}}}}),e.define("module:WebRTC.WhammyRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Time","base:Functions","base:Promise","base:Async","module:WebRTC.Support","module:Encoding.WebmEncoder.Support"],function(e,t,s,r,i,n,o,a,d,h){return e.extend({scoped:h},[t,function(i){return{constructor:function(e,t){i.constructor.call(this),this._stream=e,this._options=s.extend({recordWidth:320,recordHeight:240,quality:undefined,video:null,framerate:null},t),this._started=!1},destroy:function(){this._started=!1,this.trigger("stopped"),i.destroy.call(this)},start:function(){return this._started||(this._started=!0,this._options.video&&(this._options.recordWidth=this._options.video.videoWidth||this._options.video.clientWidth,this._options.recordHeight=this._options.video.videoHeight||this._options.video.clientHeight),this._video=document.createElement("video"),this._video.width=this._options.recordWidth||40,this._video.height=this._options.recordHeight||30,this._stream&&a.bindStreamToVideo(this._stream,this._video),this._canvas=document.createElement("canvas"),this._canvas.width=this._options.recordWidth||40,this._canvas.height=this._options.recordHeight||30,this._context=this._canvas.getContext("2d"),this._frames=[],this._lastTime=r.now(),this._startTime=this._lastTime,this.trigger("started"),o.eventually(this._process,[],this)),n.value(!0)},stop:function(){this._started&&(this._started=!1,this.trigger("stopped"),this._generateData())},_process:function(){if(this._started){var e=r.now(),t=e-this._lastTime;this._lastTime=e,this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._frames.push({duration:t,image:this._stream?this._canvas.toDataURL("image/webp",this._options.quality):"data:image/webp;base64,UklGRjQAAABXRUJQVlA4ICgAAADwAgCdASooAB4APpFGnkslo6KhpWgAsBIJaQAAKUNt8AD++E0AAAAA"});var i=this._options.framerate?1e3/this._options.framerate:10;o.eventually(this._process,[],this,Math.max(1,i-(r.now()-e)))}},averageFrameRate:function(){return 0<this._frames.length?this._frames.length/(r.now()-this._startTime)*1e3:null},_generateData:function(){this._frames.length&&(this._data=this.__compile(this._stream?this.__dropBlackFrames(this._canvas,this._frames):this._frames),this.trigger("data",this._data))},__compile:function(e){var i=0,s=null,r=null,n=[],o=0,a=null,h=null;e.forEach(function(e){a||(a=[],h=0);var t=d.parseWebP(d.parseRIFF(atob(e.image.slice(23))));a.push(d.serializeEBML(d.makeTimecodeDataBlock(t.data,h))),h+=e.duration,i+=e.duration,s=s||t.width,r=r||t.height,3e4<=h&&(n.push(d.serializeEBML(d.makeCluster(a,o))),o=i,a=null,h=0)},this),a&&n.push(d.serializeEBML(d.makeCluster(a,o)));var t=d.generateEBMLHeader(i,s,r);return t[1].data=t[1].data.concat(n),d.serializeEBML(t)},__dropBlackFrames:function(e,t,i,s){for(var r=0;r<t.length&&d.isBlankFrame(e,t[r],i,s);)r++;return t.slice(r)},createSnapshot:function(e){return this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._canvas.toDataURL(e)}}}],{supported:function(e){return e||a.globals().webpSupport}})})}).call(Scoped);