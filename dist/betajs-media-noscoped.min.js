/*!
betajs-media - v0.0.1 - 2015-08-25
Copyright (c) Oliver Friedmann
MIT Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Media"),a.binding("base","global:BetaJS"),a.binding("jquery","global:jQuery"),a.define("module:",function(){return{guid:"8475efdb-dd7e-402e-9f50-36c76945a692",version:"14.1440535406649"}}),a.define("module:Player.Flash",["base:Browser.Dom","base:Async","module:Player.FlashPlayer"],function(a,b,c){return{polyfill:function(c,d,e,f){return f?(b.eventually(function(){this.polyfill(c,d,e)},this),c):"video"==c.tagName.toLowerCase()&&"networkState"in c?c.networkState==c.NETWORK_NO_SOURCE||e?this.attach(a.changeTag(c,d||"videopoly")):c:this.attach(c)},attach:function(a){new c(a);return a}}}),a.define("module:Player.FlashPlayer",["base:Class","base:Flash.FlashClassRegistry","base:Flash.FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","jquery:"],function(a,b,c,d,e,f,g,h,i){return a.extend({scoped:i},function(a){return{constructor:function(b){a.constructor.call(this),this._element=b,this._$element=h(b),this._currentWidth=null,this._currentHeight=null,this.__initCss(),this._source=this.__preferedSource(),this._embedding=new c(b,{registry:this.cls.flashRegistry(),wrap:!0}),this._flashObjs={},this._flashData={status:"idle"},this._embedding.ready(this.__initializeEmbedding,this),this.__initEvents(),f.iter(this.__elementMethods,function(a,b){this._element[b]=g.as_method(a,this)},this)},destroy:function(){h(window).off("."+this.cid()),h(document).off("."+this.cid()),this._embedding.destroy(),a.destroy.call(this)},__initEvents:function(){var a=this;h(document).on("DOMNodeRemoved."+this.cid(),function(b){b.target==a._element&&a.weakDestroy()}),h(window).on("resize",function(){a.updateSize()})},__initCss:function(){this._$element.css("display")&&"inline"!=this._$element.css("display")||this._$element.css("display","inline-block")},__preferedSource:function(){for(var a=[".mp4",".flv"],b=[],c=this._element,e=0;e<this._element.childNodes.length;++e)c.childNodes[e].tagName&&"source"==c.childNodes[e].tagName.toLowerCase()&&c.childNodes[e].src&&b.push(c.childNodes[e].src.toLowerCase());var f=b[0],g=a.length-1;for(e=b.length-1;e>=0;--e)for(var h=0;g>=h;++h)if(d.ends_with(b[e],a[h])){f=b[e],g=h;break}-1==f.indexOf("://")&&(f=document.location.href+"/../"+f);var i=null,j=f;if(d.starts_with(f,"rtmp")){var k=d.splitLast(f,"/");i=k.head,j=k.tail}return{sourceUrl:f,connectionUrl:i,playUrl:j}},__initializeEmbedding:function(){this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.main.addChildVoid(this._flashObjs.video),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this._embedding.newCallback(g.as_method(this.__connectionStatusEvent,this))),this._flashObjs.connection.connectVoid(this._source.connectionUrl)},__connectionStatusEvent:function(){this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.set("client",this._embedding.newCallback("onMetaData",g.as_method(function(a){this._flashData.meta=a,e.eventually(this.updateSize,this)},this))),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(g.as_method(this.__streamStatusEvent,this))),this._flashObjs.video.attachNetStreamVoid(this._flashObjs.stream),this._element.attributes.autoplay&&this._element.play()},__streamStatusEvent:function(a){var b=a.get("info").code;"NetStream.Play.Start"==b&&(this._flashData.status="start"),"NetStream.Play.Stop"==b&&(this._flashData.status="stopping"),"NetStream.Buffer.Empty"==b&&"stopping"==this._flashData.status&&(this._flashData.status="stopped"),"stopped"==this._flashData.status&&this._element.attributes.loop&&(this._flashData.status="idle",this._element.play())},updateSize:function(){if(this._flashData.meta){var a=this._$element,b=this._element,c=this._flashData.meta,d=a.width();a.width()<c.width&&!b.style.width&&(element.style.width=c.width+"px",d=a.width(),delete element.style.width);var e=Math.round(d*c.height/c.width);d!=this._currentWidth&&(this._currentWidth=d,this._currentHeight=e,a.find("object").css("width",this._currentWidth+"px"),a.find("embed").css("width",this._currentWidth+"px"),a.find("object").css("height",this._currentHeight+"px"),a.find("embed").css("height",this._currentHeight+"px"),this._flashObjs.video.set("width",this._currentWidth),this._flashObjs.video.set("height",this._currentHeight))}},__elementMethods:{play:function(){"paused"===this._flashData.status?this._flashObjs.stream.resumeVoid():this._flashObjs.stream.playVoid(this._source.playUrl)},pause:function(){this._flashObjs.stream.pauseVoid(),this._flashData.status="paused"}}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new b,this.__flashRegistry.register("flash.media.Video",["attachNetStream"]),this.__flashRegistry.register("flash.display.Sprite",["addChild"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"])),this.__flashRegistry}})}),a.define("module:WebRTC.AudioRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Functions","module:WebRTC.Support"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this._leftChannel=[],this._rightChannel=[],this._recordingLength=0,this._options=c.extend({audioChannels:2,bufferSize:16384,sampleRate:44100},d),this._stream=b,this._started=!1},_audioProcess:function(a){this._started&&(this._leftChannel.push(new Float32Array(a.inputBuffer.getChannelData(0))),this._options.audioChannels>1&&this._rightChannel.push(new Float32Array(a.inputBuffer.getChannelData(1))),this._recordingLength+=this._actualBufferSize)},destroy:function(){this.stop(),a.destroy.call(this)},start:function(){if(!this._started){this._started=!0,this._recordingLength=0,this._leftChannel=[],this._rightChannel=[];var a=e.globals().AudioContext;this._audioContext=new a,this._volumeGain=this._audioContext.createGain(),this._audioInput=this._audioContext.createMediaStreamSource(this._stream),this._audioInput.connect(this._volumeGain),this._scriptProcessor=e.globals().audioContextScriptProcessor.call(this._audioContext,this._options.bufferSize,this._options.audioChannels,this._options.audioChannels),this._actualBufferSize=this._scriptProcessor.bufferSize,this._scriptProcessor.onaudioprocess=d.as_method(this._audioProcess,this),this._volumeGain.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination),this.trigger("started")}},stop:function(){this._started&&(this._started=!1,this.trigger("stopped"),this._scriptProcessor.disconnect(),this._volumeGain.disconnect(),this._audioInput.disconnect(),this._scriptProcessor.onaudioprocess=null,delete this._scriptProcessor,delete this._volumeGain,delete this._audioInput,this._generateData())},_generateData:function(){var a=this.__mergeBuffers(this._leftChannel,this._recordingLength),b=this.__mergeBuffers(this._rightChannel,this._recordingLength),c=a;if(this._options.audioChannels>1){c=new Float32Array(a.length+b.length);for(var d=0;d<a.length;++d)c[2*d]=a[d],c[2*d+1]=b[d]}var e=new ArrayBuffer(44+2*c.length),f=new DataView(e);this.__writeUTFBytes(f,0,"RIFF"),f.setUint32(4,44+2*c.length,!0),this.__writeUTFBytes(f,8,"WAVE"),this.__writeUTFBytes(f,12,"fmt "),f.setUint32(16,16,!0),f.setUint16(20,1,!0),f.setUint16(22,this._options.audioChannels,!0),f.setUint32(24,this._options.sampleRate,!0),f.setUint32(28,4*this._options.sampleRate,!0),f.setUint16(32,2*this._options.audioChannels,!0),f.setUint16(34,16,!0),this.__writeUTFBytes(f,36,"data"),f.setUint32(40,2*c.length,!0);for(var g=c.length,h=44,i=1,j=0;g>j;j++)f.setInt16(h,32767*c[j]*i,!0),h+=2;this._data=new Blob([f],{type:"audio/wav"}),this._leftChannel=[],this._rightChannel=[],this._recordingLength=0,this.trigger("data",this._data)},__mergeBuffers:function(a,b){for(var c=new Float32Array(b),d=0,e=a.length,f=0;e>f;f++){var g=a[f];c.set(g,d),d+=g.length}return c},__writeUTFBytes:function(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))}}}],{supported:function(){return!!e.globals().AudioContext&&!!e.globals().audioContextScriptProcessor}})}),a.define("module:WebRTC.MediaRecorder",["base:Class","base:Events.EventsMixin","base:Functions","module:WebRTC.Support"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b){a.constructor.call(this),this._stream=b,this._started=!1;var e=d.globals().MediaRecorder;this._mediaRecorder=new e(b),this._mediaRecorder.ondataavailable=c.as_method(this._dataAvailable,this)},destroy:function(){this.stop(),a.destroy.call(this)},start:function(){this._started||(this._started=!0,this._mediaRecorder.start(),this.trigger("started"))},stop:function(){this._started&&(this._started=!1,this._mediaRecorder.stop(),this.trigger("stopped"))},_dataAvailable:function(a){this._data=new Blob([a.data],{type:a.data.type}),this.trigger("data",this._data)}}}],{supported:function(){return!!d.globals().MediaRecorder}})}),a.define("module:WebRTC.RecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","module:WebRTC.Support"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b){a.constructor.call(this,b),this._video=b.video,this._recording=!1,this._bound=!1},_getConstraints:function(){return{audio:this._options.recordAudio,video:this._options.recordVideo?{mandatory:{minWidth:this._options.recordResolution.width,maxWidth:this._options.recordResolution.width,minHeight:this._options.recordResolution.height,maxHeight:this._options.recordResolution.height}}:!1}},bindMedia:function(){return this._bound?void 0:d.userMedia(this._getConstraints()).success(function(a){this._bound=!0,this._stream=a,d.bindStreamToVideo(a,this._video),this.trigger("bound"),this._boundMedia()},this)},startRecord:function(){this._recording||(this._recording=!0,this._startRecord())},stopRecord:function(){this._recording&&(this._recording=!1,this._stopRecord())},unbindMedia:function(){this._bound&&!this._recording&&(d.stopUserMediaStream(this._stream),this._bound=!1,this.trigger("unbound"),this._unboundMedia())},_boundMedia:function(){},_unboundMedia:function(){},_startRecord:function(){},_stopRecord:function(){},_dataAvailable:function(a,b){this.trigger("data",a,b)},destroy:function(){this.stopRecord(),this.unbindMedia(),a.destroy.call(this)}}}],{_initializeOptions:function(a){return c.extend({recordAudio:!0,recordVideo:!0,recordResolution:{width:320,height:200}},a)},supported:function(a){return!!d.globals().getUserMedia&&!!d.globals().URL}})}),a.define("module:WebRTC.MediaRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.MediaRecorder"],function(a,b,c){var d=a.extend({scoped:c},{_boundMedia:function(){this._recorder=new b(this._stream),this._recorder.on("data",function(a){this._dataAvailable(a)},this)},_unboundMedia:function(){this._recorder.destroy()},_startRecord:function(){this._recorder.start()},_stopRecord:function(){this._recorder.stop()}},function(a){return{supported:function(c){return a.supported.call(this,c)?b.supported():!1}}});return a.register(d,2),d}),a.define("module:WebRTC.WhammyAudioRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.AudioRecorder","module:WebRTC.WhammyRecorder"],function(a,b,c,d){var e=a.extend({scoped:d},{_boundMedia:function(){this._whammyRecorder=new c(this._stream,{video:this._video}),this._audioRecorder=new b(this._stream),this._audioRecorder.on("data",function(a){this._audioBlob=a,this._videoBlob&&this._dataAvailable(this._videoBlob,this._audioBlob)},this),this._whammyRecorder.on("data",function(a){this._videoBlob=a,this._audioBlob&&this._dataAvailable(this._videoBlob,this._audioBlob)},this)},_unboundMedia:function(){this._audioRecorder.destroy(),this._whammyRecorder.destroy()},_startRecord:function(){this._whammyRecorder.start(),this._audioRecorder.start()},_stopRecord:function(){this._whammyRecorder.stop(),this._audioRecorder.stop()}},function(a){return{supported:function(d){return a.supported.call(this,d)?b.supported()&&c.supported():!1}}});return a.register(e,1),e}),a.define("module:WebRTC.Support",["base:Promise.Promise"],function(a){return{canvasSupportsImageFormat:function(a){try{var b=document.createElement("canvas").toDataURL(a);b.indexOf(";");return-1!=b.substring(0,b.indexOf(";")).indexOf(a)}catch(c){return!1}},getGlobals:function(){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,b=window.URL||window.webkitURL,c=window.MediaRecorder,d=window.AudioContext||window.webkitAudioContext,e=null;if(d){var f=new d;e=f.createJavaScriptNode||f.createScriptProcessor}return{getUserMedia:a,URL:b,MediaRecorder:c,AudioContext:d,audioContextScriptProcessor:e,webpSupport:this.canvasSupportsImageFormat("image/webp")}},globals:function(){return this.__globals||(this.__globals=this.getGlobals()),this.__globals},userMediaSupported:function(){return!!this.globals().getUserMedia},userMedia:function(b){var c=new a;return this.globals().getUserMedia.call(navigator,b,function(a){c.asyncSuccess(a)},function(a){c.asyncError(a)}),c},stopUserMediaStream:function(a){a.stop()},bindStreamToVideo:function(a,b){b.volume=0,b.muted=!0,void 0!==b.mozSrcObject?b.mozSrcObject=a:b.src=this.globals().URL.createObjectURL(a),b.autoplay=!0,b.play()}}}),a.define("module:WebRTC.WhammyRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Time","base:Functions","base:Async","module:WebRTC.Support"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this._stream=b,this._options=c.extend({recordWidth:320,recordHeight:240,video:null},d),this._started=!1},destroy:function(){this.stop(),a.destroy.call(this)},start:function(){this._started||(this._started=!0,this._options.video&&(this._options.recordWidth=this._options.video.videoWidth||this._options.video.clientWidth,this._options.recordHeight=this._options.video.videoHeight||this._options.video.clientHeight),this._video=document.createElement("video"),this._video.width=this._options.recordWidth,this._video.height=this._options.recordHeight,g.bindStreamToVideo(this._stream,this._video),this._canvas=document.createElement("canvas"),this._canvas.width=this._options.recordWidth,this._canvas.height=this._options.recordHeight,this._context=this._canvas.getContext("2d"),this._frames=[],this._isOnStartedDrawingNonBlankFramesInvoked=!1,this._lastTime=d.now(),this.trigger("started"),f.eventually(this._process,[],this))},stop:function(){this._started&&(this._started=!1,this.trigger("stopped"),this._generateData())},_process:function(){if(this._started){var a=d.now(),b=a-this._lastTime;this._lastTime=a,this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._frames.push({duration:b,image:this._canvas.toDataURL("image/webp")}),this._isOnStartedDrawingNonBlankFramesInvoked||this.__isBlankFrame(this._canvas,this._frames[this._frames.length-1])||(this._isOnStartedDrawingNonBlankFramesInvoked=!0,this.trigger("onStartedDrawingNonBlankFrames")),f.eventually(this._process,[],this,Math.max(1,10-(d.now()-a)))}},_generateData:function(){this._frames.length&&(this._data=this.__compile(this.__dropBlackFrames(this._canvas,this._frames,-1)),this.trigger("data",this._data))},clearOldRecordedFrames:function(){this._frames=[]},__doubleToString:function(a){return[].slice.call(new Uint8Array(new Float64Array([a]).buffer),0).map(function(a){return String.fromCharCode(a)}).reverse().join("")},__parseRIFF:function(a){for(var b=0,c={},d=function(a){var b=a.charCodeAt(0).toString(2);return new Array(8-b.length+1).join("0")+b};b<a.length;){var e=a.substr(b,4),f=parseInt(a.substr(b+4,4).split("").map(d).join(""),2),g=a.substr(b+4+4,f);b+=8+f,c[e]=c[e]||[],"RIFF"==e||"LIST"==e?c[e].push(this.__parseRIFF(g)):c[e].push(g)}return c},__parseWebP:function(a){for(var b=a.RIFF[0].WEBP[0],c=b.indexOf("Â*"),d=0,e=[];4>d;d++)e[d]=b.charCodeAt(c+3+d);var f,g,h;return h=e[1]<<8|e[0],f=16383&h,h=e[3]<<8|e[2],g=16383&h,{width:f,height:g,data:b,riff:a}},__checkFrames:function(a){if(!a[0])return null;var b=0;return c.iter(a,function(a){b+=a.duration}),{duration:b,width:a[0].width,height:a[0].height}},__makeSimpleBlock:function(a){var b=0;if(a.keyframe&&(b|=128),a.invisible&&(b|=8),a.lacing&&(b|=a.lacing<<1),a.discardable&&(b|=1),a.trackNum>127)throw"TrackNumber > 127 not supported";var c=[128|a.trackNum,a.timecode>>8,255&a.timecode,b].map(function(a){return String.fromCharCode(a)}).join("")+a.frame;return c},__numToBuffer:function(a){for(var b=[];a>0;)b.push(255&a),a>>=8;return new Uint8Array(b.reverse())},__strToBuffer:function(a){return new Uint8Array(a.split("").map(function(a){return a.charCodeAt(0)}))},__bitsToBuffer:function(a){var b=[],c=a.length%8?new Array(9-a.length%8).join("0"):"";a=c+a;for(var d=0;d<a.length;d+=8)b.push(parseInt(a.substr(d,8),2));return new Uint8Array(b)},__generateEBML:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].data;"object"==typeof d&&(d=this.__generateEBML(d)),"number"==typeof d&&(d=this.__bitsToBuffer(d.toString(2))),"string"==typeof d&&(d=this.__strToBuffer(d));var e=d.size||d.byteLength||d.length,f=Math.ceil(Math.ceil(Math.log(e)/Math.log(2))/8),g=e.toString(2),h=new Array(7*f+7+1-g.length).join("0")+g,i=new Array(f).join("0")+"1"+h;b.push(this.__numToBuffer(a[c].id)),b.push(this.__bitsToBuffer(i)),b.push(d)}return new Blob(b,{type:"video/webm"})},__toWebM:function(a){for(var b=this.__checkFrames(a),c=3e4,d=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:this.__doubleToString(b.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:b.width,id:176},{data:b.height,id:186}]}]}]}]}],e=0,f=0,g=this,h=0,i=function(a){var b=g.__makeSimpleBlock({discardable:0,frame:a.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(h)});return h+=a.duration,{data:b,id:163}};e<a.length;){var j=[],k=0;do j.push(a[e]),k+=a[e].duration,e++;while(e<a.length&&c>k);h=0;var l={id:524531317,data:[{data:f,id:231}].concat(j.map(i))};d[1].data.push(l),f+=k}return this.__generateEBML(d)},__compile:function(a){var b=this,c=this.__toWebM(a.map(function(a){var c=b.__parseWebP(b.__parseRIFF(atob(a.image.slice(23))));return c.duration=a.duration,c}));return c},__dropBlackFrames:function(a,b,c,d,e){var f=document.createElement("canvas");f.width=a.width,f.height=a.height;for(var g=f.getContext("2d"),h=[],i=-1===c,j=c&&c>0&&c<=b.length?c:b.length,k={r:0,g:0,b:0},l=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),m=d&&d>=0&&1>=d?d:0,n=e&&e>=0&&1>=e?e:0,o=!1,p=0;j>p;p++){var q,r,s;if(!o){var t=new Image;t.src=b[p].image,g.drawImage(t,0,0,a.width,a.height);var u=g.getImageData(0,0,a.width,a.height);q=0,r=u.data.length,s=u.data.length/4;for(var v=0;r>v;v+=4){var w={r:u.data[v],g:u.data[v+1],b:u.data[v+2]},x=Math.sqrt(Math.pow(w.r-k.r,2)+Math.pow(w.g-k.g,2)+Math.pow(w.b-k.b,2));l*m>=x&&q++}}!o&&s*n>=s-q||(i&&(o=!0),h.push(b[p]))}return h=h.concat(b.slice(j)),h.length<=0&&h.push(b[b.length-1]),h},__isBlankFrame:function(a,b,c,d){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var f,g,h,i=e.getContext("2d"),j={r:0,g:0,b:0},k=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),l=c&&c>=0&&1>=c?c:0,m=d&&d>=0&&1>=d?d:0,n=new Image;n.src=b.image,i.drawImage(n,0,0,a.width,a.height);var o=i.getImageData(0,0,a.width,a.height);f=0,g=o.data.length,h=o.data.length/4;for(var p=0;g>p;p+=4){var q={r:o.data[p],g:o.data[p+1],b:o.data[p+2]},r=Math.sqrt(Math.pow(q.r-j.r,2)+Math.pow(q.g-j.g,2)+Math.pow(q.b-j.b,2));k*l>=r&&f++}return h*m>=h-f?!1:!0}}}],{supported:function(){return g.globals().webpSupport}})})}).call(Scoped);