/*!
betajs-media - v0.0.46 - 2017-03-14
Copyright (c) Ziggeo,Oliver Friedmann
Apache-2.0 Software License.
*/
var Scoped=function(){function a(a){function b(a){return{route:"string"==typeof a.route?a.route:null,parent:"object"==typeof a.parent?a.parent:null,ready:"boolean"==typeof a.ready?a.ready:!1,children:{},watchers:[],data:{},lazy:[]}}function c(a){if(!a.ready){if(a.parent&&!a.parent.ready)return void c(a.parent);if(a.route&&a.parent&&a.route in a.parent.data){a.data=a.parent.data[a.route],a.ready=!0;for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[];for(var d in a.children)c(a.children[d])}}}function d(a){if(!a.ready){a.parent&&!a.parent.ready&&d(a.parent),a.ready=!0,a.parent&&j.tree&&"object"==typeof a.parent.data&&(a.parent.data[a.route]=a.data);for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[]}}function e(a,b){if("object"==typeof b&&a.ready)for(var e in b)a.data[e]=b[e];else a.data=b;if("object"==typeof b)for(var f in b)a.children[f]&&(a.children[f].data=b[f]);d(a);for(var g in a.children)c(a.children[g])}function f(a){if(a.ready&&a.data)for(var b in a.data)delete a.data[b]}function g(a){if(!a)return k;for(var d=a.split("."),e=k,f=0;f<d.length;++f)d[f]in e.children?e=e.children[d[f]]:(e.children[d[f]]=b({parent:e,route:d[f]}),e=e.children[d[f]],c(e));return e}function h(a,b,c){if(a.ready)b.call(c||this,a.data);else if(a.watchers.push({callback:b,context:c}),a.lazy.length>0){var d=function(a){if(a.lazy.length>0){var b=a.lazy.shift();b.callback.call(b.context||this,a.data),d(a)}};d(a)}}function i(a,b,c){a=a||k,c=c||[],a.ready||c.push(b);for(var d in a.children){var e=a.children[d],f=(b?b+".":"")+e.route;c=i(e,f,c)}return c}var j={tree:"boolean"==typeof a.tree?a.tree:!1,global:"boolean"==typeof a.global?a.global:!1,root:"object"==typeof a.root?a.root:{}},k=b({ready:!0});if(j.tree)if(j.global){try{window&&(k.data=window)}catch(l){}try{global&&(k.data=global)}catch(l){}try{self&&(k.data=self)}catch(l){}}else k.data=j.root;return{extend:function(a,b){e(g(a),b)},set:function(a,b){var c=g(a);c.data&&f(c),e(c,b)},get:function(a){var b=g(a);return b.ready?b.data:null},lazy:function(a,b,c){var d=g(a);d.ready?b(c||this,d.data):d.lazy.push({callback:b,context:c})},digest:function(a){c(g(a))},obtain:function(a,b,c){h(g(a),b,c)},unresolvedWatchers:function(a){return i(g(a),a)},__export:function(){return{options:j,nsRoot:k}},__import:function(a){j=a.options,k=a.nsRoot}}}function b(e,f,g,h){var i=null,j=[],k=f,l=g,m=h,n=a({tree:!0}),o=a({tree:!1}),p={global:{namespace:m},root:{namespace:l},local:{namespace:n},"default":{namespace:o},parent:{namespace:k},scope:{namespace:n,readonly:!1}},q=function(a,b,c){var e=d.matchArgs(a,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),f=d.extend({lazy:this.options.lazy},e.options||{}),g=this.resolve(e.namespaceLocator),h=function(){this.require(e.dependencies,e.hiddenDependencies,function(){if(arguments[arguments.length-1].ns=g,this.options.compile){for(var f=[],h=0;h<a.length;++h)f.push(d.stringify(a[h]));this.compiled+=this.options.ident+"."+b+"("+f.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[g.path]=this.dependencies[g.path]||{},e.dependencies&&e.dependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this),e.hiddenDependencies&&e.hiddenDependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this));var i=this.options.compile?{}:e.callback.apply(e.context||this,arguments);c.call(this,g,i)},this)};return f.lazy?g.namespace.lazy(g.path,h,this):h.apply(this),this};return{getGlobal:d.method(c,c.getPath),setGlobal:d.method(c,c.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return i||(i=b(this,n,l,m)),i},subScope:function(){var a=this.nextScope();return j.push(a),i=null,a},binding:function(b,c,e){if(!p[b]||!p[b].readonly){var f;f="string"!=d.typeOf(c)?{namespace:a({tree:!0,root:c}),path:null}:this.resolve(c),p[b]=d.extend(e,f)}return this},resolve:function(a){var b=a.split(":");if(1==b.length)return{namespace:o,path:b[0]};var c=p[b[0]];if(!c)throw"The namespace '"+b[0]+"' has not been defined (yet).";return{namespace:c.namespace,path:c.path&&b[1]?c.path+"."+b[1]:c.path||b[1]}},define:function(){return q.call(this,arguments,"define",function(a,b){if(a.namespace.get(a.path))throw"Scoped namespace "+a.path+" has already been defined. Use extend to extend an existing namespace instead";a.namespace.set(a.path,b)})},assumeVersion:function(){var a=d.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),b=a.dependencies||[];b.unshift(a.assumption),this.require(b,function(){var b=arguments,c=b[0].replace(/[^\d\.]/g,"");b[0]=c.split(".");for(var e=0;e<b[0].length;++e)b[0][e]=parseInt(b[0][e],10);if("function"===d.typeOf(a.callback)){if(!a.callback.apply(a.context||this,a))throw"Scoped Assumption '"+a.assumption+"' failed, value is "+c+(a.error?", but assuming "+a.error:"")}else for(var f=(a.callback+"").replace(/[^\d\.]/g,"").split("."),g=0;g<Math.min(b[0].length,f.length);++g)if(parseInt(f[g],10)>b[0][g])throw"Scoped Version Assumption '"+a.assumption+"' failed, value is "+c+", but assuming at least "+a.callback})},extend:function(){return q.call(this,arguments,"extend",function(a,b){a.namespace.extend(a.path,b)})},require:function(){var a=d.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});a.callback=a.callback||function(){};var b=a.dependencies||[],c=b.concat(a.hiddenDependencies||[]),e=c.length,f=[],g={};if(e)for(var h=function(b){this.i<f.length&&(f[this.i]=b),e--,0===e&&(f.push(g),a.callback.apply(a.context||this.ctx,f))},i=0;i<c.length;++i){var j=this.resolve(c[i]);i<b.length&&f.push(null),j.namespace.obtain(j.path,h,{ctx:this,i:i})}else f.push(g),a.callback.apply(a.context||this,f);return this},digest:function(a){var b=this.resolve(a);return b.namespace.digest(b.path),this},unresolved:function(a){var b=this.resolve(a);return b.namespace.unresolvedWatchers(b.path)},__export:function(){return{parentNamespace:k.__export(),rootNamespace:l.__export(),globalNamespace:m.__export(),localNamespace:n.__export(),privateNamespace:o.__export()}},__import:function(a){k.__import(a.parentNamespace),l.__import(a.rootNamespace),m.__import(a.globalNamespace),n.__import(a.localNamespace),o.__import(a.privateNamespace)}}}var c=function(){return{get:function(a){return"undefined"!=typeof window?window[a]:"undefined"!=typeof global?global[a]:"undefined"!=typeof self?self[a]:void 0},set:function(a,b){return"undefined"!=typeof window&&(window[a]=b),"undefined"!=typeof global&&(global[a]=b),"undefined"!=typeof self&&(self[a]=b),b},getPath:function(a){var b=a.split(".");if(1==b.length)return this.get(a);for(var c=this.get(b[0]),d=1;d<b.length;++d){if(!c)return c;c=c[b[d]]}return c},setPath:function(a,b){var c=a.split(".");if(1==c.length)return this.set(a,b);for(var d=this.get(c[0])||this.set(c[0],{}),e=1;e<c.length-1;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d[c[c.length-1]]=b,b}}}.call(this),d=function(){return{method:function(a,b){return function(){return b.apply(a,arguments)}},extend:function(a,b){a=a||{},b=b||{};for(var c in b)a[c]=b[c];return a},typeOf:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":typeof a},isEmpty:function(a){if(null===a||"undefined"==typeof a)return!0;if("array"==this.typeOf(a))return 0===a.length;if("object"!=typeof a)return!1;for(var b in a)return!1;return!0},matchArgs:function(a,b){var c=0,d={};for(var e in b)b[e]===!0||this.typeOf(a[c])==b[e]?(d[e]=a[c],c++):"undefined"==this.typeOf(a[c])&&c++;return d},stringify:function(a){return"function"==this.typeOf(a)?""+a:JSON.stringify(a)}}}.call(this),e=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(a){var b=c.get(a||e.__namespace);if(b&&"object"==d.typeOf(b)&&b.guid==this.guid&&"string"==d.typeOf(b.version)){for(var f=this.version.split("."),g=b.version.split("."),h=!1,i=0;i<Math.min(f.length,g.length)&&(h=parseInt(f[i],10)>parseInt(g[i],10),f[i]==g[i]);++i);return h?this.attach(a):b}return this.attach(a)},attach:function(a){a&&(e.__namespace=a);var b=c.get(e.__namespace);if(b==this)return this;if(e.__revert=b,b)try{var d=b.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(d)}catch(f){}return c.set(e.__namespace,this),this},detach:function(a){return a&&c.set(e.__namespace,null),"undefined"!=typeof e.__revert&&c.set(e.__namespace,e.__revert),delete e.__revert,e.__exportBackup&&this.__importScoped(e.__exportBackup),this},exports:function(a,b,c){return a=a||("undefined"!=typeof module?module:null),"object"==typeof a&&a&&"exports"in a&&(c||a.exports==this||!a.exports||d.isEmpty(a.exports))&&(a.exports=b||this),this}}}.call(this),f=a({tree:!0,global:!0}),g=a({tree:!0}),h=b(null,g,g,f),i=d.extend(h,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.13",upgrade:e.upgrade,attach:e.attach,detach:e.detach,exports:e.exports,__exportScoped:function(){return{globalNamespace:f.__export(),rootNamespace:g.__export(),rootScope:h.__export()}},__importScoped:function(a){f.__import(a.globalNamespace),g.__import(a.rootNamespace),h.__import(a.rootScope)}}}.call(this));return i=i.upgrade(),i.exports(),i}.call(this);(function(){var a=this.subScope();a.binding("module","global:BetaJS.Media"),a.binding("base","global:BetaJS"),a.binding("browser","global:BetaJS.Browser"),a.binding("flash","global:BetaJS.Flash"),a.define("module:",function(){return{guid:"8475efdb-dd7e-402e-9f50-36c76945a692",version:"0.0.46"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("browser:version","~1.0.61"),a.assumeVersion("flash:version","~0.0.18"),a.define("module:Encoding.WaveEncoder.Support",["base:Promise","base:Scheduling.Helper"],function(a,b){return{dumpInputBuffer:function(a,b,c,d){return{left:new Float32Array(a.getChannelData(0)),right:b>1?new Float32Array(a.getChannelData(1)):null,offset:d||0,endOffset:c}},waveChannelTransform:function(c,d,e,f){var g=a.create(),h=32767*(d||1),i=c.offset,j=c.endOffset,k=c.left,l=c.right,m=new Int16Array((j-i)*(l?2:1)),n=0;return b.schedulable(function(a){for(;a>0;){if(a--,i>=j)return g.asyncSuccess(m),!0;m[n]=k[i]*h,n++,l&&(m[n]=l[i]*h,n++),i++}return!1},100,e,f),g},generateHeader:function(a,b,c,d){d=d||new ArrayBuffer(44);var e=new DataView(d);return e.writeUTFBytes=function(a,b){for(var c=0;c<b.length;c++)this.setUint8(a+c,b.charCodeAt(c))},e.writeUTFBytes(0,"RIFF"),e.setUint32(4,44+a,!0),e.writeUTFBytes(8,"WAVE"),e.writeUTFBytes(12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,b,!0),e.setUint32(24,c,!0),e.setUint32(28,4*c,!0),e.setUint16(32,2*b,!0),e.setUint16(34,16,!0),e.writeUTFBytes(36,"data"),e.setUint32(40,a,!0),d}}}),a.define("module:Encoding.WebmEncoder.Support",["base:Promise","base:Scheduling.Helper","base:Types"],function(a,b,c){return{parseWebP:function(a){for(var b=a.RIFF[0].WEBP[0],c=b.indexOf("\x9d*"),d=0,e=[];4>d;d++)e[d]=b.charCodeAt(c+3+d);var f,g,h;return h=e[1]<<8|e[0],f=16383&h,h=e[3]<<8|e[2],g=16383&h,{width:f,height:g,data:b,riff:a}},parseRIFF:function(a){for(var b=0,c={},d=function(a){var b=a.charCodeAt(0).toString(2);return new Array(8-b.length+1).join("0")+b};b<a.length;){var e=a.substr(b,4),f=parseInt(a.substr(b+4,4).split("").map(d).join(""),2),g=a.substr(b+4+4,f);b+=8+f,c[e]=c[e]||[],"RIFF"==e||"LIST"==e?c[e].push(this.parseRIFF(g)):c[e].push(g)}return c},isBlankFrame:function(a,b,c,d){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var f,g,h,i=e.getContext("2d"),j={r:0,g:0,b:0},k=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),l=c&&c>=0&&1>=c?c:0,m=d&&d>=0&&1>=d?d:0,n=new Image;n.src=b.image,i.drawImage(n,0,0,a.width,a.height);var o=i.getImageData(0,0,a.width,a.height);f=0,g=o.data.length,h=o.data.length/4;for(var p=0;g>p;p+=4){var q={r:o.data[p],g:o.data[p+1],b:o.data[p+2]},r=Math.sqrt(Math.pow(q.r-j.r,2)+Math.pow(q.g-j.g,2)+Math.pow(q.b-j.b,2));k*l>=r&&f++}return h*m>=h-f},makeSimpleBlock:function(a){var b=0;if(a.keyframe&&(b|=128),a.invisible&&(b|=8),a.lacing&&(b|=a.lacing<<1),a.discardable&&(b|=1),a.trackNum>127)throw"TrackNumber > 127 not supported";var c=[128|a.trackNum,a.timecode>>8,255&a.timecode,b].map(function(a){return String.fromCharCode(a)}).join("")+a.frame;return c},generateEBMLHeader:function(a,b,c){var d=function(a){return[].slice.call(new Uint8Array(new Float64Array([a]).buffer),0).map(function(a){return String.fromCharCode(a)}).reverse().join("")};return[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:d(a),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:b,id:176},{data:c,id:186}]}]}]}]}]},__numToBuffer:function(a){for(var b=[];a>0;)b.push(255&a),a>>=8;return new Uint8Array(b.reverse())},__strToBuffer:function(a){return new Uint8Array(a.split("").map(function(a){return a.charCodeAt(0)}))},__bitsToBuffer:function(a){var b=[],c=a.length%8?new Array(9-a.length%8).join("0"):"";a=c+a;for(var d=0;d<a.length;d+=8)b.push(parseInt(a.substr(d,8),2));return new Uint8Array(b)},serializeEBML:function(a){if(!c.is_array(a))return a;var b=[];return a.forEach(function(a){var c=a.data,d=typeof c;"object"===d?c=this.serializeEBML(c):"number"===d?c=this.__bitsToBuffer(c.toString(2)):"string"===d&&(c=this.__strToBuffer(c));var e=c.size||c.byteLength||c.length,f=Math.ceil(Math.ceil(Math.log(e)/Math.log(2))/8),g=e.toString(2),h=new Array(7*f+7+1-g.length).join("0")+g,i=new Array(f).join("0")+"1"+h;b.push(this.__numToBuffer(a.id)),b.push(this.__bitsToBuffer(i)),b.push(c)},this),new Blob(b,{type:"video/webm"})},makeTimecodeDataBlock:function(a,b){return{data:this.makeSimpleBlock({discardable:0,frame:a.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(b)}),id:163}},makeCluster:function(a,b){return a.unshift({data:b,id:231}),{id:524531317,data:a}}}}),a.define("module:Player.FlashPlayer",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Promise"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=a.extend({scoped:l},function(a){return{constructor:function(b,c){a.constructor.call(this,b,c),this._source=this.__preferedSource(),this._embedding=this.auto_destroy(new e(b,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1})),this._flashObjs={},this._flashData={status:"idle"},this.ready=k.create(),this._embedding.ready(this.__initializeEmbedding,this)},__preferedSource:function(){var a=[".mp4",".flv"],b=[];if(this.readAttr("src")||this.readAttr("source")||this.readAttr("sources")){var d=this.readAttr("src")||this.readAttr("source")||this.readAttr("sources");j.is_array(d)?b=d:b.push(d)}var e=this._element;if(c.isInternetExplorer()&&c.internetExplorerVersion()<9)for(var g=this._element;;){var i=g.nextSibling;if(!i||!i.tagName||"source"!=i.tagName.toLowerCase())break;b.push(i.src.toLowerCase()),g=i}else for(var k=0;k<this._element.childNodes.length;++k)e.childNodes[k].tagName&&"source"==e.childNodes[k].tagName.toLowerCase()&&e.childNodes[k].src&&b.push(e.childNodes[k].src.toLowerCase());b=h.map(b,function(a){return a.src||a});for(var l=b[0],m=a.length-1,n=b.length-1;n>=0;--n)for(var o=0;m>=o;++o)if(f.ends_with(b[n],a[o])){l=b[n],m=o;break}-1==l.indexOf("://")&&(l=document.location.href+"/../"+l);var p=null,q=l;if(f.starts_with(l,"rtmp")){var r=f.splitLast(l,"/");p=r.head,q=r.tail}return{sourceUrl:l,connectionUrl:p,playUrl:q}},__initializeEmbedding:function(){if(this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this.readAttr("poster")){this._flashObjs.imageLoader=this._embedding.newObject("flash.display.Loader");var a=this._flashObjs.imageLoader.get("contentLoaderInfo");a.addEventListener("complete",this._embedding.newCallback(i.as_method(function(){this.__imageLoaded={width:this._flashObjs.imageLoader.get("width"),height:this._flashObjs.imageLoader.get("height")},this.__metaLoaded||this.recomputeBB()},this))),a.addEventListener("ioError",this._embedding.newCallback(i.as_method(function(){this.domEvent("postererror")},this))),this._flashObjs.imageUrlRequest=this._embedding.newObject("flash.net.URLRequest",this.readAttr("poster")),this._flashObjs.imageLoader.load(this._flashObjs.imageUrlRequest),this._flashObjs.main.addChildVoid(this._flashObjs.imageLoader)}this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this._embedding.newCallback(i.as_method(this.__connectionStatusEvent,this))),this._flashObjs.connection.connectVoid(this._source.connectionUrl)},__connectionStatusEvent:function(){this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.set("client",this._embedding.newCallback("onMetaData",i.as_method(function(a){this._flashData.meta=a,this._element.duration=a.duration,this.__metaLoaded=!0,g.eventually(this.recomputeBB,this)},this))),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(i.as_method(this.__streamStatusEvent,this))),this._flashObjs.soundTransform=this._embedding.newObject("flash.media.SoundTransform"),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this._flashObjs.video.attachNetStreamVoid(this._flashObjs.stream),this.writeAttr("volume",1),this.hasAttr("muted")&&(this._flashObjs.soundTransform.set("volume",0),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.writeAttr("volume",0)),this._flashObjs.main.addChildVoid(this._flashObjs.video),this.hasAttr("autoplay")&&this._element.play(),this.ready.asyncSuccess(this)},__streamStatusEvent:function(a){var b=a.get("info").code;"NetStream.Play.StreamNotFound"==b&&(this._flashData.status="error",this.domEvent("videoerror")),"NetStream.Play.Start"==b&&(this._flashData.status="start"),"NetStream.Play.Stop"==b&&(this._flashData.status="stopping"),"NetStream.Buffer.Empty"==b&&"stopping"==this._flashData.status&&(this._flashData.status="stopped",this.domEvent("ended")),"stopped"==this._flashData.status&&this.hasAttr("loop")&&(this._flashData.status="idle",this._element.play())},idealBB:function(){return this.__imageLoaded||this.__metaLoaded?{width:this.__metaLoaded?this._flashData.meta.width:this.__imageLoaded.width,height:this.__metaLoaded?this._flashData.meta.height:this.__imageLoaded.height}:null},setActualBB:function(a){["object","embed"].forEach(function(b){var c=this._element.getElementsByTagName(b.toUpperCase())[0];c&&["width","height"].forEach(function(b){c.style[b]=a[b]+"px"})},this),this.__metaLoaded&&(this._flashObjs.video.set("width",a.width),this._flashObjs.video.set("height",a.height)),this.__imageLoaded&&(this._flashObjs.imageLoader.set("width",a.width),this._flashObjs.imageLoader.set("height",a.height))},videoWidth:function(){return this.__metaLoaded?this._flashData.meta.width:this.__imageLoaded?this.__imageLoaded.width:NaN},videoHeight:function(){return this.__metaLoaded?this._flashData.meta.height:this.__imageLoaded?this.__imageLoaded.height:NaN},_domMethods:["play","pause","load"],_domAttrs:{volume:{set:"_setVolume"},currentTime:{get:"_getCurrentTime",set:"_setCurrentTime"}},load:function(){},play:function(){this._flashObjs.main.imageLoader&&this._flashObjs.main.setChildIndex(this._flashObjs.video,1),"paused"===this._flashData.status?this._flashObjs.stream.resumeVoid():this._flashObjs.stream.playVoid(this._source.playUrl),this._flashData.status="playing",this.domEvent("playing")},pause:function(){"paused"!==this._flashData.status&&(this._flashData.status="paused",this._flashObjs.stream.pauseVoid(),this.domEvent("pause"))},_setVolume:function(a){this._flashObjs.soundTransform.set("volume",a),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.domEvent("volumechange")},_getCurrentTime:function(){return this._flashObjs.stream.get("time")},_setCurrentTime:function(a){this._flashObjs.stream.seek(a)}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new d,this.__flashRegistry.register("flash.media.Video",["attachNetStream"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"])),this.__flashRegistry},polyfill:function(a,c,d,e){if(e){var f=k.create();return g.eventually(function(){f.asyncSuccess(m.polyfill(a,c,d))}),f}return"video"==a.tagName.toLowerCase()&&"networkState"in a?a.networkState==a.NETWORK_NO_SOURCE||d?m.attach(b.changeTag(a,c||"videopoly")):a:m.attach(a)},attach:function(a,b){new m(a,b);return a}});return m}),a.define("module:Player.Support",function(){return{resolutionToLabel:function(a,b){return 300>b?"SD":400>b?"360p":500>b?"480p":"HD"}}}),a.define("module:Player.VideoPlayerWrapper",["base:Classes.OptimisticConditionalInstance","base:Events.EventsMixin","base:Types","base:Objs","base:Strings","browser:Events"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,function(a){return{constructor:function(b,g){a.constructor.call(this),b=d.extend(d.clone(b||{},1),g),this._poster=b.poster||null;var h=b.source||b.sources||[];c.is_string(h)?h=h.split(" "):c.is_array(h)||(h=[h]);var i=[];d.iter(h,function(a){if(c.is_string(a)?a={src:a.trim()}:"undefined"!=typeof Blob&&a instanceof Blob&&(a={src:a}),a.ext&&!a.type&&(a.type="video/"+a.ext),!a.ext&&a.type&&(a.ext=e.last_after(a.type,"/")),!a.ext&&!a.type&&c.is_string(a.src)){var b=e.splitFirst(a.src,"?").head;b.indexOf(".")>=0&&(a.ext=e.last_after(b,"."),a.type="video/"+a.ext)}a.ext&&(a.ext=a.ext.toLowerCase()),a.type&&(a.type=a.type.toLowerCase()),"undefined"!=typeof Blob&&a.src instanceof Blob&&(a.src=(window.URL||window.webkitURL).createObjectURL(a.src)),"undefined"!=typeof Blob&&a.audiosrc instanceof Blob&&(a.audiosrc=(window.URL||window.webkitURL).createObjectURL(a.audiosrc)),i.push(a)},this),this._sources=i,this._element=b.element,this._preload=b.preload||!1,this._reloadonplay=b.reloadonplay||!1,this._options=b,this._loop=b.loop||!1,this._loaded=!1,this._postererror=!1,this._error=0,this._domEvents=new f},destroy:function(){this._domEvents.destroy(),a.destroy.call(this)},poster:function(){return this._poster},sources:function(){return this._sources},loaded:function(){return this._loaded},postererror:function(){return this._postererror},buffered:function(){},_eventLoaded:function(){this._loaded=!0,this.trigger("loaded")},_eventPlaying:function(){this._loaded||this._eventLoaded(),this.trigger("playing")},_eventPaused:function(){this.trigger("paused")},_eventEnded:function(){this.trigger("ended")},_eventError:function(a){this._error=a,this.trigger("error",a)},_eventPosterError:function(){this._postererror=!0,this.trigger("postererror")},supportsFullscreen:function(){return!1},duration:function(){return this._element.duration},position:function(){return this._element.currentTime},enterFullscreen:function(){},exitFullscreen:function(){},isFullscreen:function(){return!1},error:function(){return this._error},play:function(){this._reloadonplay&&this._element.load(),this._reloadonplay=!1,this._element.play()},pause:function(){this._element.pause()},setPosition:function(a){this._element.currentTime=a},muted:function(){return this._element.muted},setMuted:function(a){this._element.muted=a},volume:function(){return this._element.volume},setVolume:function(a){this._element.volume=a},videoWidth:function(){},videoHeight:function(){}}}],{ERROR_NO_PLAYABLE_SOURCE:1,ERROR_FLASH_NOT_INSTALLED:2})}),a.define("module:Player.Html5VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","browser:Info","base:Promise","base:Objs","base:Timers.Timer","base:Strings","base:Async","browser:Dom","browser:Events"],function(a,b,c,d,e,f,g,h,i,j){return a.extend({scoped:j},function(a){return{_initialize:function(){if(this._options.nohtml5)return c.error(!0);if(this._sources.length<1)return c.error(!0);if(b.isInternetExplorer()&&b.internetExplorerVersion()<9)return c.error(!0);if(this._options.forceflash)return c.error(!0);var a=c.create();this._element.innerHTML="";var g=this.sources(),j=b.isInternetExplorer()&&9==b.internetExplorerVersion();if("video"!==this._element.tagName.toLowerCase())this._element=h.changeTag(this._element,"video"),this._transitionals.element=this._element;else if(j){var k=f.splitLast(this._element.outerHTML,"</video>").head;d.iter(g,function(a){k+="<source"+(a.type?" type='"+a.type+"'":"")+" src='"+a.src+"' />"}),k+="</video>";var l=h.elementByTemplate(k);h.elementInsertAfter(l,this._element),this._element.parentNode.removeChild(this._element),this._element=l,this._transitionals.element=this._element}this._domEvents.on(this._element,"loadevent",function(){return this._element.networkState===this._element.NETWORK_NO_SOURCE?void a.asyncError(!0):void a.asyncSuccess(!0)},this);var m=10,n=new e({context:this,fire:function(){this._element.networkState===this._element.NETWORK_NO_SOURCE?(m--,0>=m&&a.asyncError(!0)):this._element.networkState===this._element.NETWORK_IDLE&&a.asyncSuccess(!0)},delay:50});this._preload||(this._element.preload="none"),this._loop&&(this._element.loop="loop");var o=0;this._audioElement=null;var p=new i;if(j)for(var q=this._element.getElementsByTagName("SOURCE"),r=function(){o++,o===g.length&&a.asyncError(!0)},s=0;s<q.length;++s)p.on(q[s],"error",r);else d.iter(g,function(b){var c=document.createElement("source");if(b.type&&(c.type=b.type),this._element.appendChild(c),p.on(c,"error",function(){o++,o===g.length&&a.asyncError(!0)}),c.src=b.src,b.audiosrc){this._audioElement||(this._audioElement=document.createElement("audio"),h.elementInsertAfter(this._audioElement,this._element));var d=document.createElement("source");b.type&&(d.type=b.type),this._audioElement.appendChild(d),d.src=b.audiosrc}},this);this.poster()&&(this._element.poster=this.posterURL()),a.callback(function(){p.weakDestroy(),n.destroy()},this),a.success(function(){this._setup()},this);try{b.isChrome()||this._element.load()}catch(t){}return a},posterURL:function(){var a=this.poster();return a&&"undefined"!=typeof Blob&&a instanceof Blob?(window.URL||window.webkitURL).createObjectURL(a):a},destroy:function(){this._audioElement&&this._audioElement.remove(),this.supportsFullscreen()&&this.__fullscreenListener&&h.elementOffFullscreenChange(this._element,this.__fullscreenListener),(!b.isInternetExplorer()||b.internetExplorerVersion()>8)&&(this._element.innerHTML=""),a.destroy.call(this)},_setup:function(){this._loaded=!1,this._domEvents.on(this._element,"canplay",this._eventLoaded,this),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this);for(var a=this,c=this._element.getElementsByTagName("SOURCE"),d=function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},e=0;e<c.length;++e)this._domEvents.on(c[e],"error",d,this);if(this.poster()){var f=new Image;f.onerror=function(){delete a._element.poster,delete a._element.preload,a._eventPosterError()},f.src=this.posterURL(),f.onload=function(){a.__imageWidth=f.width,a.__imageHeight=f.height}}b.isSafari()&&(b.safariVersion()>5||b.safariVersion()<9)&&this._element.networkState===this._element.NETWORK_LOADING&&g.eventually(function(){this.destroyed()||this._element.networkState!==this._element.NETWORK_LOADING||0!==this._element.buffered.length||this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this,1e4),this.supportsFullscreen()&&(this.__videoClassBackup="",this.__fullscreenListener=h.elementOnFullscreenChange(this._element,function(a,b){this.trigger("fullscreen-change",b),b?(this.__videoClassBackup=this._element.className,this._element.className=""):(this._element.className=this.__videoClassBackup,this.__videoClassBackup="")},this))},buffered:function(){return this._element.buffered.end(0)},_fullscreenElement:function(){return b.isFirefox()?this._element.parentElement:this._element},supportsFullscreen:function(){return h.elementSupportsFullscreen(this._fullscreenElement())},enterFullscreen:function(){h.elementEnterFullscreen(this._fullscreenElement())},exitFullscreen:function(){h.documentExitFullscreen()},isFullscreen:function(){return h.elementIsFullscreen(this._fullscreenElement())},videoWidth:function(){return this._element.width||this.__imageWidth||NaN},videoHeight:function(){return this._element.height||this.__imageHeight||NaN},play:function(){a.play.call(this),this._audioElement&&(this._reloadonplay&&this._audioElement.load(),this._audioElement.play())},pause:function(){this._element.pause(),this._audioElement&&this._audioElement.pause()},setPosition:function(a){this._element.currentTime=a,this._audioElement&&(this._audioElement.currentTime=a)},muted:function(){return(this._audioElement?this._audioElement:this._element).muted},setMuted:function(a){(this._audioElement?this._audioElement:this._element).muted=a},volume:function(){return(this._audioElement?this._audioElement:this._element).volume},setVolume:function(a){(this._audioElement?this._audioElement:this._element).volume=a}}})}),a.define("module:Player.FlashPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayer","browser:Info","base:Promise","browser:Dom"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{_initialize:function(){if(this._options.noflash)return d.error(!0);if(this._sources.length<1)return d.error(!0);if(c.isMobile()||!c.flash().supported())return d.error(!0);if(!c.flash().installed()&&this._options.flashinstallrequired)return d.error(!0);if(!c.flash().installed())return this._eventError(this.cls.ERROR_NO_FLASH_INSTALLED),d.value(!0);d.create();"div"!==this._element.tagName.toLowerCase()&&(this._element=e.changeTag(this._element,"div"),this._transitionals.element=this._element);var a={poster:this.poster(),sources:this.sources()};return this._loop&&(a.loop=!0),this._flashPlayer=new b(this._element,a),this._flashPlayer.ready.success(function(){this._setup()},this)},destroy:function(){this._flashPlayer&&this._flashPlayer.weakDestroy(),this._element.innerHTML="",a.destroy.call(this)},_setup:function(){this._loaded=!0,this._eventLoaded(),this._domEvents.on(this._element,"playing",this._eventPlaying,this),this._domEvents.on(this._element,"pause",this._eventPaused,this),this._domEvents.on(this._element,"ended",this._eventEnded,this),this._domEvents.on(this._element,"videoerror",function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)},this),this._domEvents.on(this._element,"postererror",this._eventPosterError,this)},position:function(){return this._element.get("currentTime")},buffered:function(){return this.position()},setPosition:function(a){this._element.set("currentTime",a)},setVolume:function(a){
this._element.set("volume",a)},videoWidth:function(){return this._flashPlayer?this._flashPlayer.videoWidth():null},videoHeight:function(){return this._flashPlayer?this._flashPlayer.videoHeight():null}}})}),a.extend("module:Player.VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.Html5VideoPlayerWrapper"],function(a,b){return a.register(b,2),{}}),a.extend("module:Player.VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayerWrapper"],function(a,b){return a.register(b,1),{}}),a.define("module:Flash.FlashRecorder",["browser:DomExtend.DomExtension","browser:Dom","browser:Info","flash:FlashClassRegistry","flash:FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","base:Timers.Timer","base:Time","base:Promise","base:Events.EventsMixin","module:Recorder.PixelSampleMixin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=a.extend({scoped:p},[n,o,function(a){return{constructor:function(b,c){a.constructor.call(this,b,c),this._embedding=this.auto_destroy(new e(b,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1},{parentBgcolor:!0,fixHalfPixels:!0})),this._flashObjs={},this.ready=m.create(),this.__status="idle",this.__disableAudio=this.readAttr("disableaudio")||!1,this.__cameraWidth=this.readAttr("camerawidth")||640,this.__cameraHeight=this.readAttr("cameraheight")||480,this.__audioRate=this.readAttr("audiorate")||44,this.__audioQuality=this.readAttr("audioquality")||10,this.__videoRate=this.readAttr("videorate")||0,this.__videoQuality=this.readAttr("videoquality")||90,this.__streamType=this.readAttr("streamtype")||"mp4",this.__microphoneCodec=this.readAttr("microphonecodec")||"speex",this.__fps=this.readAttr("fps")||20,this.__defaultGain=55,this._flip=j.parseBool(this.readAttr("flip")||!1),this._embedding.ready(this.__initializeEmbedding,this)},averageFrameRate:function(){return this.__fps},__initializeEmbedding:function(){this.__hasMicrophoneActivity=!1,this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.cameraVideo=this._embedding.newObject("flash.media.Video",this.__cameraWidth,this.__cameraHeight),this._flashObjs.main.addChildVoid(this._flashObjs.video),this._flashObjs.Microphone=this._embedding.getClass("flash.media.Microphone"),this._flashObjs.Camera=this._embedding.getClass("flash.media.Camera"),this._flashObjs.microphone=this._flashObjs.Microphone.getMicrophone(0),this.setMicrophoneProfile(),this._flashObjs.camera=this._flashObjs.Camera.getCamera(0),this._currentCamera=0,this._currentMicrophone=0,this._flashObjs.Security=this._embedding.getClass("flash.system.Security"),this.recomputeBB(),this.ready.asyncSuccess(this),this.auto_destroy(new k({delay:100,fire:this._fire,context:this}))},isAccessGranted:function(){return!(this._flashObjs.camera&&this._flashObjs.camera.get("muted")||this._flashObjs.microphone&&this._flashObjs.microphone.get("muted"))},isSecurityDialogOpen:function(){var a=this._embedding.newObject("flash.display.BitmapData",1,1),b=!1;try{a.draw(this._flashObjs.stage)}catch(c){b=!0}return a.dispose(),a.destroy(),b},openSecurityDialog:function(a){this.trigger("require_display"),a?this._flashObjs.Security.showSettings("privacy"):(this._flashObjs.video.attachCamera(null),this._flashObjs.video.attachCamera(this._flashObjs.camera))},grantAccess:function(a,b){var c=m.create(),d=new k({fire:function(){this.isSecurityDialogOpen()||(this.isAccessGranted()?(d.destroy(),c.asyncSuccess(!0)):b?(d.destroy(),c.asyncError(!0)):this.openSecurityDialog(a))},context:this,delay:10,start:!0});return c},bindMedia:function(a,b){return this.grantAccess(a,b).mapSuccess(function(){this._mediaBound=!0,this._attachCamera()},this)},unbindMedia:function(){this._detachCamera(),this._mediaBound=!1},_attachCamera:function(){this._flashObjs.camera.setMode(this.__cameraWidth,this.__cameraHeight,this.__fps),this._flashObjs.camera.setQuality(this.__videoRate,this.__videoQuality),this._flashObjs.camera.setKeyFrameInterval(5),this._flashObjs.video.attachCamera(this._flashObjs.camera),this._flashObjs.cameraVideo.attachCamera(this._flashObjs.camera),this._flip&&(this._flashObjs.video.get("scaleX")>0&&this._flashObjs.video.set("scaleX",-this._flashObjs.video.get("scaleX")),this._flashObjs.video.set("x",this._flashObjs.video.get("width")))},_detachCamera:function(){this._flashObjs.video.attachCamera(null),this._flashObjs.cameraVideo.attachCamera(null)},enumerateDevices:function(){return{audios:this._flashObjs.Microphone.get("names"),videos:this._flashObjs.Camera.get("names")}},selectMicrophone:function(a){this._flashObjs.microphone&&this._flashObjs.microphone.weakDestroy(),this.__hasMicrophoneActivity=!1,this.__microphoneActivityTime=null,this._flashObjs.microphone=this._flashObjs.Microphone.getMicrophone(a),this._currentMicrophone=a,this.setMicrophoneProfile(this._currentMicrophoneProfile)},selectCamera:function(a){this._flashObjs.camera&&this._flashObjs.camera.weakDestroy(),this.__cameraActivityTime=null,this._flashObjs.camera=this._flashObjs.Camera.getCamera(a),this._currentCamera=a,this._mediaBound&&this._attachCamera()},currentCamera:function(){return this._currentCamera},currentMicrophone:function(){return this._currentMicrophone},microphoneInfo:function(){return{muted:this._flashObjs.microphone.get("muted"),name:this._flashObjs.microphone.get("name"),activityLevel:this._flashObjs.microphone.get("activityLevel"),gain:this._flashObjs.microphone.get("gain"),rate:this._flashObjs.microphone.get("rate"),encodeQuality:this._flashObjs.microphone.get("encodeQuality"),codec:this._flashObjs.microphone.get("codec"),hadActivity:this.__hadMicrophoneActivity,inactivityTime:this.__microphoneActivityTime?l.now()-this.__microphoneActivityTime:null}},cameraInfo:function(){return{muted:this._flashObjs.camera.get("muted"),name:this._flashObjs.camera.get("name"),activityLevel:this._flashObjs.camera.get("activityLevel"),fps:this._flashObjs.camera.get("fps"),width:this._flashObjs.camera.get("width"),height:this._flashObjs.camera.get("height"),inactivityTime:this.__cameraActivityTime?l.now()-this.__cameraActivityTime:null}},setMicrophoneProfile:function(a){a=a||{},this._flashObjs.microphone.setLoopBack(a.loopback||!1),this._flashObjs.microphone.set("gain",a.gain||this.__defaultGain),this._flashObjs.microphone.setSilenceLevel(a.silenceLevel||0),this._flashObjs.microphone.setUseEchoSuppression(a.echoSuppression||!1),this._flashObjs.microphone.set("rate",a.rate||this.__audioRate),this._flashObjs.microphone.set("encodeQuality",a.encodeQuality||this.__audioQuality),this._flashObjs.microphone.set("codec",a.codec||this.__microphoneCodec),this._currentMicrophoneProfile=a},getVolumeGain:function(){var a=this._mediaBound?this._flashObjs.micropone.get("gain"):55;return a/55},setVolumeGain:function(a){this.__defaultGain=Math.min(Math.max(0,Math.round(55*a)),100),this._mediaBound&&this._flashObjs.microphone.set("gain",this.__defaultGain)},_pixelSample:function(a,b,c){a=a||100;var d=this._flashObjs.cameraVideo.get("width"),e=this._flashObjs.cameraVideo.get("height"),f=this._embedding.newObject("flash.display.BitmapData",d,e);f.draw(this._flashObjs.cameraVideo);for(var g=2;a>0;){for(var h=1;g>h;++h){for(var i=1;g>i;++i){var j=f.getPixel(Math.floor(h*d/g),Math.floor(i*e/g));if(b.call(c||this,j%256,j/256%256,j/256/256%256),--a,0>=a)break}if(0>=a)break}++g}f.destroy()},testSoundLevel:function(a){this.setMicrophoneProfile(a?{loopback:!0,gain:55,silenceLevel:100,echoSuppression:!0}:{})},soundLevel:function(){return this._flashObjs.microphone.get("activityLevel")},_fire:function(){if(this._mediaBound&&(this.__hadMicrophoneActivity=this.__hadMicrophoneActivity||this._flashObjs.microphone&&this._flashObjs.microphone.get("activityLevel")>0,this._flashObjs.microphone&&this._flashObjs.microphone.get("activityLevel")>0&&(this.__microphoneActivityTime=l.now()),this._flashObjs.camera)){var a=this._flashObjs.camera.get("activityLevel");this.__lastCameraActivity&&this.__lastCameraActivity===a||(this.__cameraActivityTime=l.now()),this.__lastCameraActivity=a}},createSnapshot:function(){var a=this._embedding.newObject("flash.display.BitmapData",this._flashObjs.cameraVideo.get("videoWidth"),this._flashObjs.cameraVideo.get("videoHeight"));return a.draw(this._flashObjs.cameraVideo),a},postSnapshot:function(a,b,c,d){var e=m.create();d=d||90;var f=this._embedding.newObject("flash.net.URLRequestHeader","Content-type","application/octet-stream"),g=this._embedding.newObject("flash.net.URLRequest",b);if(g.set("requestHeaders",[f]),g.set("method","POST"),"jpg"===c){var h=this._embedding.newObject("com.adobe.images.JPGEncoder",d);g.set("data",h.encode(a)),h.destroy()}else{var j=this._embedding.getClass("com.adobe.images.PNGEncoder");g.set("data",j.encode(a))}var k=this._embedding.newObject("flash.net.URLLoader");return k.set("dataFormat","BINARY"),k.addEventListener("complete",this._embedding.newCallback(i.as_method(function(){e.asyncSuccess(!0)},this))),k.addEventListener("ioError",this._embedding.newCallback(i.as_method(function(){e.asyncError("IO Error")},this))),k.load(g),e.callback(function(){k.destroy(),g.destroy(),f.destroy()}),e},createSnapshotDisplay:function(a,b,c,d,e){var f=this._embedding.newObject("flash.display.Bitmap",a);return this.updateSnapshotDisplay(a,f,b,c,d,e),this._flashObjs.main.addChildVoid(f),f},updateSnapshotDisplay:function(a,b,c,d,e,f){b.set("x",c),b.set("y",d),b.set("scaleX",e/a.get("width")),b.set("scaleY",f/a.get("height"))},removeSnapshotDisplay:function(a){this._flashObjs.main.removeChildVoid(a),a.destroy()},idealBB:function(){return{width:this.__cameraWidth,height:this.__cameraHeight}},setActualBB:function(a){["object","embed"].forEach(function(b){var c=this._element.getElementsByTagName(b.toUpperCase())[0];c&&["width","height"].forEach(function(b){c.style[b]=a[b]+"px"})},this);var b=this._flashObjs.video;b&&(b.set("width",a.width),b.set("height",a.height),this._flip&&(b.get("scaleX")>0&&b.set("scaleX",-b.get("scaleX")),b.set("x",b.get("width"))))},_error:function(a){this.__status="error",this.trigger("error",a)},_status:function(a){return a&&a!==this.__status&&(this.__status=a,this.trigger("status",a),this.trigger(a)),this.__status},startRecord:function(a,b){this._status("connecting"),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this._embedding.newCallback(i.as_method(function(a){var c=a.get("info").code;return"NetConnection.Connect.Closed"===c&&"recording"===this._status()?void this._error("Connection to server interrupted."):"NetConnection.Connect.Success"===c&&"connecting"!==this._status()?void this._error("Could not connect to server"):void("NetConnection.Connect.Success"===c&&"connecting"===this._status()&&("mp4"===this.__streamType&&this._flashObjs.connection.callVoid("setStreamType",null,"live"),this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(i.as_method(function(a){var b=a.get("info").code;return"NetStream.Record.Start"===b?void this._status("recording"):"NetStream.Play.StreamNotFound"===b?(this._flashObjs.stream.closeVoid(),void("none"!==this._status()&&this._error("Stream not found"))):("NetStream.Buffer.Empty"===b&&"uploading"===this._status()&&"mp4"===this.__streamType&&this._flashObjs.stream.publish(null),void(("NetStream.Unpublish.Success"===b||"uploading"===this._status()&&"NetStream.Buffer.Empty"===b&&"flv"===this.__streamType&&0===this._flashObjs.stream.get("bufferLength"))&&(this._flashObjs.stream.closeVoid(),this._flashObjs.stream.destroy(),this._flashObjs.stream=null,this._flashObjs.connection.closeVoid(),this._flashObjs.connection.destroy(),this._flashObjs.connection=null,this._status("finished"))))},this))),this._flashObjs.stream.set("bufferTime",120),"mp4"===this.__streamType&&(this._flashObjs.h264Settings=this._embedding.newObject("flash.media.H264VideoStreamSettings"),this._flashObjs.h264Settings.setProfileLevel("baseline","3.1"),this._flashObjs.stream.set("videoStreamSettings",this._flashObjs.h264Settings)),this._flashObjs.stream.attachCameraVoid(this._flashObjs.camera),this.__disableAudio||this._flashObjs.stream.attachAudioVoid(this._flashObjs.microphone),this._flashObjs.stream.publish(b,"record")))},this))),this._flashObjs.connection.connectVoid(a)},stopRecord:function(){"recording"===this._status()&&(this.__initialBufferLength=0,this._status("uploading"),this.__initialBufferLength=this._flashObjs.stream.get("bufferLength"),this._flashObjs.stream.attachCameraVoid(null))},uploadStatus:function(){return{total:this.__initialBufferLength,remaining:this._flashObjs.stream.get("bufferLength")}}}}],{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new d,this.__flashRegistry.register("flash.media.Microphone",["setLoopBack","setSilenceLevel","setUseEchoSuppression"],["getMicrophone"]),this.__flashRegistry.register("flash.media.Camera",["setMode","setQuality","setKeyFrameInterval","addEventListener"],["getCamera"]),this.__flashRegistry.register("flash.media.Video",["attachCamera","attachNetStream"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.media.H264VideoStreamSettings",["setProfileLevel"]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek","attachCamera","attachAudio","publish","close"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener","call","close"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.net.URLRequestHeader",[]),this.__flashRegistry.register("flash.net.URLLoader",["addEventListener","load"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","removeChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"]),this.__flashRegistry.register("flash.display.BitmapData",["draw","getPixel","dispose"]),this.__flashRegistry.register("flash.display.Bitmap",[]),this.__flashRegistry.register("flash.system.Security",[],["allowDomain","showSettings"]),this.__flashRegistry.register("com.adobe.images.PNGEncoder",[],["encode"]),this.__flashRegistry.register("com.adobe.images.JPGEncoder",["encode"])),this.__flashRegistry},attach:function(a,b){new q(a,b);return a}});return q}),a.define("module:Flash.Support",["base:Promise","base:Timers.Timer","base:Async","base:Objs","flash:FlashClassRegistry","flash:FlashEmbedding","browser:Info"],function(a,b,c,d,e,f,g){return{flashCanConnect:function(d,h){if(!g.flash().installed())return a.error(!1);var i=a.create(),j=new e;j.register("flash.net.NetConnection",["connect","addEventListener"]);var k=new f(null,{registry:j,wrap:!0});k.ready(function(){var a=k.newObject("flash.net.NetConnection");a.addEventListener("netStatus",k.newCallback(function(a){a.get("info")&&"NetConnection.Connect.Success"===a.get("info").code?i.asyncSuccess(!0):i.asyncError(!1)})),a.connectVoid(d)});var l=null;return h&&(l=new b({delay:h,once:!0,start:!0,fire:function(){i.asyncError()}})),i.callback(function(){l&&l.destroy(),c.eventually(function(){k.destroy()})}),i},enumerateMediaSources:function(){if(!g.flash().installed())return a.error(!1);var b=a.create(),h=new e;h.register("flash.media.Microphone"),h.register("flash.media.Camera");var i=new f(null,{registry:h,wrap:!0});return i.ready(function(){var a=i.getClass("flash.media.Camera").get("names"),c=i.getClass("flash.media.Microphone").get("names");b.asyncSuccess({videoCount:d.count(a),audioCount:d.count(c),video:d.map(a,function(a,b){return{id:b,label:a}}),audio:d.map(c,function(a,b){return{id:b,label:a}})})}),b.callback(function(){c.eventually(function(){i.destroy()})}),b}}}),a.define("module:Recorder.PixelSampleMixin",[],function(){return{lightLevel:function(a){a=a||100;var b=0;return this._pixelSample(a,function(a,c,d){b+=a+c+d}),b/(3*a)},blankLevel:function(a){a=a||100;var b=0;return this._pixelSample(a,function(a,c,d){b+=Math.pow(a,2)+Math.pow(c,2)+Math.pow(d,2)}),Math.sqrt(b/(3*a))},_materializePixelSample:function(a){var b=[];return this._pixelSample(a,function(a,c,d){b.push([a,c,d])}),b},deltaCoefficient:function(a){a=a||100;var b=this._materializePixelSample(a);if(!this.__deltaSample)return this.__deltaSample=b,null;for(var c=0,d=0;d<b.length;++d)for(var e=0;3>e;++e)c+=Math.pow(b[d][e]-this.__deltaSample[d][e],2);return this.__deltaSample=b,Math.sqrt(c/(3*a))}}}),a.define("module:Recorder.VideoRecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","base:Promise"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b){a.constructor.call(this,b),this._element=this._options.element,this.ready=d.create()},destroy:function(){a.destroy.call(this)},bindMedia:function(){return this._bindMedia()},_bindMedia:function(){},unbindMedia:function(){return this._unbindMedia()},_unbindMedia:function(){},cameraWidth:function(){return this._options.recordingWidth},cameraHeight:function(){return this._options.recordingHeight},lightLevel:function(){},soundLevel:function(){},testSoundLevel:function(a){},blankLevel:function(){},deltaCoefficient:function(){},getVolumeGain:function(){},setVolumeGain:function(a){},enumerateDevices:function(){},currentDevices:function(){},setCurrentDevices:function(a){},createSnapshot:function(){},removeSnapshot:function(a){},createSnapshotDisplay:function(a,b,c,d,e,f){},updateSnapshotDisplay:function(a,b,c,d,e,f){},removeSnapshotDisplay:function(a){},createSnapshotUploader:function(a,b,c){},startRecord:function(a){},stopRecord:function(a){},isFlash:function(){return!1},supportsLocalPlayback:function(){return!1},snapshotToLocalPoster:function(a){return null},localPlaybackSource:function(){return null},averageFrameRate:function(){return null}}}],{_initializeOptions:function(a){return c.extend({forceflash:!1,noflash:!1,recordingWidth:640,recordingHeight:480,recordVideo:!0,recordAudio:!0},a)}})}),a.define("module:Recorder.WebRTCVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:WebRTC.RecorderWrapper","module:WebRTC.Support","module:WebRTC.AudioAnalyser","browser:Dom","base:Objs","browser:Upload.FileUploader","browser:Upload.MultiUploader","base:Promise"],function(a,b,c,d,e,f,g,h,i,j){return a.extend({scoped:j},function(a){return{constructor:function(c){a.constructor.call(this,c),"video"!==this._element.tagName.toLowerCase()&&(this._element=e.changeTag(this._element,"video")),this._recorder=b.create({video:this._element,flip:!!this._options.flip,framerate:this._options.framerate,recordVideo:this._options.recordVideo,recordAudio:this._options.recordAudio,recordResolution:{width:this._options.recordingWidth,height:this._options.recordingHeight},videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate,webrtcStreaming:this._options.webrtcStreaming}),this._recorder.on("bound",function(){this._analyser&&this.testSoundLevel(!0)},this),this.ready.asyncSuccess(!0)},destroy:function(){this._analyser&&this._analyser.weakDestroy(),this._recorder.destroy(),a.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia()},_unbindMedia:function(){return this._recorder.unbindMedia()},lightLevel:function(){return this._recorder.lightLevel()},blankLevel:function(){return this._recorder.blankLevel()},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(a){this._recorder.setVolumeGain(a)},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},soundLevel:function(){return!this._analyser&&this._recorder&&this._recorder.stream()&&(this._analyser=new d(this._recorder.stream())),this._analyser?this._analyser.soundLevel():0},testSoundLevel:function(a){this._analyser&&(this._analyser.weakDestroy(),delete this._analyser),a&&(this._analyser=new d(this._recorder.stream()))},currentDevices:function(){return{video:this._currentVideo,audio:this._currentAudio}},enumerateDevices:function(){return c.enumerateMediaSources().success(function(a){this._currentVideo||(this._currentVideo=f.ithKey(a.video)),this._currentAudio||(this._currentAudio=f.ithKey(a.audio))},this)},setCurrentDevices:function(a){a&&a.video&&this._recorder.selectCamera(a.video),a&&a.audio&&this._recorder.selectMicrophone(a.audio)},createSnapshot:function(a){return this._recorder.createSnapshot(a)},removeSnapshot:function(a){},createSnapshotDisplay:function(a,b,d,f,g,h){var i=c.globals().URL.createObjectURL(b),j=document.createElement("img");return j.style.position="absolute",this.updateSnapshotDisplay(b,j,d,f,g,h),j.src=i,e.elementPrependChild(a,j),j},updateSnapshotDisplay:function(a,b,c,d,e,f){b.style.left=c+"px",b.style.top=d+"px",b.style.width=e+"px",b.style.height=f+"px"},removeSnapshotDisplay:function(a){a.remove()},createSnapshotUploader:function(a,b,c){return g.create(f.extend({source:a},c))},startRecord:function(a){return this.__localPlaybackSource=null,this._recorder.startRecord(a),i.value(!0)},stopRecord:function(a){var b=i.create();return this._recorder.once("data",function(c,d){this.__localPlaybackSource={src:c,audiosrc:d};var e=new h;this._options.simulate||(c&&e.addUploader(g.create(f.extend({source:c},a.video))),d&&e.addUploader(g.create(f.extend({source:d},a.audio)))),b.asyncSuccess(e)},this),this._recorder.stopRecord(),b},supportsLocalPlayback:function(){return!!this.__localPlaybackSource.src},snapshotToLocalPoster:function(a){return a},localPlaybackSource:function(){return this.__localPlaybackSource},averageFrameRate:function(){return this._recorder.averageFrameRate()}}},{supported:function(a){return b.anySupport(a)&&!a.forceflash}})}),a.define("module:Recorder.FlashVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Flash.FlashRecorder","browser:Dom","browser:Info","base:Promise","base:Objs","base:Timers.Timer","browser:Upload.CustomUploader","browser:Upload.MultiUploader"],function(a,b,c,d,e,f,g,h,i,j){return a.extend({scoped:j},function(a){return{constructor:function(d){a.constructor.call(this,d),"div"!==this._element.tagName.toLowerCase()&&(this._element=c.changeTag(this._element,"div")),this._recorder=new b(this._element,{flip:!!this._options.flip,disableaudio:!this._options.recordAudio,streamtype:this._options.rtmpStreamType,camerawidth:this._options.recordingWidth,cameraheight:this._options.recordingHeight,microphonecodec:this._options.rtmpMicrophoneCodec,fps:this._options.framerate,audioRate:this._options.audioBitrate?Math.floor(this._options.audioBitrate/1e3):void 0,videoRate:this._options.videoBitrate?1e3*this._options.videoBitrate:void 0}),this._recorder.ready.forwardCallback(this.ready),this._recorder.on("require_display",function(){this.trigger("require_display")},this)},destroy:function(){this._recorder.destroy(),a.destroy.call(this)},_bindMedia:function(){return this._recorder.bindMedia(this._options.flashFullSecurityDialog)},_unbindMedia:function(){return this._recorder.unbindMedia()},blankLevel:function(){return this._recorder.blankLevel()},deltaCoefficient:function(){return this._recorder.deltaCoefficient()},lightLevel:function(){return this._recorder.lightLevel()},soundLevel:function(){var a=this._recorder.soundLevel();return 1>=a?1:1+(a-1)/100},getVolumeGain:function(){return this._recorder.getVolumeGain()},setVolumeGain:function(a){this._recorder.setVolumeGain(a)},testSoundLevel:function(a){this._recorder.testSoundLevel(a)},enumerateDevices:function(){var a=this._recorder.enumerateDevices();return e.value({videoCount:f.count(a.videos),audioCount:f.count(a.audios),video:f.map(a.videos,function(a,b){return{id:b,label:a}}),audio:f.map(a.audios,function(a,b){return{id:b,label:a}})})},currentDevices:function(){return{video:this._recorder.currentCamera(),audio:this._recorder.currentMicrophone()}},setCurrentDevices:function(a){a&&a.video&&this._recorder.selectCamera(a.video),a&&a.audio&&this._recorder.selectMicrophone(a.audio)},createSnapshot:function(a){return this._recorder.createSnapshot()},createSnapshotDisplay:function(a,b,c,d,e,f){return this._recorder.createSnapshotDisplay(b,c,d,e,f)},updateSnapshotDisplay:function(a,b,c,d,e,f){return this._recorder.updateSnapshotDisplay(a,b,c,d,e,f)},removeSnapshotDisplay:function(a){this._recorder.removeSnapshotDisplay(a)},createSnapshotUploader:function(a,b,c){var d=new h(f.extend({source:a,type:b,recorder:this._recorder},c));return d.on("upload",function(a){a.recorder.postSnapshot(a.source,a.url,a.type).success(d.successCallback,d).error(d.errorCallback,d)}),d},startRecord:function(a){if(this._options.simulate)return e.value(!0);var b=this,c={},d=e.create();return this._recorder.on("recording",function(){d.asyncSuccess(),b._recorder.off(null,null,c)},c).on("error",function(a){d.asyncError(a),b._recorder.off(null,null,c)},c),this._recorder.startRecord(a.rtmp.serverUrl,a.rtmp.streamName),d},stopRecord:function(a){if(this._options.simulate)return e.value(new i);var b=this,c={},d=new h,f=new g({delay:100,context:this,fire:function(){var a=this._recorder.uploadStatus();d.progressCallback(a.total-a.remaining,a.total)}});return this._recorder.on("finished",function(){d.successCallback(!0),b._recorder.off(null,null,c),f.weakDestroy()},c).on("error",function(a){d.errorCallback(a),b._recorder.off(null,null,c),f.weakDestroy()},c),this._recorder.stopRecord(),e.create(d)},isFlash:function(){return!0},averageFrameRate:function(){return this._recorder.averageFrameRate()}}},{supported:function(a){return!d.isMobile()&&!a.noflash&&d.flash().installed()}})}),a.extend("module:Recorder.WebRTCVideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Recorder.WebRTCVideoRecorderWrapper"],function(a,b){return a.register(b,2),{}}),a.extend("module:Recorder.VideoRecorderWrapper",["module:Recorder.VideoRecorderWrapper","module:Recorder.FlashVideoRecorderWrapper"],function(a,b){return a.register(b,1),{}}),a.define("module:WebRTC.AudioAnalyser",["base:Class","module:WebRTC.Support"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c){a.constructor.call(this);var d=b.globals().AudioContext;this._audioContext=new d,this._analyserNode=b.globals().createAnalyser.call(this._audioContext),this._analyserNode.fftSize=32,c.getAudioTracks().length>0&&(this._audioInput=this._audioContext.createMediaStreamSource(c),this._audioInput.connect(this._analyserNode))},destroy:function(){this._analyserNode.disconnect(),delete this._analyserNode,this._audioContext.close(),delete this._audioContext,a.destroy.call(this)},soundLevel:function(){if(!this._audioInput)return 0;var a=this._analyserNode.fftSize,b=new Uint8Array(a);this._analyserNode.getByteTimeDomainData(b);for(var c=0,d=0;a>d;d++)c=Math.max(c,Math.abs(b[d]/128));return c}}},{supported:function(){return!!b.globals().AudioContext&&!!b.globals().createAnalyser}})}),a.define("module:WebRTC.AudioRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Functions","module:WebRTC.Support","module:Encoding.WaveEncoder.Support"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this._channels=[],this._recordingLength=0,this._options=c.extend({audioChannels:2,bufferSize:16384,sampleRate:44100},d),this._stream=b,this._started=!1,this._stopped=!1,this._volumeGainValue=1},_audioProcess:function(a){this._started&&(this._channels.push(f.dumpInputBuffer(a.inputBuffer,this._options.audioChannels,this._actualBufferSize)),this._recordingLength+=this._actualBufferSize)},destroy:function(){this.stop(),a.destroy.call(this)},getVolumeGain:function(){return this._volumeGainValue},setVolumeGain:function(a){this._volumeGainValue=a,this._volumeGain&&(this._volumeGain.value.gain=a)},__initializeContext:function(){var a=e.globals().AudioContext;this._audioContext=new a,this._actualSampleRate=this._audioContext.sampleRate||this._options.sampleRate,this._volumeGain=this._audioContext.createGain(),this._volumeGain.gain.value=this._volumeGainValue,this._audioInput=this._audioContext.createMediaStreamSource(this._stream),this._audioInput.connect(this._volumeGain),this._scriptProcessor=e.globals().audioContextScriptProcessor.call(this._audioContext,this._options.bufferSize,this._options.audioChannels,this._options.audioChannels),this._actualBufferSize=this._scriptProcessor.bufferSize,this._scriptProcessor.onaudioprocess=d.as_method(this._audioProcess,this),this._volumeGain.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)},__finalizeContext:function(){this._scriptProcessor.disconnect(),this._volumeGain.disconnect(),this._audioInput.disconnect(),this._scriptProcessor.onaudioprocess=null,this._audioContext.close(),delete this._scriptProcessor,delete this._volumeGain,delete this._audioInput,delete this._audioContext},start:function(){this._started||(this.__initializeContext(),this._startContextTime=this._audioContext.currentTime,this._started=!0,this._stopped=!1,this._recordingLength=0,this._channels=[],this.trigger("started"))},stop:function(){this._started&&!this._stopped&&(this._stopContextTime=this._audioContext.currentTime,this._stopped=!0,this.trigger("stopped"),this.__finalizeContext(),this._started=!1,this._generateData())},_generateData:function(){var a=1,b=44,c=this._recordingLength*this._options.audioChannels*2+44,d=new ArrayBuffer(c),e=new DataView(d);f.generateHeader(c,this._options.audioChannels,this._actualSampleRate,d),this._channels.forEach(function(c){f.waveChannelTransform(c,a).value().forEach(function(a){e.setInt16(b,a,!0),b+=2})}),this._data=new Blob([e],{type:"audio/wav"}),this._leftChannel=[],this._rightChannel=[],this._recordingLength=0,this.trigger("data",this._data)}}}],{supported:function(){return!!e.globals().AudioContext&&!!e.globals().audioContextScriptProcessor}})}),a.define("module:WebRTC.MediaRecorder",["base:Class","base:Events.EventsMixin","base:Functions","browser:Info","module:WebRTC.Support"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,d){d=d||{},a.constructor.call(this),this._stream=b,this._started=!1;var f=e.globals().MediaRecorder,g={};d.videoBitrate&&(g.videoBitsPerSecond=1e3*d.videoBitrate),d.audioBitrate&&(g.audioBitsPerSecond=1e3*d.audioBitrate),this._mediaRecorder=new f(b,g),this._mediaRecorder.ondataavailable=c.as_method(this._dataAvailable,this),this._mediaRecorder.onstop=c.as_method(this._dataStop,this)},destroy:function(){this.stop(),a.destroy.call(this)},start:function(){this._started||(this._started=!0,this._chunks=[],this._mediaRecorder.start(),this.trigger("started"))},stop:function(){this._started&&(this._started=!1,this._mediaRecorder.stop(),this.trigger("stopped"))},_dataAvailable:function(a){this._chunks.push(a.data)},_dataStop:function(a){if(this._data=new Blob(this._chunks,{type:"video/webm"}),this._chunks=[],d.isFirefox()){var b=this,c=new FileReader;c.onload=function(){b._data=new Blob([this.result],{type:b._data.type}),b.trigger("data",b._data)},c.readAsArrayBuffer(this._data)}else this.trigger("data",this._data)}}}],{supported:function(){return!!e.globals().MediaRecorder&&!d.isChrome()&&!d.isOpera()}})}),a.define("module:WebRTC.PeerRecorder",["base:Class","base:Events.EventsMixin","base:Functions","base:Objs","browser:Info","module:WebRTC.Support"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,function(a){return{constructor:function(b,c){a.constructor.call(this),this._stream=b,this._videoBitrate=c.videoBitrate||700,this._audioBitrate=c.audioBitrate||128,this._started=!1},destroy:function(){this.stop(),
a.destroy.call(this)},start:function(a){this._started||(this._wssUrl=a.wssUrl,this._streamInfo=a.streamInfo,this._userData=a.userData||{},this._started=!0,this._wsConnection=new(f.globals().WebSocket)(this._wssUrl),this._wsConnection.binaryType="arraybuffer",this._wsConnection.onopen=c.as_method(this._wsOnOpen,this),this._wsConnection.onmessage=c.as_method(this._wsOnMessage,this),this._wsConnection.onclose=c.as_method(this._wsOnClose,this),this._wsConnection.onerror=this._errorCallback("WS_CONNECTION"),this.trigger("started"))},stop:function(){this._started&&(this._started=!1,this._peerConnection&&this._peerConnection.close(),this._peerConnection=null,this._wsConnection&&this._wsConnection.close(),this._wsConnection=null,this.trigger("stopped"))},_wsOnOpen:function(){this._peerConnection=new(f.globals().RTCPeerConnection)({iceServers:[]}),this._stream.getTracks&&this._peerConnection.addTrack?d.iter(this._stream.getTracks(),function(a){this._peerConnection.addTrack(a,localStream)},this):this._peerConnection.addStream(this._stream),this._peerConnection.createOffer(c.as_method(this._offerGotDescription,this),this._errorCallback("PEER_CREATE_OFFER"))},_wsOnMessage:function(a){var b=JSON.parse(a.data),c=parseInt(b.status,10);b.command;200!==c?this._error("MESSAGE_ERROR",{status:c,description:b.statusDescription}):(void 0!==b.sdp&&this._peerConnection.setRemoteDescription(new(f.globals().RTCSessionDescription)(b.sdp),function(){},this._errorCallback("PEER_REMOTE_DESCRIPTION")),b.iceCandidates&&d.iter(b.iceCandidates,function(a){this._peerConnection.addIceCandidate(new(f.globals().RTCIceCandidate)(a))},this)),this._wsConnection&&this._wsConnection.close(),this._wsConnection=null},_offerGotDescription:function(a){var b={};this._audioBitrate&&(b.audioBitrate=this._audioBitrate),this._videoBitrate&&(b.videoBitrate=this._videoBitrate),a.sdp=this._enhanceSDP(a.sdp,b),this._peerConnection.setLocalDescription(a,c.as_method(function(){this._wsConnection.send(JSON.stringify({direction:"publish",command:"sendOffer",streamInfo:this._streamInfo,sdp:a,userData:this._userData}))},this),this._errorCallback("PEER_LOCAL_DESCRIPTION"))},_enhanceSDP:function(a,b){var c=a.split(/\r\n/),e="header",f=!1,g="";return d.iter(c,function(a){a.length<=0||(g+=a+"\r\n",0===a.indexOf("m=audio")?(e="audio",f=!1):0===a.indexOf("m=video")&&(e="video",f=!1),0===a.indexOf("a=mid:")&&(f||(0==="audio".localeCompare(e)?void 0!==b.audioBitrate&&(g+="b=AS:"+b.audioBitrate+"\r\n",g+="b=TIAS:"+1024*b.audioBitrate+"\r\n"):0==="video".localeCompare(e)&&void 0!==b.videoBitrate&&(g+="b=AS:"+b.videoBitrate+"\r\n",g+="b=TIAS:"+1024*b.videoBitrate+"\r\n"),f=!0)))},this),g},_wsOnClose:function(){},_error:function(a,b){this.trigger("error",a,b),this.stop()},_errorCallback:function(a){return c.as_method(function(b){this._error(a,b)},this)}}}],{supported:function(){if(0!==document.location.href.indexOf("https://")&&"localhost"!==document.location.hostname){if(e.isChrome()&&e.chromeVersion()>=47)return!1;if(e.isOpera()&&e.operaVersion()>=34)return!1}return f.globals().RTCPeerConnection&&f.globals().RTCIceCandidate&&f.globals().RTCSessionDescription&&f.globals().WebSocket}})}),a.define("module:WebRTC.RecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","module:WebRTC.Support","base:Time","module:Recorder.PixelSampleMixin"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,f,function(a){return{constructor:function(b){a.constructor.call(this,b),this._video=b.video,this._recording=!1,this._bound=!1,this._hasAudio=!1,this._hasVideo=!1,this._flip=!!b.flip},_getConstraints:function(){return{audio:this._options.recordAudio?{sourceId:this._options.audioId}:!1,video:this._options.recordVideo?{sourceId:this._options.videoId,width:this._options.recordResolution.width,height:this._options.recordResolution.height}:!1}},stream:function(){return this._stream},bindMedia:function(){return this._bound?void 0:d.userMedia2(this._getConstraints()).success(function(a){this._hasAudio=this._options.recordAudio&&a.getAudioTracks().length>0,this._hasVideo=this._options.recordVideo&&a.getVideoTracks().length>0,this._bound=!0,this._stream=a,d.bindStreamToVideo(a,this._video,this._flip),this.trigger("bound",a),this._boundMedia()},this)},selectCamera:function(a){this._options.videoId=a,this._bound&&(this.unbindMedia(),this.bindMedia())},selectMicrophone:function(a){this._options.audioId=a,this._bound&&(this.unbindMedia(),this.bindMedia())},startRecord:function(a){this._recording||(this._recording=!0,this._startRecord(a),this._startTime=e.now())},stopRecord:function(){this._recording&&(this._recording=!1,this._stopRecord(),this._stopTime=e.now())},duration:function(){return(this._recording||!this._stopTime?e.now():this._stopTime)-this._startTime},unbindMedia:function(){this._bound&&!this._recording&&(d.stopUserMediaStream(this._stream),this._bound=!1,this.trigger("unbound"),this._unboundMedia())},createSnapshot:function(a){return d.dataURItoBlob(this._createSnapshot(a))},_createSnapshot:function(a){var b=document.createElement("canvas");b.width=this._video.videoWidth||this._video.clientWidth,b.height=this._video.videoHeight||this._video.clientHeight;var c=b.getContext("2d");c.drawImage(this._video,0,0,b.width,b.height);var d=b.toDataURL(a);return d},_pixelSample:function(a,b,c){a=a||100;var d=document.createElement("canvas"),e=this._video.videoWidth||this._video.clientWidth,f=this._video.videoHeight||this._video.clientHeight;d.width=e,d.height=f;var g=d.getContext("2d");g.drawImage(this._video,0,0,e,f);for(var h=2;a>0;){for(var i=1;h>i;++i){for(var j=1;h>j;++j){var k=g.getImageData(Math.floor(i*e/h),Math.floor(j*f/h),1,1).data;if(b.call(c||this,k[0],k[1],k[2]),--a,0>=a)break}if(0>=a)break}++h}},_boundMedia:function(){},_unboundMedia:function(){},_startRecord:function(a){},_stopRecord:function(){},_error:function(a,b){this.trigger("error",a,b)},getVolumeGain:function(){},setVolumeGain:function(a){},_dataAvailable:function(a,b){this.destroyed()||this.trigger("data",a,b)},destroy:function(){this.stopRecord(),this.unbindMedia(),a.destroy.call(this)},averageFrameRate:function(){return null}}}],{_initializeOptions:function(a){return c.extend({recordAudio:!0,recordVideo:!0,recordResolution:{width:320,height:200}},a)},supported:function(a){return!!d.globals().getUserMedia&&!!d.globals().URL}})}),a.define("module:WebRTC.PeerRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.PeerRecorder"],function(a,b,c){return a.extend({scoped:c},{_boundMedia:function(){this._recorder=new b(this._stream,{videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate}),this._recorder.on("error",this._error,this)},_unboundMedia:function(){this._recorder.destroy()},_startRecord:function(a){this._recorder.start(a.webrtcStreaming)},_stopRecord:function(){this._recorder.stop(),this._dataAvailable()},getVolumeGain:function(){},setVolumeGain:function(a){},averageFrameRate:function(){return null}},function(a){return{supported:function(c){return a.supported.call(this,c)?c.webrtcStreaming&&b.supported():!1}}})}),a.define("module:WebRTC.MediaRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.MediaRecorder"],function(a,b,c){return a.extend({scoped:c},{_boundMedia:function(){this._recorder=new b(this._stream,{videoBitrate:this._options.videoBitrate,audioBitrate:this._options.audioBitrate}),this._recorder.on("data",function(a){this._dataAvailable(a)},this)},_unboundMedia:function(){this._recorder.destroy()},_startRecord:function(){this._recorder.start()},_stopRecord:function(){this._recorder.stop()},getVolumeGain:function(){},setVolumeGain:function(a){},averageFrameRate:function(){return null}},function(a){return{supported:function(c){return a.supported.call(this,c)?b.supported():!1}}})}),a.define("module:WebRTC.WhammyAudioRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.AudioRecorder","module:WebRTC.WhammyRecorder","browser:Info"],function(a,b,c,d,e){return a.extend({scoped:e},{_createSnapshot:function(a){return this._whammyRecorder.createSnapshot(a)},_boundMedia:function(){this._videoBlob=null,this._audioBlob=null,this._hasVideo&&(this._whammyRecorder=new c(this._stream,{video:this._video,framerate:this._options.framerate})),this._hasAudio&&(this._audioRecorder=new b(this._stream),this._audioRecorder.on("data",function(a){this._audioBlob=a,!this._videoBlob&&this._hasVideo||this._dataAvailable(this._videoBlob,this._audioBlob)},this)),this._hasVideo&&this._whammyRecorder.on("data",function(a){this._videoBlob=a,!this._audioBlob&&this._hasAudio||this._dataAvailable(this._videoBlob,this._audioBlob)},this)},_unboundMedia:function(){this._hasAudio&&this._audioRecorder.destroy(),this._hasVideo&&this._whammyRecorder.destroy()},_startRecord:function(){this._hasVideo&&this._whammyRecorder.start(),this._hasAudio&&this._audioRecorder.start()},_stopRecord:function(){this._hasVideo&&this._whammyRecorder.stop(),this._hasAudio&&this._audioRecorder.stop()},getVolumeGain:function(){return this._audioRecorder?this._audioRecorder.getVolumeGain():1},setVolumeGain:function(a){this._audioRecorder&&this._audioRecorder.setVolumeGain(a)},averageFrameRate:function(){return this._hasVideo?this._whammyRecorder.averageFrameRate():0}},function(a){return{supported:function(e){if(!a.supported.call(this,e))return!1;if(0!==document.location.href.indexOf("https://")&&"localhost"!==document.location.hostname){if(d.isChrome()&&d.chromeVersion()>=47)return!1;if(d.isOpera()&&d.operaVersion()>=34)return!1}return b.supported()&&c.supported()}}})}),a.extend("module:WebRTC.RecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.PeerRecorderWrapper","module:WebRTC.MediaRecorderWrapper","module:WebRTC.WhammyAudioRecorderWrapper"],function(a,b,c,d){return a.register(b,3),a.register(c,2),a.register(d,1),{}}),a.define("module:WebRTC.Support",["base:Promise","base:Objs","browser:Info"],function(a,b,c){return{canvasSupportsImageFormat:function(a){try{var b=document.createElement("canvas").toDataURL(a);b.indexOf(";");return-1!=b.substring(0,b.indexOf(";")).indexOf(a)}catch(c){return!1}},getGlobals:function(){var a=null,b=null;a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,b=navigator;var c=window.URL||window.webkitURL,d=window.MediaRecorder,e=window.AudioContext||window.webkitAudioContext,f=null,g=null;if(e){var h=new e;f=h.createJavaScriptNode||h.createScriptProcessor,g=h.createAnalyser}var i=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,j=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,k=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,l=window.WebSocket;return{getUserMedia:a,getUserMediaCtx:b,URL:c,MediaRecorder:d,AudioContext:e,createAnalyser:g,audioContextScriptProcessor:f,webpSupport:this.canvasSupportsImageFormat("image/webp"),RTCPeerConnection:i,RTCIceCandidate:j,RTCSessionDescription:k,WebSocket:l}},globals:function(){return this.__globals||(this.__globals=this.getGlobals()),this.__globals},userMediaSupported:function(){return!!this.globals().getUserMedia},enumerateMediaSources:function(){var c=a.create(),d=function(a){var d={audio:{},audioCount:0,video:{},videoCount:0};b.iter(a,function(a){0===a.kind.indexOf("video")&&(d.videoCount++,d.video[a.id||a.deviceId]={id:a.id||a.deviceId,label:a.label}),0===a.kind.indexOf("audio")&&(d.audioCount++,d.audio[a.id||a.deviceId]={id:a.id||a.deviceId,label:a.label})}),c.asyncSuccess(d)};try{navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(d):MediaStreamTrack&&MediaStreamTrack.getSources?MediaStreamTrack.getSources(d):c.asyncError("Unsupported")}catch(e){c.asyncError(e)}return c},streamQueryResolution:function(b){var c=a.create(),d=this.bindStreamToVideo(b);return d.addEventListener("playing",function(){setTimeout(function(){c.asyncSuccess({stream:b,width:d.videoWidth,height:d.videoHeight}),d.remove()},500)}),c},userMedia:function(b){var c=a.create();return this.globals().getUserMedia.call(this.globals().getUserMediaCtx,b,function(a){c.asyncSuccess(a)},function(a){c.asyncError(a)}),c},userMedia2:function(a){var d={};if(a.audio&&(d.audio=a.audio),!a.video)return this.userMedia(d);if(c.isFirefox())return d.video={},!a.video.aspectRatio||a.video.width&&a.video.height||(a.video.width?a.video.height=Math.round(a.video.width/a.video.aspectRatio):a.video.height&&(a.video.width=Math.round(a.video.height*a.video.aspectRatio))),a.video.width&&(d.video.width={ideal:a.video.width}),a.video.height&&(d.video.height={ideal:a.video.height}),a.video.sourceId&&(d.video.sourceId=a.video.sourceId),this.userMedia(d);d.video={mandatory:{}},a.video.width&&(d.video.mandatory.minWidth=a.video.width,d.video.mandatory.maxWidth=a.video.width),!a.video.width&&a.video.height&&(d.video.mandatory.minHeight=a.video.height,d.video.mandatory.maxHeight=a.video.height);var e=a.video.aspectRatio?a.video.aspectRatio:a.video.width&&a.video.height?a.video.width/a.video.height:null;e&&(d.video.mandatory.minAspectRatio=e,d.video.mandatory.maxAspectRatio=e),a.video.sourceId&&(d.video.mandatory.sourceId=a.video.sourceId);var f=function(a){var c=d.video.mandatory;return this.userMedia(d).mapError(function(d){if(a--,"ConstraintNotSatisfiedError"!==d.name)return d;var e=d.constraintName.toLowerCase();return b.iter(c,function(b,d){var f=d.toLowerCase();if(f.indexOf(e)>=0){var g=f.indexOf("aspect")>0,h=0===f.indexOf("min")?-1:1,i=Math.max(0,c[d]*(1+h/10));c[d]=g?i:Math.round(i),0>a&&(delete c[d],a=100)}},this),f.call(this,a)},this)};return f.call(this,100)},stopUserMediaStream:function(a){try{a.stop?a.stop():a.getTracks&&a.getTracks().forEach(function(a){a.stop()})}catch(b){}},bindStreamToVideo:function(a,b,c){return b||(b=document.createElement("video")),b.volume=0,b.muted=!0,void 0!==b.mozSrcObject?b.mozSrcObject=a:b.src=this.globals().URL.createObjectURL(a),c?(b.style["-moz-transform"]="scale(-1, 1)",b.style["-webkit-transform"]="scale(-1, 1)",b.style["-o-transform"]="scale(-1, 1)",b.style.transform="scale(-1, 1)",b.style.filter="FlipH"):(delete b.style["-moz-transform"],delete b.style["-webkit-transform"],delete b.style["-o-transform"],delete b.style.transform,delete b.style.filter),b.autoplay=!0,b.play(),b},dataURItoBlob:function(a){for(var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);var g=new DataView(d),h=new Blob([g],{type:c});return h}}}),a.define("module:WebRTC.WhammyRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Time","base:Functions","base:Async","module:WebRTC.Support","module:Encoding.WebmEncoder.Support"],function(a,b,c,d,e,f,g,h,i){return a.extend({scoped:i},[b,function(a){var b=3e4;return{constructor:function(b,d){a.constructor.call(this),this._stream=b,this._options=c.extend({recordWidth:320,recordHeight:240,quality:void 0,video:null,framerate:null},d),this._started=!1},destroy:function(){this._started=!1,this.trigger("stopped"),a.destroy.call(this)},start:function(){this._started||(this._started=!0,this._options.video&&(this._options.recordWidth=this._options.video.videoWidth||this._options.video.clientWidth,this._options.recordHeight=this._options.video.videoHeight||this._options.video.clientHeight),this._video=document.createElement("video"),this._video.width=this._options.recordWidth,this._video.height=this._options.recordHeight,g.bindStreamToVideo(this._stream,this._video),this._canvas=document.createElement("canvas"),this._canvas.width=this._options.recordWidth,this._canvas.height=this._options.recordHeight,this._context=this._canvas.getContext("2d"),this._frames=[],this._lastTime=d.now(),this._startTime=this._lastTime,this.trigger("started"),f.eventually(this._process,[],this))},stop:function(){this._started&&(this._started=!1,this.trigger("stopped"),this._generateData())},_process:function(){if(this._started){var a=d.now(),b=a-this._lastTime;this._lastTime=a,this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._frames.push({duration:b,image:this._canvas.toDataURL("image/webp",this._options.quality)});var c=this._options.framerate?1e3/this._options.framerate:10;f.eventually(this._process,[],this,Math.max(1,c-(d.now()-a)))}},averageFrameRate:function(){return this._frames.length>0?this._frames.length/(d.now()-this._startTime)*1e3:null},_generateData:function(){this._frames.length&&(this._data=this.__compile(this.__dropBlackFrames(this._canvas,this._frames)),this.trigger("data",this._data))},__compile:function(a){var c=0,d=null,e=null,f=[],g=0,i=null,j=null;a.forEach(function(a){i||(i=[],j=0);var k=h.parseWebP(h.parseRIFF(atob(a.image.slice(23))));i.push(h.serializeEBML(h.makeTimecodeDataBlock(k.data,j))),j+=a.duration,c+=a.duration,d=d||k.width,e=e||k.height,j>=b&&(f.push(h.serializeEBML(h.makeCluster(i,g))),g=c,i=null,j=0)},this),i&&f.push(h.serializeEBML(h.makeCluster(i,g)));var k=h.generateEBMLHeader(c,d,e);return k[1].data=k[1].data.concat(f),h.serializeEBML(k)},__dropBlackFrames:function(a,b,c,d){for(var e=0;e<b.length&&h.isBlankFrame(a,b[e],c,d);)e++;return b.slice(e)},createSnapshot:function(a){return this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._canvas.toDataURL(a)}}}],{supported:function(){return g.globals().webpSupport}})})}).call(Scoped);