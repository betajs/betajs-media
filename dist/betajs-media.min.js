/*!
betajs-media - v0.0.4 - 2015-12-05
Copyright (c) Oliver Friedmann
MIT Software License.
*/
var Scoped=function(){function a(a){function b(a){return d.extend({route:null,parent:null,children:{},watchers:[],data:{},ready:!1,lazy:[]},a)}function c(a){if(!a.ready){if(a.parent&&!a.parent.ready)return void c(a.parent);if(a.route in a.parent.data){a.data=a.parent.data[a.route],a.ready=!0;for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[];for(var d in a.children)c(a.children[d])}}}function e(b){if(!b.ready){b.parent&&!b.parent.ready&&e(b.parent),b.ready=!0,a.tree&&"object"==typeof b.parent.data&&(b.parent.data[b.route]=b.data);for(var c=0;c<b.watchers.length;++c)b.watchers[c].callback.call(b.watchers[c].context||this,b.data);b.watchers=[]}}function f(a,b){if("object"==typeof b)for(var d in b)a.data[d]=b[d],a.children[d]&&(a.children[d].data=b[d]);else a.data=b;e(a);for(var f in a.children)c(a.children[f])}function g(a){if(a.ready&&a.data)for(var b in a.data)delete a.data[b]}function h(a){if(!a)return k;for(var d=a.split("."),e=k,f=0;f<d.length;++f)d[f]in e.children?e=e.children[d[f]]:(e.children[d[f]]=b({parent:e,route:d[f]}),e=e.children[d[f]],c(e));return e}function i(a,b,c){if(a.ready)b.call(c||this,a.data);else if(a.watchers.push({callback:b,context:c}),a.lazy.length>0){var d=function(a){if(a.lazy.length>0){var b=a.lazy.shift();b.callback.call(b.context||this,a.data),d(a)}};d(a)}}function j(a,b,c){a=a||k,c=c||[],a.ready||c.push(b);for(var d in a.children){var e=a.children[d],f=(b?b+".":"")+e.route;c=j(e,f,c)}return c}a=d.extend({tree:!1,global:!1,root:{}},a);var k=b({ready:!0}),l=null;if(a.tree){if(a.global){try{window&&(l=window)}catch(m){}try{global&&(l=global)}catch(m){}}else l=a.root;k.data=l}return{extend:function(a,b){f(h(a),b)},set:function(a,b){var c=h(a);c.data&&g(c),f(c,b)},lazy:function(a,b,c){var d=h(a);d.ready?b(c||this,d.data):d.lazy.push({callback:b,context:c})},digest:function(a){c(h(a))},obtain:function(a,b,c){i(h(a),b,c)},unresolvedWatchers:function(a){return j(h(a),a)}}}function b(e,f,g,h){var i=null,j=[],k=a({tree:!0}),l=a({tree:!1}),m={global:{namespace:h},root:{namespace:g},local:{namespace:k},"default":{namespace:l},parent:{namespace:f},scope:{namespace:k,readonly:!1}},n=function(a,b,c){var e=d.matchArgs(a,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),f=d.extend({lazy:this.options.lazy},e.options||{}),g=this.resolve(e.namespaceLocator),h=function(){this.require(e.dependencies,e.hiddenDependencies,function(){if(arguments[arguments.length-1].ns=g,this.options.compile){for(var f=[],h=0;h<a.length;++h)f.push(d.stringify(a[h]));this.compiled+=this.options.ident+"."+b+"("+f.join(", ")+");\n\n"}var i=e.callback.apply(e.context||this,arguments);c.call(this,g,i)},this)};return f.lazy?g.namespace.lazy(g.path,h,this):h.apply(this),this};return{getGlobal:d.method(c,c.getPath),setGlobal:d.method(c,c.setPath),options:{lazy:!1,ident:"Scoped",compile:!1},compiled:"",nextScope:function(){return i||(i=b(this,k,g,h)),i},subScope:function(){var a=this.nextScope();return j.push(a),i=null,a},binding:function(b,c,e){if(!m[b]||!m[b].readonly){var f;f="string"!=d.typeOf(c)?{namespace:a({tree:!0,root:c}),path:null}:this.resolve(c),m[b]=d.extend(e,f)}return this},resolve:function(a){var b=a.split(":");if(1==b.length)return{namespace:l,path:b[0]};var c=m[b[0]];if(!c)throw"The namespace '"+b[0]+"' has not been defined (yet).";return{namespace:c.namespace,path:c.path&&b[1]?c.path+"."+b[1]:c.path||b[1]}},define:function(){return n.call(this,arguments,"define",function(a,b){a.namespace.set(a.path,b)})},extend:function(){return n.call(this,arguments,"extend",function(a,b){a.namespace.extend(a.path,b)})},condition:function(){return n.call(this,arguments,"condition",function(a,b){b&&a.namespace.set(a.path,b)})},require:function(){var a=d.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});a.callback=a.callback||function(){};var b=a.dependencies||[],c=b.concat(a.hiddenDependencies||[]),e=c.length,f=[],g={};if(e)for(var h=function(b){this.i<f.length&&(f[this.i]=b),e--,0===e&&(f.push(g),a.callback.apply(a.context||this.ctx,f))},i=0;i<c.length;++i){var j=this.resolve(c[i]);i<b.length&&f.push(null),j.namespace.obtain(j.path,h,{ctx:this,i:i})}else f.push(g),a.callback.apply(a.context||this,f);return this},digest:function(a){var b=this.resolve(a);return b.namespace.digest(b.path),this},unresolved:function(a){var b=this.resolve(a);return b.namespace.unresolvedWatchers(b.path)}}}var c={get:function(a){return"undefined"!=typeof window?window[a]:"undefined"!=typeof global?global[a]:null},set:function(a,b){return"undefined"!=typeof window&&(window[a]=b),"undefined"!=typeof global&&(global[a]=b),b},setPath:function(a,b){var c=a.split(".");if(1==c.length)return this.set(a,b);for(var d=this.get(c[0])||this.set(c[0],{}),e=1;e<c.length-1;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d[c[c.length-1]]=b,b},getPath:function(a){var b=a.split(".");if(1==b.length)return this.get(a);for(var c=this.get(b[0]),d=1;d<b.length;++d){if(!c)return c;c=c[b[d]]}return c}},d={method:function(a,b){return function(){return b.apply(a,arguments)}},extend:function(a,b){a=a||{},b=b||{};for(var c in b)a[c]=b[c];return a},typeOf:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":typeof a},isEmpty:function(a){if(null===a||"undefined"==typeof a)return!0;if("array"==this.typeOf(a))return 0===a.length;if("object"!=typeof a)return!1;for(var b in a)return!1;return!0},matchArgs:function(a,b){var c=0,d={};for(var e in b)b[e]===!0||this.typeOf(a[c])==b[e]?(d[e]=a[c],c++):"undefined"==this.typeOf(a[c])&&c++;return d},stringify:function(a){return"function"==this.typeOf(a)?""+a:JSON.stringify(a)}},e={__namespace:"Scoped",upgrade:function(a){var b=c.get(a||e.__namespace);if(b&&"object"==d.typeOf(b)&&b.guid==this.guid&&"string"==d.typeOf(b.version)){for(var f=this.version.split("."),g=b.version.split("."),h=!1,i=0;i<Math.min(f.length,g.length)&&(h=parseInt(f[i],10)>parseInt(g[i],10),f[i]==g[i]);++i);return h?this.attach(a):b}return this.attach(a)},attach:function(a){a&&(e.__namespace=a);var b=c.get(e.__namespace);return b==this?this:(e.__revert=b,c.set(e.__namespace,this),this)},detach:function(a){return a&&c.set(e.__namespace,null),"undefined"!=typeof e.__revert&&c.set(e.__namespace,e.__revert),delete e.__revert,this},exports:function(a,b,c){return a=a||("undefined"!=typeof module?module:null),"object"==typeof a&&a&&"exports"in a&&(c||a.exports==this||!a.exports||d.isEmpty(a.exports))&&(a.exports=b||this),this}},f=a({tree:!0,global:!0}),g=a({tree:!0}),h=b(null,g,g,f),i=d.extend(h,{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"9.9436392609879",upgrade:e.upgrade,attach:e.attach,detach:e.detach,exports:e.exports});return i=i.upgrade(),i.exports(),i}.call(this);(function(){var a=this.subScope();a.binding("module","global:BetaJS.Media"),a.binding("base","global:BetaJS"),a.binding("jquery","global:jQuery"),a.define("module:",function(){return{guid:"8475efdb-dd7e-402e-9f50-36c76945a692",version:"29.1449366249936"}}),a.define("module:Player.FlashPlayer",["base:Browser.DomExtend.DomExtension","base:Browser.Dom","base:Browser.Info","base:Flash.FlashClassRegistry","base:Flash.FlashEmbedding","base:Strings","base:Async","base:Objs","base:Functions","base:Types","jquery:","base:Promise"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=a.extend({scoped:m},function(a){return{constructor:function(b,c){a.constructor.call(this,b,c),this._source=this.__preferedSource(),this._embedding=this.auto_destroy(new e(b,{registry:this.cls.flashRegistry(),wrap:!0,debug:!1})),this._flashObjs={},this._flashData={status:"idle"},this.ready=l.create(),this._embedding.ready(this.__initializeEmbedding,this)},__preferedSource:function(){var a=[".mp4",".flv"],b=[];if(this.readAttr("src")||this.readAttr("source")||this.readAttr("sources")){var d=this.readAttr("src")||this.readAttr("source")||this.readAttr("sources");j.is_array(d)?b=d:b.push(d)}var e=this._element;if(c.isInternetExplorer()&&c.internetExplorerVersion()<9)for(var g=this._$element;;){var i=g.next(),k=i.get(0);if(!k||"source"!=k.tagName.toLowerCase())break;b.push(i.attr("src").toLowerCase()),g=i}else for(var l=0;l<this._element.childNodes.length;++l)e.childNodes[l].tagName&&"source"==e.childNodes[l].tagName.toLowerCase()&&e.childNodes[l].src&&b.push(e.childNodes[l].src.toLowerCase());b=h.map(b,function(a){return a.src||a});for(var m=b[0],n=a.length-1,o=b.length-1;o>=0;--o)for(var p=0;n>=p;++p)if(f.ends_with(b[o],a[p])){m=b[o],n=p;break}-1==m.indexOf("://")&&(m=document.location.href+"/../"+m);var q=null,r=m;if(f.starts_with(m,"rtmp")){var s=f.splitLast(m,"/");q=s.head,r=s.tail}return{sourceUrl:m,connectionUrl:q,playUrl:r}},__initializeEmbedding:function(){this._flashObjs.main=this._embedding.flashMain(),this._flashObjs.stage=this._flashObjs.main.get("stage"),this._flashObjs.stage.set("scaleMode","noScale"),this._flashObjs.stage.set("align","TL"),this.readAttr("poster")&&(this._flashObjs.imageLoader=this._embedding.newObject("flash.display.Loader"),this._flashObjs.imageLoader.get("contentLoaderInfo").addEventListener("complete",this._embedding.newCallback(i.as_method(function(){this.__imageLoaded=!0,this.__metaLoaded||this.recomputeBB()},this))),this._flashObjs.imageUrlRequest=this._embedding.newObject("flash.net.URLRequest",this.readAttr("poster")),this._flashObjs.imageLoader.load(this._flashObjs.imageUrlRequest),this._flashObjs.main.addChildVoid(this._flashObjs.imageLoader)),this._flashObjs.video=this._embedding.newObject("flash.media.Video",this._flashObjs.stage.get("stageWidth"),this._flashObjs.stage.get("stageHeight")),this._flashObjs.connection=this._embedding.newObject("flash.net.NetConnection"),this._flashObjs.connection.addEventListener("netStatus",this._embedding.newCallback(i.as_method(this.__connectionStatusEvent,this))),this._flashObjs.connection.connectVoid(this._source.connectionUrl)},__connectionStatusEvent:function(){this._flashObjs.stream=this._embedding.newObject("flash.net.NetStream",this._flashObjs.connection),this._flashObjs.stream.set("client",this._embedding.newCallback("onMetaData",i.as_method(function(a){this._flashData.meta=a,this._element.duration=a.duration,this.__metaLoaded=!0,g.eventually(this.recomputeBB,this)},this))),this._flashObjs.stream.addEventListener("netStatus",this._embedding.newCallback(i.as_method(this.__streamStatusEvent,this))),this._flashObjs.soundTransform=this._embedding.newObject("flash.media.SoundTransform"),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this._flashObjs.video.attachNetStreamVoid(this._flashObjs.stream),this.writeAttr("volume",1),this.hasAttr("muted")&&(this._flashObjs.soundTransform.set("volume",0),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.writeAttr("volume",0)),this._flashObjs.main.addChildVoid(this._flashObjs.video),this.hasAttr("autoplay")&&this._element.play(),this.ready.asyncSuccess(this)},__streamStatusEvent:function(a){var b=a.get("info").code;"NetStream.Play.StreamNotFound"==b&&(this._flashData.status="error",this.domEvent("error")),"NetStream.Play.Start"==b&&(this._flashData.status="start"),"NetStream.Play.Stop"==b&&(this._flashData.status="stopping"),"NetStream.Buffer.Empty"==b&&"stopping"==this._flashData.status&&(this._flashData.status="stopped",this.domEvent("ended")),"stopped"==this._flashData.status&&this.hasAttr("loop")&&(this._flashData.status="idle",this._element.play())},idealBB:function(){return this.__imageLoaded||this.__metaLoaded?{width:this.__metaLoaded?this._flashData.meta.width:this._flashObjs.imageLoader.get("width"),height:this.__metaLoaded?this._flashData.meta.height:this._flashObjs.imageLoader.get("height")}:null},setActualBB:function(a){this._$element.find("object").css("width",a.width+"px"),this._$element.find("embed").css("width",a.width+"px"),this._$element.find("object").css("height",a.height+"px"),this._$element.find("embed").css("height",a.height+"px"),this.__metaLoaded&&(this._flashObjs.video.set("width",a.width),this._flashObjs.video.set("height",a.height)),this.__imageLoaded&&(this._flashObjs.imageLoader.set("width",a.width),this._flashObjs.imageLoader.set("height",a.height))},_domMethods:["play","pause"],_domAttrs:{volume:{set:"_setVolume"},currentTime:{get:"_getCurrentTime",set:"_setCurrentTime"}},play:function(){this._flashObjs.main.setChildIndex(this._flashObjs.video,1),"paused"===this._flashData.status?this._flashObjs.stream.resumeVoid():this._flashObjs.stream.playVoid(this._source.playUrl),this._flashData.status="playing",this.domEvent("playing")},pause:function(){"paused"!==this._flashData.status&&(this._flashData.status="paused",this._flashObjs.stream.pauseVoid(),this.domEvent("pause"))},_setVolume:function(a){this._flashObjs.soundTransform.set("volume",a),this._flashObjs.stream.set("soundTransform",null),this._flashObjs.stream.set("soundTransform",this._flashObjs.soundTransform),this.domEvent("volumechange")},_getCurrentTime:function(){return this._flashObjs.stream.get("time")},_setCurrentTime:function(a){this._flashObjs.stream.seek(a)}}},{flashRegistry:function(){return this.__flashRegistry||(this.__flashRegistry=new d,this.__flashRegistry.register("flash.media.Video",["attachNetStream"]),this.__flashRegistry.register("flash.display.Sprite",["addChild","setChildIndex"]),this.__flashRegistry.register("flash.display.Stage",[]),this.__flashRegistry.register("flash.net.NetStream",["play","pause","resume","addEventListener","seek"]),this.__flashRegistry.register("flash.net.NetConnection",["connect","addEventListener"]),this.__flashRegistry.register("flash.media.SoundTransform",[]),this.__flashRegistry.register("flash.display.Loader",["load"]),this.__flashRegistry.register("flash.net.URLRequest",[]),this.__flashRegistry.register("flash.display.LoaderInfo",["addEventListener"])),this.__flashRegistry},polyfill:function(a,c,d,e){if(e){var f=l.create();return g.eventually(function(){f.asyncSuccess(n.polyfill(a,c,d))}),f}return"video"==a.tagName.toLowerCase()&&"networkState"in a?a.networkState==a.NETWORK_NO_SOURCE||d?n.attach(b.changeTag(a,c||"videopoly")):a:n.attach(a)},attach:function(a,b){new n(a,b);return a}});return n}),a.define("module:Player.VideoPlayerWrapper",["base:Classes.OptimisticConditionalInstance","base:Events.EventsMixin","base:Types","base:Objs","base:Strings","jquery:"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,function(a){return{constructor:function(b,g){a.constructor.call(this),b=d.extend(d.clone(b||{},1),g),this._poster=b.poster||null;var h=b.source||b.sources||[];c.is_string(h)&&(h=h.split(" "));var i=[];d.iter(h,function(a){c.is_string(a)&&(a={src:e.trim(a)}),a.ext&&!a.type&&(a.type="video/"+a.ext),!a.ext&&a.type&&(a.ext=e.last_after(a.type,"/")),!a.ext&&!a.type&&a.src.indexOf(".")>=0&&(a.ext=e.last_after(a.src,"."),a.type="video/"+a.ext),a.type||(a.type="video"),a.ext=a.ext.toLowerCase(),a.type=a.type.toLowerCase(),i.push(a)},this),this._sources=i,this._element=b.element,this._$element=f(b.element),this._preload=b.preload||!1,this._options=b,this._loaded=!1,this._error=0},destroy:function(){this._$element.off("."+this.cid()),a.destroy.call(this)},poster:function(){return this._poster},sources:function(){return this._sources},loaded:function(){return this._loaded},buffered:function(){},_eventLoaded:function(){this._loaded=!0,this.trigger("loaded")},_eventPlaying:function(){this.trigger("playing")},_eventPaused:function(){this.trigger("paused")},_eventEnded:function(){this.trigger("ended")},_eventError:function(a){this._error=a,this.trigger("error",a)},supportsFullscreen:function(){return!1},duration:function(){return this._element.duration},position:function(){return this._element.currentTime},enterFullscreen:function(){},error:function(){return this._error},play:function(){this._element.play()},pause:function(){this._element.pause()},setPosition:function(a){this._element.currentTime=a},muted:function(){return this._element.muted},setMuted:function(a){this._element.muted=a},volume:function(){return this._element.volume},setVolume:function(a){this._element.volume=a}}}],{ERROR_NO_PLAYABLE_SOURCE:1,ERROR_FLASH_NOT_INSTALLED:2})}),a.define("module:Player.Html5VideoPlayerWrapper",["module:Player.VideoPlayerWrapper","base:Browser.Info","base:Promise","base:Objs","base:Timers.Timer","jquery:","base:Browser.Dom"],function(a,b,c,d,e,f,g,h){var i=a.extend({scoped:h},function(a){return{constructor:function(b,c){a.constructor.call(this,b,c)},_initialize:function(){if(this._options.nohtml5)return c.error(!0);if(this._sources.length<1)return c.error(!0);if(b.isInternetExplorer()&&b.internetExplorerVersion()<9)return c.error(!0);if(this._options.forceflash)return c.error(!0);var a=c.create();this._$element.html(""),"video"!==this._element.tagName.toLowerCase()&&(this._element=g.changeTag(this._element,"video"),this._$element=f(this._element),this._transitionals.element=this._element),this._element.poster=this.poster(),this._$element.on("loadedmetadata",function(){a.asyncSuccess(!0)});var h=new e({context:this,fire:function(){this._element.networkState===this._element.NETWORK_NO_SOURCE?a.asyncError(!0):this._element.networkState===this._element.NETWORK_IDLE&&a.asyncSuccess(!0)},delay:50});this._preload||this._$element.attr("preload","none");var i=0,j=this.sources();return d.iter(j,function(b){$source=f("<source type='"+b.type+"' />").appendTo(this._$element),$source.on("error",function(){i++,i===j.length&&a.asyncError(!0)}),$source.get(0).src=b.src},this),a.callback(function(){this._$element.find("source").off("error"),h.destroy()},this),a.success(function(){this._setup()},this),a},destroy:function(){this._$element.html(""),a.destroy.call(this)},_setup:function(){this._loaded=!1;var a=this,b=function(b,c){a._$element.on(b+"."+a.cid(),function(){c.apply(a,arguments)})};b("canplay",this._eventLoaded),b("playing",this._eventPlaying),b("pause",this._eventPaused),b("ended",this._eventEnded)},buffered:function(){return this._element.buffered.end(0)},supportsFullscreen:function(){return"webkitEnterFullscreen"in this._element||"mozRequestFullScreen"in this._element},enterFullscreen:function(){"webkitEnterFullscreen"in this._element?this._element.webkitEnterFullscreen():"mozRequestFullScreen"in this._element&&this._element.mozRequestFullScreen()}}});return a.register(i,2),i}),a.define("module:Player.FlashPlayerWrapper",["module:Player.VideoPlayerWrapper","module:Player.FlashPlayer","base:Browser.Info","base:Promise","base:Browser.Dom"],function(a,b,c,d,e,f){var g=a.extend({scoped:f},function(a){return{_initialize:function(){if(this._options.noflash)return d.error(!0);if(this._sources.length<1)return d.error(!0);if(c.isMobile()||!c.flash().supported())return d.error(!0);if(!c.flash().installed()&&this._options.flashinstallrequired)return d.error(!0);if(!c.flash().installed())return this._errorEvent(this.cls.ERROR_NO_FLASH_INSTALLED),d.value(!0);d.create();return"div"!==this._element.tagName.toLowerCase()&&(this._element=e.changeTag(this._element,"div"),this._$element=$(this._element),this._transitionals.element=this._element),this._flashPlayer=this.auto_destroy(new b(this._element,{poster:this.poster(),sources:this.sources()})),this._flashPlayer.ready.success(function(){this._setup()},this)},destroy:function(){this._$element.html(""),a.destroy.call(this)},_setup:function(){this._loaded=!0,this._eventLoaded();var a=this,b=function(b,c){a._$element.on(b+"."+a.cid(),function(){c.apply(a,arguments)})};b("playing",this._eventPlaying),b("pause",this._eventPaused),b("ended",this._eventEnded),b("error",function(){this._eventError(this.cls.ERROR_NO_PLAYABLE_SOURCE)})},position:function(){return this._element.get("currentTime")},buffered:function(){return this.position()},setPosition:function(a){this._element.set("currentTime",a)},setVolume:function(a){this._element.set("volume",a)}}});return a.register(g,1),g}),a.define("module:WebRTC.AudioAnalyser",["base:Class","module:WebRTC.Support"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c){a.constructor.call(this);var d=b.globals().AudioContext;this._audioContext=new d,this._analyserNode=b.globals().createAnalyser.call(this._audioContext),this._analyserNode.fftSize=32,this._audioInput=this._audioContext.createMediaStreamSource(c),this._audioInput.connect(this._analyserNode)},destroy:function(){this._analyserNode.disconnect(),delete this._analyserNode,delete this._audioContext,a.destroy.call(this)},soundLevel:function(){var a=this._analyserNode.fftSize,b=new Uint8Array(a);this._analyserNode.getByteTimeDomainData(b);for(var c=0,d=0;a>d;d++)c=Math.max(c,Math.abs(b[d]/128));return c}}},{supported:function(){return!!b.globals().AudioContext&&!!b.globals().createAnalyser}})}),a.define("module:WebRTC.AudioRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Functions","module:WebRTC.Support"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this._channels=[],this._recordingLength=0,this._options=c.extend({audioChannels:2,bufferSize:16384,sampleRate:44100},d),this._stream=b,this._started=!1,this._stopped=!1},_audioProcess:function(a){if(this._started){var b=0,c=this._actualBufferSize;this._channels.push({left:new Float32Array(a.inputBuffer.getChannelData(0)),right:this._options.audioChannels>1?new Float32Array(a.inputBuffer.getChannelData(1)):null,offset:b,endOffset:c}),this._recordingLength+=c-b}},destroy:function(){this.stop(),a.destroy.call(this)},__initializeContext:function(){var a=e.globals().AudioContext;this._audioContext=new a,this._actualSampleRate=this._audioContext.sampleRate||this._options.sampleRate,this._volumeGain=this._audioContext.createGain(),this._audioInput=this._audioContext.createMediaStreamSource(this._stream),this._audioInput.connect(this._volumeGain),this._scriptProcessor=e.globals().audioContextScriptProcessor.call(this._audioContext,this._options.bufferSize,this._options.audioChannels,this._options.audioChannels),this._actualBufferSize=this._scriptProcessor.bufferSize,this._scriptProcessor.onaudioprocess=d.as_method(this._audioProcess,this),this._volumeGain.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)},__finalizeContext:function(){this._scriptProcessor.disconnect(),this._volumeGain.disconnect(),this._audioInput.disconnect(),this._scriptProcessor.onaudioprocess=null,delete this._scriptProcessor,delete this._volumeGain,delete this._audioInput},start:function(){this._started||(this.__initializeContext(),this._startContextTime=this._audioContext.currentTime,this._started=!0,this._stopped=!1,this._recordingLength=0,this._channels=[],this.trigger("started"))},stop:function(){this._started&&!this._stopped&&(this._stopContextTime=this._audioContext.currentTime,this._stopped=!0,this.trigger("stopped"),this.__finalizeContext(),this._started=!1,this._generateData())},_generateData:function(){for(var a=new Float32Array(this._recordingLength*this._options.audioChannels),b=0,c=0;c<this._channels.length;++c)for(var d=this._channels[c].offset,e=this._channels[c].endOffset,f=this._channels[c].left,g=this._channels[c].right;e>d;)a[b]=f[d],g&&(a[b+1]=g[d]),++d,b+=this._options.audioChannels;var h=new ArrayBuffer(44+2*a.length),i=new DataView(h);this.__writeUTFBytes(i,0,"RIFF"),i.setUint32(4,44+2*a.length,!0),this.__writeUTFBytes(i,8,"WAVE"),this.__writeUTFBytes(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,this._options.audioChannels,!0),i.setUint32(24,this._actualSampleRate,!0),i.setUint32(28,4*this._actualSampleRate,!0),i.setUint16(32,2*this._options.audioChannels,!0),i.setUint16(34,16,!0),this.__writeUTFBytes(i,36,"data"),i.setUint32(40,2*a.length,!0);for(var j=a.length,k=44,l=1,m=0;j>m;m++)i.setInt16(k,a[m]*(32767*l),!0),k+=2;this._data=new Blob([i],{type:"audio/wav"}),this._leftChannel=[],this._rightChannel=[],this._recordingLength=0,this.trigger("data",this._data)},__writeUTFBytes:function(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))}}}],{supported:function(){return!!e.globals().AudioContext&&!!e.globals().audioContextScriptProcessor}})}),a.define("module:WebRTC.MediaRecorder",["base:Class","base:Events.EventsMixin","base:Functions","module:WebRTC.Support"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b){a.constructor.call(this),this._stream=b,this._started=!1;var e=d.globals().MediaRecorder;this._mediaRecorder=new e(b),this._mediaRecorder.ondataavailable=c.as_method(this._dataAvailable,this)},destroy:function(){this.stop(),a.destroy.call(this)},start:function(){this._started||(this._started=!0,this._mediaRecorder.start(),this.trigger("started"))},stop:function(){this._started&&(this._started=!1,this._mediaRecorder.stop(),this.trigger("stopped"))},_dataAvailable:function(a){this._data=new Blob([a.data],{type:a.data.type}),this.trigger("data",this._data)}}}],{supported:function(){return!!d.globals().MediaRecorder}})}),a.define("module:WebRTC.RecorderWrapper",["base:Classes.ConditionalInstance","base:Events.EventsMixin","base:Objs","module:WebRTC.Support","base:Time"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b){a.constructor.call(this,b),this._video=b.video,this._recording=!1,this._bound=!1},_getConstraints:function(){return{audio:this._options.recordAudio,video:this._options.recordVideo?{width:this._options.recordResolution.width,height:this._options.recordResolution.height}:!1}},stream:function(){return this._stream},bindMedia:function(){return this._bound?void 0:d.userMedia2(this._getConstraints()).success(function(a){this._bound=!0,this._stream=a,d.bindStreamToVideo(a,this._video),this.trigger("bound",a),this._boundMedia()},this)},startRecord:function(){this._recording||(this._recording=!0,this._startRecord(),this._startTime=e.now())},stopRecord:function(){this._recording&&(this._recording=!1,this._stopRecord(),this._stopTime=e.now())},duration:function(){return(this._recording?e.now():this._stopTime)-this._startTime},unbindMedia:function(){this._bound&&!this._recording&&(d.stopUserMediaStream(this._stream),this._bound=!1,this.trigger("unbound"),this._unboundMedia())},createSnapshot:function(a){return d.dataURItoBlob(this._createSnapshot(a))},_createSnapshot:function(a){var b=document.createElement("canvas");b.width=this._video.videoWidth||this._video.clientWidth,b.height=this._video.videoHeight||this._video.clientHeight;var c=b.getContext("2d");c.drawImage(this._video,0,0,b.width,b.height);var d=b.toDataURL(a);return d},lightLevel:function(a){a=a||10;var b=document.createElement("canvas");b.width=this._video.videoWidth||this._video.clientWidth,b.height=this._video.videoHeight||this._video.clientHeight;var c=b.getContext("2d");c.drawImage(this._video,0,0,b.width,b.height);for(var d=0,e=0;a>e;++e)for(var f=0;a>f;++f){var g=c.getImageData(Math.floor(b.width*e/a),Math.floor(b.height*f/a),1,1).data;d+=(g[0]+g[1]+g[2])/3}return d/a/a},_boundMedia:function(){},_unboundMedia:function(){},_startRecord:function(){},_stopRecord:function(){},_dataAvailable:function(a,b){this.trigger("data",a,b)},destroy:function(){this.stopRecord(),this.unbindMedia(),a.destroy.call(this)},averageFrameRate:function(){return null}}}],{_initializeOptions:function(a){return c.extend({recordAudio:!0,recordVideo:!0,recordResolution:{width:320,height:200}},a)},supported:function(a){return!!d.globals().getUserMedia&&!!d.globals().URL}})}),a.define("module:WebRTC.MediaRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.MediaRecorder"],function(a,b,c){var d=a.extend({scoped:c},{_boundMedia:function(){this._recorder=new b(this._stream),this._recorder.on("data",function(a){this._dataAvailable(a)},this)},_unboundMedia:function(){this._recorder.destroy()},_startRecord:function(){this._recorder.start()},_stopRecord:function(){this._recorder.stop()}},function(a){return{supported:function(c){return a.supported.call(this,c)?b.supported():!1}}});return a.register(d,2),d}),a.define("module:WebRTC.WhammyAudioRecorderWrapper",["module:WebRTC.RecorderWrapper","module:WebRTC.AudioRecorder","module:WebRTC.WhammyRecorder","base:Browser.Info"],function(a,b,c,d,e){var f=a.extend({scoped:e},{_createSnapshot:function(a){return this._whammyRecorder.createSnapshot(a)},_boundMedia:function(){this._whammyRecorder=new c(this._stream,{video:this._video}),this._audioRecorder=new b(this._stream),this._audioRecorder.on("data",function(a){this._audioBlob=a,this._videoBlob&&this._dataAvailable(this._videoBlob,this._audioBlob)},this),this._whammyRecorder.on("data",function(a){this._videoBlob=a,this._audioBlob&&this._dataAvailable(this._videoBlob,this._audioBlob)},this)},_unboundMedia:function(){this._audioRecorder.destroy(),this._whammyRecorder.destroy()},_startRecord:function(){this._whammyRecorder.start(),this._audioRecorder.start()},_stopRecord:function(){this._whammyRecorder.stop(),this._audioRecorder.stop()},averageFrameRate:function(){return this._whammyRecorder.averageFrameRate()}},function(a){return{supported:function(e){return a.supported.call(this,e)?d.isChrome()&&d.chromeVersion()>=47&&0!==document.location.href.indexOf("https://")?!1:b.supported()&&c.supported():!1}}});return a.register(f,1),f}),a.define("module:WebRTC.Support",["base:Promise.Promise","base:Objs","base:Browser.Info"],function(a,b,c){return{canvasSupportsImageFormat:function(a){try{var b=document.createElement("canvas").toDataURL(a);b.indexOf(";");return-1!=b.substring(0,b.indexOf(";")).indexOf(a)}catch(c){return!1}},getGlobals:function(){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,b=window.URL||window.webkitURL,c=window.MediaRecorder,d=window.AudioContext||window.webkitAudioContext,e=null,f=null;if(d){var g=new d;e=g.createJavaScriptNode||g.createScriptProcessor,f=g.createAnalyser}return{getUserMedia:a,URL:b,MediaRecorder:c,AudioContext:d,createAnalyser:f,audioContextScriptProcessor:e,webpSupport:this.canvasSupportsImageFormat("image/webp")}},globals:function(){return this.__globals||(this.__globals=this.getGlobals()),this.__globals},userMediaSupported:function(){return!!this.globals().getUserMedia},mediaStreamTrackSourcesSupported:function(){return MediaStreamTrack&&MediaStreamTrack.getSources},mediaStreamTrackSources:function(){if(!this.mediaStreamTrackSourcesSupported())return a.error("Unsupported");var c=new a;try{return MediaStreamTrack.getSources(function(a){var d={audio:{},audioCount:0,video:{},videoCount:0};b.iter(a,function(a){"video"===a.kind&&(d.videoCount++,d.video[a.id]={id:a.id,label:a.label}),"audio"===a.kind&&(d.audioCount++,d.audio[a.id]={id:a.id,label:a.label})}),c.asyncSuccess(d)}),c}catch(d){return a.error(d)}},streamQueryResolution:function(b){var c=new a,d=this.bindStreamToVideo(b);return d.addEventListener("playing",function(){setTimeout(function(){c.asyncSuccess({stream:b,width:d.videoWidth,height:d.videoHeight}),d.remove()},500)}),c},userMedia:function(b){var c=new a;return this.globals().getUserMedia.call(navigator,b,function(a){c.asyncSuccess(a)},function(a){c.asyncError(a)}),c},userMedia2:function(a){var b={};if(a.audio&&(b.audio=!0),!a.video)return this.userMedia(b);if(c.isFirefox())return a.video&&(b.video={},!a.video.aspectRatio||a.video.width&&a.video.height||(a.video.width?a.video.height=Math.round(a.video.width/a.video.aspectRatio):a.video.height&&(a.video.width=Math.round(a.video.height*a.video.aspectRatio))),a.video.width&&(b.video.width={ideal:a.video.width}),a.video.height&&(b.video.height={ideal:a.video.height})),this.userMedia(b);if(a.video){b.video={mandatory:{}},a.video.width&&(b.video.mandatory.minWidth=a.video.width,b.video.mandatory.maxWidth=a.video.width),!a.video.width&&a.video.height&&(b.video.mandatory.minHeight=a.video.height,b.video.mandatory.maxHeight=a.video.height);var d=a.video.aspectRatio?a.video.aspectRatio:a.video.width&&a.video.height?a.video.width/a.video.height:null;
d&&(b.video.mandatory.minAspectRatio=d,b.video.mandatory.maxAspectRatio=d)}var e=function(){var a=b.video.mandatory;return this.userMedia(b).mapError(function(b){if("ConstraintNotSatisfiedError"!==b.name)return b;var c=b.constraintName,d=c.indexOf("aspect")>0,f=0===c.indexOf("min")?-1:1,g=Math.max(0,a[c]*(1+f/10));return a[c]=d?g:Math.round(g),e.call(this)},this)};return e.call(this)},stopUserMediaStream:function(a){try{a.stop?a.stop():a.getTracks&&a.getTracks().each(function(a){a.stop()})}catch(b){}},bindStreamToVideo:function(a,b){return b||(b=document.createElement("video")),b.volume=0,b.muted=!0,void 0!==b.mozSrcObject?b.mozSrcObject=a:b.src=this.globals().URL.createObjectURL(a),b.autoplay=!0,b.play(),b},dataURItoBlob:function(a){for(var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);var g=new DataView(d),h=new Blob([g],{type:c});return h}}}),a.define("module:WebRTC.WhammyRecorder",["base:Class","base:Events.EventsMixin","base:Objs","base:Time","base:Functions","base:Async","module:WebRTC.Support"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this._stream=b,this._options=c.extend({recordWidth:320,recordHeight:240,video:null},d),this._started=!1},destroy:function(){this.stop(),a.destroy.call(this)},start:function(){this._started||(this._started=!0,this._options.video&&(this._options.recordWidth=this._options.video.videoWidth||this._options.video.clientWidth,this._options.recordHeight=this._options.video.videoHeight||this._options.video.clientHeight),this._video=document.createElement("video"),this._video.width=this._options.recordWidth,this._video.height=this._options.recordHeight,g.bindStreamToVideo(this._stream,this._video),this._canvas=document.createElement("canvas"),this._canvas.width=this._options.recordWidth,this._canvas.height=this._options.recordHeight,this._context=this._canvas.getContext("2d"),this._frames=[],this._isOnStartedDrawingNonBlankFramesInvoked=!1,this._lastTime=d.now(),this._startTime=this._lastTime,this.trigger("started"),f.eventually(this._process,[],this))},stop:function(){this._started&&(this._started=!1,this.trigger("stopped"),this._generateData())},_process:function(){if(this._started){var a=d.now(),b=a-this._lastTime;this._lastTime=a,this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._frames.push({duration:b,image:this._canvas.toDataURL("image/webp")}),this._isOnStartedDrawingNonBlankFramesInvoked||this.__isBlankFrame(this._canvas,this._frames[this._frames.length-1])||(this._isOnStartedDrawingNonBlankFramesInvoked=!0,this.trigger("onStartedDrawingNonBlankFrames")),f.eventually(this._process,[],this,Math.max(1,10-(d.now()-a)))}},averageFrameRate:function(){return this._frames.length>0?this._frames.length/(d.now()-this._startTime)*1e3:null},_generateData:function(){this._frames.length&&(this._data=this.__compile(this.__dropBlackFrames(this._canvas,this._frames,-1)),this.trigger("data",this._data))},clearOldRecordedFrames:function(){this._frames=[]},__doubleToString:function(a){return[].slice.call(new Uint8Array(new Float64Array([a]).buffer),0).map(function(a){return String.fromCharCode(a)}).reverse().join("")},__parseRIFF:function(a){for(var b=0,c={},d=function(a){var b=a.charCodeAt(0).toString(2);return new Array(8-b.length+1).join("0")+b};b<a.length;){var e=a.substr(b,4),f=parseInt(a.substr(b+4,4).split("").map(d).join(""),2),g=a.substr(b+4+4,f);b+=8+f,c[e]=c[e]||[],"RIFF"==e||"LIST"==e?c[e].push(this.__parseRIFF(g)):c[e].push(g)}return c},__parseWebP:function(a){for(var b=a.RIFF[0].WEBP[0],c=b.indexOf("Â*"),d=0,e=[];4>d;d++)e[d]=b.charCodeAt(c+3+d);var f,g,h;return h=e[1]<<8|e[0],f=16383&h,h=e[3]<<8|e[2],g=16383&h,{width:f,height:g,data:b,riff:a}},__checkFrames:function(a){if(!a[0])return null;var b=0;return c.iter(a,function(a){b+=a.duration}),{duration:b,width:a[0].width,height:a[0].height}},__makeSimpleBlock:function(a){var b=0;if(a.keyframe&&(b|=128),a.invisible&&(b|=8),a.lacing&&(b|=a.lacing<<1),a.discardable&&(b|=1),a.trackNum>127)throw"TrackNumber > 127 not supported";var c=[128|a.trackNum,a.timecode>>8,255&a.timecode,b].map(function(a){return String.fromCharCode(a)}).join("")+a.frame;return c},__numToBuffer:function(a){for(var b=[];a>0;)b.push(255&a),a>>=8;return new Uint8Array(b.reverse())},__strToBuffer:function(a){return new Uint8Array(a.split("").map(function(a){return a.charCodeAt(0)}))},__bitsToBuffer:function(a){var b=[],c=a.length%8?new Array(9-a.length%8).join("0"):"";a=c+a;for(var d=0;d<a.length;d+=8)b.push(parseInt(a.substr(d,8),2));return new Uint8Array(b)},__generateEBML:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].data;"object"==typeof d&&(d=this.__generateEBML(d)),"number"==typeof d&&(d=this.__bitsToBuffer(d.toString(2))),"string"==typeof d&&(d=this.__strToBuffer(d));var e=d.size||d.byteLength||d.length,f=Math.ceil(Math.ceil(Math.log(e)/Math.log(2))/8),g=e.toString(2),h=new Array(7*f+7+1-g.length).join("0")+g,i=new Array(f).join("0")+"1"+h;b.push(this.__numToBuffer(a[c].id)),b.push(this.__bitsToBuffer(i)),b.push(d)}return new Blob(b,{type:"video/webm"})},__toWebM:function(a){for(var b=this.__checkFrames(a),c=3e4,d=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:this.__doubleToString(b.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:b.width,id:176},{data:b.height,id:186}]}]}]}]}],e=0,f=0,g=this,h=0,i=function(a){var b=g.__makeSimpleBlock({discardable:0,frame:a.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(h)});return h+=a.duration,{data:b,id:163}};e<a.length;){var j=[],k=0;do j.push(a[e]),k+=a[e].duration,e++;while(e<a.length&&c>k);h=0;var l={id:524531317,data:[{data:f,id:231}].concat(j.map(i))};d[1].data.push(l),f+=k}return this.__generateEBML(d)},__compile:function(a){var b=this,c=this.__toWebM(a.map(function(a){var c=b.__parseWebP(b.__parseRIFF(atob(a.image.slice(23))));return c.duration=a.duration,c}));return c},__dropBlackFrames:function(a,b,c,d,e){var f=document.createElement("canvas");f.width=a.width,f.height=a.height;for(var g=f.getContext("2d"),h=[],i=-1===c,j=c&&c>0&&c<=b.length?c:b.length,k={r:0,g:0,b:0},l=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),m=d&&d>=0&&1>=d?d:0,n=e&&e>=0&&1>=e?e:0,o=!1,p=0;j>p;p++){var q,r,s;if(!o){var t=new Image;t.src=b[p].image,g.drawImage(t,0,0,a.width,a.height);var u=g.getImageData(0,0,a.width,a.height);q=0,r=u.data.length,s=u.data.length/4;for(var v=0;r>v;v+=4){var w={r:u.data[v],g:u.data[v+1],b:u.data[v+2]},x=Math.sqrt(Math.pow(w.r-k.r,2)+Math.pow(w.g-k.g,2)+Math.pow(w.b-k.b,2));l*m>=x&&q++}}!o&&s*n>=s-q||(i&&(o=!0),h.push(b[p]))}return h=h.concat(b.slice(j)),h.length<=0&&h.push(b[b.length-1]),h},__isBlankFrame:function(a,b,c,d){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var f,g,h,i=e.getContext("2d"),j={r:0,g:0,b:0},k=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),l=c&&c>=0&&1>=c?c:0,m=d&&d>=0&&1>=d?d:0,n=new Image;n.src=b.image,i.drawImage(n,0,0,a.width,a.height);var o=i.getImageData(0,0,a.width,a.height);f=0,g=o.data.length,h=o.data.length/4;for(var p=0;g>p;p+=4){var q={r:o.data[p],g:o.data[p+1],b:o.data[p+2]},r=Math.sqrt(Math.pow(q.r-j.r,2)+Math.pow(q.g-j.g,2)+Math.pow(q.b-j.b,2));k*l>=r&&f++}return h*m>=h-f?!1:!0},createSnapshot:function(a){return this._context.drawImage(this._video,0,0,this._canvas.width,this._canvas.height),this._canvas.toDataURL(a)}}}],{supported:function(){return g.globals().webpSupport}})})}).call(Scoped);